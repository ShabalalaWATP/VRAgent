"""add malware analysis tables

Revision ID: 0043_malware_analysis
Revises: 0042_binary_fuzzer_sessions
Create Date: 2026-01-20

"""
from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision = '0043_malware_analysis'
down_revision = '0042_binary_fuzzer_sessions'
branch_labels = None
depends_on = None


def upgrade() -> None:
    # Create malware_analysis_sessions table
    op.create_table(
        'malware_analysis_sessions',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('session_id', sa.String(length=64), nullable=False),
        sa.Column('user_id', sa.Integer(), nullable=False),
        sa.Column('project_id', sa.Integer(), nullable=True),

        # Binary information
        sa.Column('binary_name', sa.String(length=255), nullable=False),
        sa.Column('binary_hash_sha256', sa.String(length=64), nullable=False),
        sa.Column('binary_hash_md5', sa.String(length=32), nullable=False),
        sa.Column('binary_size', sa.Integer(), nullable=True),
        sa.Column('binary_path', sa.String(length=512), nullable=True),

        # Platform and architecture
        sa.Column('platform', sa.String(length=32), nullable=False),
        sa.Column('architecture', sa.String(length=32), nullable=False),

        # Sandbox information
        sa.Column('container_id', sa.String(length=128), nullable=True),
        sa.Column('sandbox_ip', sa.String(length=45), nullable=True),
        sa.Column('frida_session_id', sa.String(length=128), nullable=True),

        # Analysis status
        sa.Column('status', sa.String(length=32), server_default='created'),
        sa.Column('phase', sa.String(length=64), nullable=True),
        sa.Column('progress', sa.Float(), server_default='0.0'),

        # Malware classification
        sa.Column('is_malicious', sa.Boolean(), server_default='false'),
        sa.Column('malware_family', sa.String(length=128), nullable=True),
        sa.Column('malware_category', sa.String(length=64), nullable=True),
        sa.Column('confidence_score', sa.Float(), nullable=True),
        sa.Column('threat_score', sa.Integer(), nullable=True),
        sa.Column('severity', sa.String(length=32), nullable=True),

        # Capabilities and MITRE ATT&CK
        sa.Column('capabilities', postgresql.JSON(astext_type=sa.Text()), nullable=True),
        sa.Column('mitre_tactics', postgresql.JSON(astext_type=sa.Text()), nullable=True),
        sa.Column('mitre_techniques', postgresql.JSON(astext_type=sa.Text()), nullable=True),

        # Indicators of Compromise
        sa.Column('iocs', postgresql.JSON(astext_type=sa.Text()), nullable=True),

        # Error information
        sa.Column('error', sa.Text(), nullable=True),

        # Timestamps
        sa.Column('started_at', sa.DateTime(timezone=True), nullable=True),
        sa.Column('completed_at', sa.DateTime(timezone=True), nullable=True),
        sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.func.now()),
        sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.func.now(), onupdate=sa.func.now()),

        # Constraints
        sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='CASCADE'),
        sa.ForeignKeyConstraint(['project_id'], ['projects.id'], ondelete='SET NULL'),
        sa.PrimaryKeyConstraint('id'),
        sa.UniqueConstraint('session_id')
    )

    # Create indexes for malware_analysis_sessions
    op.create_index('ix_malware_analysis_sessions_id', 'malware_analysis_sessions', ['id'])
    op.create_index('ix_malware_analysis_sessions_session_id', 'malware_analysis_sessions', ['session_id'])
    op.create_index('ix_malware_analysis_sessions_user_id', 'malware_analysis_sessions', ['user_id'])
    op.create_index('ix_malware_analysis_sessions_project_id', 'malware_analysis_sessions', ['project_id'])
    op.create_index('ix_malware_analysis_sessions_binary_hash_sha256', 'malware_analysis_sessions', ['binary_hash_sha256'])
    op.create_index('ix_malware_analysis_sessions_platform', 'malware_analysis_sessions', ['platform'])
    op.create_index('ix_malware_analysis_sessions_status', 'malware_analysis_sessions', ['status'])
    op.create_index('ix_malware_analysis_sessions_is_malicious', 'malware_analysis_sessions', ['is_malicious'])
    op.create_index('ix_malware_analysis_sessions_malware_family', 'malware_analysis_sessions', ['malware_family'])

    # Create runtime_behaviors table
    op.create_table(
        'runtime_behaviors',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('session_id', sa.String(length=64), nullable=False),

        # Process information
        sa.Column('process_id', sa.Integer(), nullable=True),
        sa.Column('process_name', sa.String(length=255), nullable=True),
        sa.Column('parent_process_id', sa.Integer(), nullable=True),
        sa.Column('command_line', sa.Text(), nullable=True),

        # Behavior data (JSONB)
        sa.Column('api_calls', postgresql.JSON(astext_type=sa.Text()), nullable=True),
        sa.Column('network_connections', postgresql.JSON(astext_type=sa.Text()), nullable=True),
        sa.Column('dns_queries', postgresql.JSON(astext_type=sa.Text()), nullable=True),
        sa.Column('files_read', postgresql.JSON(astext_type=sa.Text()), nullable=True),
        sa.Column('files_written', postgresql.JSON(astext_type=sa.Text()), nullable=True),
        sa.Column('files_deleted', postgresql.JSON(astext_type=sa.Text()), nullable=True),
        sa.Column('registry_read', postgresql.JSON(astext_type=sa.Text()), nullable=True),
        sa.Column('registry_written', postgresql.JSON(astext_type=sa.Text()), nullable=True),
        sa.Column('processes_created', postgresql.JSON(astext_type=sa.Text()), nullable=True),
        sa.Column('crypto_operations', postgresql.JSON(astext_type=sa.Text()), nullable=True),
        sa.Column('memory_allocations', postgresql.JSON(astext_type=sa.Text()), nullable=True),
        sa.Column('decrypted_strings', postgresql.JSON(astext_type=sa.Text()), nullable=True),
        sa.Column('suspicious_behaviors', postgresql.JSON(astext_type=sa.Text()), nullable=True),
        sa.Column('mitre_techniques', postgresql.JSON(astext_type=sa.Text()), nullable=True),
        sa.Column('execution_timeline', postgresql.JSON(astext_type=sa.Text()), nullable=True),

        # Summary statistics
        sa.Column('total_api_calls', sa.Integer(), server_default='0'),
        sa.Column('total_network_connections', sa.Integer(), server_default='0'),
        sa.Column('total_files_accessed', sa.Integer(), server_default='0'),

        # Timestamp
        sa.Column('captured_at', sa.DateTime(timezone=True), server_default=sa.func.now()),

        # Constraints
        sa.ForeignKeyConstraint(['session_id'], ['malware_analysis_sessions.session_id'], ondelete='CASCADE'),
        sa.PrimaryKeyConstraint('id')
    )

    # Create indexes for runtime_behaviors
    op.create_index('ix_runtime_behaviors_id', 'runtime_behaviors', ['id'])
    op.create_index('ix_runtime_behaviors_session_id', 'runtime_behaviors', ['session_id'])

    # Create malware_artifacts table
    op.create_table(
        'malware_artifacts',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('session_id', sa.String(length=64), nullable=False),

        # Artifact information
        sa.Column('artifact_type', sa.String(length=64), nullable=False),
        sa.Column('artifact_name', sa.String(length=255), nullable=False),
        sa.Column('artifact_path', sa.String(length=512), nullable=True),
        sa.Column('artifact_size', sa.Integer(), nullable=True),
        sa.Column('artifact_hash', sa.String(length=64), nullable=True),

        # Classification
        sa.Column('is_malicious', sa.Boolean(), server_default='false'),
        sa.Column('description', sa.Text(), nullable=True),

        # Metadata and analysis
        sa.Column('metadata', postgresql.JSON(astext_type=sa.Text()), nullable=True),
        sa.Column('analysis_results', postgresql.JSON(astext_type=sa.Text()), nullable=True),

        # Timestamps
        sa.Column('discovered_at', sa.DateTime(timezone=True), nullable=True),
        sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.func.now()),

        # Constraints
        sa.ForeignKeyConstraint(['session_id'], ['malware_analysis_sessions.session_id'], ondelete='CASCADE'),
        sa.PrimaryKeyConstraint('id')
    )

    # Create indexes for malware_artifacts
    op.create_index('ix_malware_artifacts_id', 'malware_artifacts', ['id'])
    op.create_index('ix_malware_artifacts_session_id', 'malware_artifacts', ['session_id'])
    op.create_index('ix_malware_artifacts_artifact_type', 'malware_artifacts', ['artifact_type'])
    op.create_index('ix_malware_artifacts_artifact_hash', 'malware_artifacts', ['artifact_hash'])


def downgrade() -> None:
    # Drop malware_artifacts table
    op.drop_index('ix_malware_artifacts_artifact_hash', table_name='malware_artifacts')
    op.drop_index('ix_malware_artifacts_artifact_type', table_name='malware_artifacts')
    op.drop_index('ix_malware_artifacts_session_id', table_name='malware_artifacts')
    op.drop_index('ix_malware_artifacts_id', table_name='malware_artifacts')
    op.drop_table('malware_artifacts')

    # Drop runtime_behaviors table
    op.drop_index('ix_runtime_behaviors_session_id', table_name='runtime_behaviors')
    op.drop_index('ix_runtime_behaviors_id', table_name='runtime_behaviors')
    op.drop_table('runtime_behaviors')

    # Drop malware_analysis_sessions table
    op.drop_index('ix_malware_analysis_sessions_malware_family', table_name='malware_analysis_sessions')
    op.drop_index('ix_malware_analysis_sessions_is_malicious', table_name='malware_analysis_sessions')
    op.drop_index('ix_malware_analysis_sessions_status', table_name='malware_analysis_sessions')
    op.drop_index('ix_malware_analysis_sessions_platform', table_name='malware_analysis_sessions')
    op.drop_index('ix_malware_analysis_sessions_binary_hash_sha256', table_name='malware_analysis_sessions')
    op.drop_index('ix_malware_analysis_sessions_project_id', table_name='malware_analysis_sessions')
    op.drop_index('ix_malware_analysis_sessions_user_id', table_name='malware_analysis_sessions')
    op.drop_index('ix_malware_analysis_sessions_session_id', table_name='malware_analysis_sessions')
    op.drop_index('ix_malware_analysis_sessions_id', table_name='malware_analysis_sessions')
    op.drop_table('malware_analysis_sessions')
