/*
    Malware Detection Rules
    Detects common malware families and behaviors
*/

rule ransomware_indicators
{
    meta:
        description = "Detects ransomware indicators and behaviors"
        severity = "critical"
        category = "malware"
        family = "ransomware"
    strings:
        // File extension manipulation
        $ext1 = ".locked" nocase
        $ext2 = ".encrypted" nocase
        $ext3 = ".crypto" nocase
        $ext4 = ".cerber" nocase
        $ext5 = ".locky" nocase
        $ext6 = ".zepto" nocase

        // Ransom note indicators
        $note1 = "your files have been encrypted" nocase
        $note2 = "decrypt your files" nocase
        $note3 = "pay the ransom" nocase
        $note4 = "bitcoin address" nocase
        $note5 = "HOW_TO_DECRYPT" nocase
        $note6 = "DECRYPT_INSTRUCTION" nocase

        // Crypto APIs
        $api1 = "CryptEncrypt"
        $api2 = "CryptGenKey"
        $api3 = "CryptAcquireContext"

        // Volume shadow deletion
        $shadow1 = "vssadmin.exe Delete Shadows" nocase
        $shadow2 = "wmic shadowcopy delete" nocase
        $shadow3 = "bcdedit /set {default} recoveryenabled no" nocase

    condition:
        (2 of ($ext*) or 2 of ($note*) or $shadow1 or $shadow2 or $shadow3) and
        1 of ($api*)
}

rule trojan_remote_access
{
    meta:
        description = "Detects Remote Access Trojan (RAT) indicators"
        severity = "critical"
        category = "malware"
        family = "trojan"
    strings:
        // Common RAT strings
        $rat1 = "DarkComet" nocase
        $rat2 = "NjRAT" nocase
        $rat3 = "QuasarRAT" nocase
        $rat4 = "AsyncRAT" nocase
        $rat5 = "RemcosRAT" nocase

        // Remote desktop APIs
        $api1 = "GetDesktopWindow"
        $api2 = "GetWindowDC"
        $api3 = "BitBlt"
        $api4 = "CreateDesktop"

        // Keylogger functions
        $key1 = "GetAsyncKeyState"
        $key2 = "GetKeyboardState"
        $key3 = "SetWindowsHookEx"

        // Network functions
        $net1 = "InternetOpenUrl"
        $net2 = "WSAStartup"
        $net3 = "connect"

    condition:
        (1 of ($rat*) or (2 of ($key*) and 1 of ($net*))) and
        1 of ($api*)
}

rule backdoor_indicators
{
    meta:
        description = "Detects backdoor implant indicators"
        severity = "critical"
        category = "malware"
        family = "backdoor"
    strings:
        // Persistence mechanisms
        $persist1 = "CurrentVersion\\Run" nocase
        $persist2 = "CurrentVersion\\RunOnce" nocase
        $persist3 = "\\Start Menu\\Startup" nocase
        $persist4 = "schtasks /create" nocase

        // Backdoor commands
        $cmd1 = "cmd.exe /c" nocase
        $cmd2 = "powershell -enc" nocase
        $cmd3 = "WScript.Shell" nocase

        // Network backdoor
        $net1 = "bind shell" nocase
        $net2 = "reverse shell" nocase
        $net3 = "accept connections" nocase

        // Credential theft
        $cred1 = "mimikatz" nocase
        $cred2 = "sekurlsa::logonpasswords" nocase
        $cred3 = "lsadump::sam" nocase

    condition:
        2 of ($persist*) or 2 of ($cmd*) or 1 of ($net*) or 1 of ($cred*)
}

rule rootkit_indicators
{
    meta:
        description = "Detects rootkit behaviors and indicators"
        severity = "critical"
        category = "malware"
        family = "rootkit"
    strings:
        // Driver loading
        $drv1 = "NtLoadDriver"
        $drv2 = "ZwLoadDriver"
        $drv3 = "\\\\.\\\\GLOBALROOT" nocase

        // SSDT hooking
        $hook1 = "KeServiceDescriptorTable"
        $hook2 = "KiServiceTable"
        $hook3 = "NtQuerySystemInformation"

        // Process hiding
        $hide1 = "PsLookupProcessByProcessId"
        $hide2 = "EPROCESS"
        $hide3 = "ActiveProcessLinks"

        // Direct kernel object manipulation
        $kern1 = "\\Device\\PhysicalMemory"
        $kern2 = "MmMapIoSpace"
        $kern3 = "ZwSystemDebugControl"

    condition:
        2 of ($drv*) or 2 of ($hook*) or 2 of ($hide*) or 1 of ($kern*)
}

rule infostealer_indicators
{
    meta:
        description = "Detects information stealer malware"
        severity = "high"
        category = "malware"
        family = "stealer"
    strings:
        // Browser credential paths
        $path1 = "\\Google\\Chrome\\User Data\\Default\\Login Data" nocase
        $path2 = "\\Mozilla\\Firefox\\Profiles" nocase
        $path3 = "\\Microsoft\\Edge\\User Data\\Default\\Login Data" nocase

        // Crypto wallet paths
        $wallet1 = "\\Electrum\\wallets" nocase
        $wallet2 = "\\Exodus\\exodus.wallet" nocase
        $wallet3 = "\\Bitcoin\\wallet.dat" nocase

        // Data exfiltration
        $exfil1 = "POST" nocase
        $exfil2 = "multipart/form-data" nocase
        $exfil3 = "application/x-www-form-urlencoded" nocase

        // Credential APIs
        $api1 = "CryptUnprotectData"
        $api2 = "sqlite3_open"
        $api3 = "RegQueryValueEx"

    condition:
        (2 of ($path*) or 1 of ($wallet*)) and
        1 of ($exfil*) and
        1 of ($api*)
}

rule cryptominer_indicators
{
    meta:
        description = "Detects cryptocurrency mining malware"
        severity = "medium"
        category = "malware"
        family = "miner"
    strings:
        // Mining pool domains
        $pool1 = "pool.minexmr.com" nocase
        $pool2 = "pool.supportxmr.com" nocase
        $pool3 = "xmr-" nocase
        $pool4 = "stratum+tcp://" nocase

        // Mining software
        $miner1 = "xmrig" nocase
        $miner2 = "cpuminer" nocase
        $miner3 = "ccminer" nocase
        $miner4 = "NiceHash" nocase

        // Mining parameters
        $param1 = "--donate-level" nocase
        $param2 = "--algo=" nocase
        $param3 = "--user=" nocase
        $param4 = "randomx" nocase

        // High CPU usage
        $cpu1 = "SetThreadPriority"
        $cpu2 = "GetSystemInfo"

    condition:
        (1 of ($pool*) or 1 of ($miner*) or 2 of ($param*)) and
        1 of ($cpu*)
}

rule worm_propagation
{
    meta:
        description = "Detects worm propagation mechanisms"
        severity = "high"
        category = "malware"
        family = "worm"
    strings:
        // Network scanning
        $scan1 = "445/tcp" nocase
        $scan2 = "SMB" nocase
        $scan3 = "NetBIOS" nocase

        // EternalBlue indicators
        $eb1 = "MS17-010" nocase
        $eb2 = "EternalBlue" nocase
        $eb3 = "DoublePulsar" nocase

        // Lateral movement
        $move1 = "PsExec" nocase
        $move2 = "admin$" nocase
        $move3 = "IPC$" nocase

        // Self-replication
        $rep1 = "CopyFile"
        $rep2 = "WriteFile"
        $rep3 = "CreateProcess"

    condition:
        (2 of ($scan*) or 1 of ($eb*)) and
        1 of ($move*) and
        2 of ($rep*)
}

rule spyware_indicators
{
    meta:
        description = "Detects spyware and monitoring software"
        severity = "high"
        category = "malware"
        family = "spyware"
    strings:
        // Keylogger
        $key1 = "GetAsyncKeyState"
        $key2 = "GetKeyState"
        $key3 = "keyboard hook" nocase

        // Screen capture
        $screen1 = "BitBlt"
        $screen2 = "GetDC"
        $screen3 = "screenshot" nocase

        // Audio capture
        $audio1 = "waveInOpen"
        $audio2 = "waveInStart"
        $audio3 = "microphone" nocase

        // Webcam access
        $cam1 = "avicap32.dll" nocase
        $cam2 = "capCreateCaptureWindow"
        $cam3 = "camera" nocase

        // Clipboard monitoring
        $clip1 = "GetClipboardData"
        $clip2 = "SetClipboardViewer"

    condition:
        2 of ($key*) or 2 of ($screen*) or 2 of ($audio*) or
        2 of ($cam*) or 2 of ($clip*)
}
