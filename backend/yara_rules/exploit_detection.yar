/*
    Exploit Detection Rules
    Detects exploit code, shellcode, and vulnerability exploitation
*/

rule shellcode_indicators
{
    meta:
        description = "Detects common shellcode patterns"
        severity = "critical"
        category = "exploit"
        technique = "shellcode"
    strings:
        // Common shellcode opcodes (x86/x64)
        $nop_sled = { 90 90 90 90 90 90 90 90 }

        // GetPC (get program counter) - common shellcode technique
        $getpc1 = { E8 00 00 00 00 }  // call $+5
        $getpc2 = { EB 03 5E EB 05 E8 F8 FF FF FF }

        // Egg hunters
        $egg1 = { 66 81 CA FF 0F 42 52 6A 02 58 CD 2E }
        $egg2 = { 31 C9 66 81 C9 FF 0F 41 }

        // Common x86 shellcode (execve, socket)
        $exec1 = { 31 C0 50 68 2F 2F 73 68 68 2F 62 69 6E }  // execve("/bin/sh")
        $socket1 = { 6A 66 58 }  // socket syscall

        // Windows shellcode (LoadLibrary, GetProcAddress)
        $load1 = "LoadLibraryA" ascii
        $load2 = "GetProcAddress" ascii
        $winexec = { FF D5 }  // call ebp (common after GetProcAddress)

        // Metasploit shikata_ga_nai decoder stub
        $shikata = { D9 74 24 F4 5? B? ?? ?? ?? ?? ?? 31 }

        // Cobalt Strike beacon
        $beacon1 = { 4D 5A 41 52 55 48 89 E5 }

    condition:
        $nop_sled or
        $getpc1 or $getpc2 or
        $egg1 or $egg2 or
        $exec1 or $socket1 or
        ($load1 and $load2 and $winexec) or
        $shikata or
        $beacon1
}

rule rop_gadget_usage
{
    meta:
        description = "Detects ROP (Return-Oriented Programming) gadget usage"
        severity = "high"
        category = "exploit"
        technique = "ROP"
    strings:
        // Common ROP gadgets (x86/x64)
        $pop_ret = { 5? C3 }  // pop reg; ret
        $pop_pop_ret = { 5? 5? C3 }  // pop reg; pop reg; ret
        $xchg_esp = { 9? C3 }  // xchg eax, esp; ret
        $leave_ret = { C9 C3 }  // leave; ret
        $int80_ret = { CD 80 C3 }  // int 0x80; ret
        $syscall_ret = { 0F 05 C3 }  // syscall; ret

        // Pivot gadgets
        $pivot1 = { 89 ?? C3 }  // mov esp, reg; ret
        $pivot2 = { 8B ?? C3 }  // mov reg, esp; ret

        // Stack alignment
        $align1 = { 83 E4 F0 }  // and esp, 0xFFFFFFF0
        $align2 = { 48 83 E4 F0 }  // and rsp, 0xFFFFFFF0

    condition:
        (#pop_ret > 10 or #pop_pop_ret > 5) and
        (1 of ($pivot*) or 1 of ($align*))
}

rule heap_spray_indicators
{
    meta:
        description = "Detects heap spray exploitation technique"
        severity = "high"
        category = "exploit"
        technique = "heap_spray"
    strings:
        // JavaScript heap spray
        $js_spray1 = "unescape(\"%u" nocase
        $js_spray2 = "%u9090%u9090" nocase
        $js_spray3 = ".substring(0," nocase

        // ActionScript heap spray
        $as_spray1 = "new Array(" nocase
        $as_spray2 = ".length" nocase

        // Repeated shellcode patterns
        $nop_block = { 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 }

    condition:
        (2 of ($js_spray*) or 2 of ($as_spray*)) or
        #nop_block > 20
}

rule format_string_exploit
{
    meta:
        description = "Detects format string exploitation patterns"
        severity = "high"
        category = "exploit"
        cwe = "CWE-134"
    strings:
        // Format string specifiers
        $fmt1 = "%x%x%x%x" nocase
        $fmt2 = "%n%n%n" nocase
        $fmt3 = "%s%s%s" nocase
        $fmt4 = "AAAA%08x" nocase

        // Direct parameter access
        $direct1 = "%10$x" nocase
        $direct2 = "%20$n" nocase

        // Format functions
        $func1 = "printf("
        $func2 = "sprintf("
        $func3 = "fprintf("
        $func4 = "snprintf("

    condition:
        (1 of ($fmt*) or 1 of ($direct*)) and
        1 of ($func*)
}

rule use_after_free_indicators
{
    meta:
        description = "Detects potential UAF (Use-After-Free) exploitation"
        severity = "high"
        category = "exploit"
        cwe = "CWE-416"
    strings:
        // Allocation/deallocation
        $alloc1 = "malloc"
        $alloc2 = "calloc"
        $alloc3 = "realloc"
        $free = "free"

        // C++ new/delete
        $new = "operator new"
        $delete = "operator delete"

        // Spray/massage heap
        $heap1 = "heap spray" nocase
        $heap2 = "heap massage" nocase
        $heap3 = "heap feng shui" nocase

    condition:
        ($free and (1 of ($alloc*))) or
        ($new and $delete) or
        1 of ($heap*)
}

rule integer_overflow_exploit
{
    meta:
        description = "Detects integer overflow exploitation patterns"
        severity = "medium"
        category = "exploit"
        cwe = "CWE-190"
    strings:
        // Large numbers near limits
        $max_int = { FF FF FF 7F }  // 0x7FFFFFFF
        $max_uint = { FF FF FF FF }  // 0xFFFFFFFF

        // Multiplication before allocation
        $pattern1 = "malloc" nocase
        $pattern2 = "calloc" nocase
        $pattern3 = "realloc" nocase

    condition:
        ($max_int or $max_uint) and
        1 of ($pattern*)
}

rule buffer_overflow_exploit
{
    meta:
        description = "Detects buffer overflow exploitation patterns"
        severity = "critical"
        category = "exploit"
        cwe = "CWE-120"
    strings:
        // Unsafe string functions
        $unsafe1 = "strcpy"
        $unsafe2 = "strcat"
        $unsafe3 = "gets"
        $unsafe4 = "sprintf"
        $unsafe5 = "vsprintf"

        // Potentially dangerous memory operations
        $mem1 = "memcpy"
        $mem2 = "memmove"
        $mem3 = "bcopy"

        // Return address manipulation
        $ret1 = "ret" ascii
        $ret2 = { C3 }  // ret opcode

        // Stack cookie check bypass
        $canary1 = "__stack_chk_fail"
        $canary2 = "StackGuard" nocase

    condition:
        2 of ($unsafe*) or
        (1 of ($mem*) and 1 of ($ret*))
}

rule cve_2017_0144_eternalblue
{
    meta:
        description = "Detects EternalBlue exploit (MS17-010)"
        severity = "critical"
        category = "exploit"
        cve = "CVE-2017-0144"
        reference = "https://nvd.nist.gov/vuln/detail/CVE-2017-0144"
    strings:
        // SMBv1 Trans2 packets
        $smb1 = { FF 53 4D 42 }  // SMB signature
        $trans2 = { 32 00 }  // Trans2 command

        // DoublePulsar backdoor
        $double_pulsar = "DoublePulsar" nocase

        // EternalBlue specific strings
        $eb_string1 = "EternalBlue" nocase
        $eb_string2 = "\\mssecsvc.exe" nocase

        // Kernel shellcode pattern
        $kernel_sc = { 48 31 C0 B8 ?? ?? ?? ?? 48 8B 80 }

    condition:
        ($smb1 and $trans2) or
        $double_pulsar or
        1 of ($eb_string*) or
        $kernel_sc
}

rule cve_2017_11882_equation_editor
{
    meta:
        description = "Detects CVE-2017-11882 (Microsoft Office Equation Editor)"
        severity = "critical"
        category = "exploit"
        cve = "CVE-2017-11882"
    strings:
        // Equation Editor OLE object
        $ole1 = "Equation.3" nocase
        $ole2 = "EQNEDT32.EXE" nocase

        // Malformed font structure
        $font_struct = { 01 00 00 00 02 CE 02 00 00 00 00 00 }

        // Shellcode after overflow
        $shellcode_marker = { 90 90 90 90 CC CC CC CC }

    condition:
        1 of ($ole*) and
        ($font_struct or $shellcode_marker)
}

rule cve_2012_0158_mscomctl
{
    meta:
        description = "Detects CVE-2012-0158 (MSCOMCTL.OCX)"
        severity = "critical"
        category = "exploit"
        cve = "CVE-2012-0158"
    strings:
        // MSCOMCTL ActiveX control
        $activex = "MSCOMCTL.OCX" nocase

        // Malformed ListView/TreeView
        $listview = "MSComctlLib.ListViewCtrl" nocase
        $treeview = "MSComctlLib.TreeViewCtrl" nocase

        // Heap spray marker
        $spray = { 0C 0C 0C 0C }

    condition:
        $activex and
        (1 of ($listview, $treeview)) and
        $spray
}

rule log4shell_exploitation
{
    meta:
        description = "Detects Log4Shell (CVE-2021-44228) exploitation attempts"
        severity = "critical"
        category = "exploit"
        cve = "CVE-2021-44228"
    strings:
        // JNDI lookup patterns
        $jndi1 = "${jndi:ldap://" nocase
        $jndi2 = "${jndi:rmi://" nocase
        $jndi3 = "${jndi:dns://" nocase
        $jndi4 = "${jndi:ldaps://" nocase

        // Obfuscated variants
        $obf1 = "${${" nocase
        $obf2 = "${lower:" nocase
        $obf3 = "${upper:" nocase
        $obf4 = "${::-" nocase

        // Base64 encoded payloads
        $b64_marker = "/Basic/Command/Base64/" nocase

    condition:
        1 of ($jndi*) or
        2 of ($obf*) or
        $b64_marker
}

rule java_deserialization_exploit
{
    meta:
        description = "Detects Java deserialization exploitation"
        severity = "high"
        category = "exploit"
        technique = "deserialization"
    strings:
        // Java serialization magic
        $java_serial = { AC ED 00 05 }

        // Commons Collections gadget chains
        $cc1 = "org.apache.commons.collections.functors.InvokerTransformer"
        $cc2 = "org.apache.commons.collections.functors.ChainedTransformer"
        $cc3 = "org.apache.commons.collections.map.LazyMap"

        // ysoserial payloads
        $yso1 = "ysoserial" nocase
        $yso2 = "CommonsCollections" nocase
        $yso3 = "Groovy" nocase

        // Runtime.exec patterns
        $exec1 = "java.lang.Runtime"
        $exec2 = "getRuntime"
        $exec3 = "exec"

    condition:
        $java_serial and
        (1 of ($cc*) or 1 of ($yso*)) and
        all of ($exec*)
}
