/**
 * AI Vulnerability Hunter Component
 * 
 * Provides a multi-pass AI-powered vulnerability hunting interface:
 * - Pass 1: Reconnaissance (Ghidra decompilation + attack surface mapping)
 * - Pass 2: AI Triage (identify high-priority targets)
 * - Pass 3+: Deep Analysis (AI vulnerability analysis on targets)
 */

import React, { useState, useCallback, useRef, useEffect } from "react";
import {
  Box,
  Typography,
  Paper,
  Grid,
  Button,
  Alert,
  LinearProgress,
  Stepper,
  Step,
  StepLabel,
  StepContent,
  Chip,
  Accordion,
  AccordionSummary,
  AccordionDetails,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  Card,
  CardContent,
  Stack,
  IconButton,
  Tooltip,
  Divider,
  FormControl,
  FormControlLabel,
  FormGroup,
  Checkbox,
  InputLabel,
  Select,
  MenuItem,
  Slider,
  alpha,
  useTheme,
  Fab,
  Dialog,
  Tabs,
  Tab,
  DialogTitle,
  DialogContent,
  DialogActions,
  TextField,
  Drawer,
  List,
  ListItem,
  ListItemText,
  ListItemSecondaryAction,
  SpeedDial,
  SpeedDialAction,
  SpeedDialIcon,
  Badge,
  CircularProgress,
} from "@mui/material";
import {
  PlayArrow as PlayIcon,
  Stop as StopIcon,
  BugReport as BugIcon,
  BugReport as BugReportIcon,
  Security as SecurityIcon,
  Memory as BinaryIcon,
  Code as CodeIcon,
  Speed as SpeedIcon,
  ExpandMore as ExpandMoreIcon,
  Warning as WarningIcon,
  Error as CriticalIcon,
  Info as InfoIcon,
  CheckCircle as CheckIcon,
  Search as SearchIcon,
  Radar as RadarIcon,
  AutoAwesome as AiIcon,
  ContentCopy as CopyIcon,
  Timeline as TimelineIcon,
  Psychology as PsychologyIcon,
  Bolt as BoltIcon,
  Download as DownloadIcon,
  NetworkWifi as NetworkIcon,
  Folder as FolderIcon,
  Terminal as TerminalIcon,
  Lock as LockIcon,
  Storage as StorageIcon,
  Chat as ChatIcon,
  Note as NoteIcon,
  Send as SendIcon,
  Close as CloseIcon,
  Edit as EditIcon,
  Delete as DeleteIcon,
  Add as AddIcon,
  Save as SaveIcon,
  Transform as TransformIcon,
  TravelExplore as NLSearchIcon,
  AutoFixHigh as EnhanceIcon,
  Lightbulb as LightbulbIcon,
  PlayCircle as SimulateIcon,
  Dangerous as DangerIcon,
  Shield as ShieldIcon,
  Memory as MemoryIcon,
  ArrowForward as ArrowForwardIcon,
  ArrowBack as ArrowBackIcon,
  Visibility as VisibilityIcon,
  AccountTree as CFGIcon,
  RouteOutlined as PathIcon,
  Coronavirus as TaintIcon,
} from "@mui/icons-material";
import {
  reverseEngineeringClient,
  type VulnerabilityHuntProgress,
  type VulnerabilityHuntResult,
  type VulnerabilityFinding,
  type VulnerabilityHuntOptions,
  type BinaryPurposeAnalysis,
  type BinaryPurposeProgress,
  type PoCExploit,
  type ChatMessage,
  type AnalysisNote,
  type EnhanceCodeResponse,
  type NaturalLanguageSearchResponse,
  type SearchMatch,
  type AttackSimulationResponse,
  type AttackStep,
  type SymbolicTraceResponse,
  type SymbolicEnhancedCodeResponse,
  type ExecutionPath,
  type TaintedVariable,
  type DangerousSink,
  type BasicBlock,
  type PathConstraint,
} from "../api/client";

// ============================================================================
// Types and Constants
// ============================================================================

const VULN_CATEGORIES = [
  { id: "buffer_overflow", label: "Buffer Overflow", icon: <BinaryIcon />, description: "Memory corruption via buffer overflow" },
  { id: "format_string", label: "Format String", icon: <CodeIcon />, description: "Format string vulnerabilities" },
  { id: "integer_overflow", label: "Integer Overflow", icon: <SpeedIcon />, description: "Integer overflow in size calculations" },
  { id: "use_after_free", label: "Use-After-Free", icon: <BugIcon />, description: "Dangling pointer access" },
  { id: "command_injection", label: "Command Injection", icon: <SecurityIcon />, description: "OS command injection" },
  { id: "path_traversal", label: "Path Traversal", icon: <SearchIcon />, description: "Arbitrary file access" },
  { id: "race_condition", label: "Race Condition", icon: <TimelineIcon />, description: "TOCTOU vulnerabilities" },
  { id: "crypto_weakness", label: "Crypto Weakness", icon: <SecurityIcon />, description: "Weak cryptographic algorithms" },
];

const NL_SEARCH_EXAMPLES = [
  "Find functions that handle network authentication",
  "Show me code that reads from files",
  "Where is the encryption key derived?",
  "Functions vulnerable to buffer overflow",
  "Code that parses user input",
  "Memory allocation without bounds checking",
];
const SEVERITY_COLORS: Record<string, string> = {
  critical: "#dc2626",
  high: "#ea580c",
  medium: "#ca8a04",
  low: "#16a34a",
};

const SEVERITY_ICONS: Record<string, React.ReactNode> = {
  critical: <CriticalIcon color="error" />,
  high: <WarningIcon sx={{ color: "#ea580c" }} />,
  medium: <WarningIcon sx={{ color: "#ca8a04" }} />,
  low: <InfoIcon sx={{ color: "#16a34a" }} />,
};

// ============================================================================
// Sub-Components
// ============================================================================

interface FileDropZoneProps {
  onFileSelect: (file: File | null) => void;
  disabled?: boolean;
}

function FileDropZone({ onFileSelect, disabled }: FileDropZoneProps) {
  const theme = useTheme();
  const [dragOver, setDragOver] = useState(false);
  const inputRef = useRef<HTMLInputElement>(null);

  const handleDrop = useCallback((e: React.DragEvent) => {
    e.preventDefault();
    setDragOver(false);
    if (disabled) return;
    const file = e.dataTransfer.files[0];
    if (file) onFileSelect(file);
  }, [disabled, onFileSelect]);

  const handleDragOver = useCallback((e: React.DragEvent) => {
    e.preventDefault();
    if (!disabled) setDragOver(true);
  }, [disabled]);

  const handleDragLeave = useCallback(() => {
    setDragOver(false);
  }, []);

  const handleClick = useCallback(() => {
    if (!disabled) inputRef.current?.click();
  }, [disabled]);

  const handleChange = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) onFileSelect(file);
  }, [onFileSelect]);

  return (
    <Paper
      onClick={handleClick}
      onDrop={handleDrop}
      onDragOver={handleDragOver}
      onDragLeave={handleDragLeave}
      sx={{
        p: 4,
        textAlign: "center",
        cursor: disabled ? "not-allowed" : "pointer",
        border: `2px dashed ${dragOver ? theme.palette.primary.main : alpha(theme.palette.primary.main, 0.3)}`,
        bgcolor: dragOver ? alpha(theme.palette.primary.main, 0.1) : "transparent",
        transition: "all 0.2s ease",
        opacity: disabled ? 0.5 : 1,
        "&:hover": disabled ? {} : {
          borderColor: theme.palette.primary.main,
          bgcolor: alpha(theme.palette.primary.main, 0.05),
        },
      }}
    >
      <input
        ref={inputRef}
        type="file"
        accept=".exe,.dll,.so,.elf,.bin,.o,.dylib,.mach"
        onChange={handleChange}
        style={{ display: "none" }}
        disabled={disabled}
      />
      <RadarIcon sx={{ fontSize: 48, color: "primary.main", mb: 2 }} />
      <Typography variant="h6" gutterBottom>
        Upload Binary for Vulnerability Hunt
      </Typography>
      <Typography variant="body2" color="text.secondary">
        EXE, DLL, ELF, SO, or other binary files up to 500MB
      </Typography>
    </Paper>
  );
}

interface VulnerabilityCardProps {
  finding: VulnerabilityFinding;
  onGeneratePoc?: (finding: VulnerabilityFinding) => void;
  isGeneratingPoc?: boolean;
  onSimulateAttack?: (finding: VulnerabilityFinding) => void;
  onSymbolicTrace?: (code: string, functionName: string) => void;
}

function VulnerabilityCard({ finding, onGeneratePoc, isGeneratingPoc, onSimulateAttack, onSymbolicTrace }: VulnerabilityCardProps) {
  const theme = useTheme();
  const [expanded, setExpanded] = useState(false);
  const [copied, setCopied] = useState(false);

  const handleCopy = (text: string) => {
    navigator.clipboard.writeText(text);
    setCopied(true);
    setTimeout(() => setCopied(false), 2000);
  };

  return (
    <Accordion
      expanded={expanded}
      onChange={() => setExpanded(!expanded)}
      sx={{
        borderLeft: `4px solid ${SEVERITY_COLORS[finding.severity]}`,
        mb: 2,
      }}
    >
      <AccordionSummary expandIcon={<ExpandMoreIcon />}>
        <Box sx={{ display: "flex", alignItems: "center", gap: 2, width: "100%" }}>
          {SEVERITY_ICONS[finding.severity]}
          <Box sx={{ flex: 1 }}>
            <Typography variant="subtitle1" fontWeight="bold">
              {finding.title}
            </Typography>
            <Typography variant="body2" color="text.secondary">
              {finding.function_name} @ {finding.entry_address}
            </Typography>
          </Box>
          <Chip
            label={finding.severity.toUpperCase()}
            size="small"
            sx={{
              bgcolor: alpha(SEVERITY_COLORS[finding.severity], 0.2),
              color: SEVERITY_COLORS[finding.severity],
              fontWeight: "bold",
            }}
          />
          {finding.cwe_id && (
            <Chip label={finding.cwe_id} size="small" variant="outlined" />
          )}
          <Chip
            label={`CVSS: ${finding.cvss_estimate.toFixed(1)}`}
            size="small"
            color="default"
          />
          <Chip
            label={`${Math.round(finding.confidence * 100)}% confidence`}
            size="small"
            color={finding.confidence > 0.8 ? "success" : finding.confidence > 0.5 ? "warning" : "default"}
          />
        </Box>
      </AccordionSummary>
      <AccordionDetails>
        <Grid container spacing={3}>
          <Grid item xs={12}>
            <Typography variant="subtitle2" color="primary" gutterBottom>
              Description
            </Typography>
            <Typography variant="body2">{finding.description}</Typography>
          </Grid>

          <Grid item xs={12}>
            <Typography variant="subtitle2" color="primary" gutterBottom>
              Technical Details
            </Typography>
            <Typography variant="body2" sx={{ whiteSpace: "pre-wrap" }}>
              {finding.technical_details}
            </Typography>
          </Grid>

          <Grid item xs={12} md={6}>
            <Typography variant="subtitle2" color="primary" gutterBottom>
              Proof of Concept
            </Typography>
            <Paper
              sx={{
                p: 2,
                bgcolor: alpha(theme.palette.background.paper, 0.5),
                fontFamily: "monospace",
                fontSize: "0.8rem",
                position: "relative",
              }}
            >
              <IconButton
                size="small"
                onClick={() => handleCopy(finding.proof_of_concept)}
                sx={{ position: "absolute", top: 8, right: 8 }}
              >
                <CopyIcon fontSize="small" />
              </IconButton>
              <pre style={{ margin: 0, whiteSpace: "pre-wrap" }}>
                {finding.proof_of_concept}
              </pre>
            </Paper>
          </Grid>

          <Grid item xs={12} md={6}>
            <Typography variant="subtitle2" color="primary" gutterBottom>
              Exploitation Steps
            </Typography>
            <Box component="ol" sx={{ pl: 2, m: 0 }}>
              {finding.exploitation_steps.map((step, idx) => (
                <Typography component="li" variant="body2" key={idx} sx={{ mb: 1 }}>
                  {step}
                </Typography>
              ))}
            </Box>
          </Grid>

          <Grid item xs={12}>
            <Alert severity="info" icon={<SecurityIcon />}>
              <Typography variant="subtitle2">Remediation</Typography>
              <Typography variant="body2">{finding.remediation}</Typography>
            </Alert>
          </Grid>

          <Grid item xs={12}>
            <Typography variant="subtitle2" color="text.secondary" gutterBottom>
              AI Reasoning
            </Typography>
            <Typography variant="body2" color="text.secondary" sx={{ fontStyle: "italic" }}>
              {finding.ai_reasoning}
            </Typography>
          </Grid>

          {/* Action Buttons */}
          {(onGeneratePoc || onSimulateAttack || onSymbolicTrace) && (
            <Grid item xs={12}>
              <Divider sx={{ my: 2 }} />
              <Stack direction="row" spacing={2} flexWrap="wrap">
                {onSymbolicTrace && finding.code_snippet && (
                  <Button
                    variant="contained"
                    color="secondary"
                    startIcon={<CFGIcon />}
                    onClick={() => onSymbolicTrace(finding.code_snippet!, finding.function_name)}
                    sx={{
                      background: "linear-gradient(135deg, #9333ea 0%, #6366f1 100%)",
                    }}
                  >
                    Symbolic Trace
                  </Button>
                )}
                {onSimulateAttack && (
                  <Button
                    variant="contained"
                    color="warning"
                    startIcon={<SimulateIcon />}
                    onClick={() => onSimulateAttack(finding)}
                    sx={{
                      background: "linear-gradient(135deg, #f59e0b 0%, #dc2626 100%)",
                    }}
                  >
                    Simulate Attack
                  </Button>
                )}
                {onGeneratePoc && (
                  <Button
                    variant="contained"
                    color="error"
                    startIcon={isGeneratingPoc ? <AiIcon /> : <BoltIcon />}
                    onClick={() => onGeneratePoc(finding)}
                    disabled={isGeneratingPoc}
                    sx={{
                      background: isGeneratingPoc 
                        ? undefined 
                        : "linear-gradient(135deg, #dc2626 0%, #7c3aed 100%)",
                    }}
                  >
                    {isGeneratingPoc ? "Generating Exploit..." : "Generate Full PoC Exploit"}
                  </Button>
                )}
              </Stack>
            </Grid>
          )}

          {finding.code_snippet && (
            <Grid item xs={12}>
              <Typography variant="subtitle2" color="primary" gutterBottom>
                Vulnerable Code
              </Typography>
              <Paper
                sx={{
                  p: 2,
                  bgcolor: "#1a1a2e",
                  fontFamily: "monospace",
                  fontSize: "0.75rem",
                  maxHeight: 300,
                  overflow: "auto",
                }}
              >
                <pre style={{ margin: 0, color: "#e0e0e0", whiteSpace: "pre-wrap" }}>
                  {finding.code_snippet}
                </pre>
              </Paper>
            </Grid>
          )}
        </Grid>
      </AccordionDetails>
    </Accordion>
  );
}

// ============================================================================
// Main Component
// ============================================================================

interface VulnerabilityHunterProps {
  onComplete?: (result: VulnerabilityHuntResult) => void;
}

export function VulnerabilityHunter({ onComplete }: VulnerabilityHunterProps) {
  const theme = useTheme();
  
  // State
  const [file, setFile] = useState<File | null>(null);
  const [isHunting, setIsHunting] = useState(false);
  const [progress, setProgress] = useState<VulnerabilityHuntProgress | null>(null);
  const [result, setResult] = useState<VulnerabilityHuntResult | null>(null);
  const [error, setError] = useState<string | null>(null);
  
  // Binary Purpose Analysis state
  const [isAnalyzingPurpose, setIsAnalyzingPurpose] = useState(false);
  const [purposeProgress, setPurposeProgress] = useState<BinaryPurposeProgress | null>(null);
  const [purposeAnalysis, setPurposeAnalysis] = useState<BinaryPurposeAnalysis | null>(null);
  
  // PoC Generation state
  const [isGeneratingPoc, setIsGeneratingPoc] = useState(false);
  const [generatingPocForId, setGeneratingPocForId] = useState<string | null>(null);
  const [generatedPocs, setGeneratedPocs] = useState<Map<string, PoCExploit>>(new Map());
  const [pocError, setPocError] = useState<string | null>(null);
  
  // AI Chat state
  const [chatOpen, setChatOpen] = useState(false);
  const [chatMessages, setChatMessages] = useState<ChatMessage[]>([]);
  const [chatInput, setChatInput] = useState("");
  const [isChatLoading, setIsChatLoading] = useState(false);
  const chatEndRef = useRef<HTMLDivElement>(null);
  
  // Notes state
  const [notesOpen, setNotesOpen] = useState(false);
  const [notes, setNotes] = useState<AnalysisNote[]>([]);
  const [newNoteContent, setNewNoteContent] = useState("");
  const [newNoteCategory, setNewNoteCategory] = useState<"general" | "vulnerability" | "poc" | "remediation">("general");
  const [editingNote, setEditingNote] = useState<string | null>(null);
  const [editNoteContent, setEditNoteContent] = useState("");
  const [sessionId] = useState(() => `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`);
  
  // SpeedDial state
  const [speedDialOpen, setSpeedDialOpen] = useState(false);
  
  // AI Code Enhancement state
  const [enhanceDialogOpen, setEnhanceDialogOpen] = useState(false);
  const [codeToEnhance, setCodeToEnhance] = useState("");
  const [enhanceFunctionName, setEnhanceFunctionName] = useState("");
  const [enhanceLevel, setEnhanceLevel] = useState<"basic" | "standard" | "full">("full");
  const [isEnhancing, setIsEnhancing] = useState(false);
  const [enhanceResult, setEnhanceResult] = useState<EnhanceCodeResponse | null>(null);
  const [enhanceError, setEnhanceError] = useState<string | null>(null);
  
  // Natural Language Search state
  const [nlSearchDialogOpen, setNlSearchDialogOpen] = useState(false);
  const [nlSearchQuery, setNlSearchQuery] = useState("");
  const [nlSearchScope, setNlSearchScope] = useState<"all" | "security" | "network" | "crypto" | "file_io">("all");
  const [isSearching, setIsSearching] = useState(false);
  const [searchResult, setSearchResult] = useState<NaturalLanguageSearchResponse | null>(null);
  const [searchError, setSearchError] = useState<string | null>(null);
  const [selectedSearchMatch, setSelectedSearchMatch] = useState<SearchMatch | null>(null);
  
  // Attack Simulation state
  const [attackSimDialogOpen, setAttackSimDialogOpen] = useState(false);
  const [selectedVulnForSim, setSelectedVulnForSim] = useState<VulnerabilityFinding | null>(null);
  const [simDepth, setSimDepth] = useState<"quick" | "standard" | "comprehensive">("standard");
  const [isSimulating, setIsSimulating] = useState(false);
  const [simResult, setSimResult] = useState<AttackSimulationResponse | null>(null);
  const [simError, setSimError] = useState<string | null>(null);
  const [currentSimStep, setCurrentSimStep] = useState(0);
  const [simAutoPlay, setSimAutoPlay] = useState(false);
  const simAutoPlayRef = useRef<NodeJS.Timeout | null>(null);
  
  // Symbolic Execution state
  const [symbolicDialogOpen, setSymbolicDialogOpen] = useState(false);
  const [selectedCodeForSymbolic, setSelectedCodeForSymbolic] = useState<string>("");
  const [selectedFunctionForSymbolic, setSelectedFunctionForSymbolic] = useState<string>("");
  const [isRunningSymbolic, setIsRunningSymbolic] = useState(false);
  const [symbolicResult, setSymbolicResult] = useState<SymbolicTraceResponse | null>(null);
  const [symbolicError, setSymbolicError] = useState<string | null>(null);
  const [selectedPath, setSelectedPath] = useState<ExecutionPath | null>(null);
  const [selectedBlock, setSelectedBlock] = useState<BasicBlock | null>(null);
  const [symbolicViewTab, setSymbolicViewTab] = useState<number>(0);
  const [enhancedCodeResult, setEnhancedCodeResult] = useState<SymbolicEnhancedCodeResponse | null>(null);
  const [isEnhancingCode, setIsEnhancingCode] = useState(false);
  
  // Options
  const [selectedCategories, setSelectedCategories] = useState<string[]>([]);
  const [maxPasses, setMaxPasses] = useState(3);
  const [maxTargets, setMaxTargets] = useState(20);
  const [showOptions, setShowOptions] = useState(false);
  
  // Ref for abort
  const abortRef = useRef<{ abort: () => void } | null>(null);
  const purposeAbortRef = useRef<{ abort: () => void } | null>(null);
  
  const startHunt = useCallback(() => {
    if (!file) return;
    
    setIsHunting(true);
    setError(null);
    setResult(null);
    setProgress(null);
    
    const options: VulnerabilityHuntOptions = {
      maxPasses,
      maxTargetsPerPass: maxTargets,
      focusCategories: selectedCategories.length > 0 ? selectedCategories : undefined,
    };
    
    const controller = reverseEngineeringClient.runVulnerabilityHunt(
      file,
      options,
      (prog) => setProgress(prog),
      (res) => {
        setResult(res);
        setIsHunting(false);
        onComplete?.(res);
      },
      (err) => {
        setError(err);
        setIsHunting(false);
      },
      () => setIsHunting(false)
    );
    
    abortRef.current = controller;
  }, [file, maxPasses, maxTargets, selectedCategories, onComplete]);
  
  const cancelHunt = useCallback(() => {
    abortRef.current?.abort();
    setIsHunting(false);
    setProgress(null);
  }, []);
  
  const resetHunt = useCallback(() => {
    setFile(null);
    setResult(null);
    setProgress(null);
    setError(null);
    setPurposeAnalysis(null);
    setPurposeProgress(null);
    setGeneratedPocs(new Map());
    setPocError(null);
  }, []);
  
  // Binary purpose analysis
  const startPurposeAnalysis = useCallback(() => {
    if (!file) return;
    
    setIsAnalyzingPurpose(true);
    setPurposeProgress(null);
    setPurposeAnalysis(null);
    setError(null);
    
    const controller = reverseEngineeringClient.analyzeBinaryPurpose(
      file,
      true, // useGhidra
      (prog) => setPurposeProgress(prog),
      (res) => {
        setPurposeAnalysis(res);
        setIsAnalyzingPurpose(false);
      },
      (err) => {
        setError(err);
        setIsAnalyzingPurpose(false);
      },
      () => setIsAnalyzingPurpose(false)
    );
    
    purposeAbortRef.current = controller;
  }, [file]);
  
  // PoC generation
  const generatePoc = useCallback(async (finding: VulnerabilityFinding) => {
    setIsGeneratingPoc(true);
    setGeneratingPocForId(finding.id);
    setPocError(null);
    
    try {
      const poc = await reverseEngineeringClient.generatePoCExploit(finding, {
        target_platform: "linux",
        exploit_style: "python",
      });
      
      setGeneratedPocs((prev) => {
        const newMap = new Map(prev);
        newMap.set(finding.id, poc);
        return newMap;
      });
    } catch (err) {
      setPocError((err as Error).message || "Failed to generate PoC");
    } finally {
      setIsGeneratingPoc(false);
      setGeneratingPocForId(null);
    }
  }, []);
  
  // Auto-scroll chat to bottom
  useEffect(() => {
    chatEndRef.current?.scrollIntoView({ behavior: "smooth" });
  }, [chatMessages]);
  
  // AI Chat functions
  const sendChatMessage = useCallback(async () => {
    if (!chatInput.trim() || isChatLoading) return;
    
    const userMessage: ChatMessage = { role: "user", content: chatInput };
    setChatMessages((prev) => [...prev, userMessage]);
    setChatInput("");
    setIsChatLoading(true);
    
    try {
      const response = await reverseEngineeringClient.chatAboutAnalysis({
        message: userMessage.content,
        conversation_history: chatMessages,
        analysis_context: {
          binary_info: file ? { filename: file.name, size: file.size } : undefined,
          purpose_analysis: purposeAnalysis,
          vulnerabilities: result?.vulnerabilities || [],
          poc_exploits: Array.from(generatedPocs.values()),
          attack_surface: result?.attack_surface_summary,
          hunt_result: result ? {
            risk_score: result.risk_score,
            total_functions_analyzed: result.total_functions_analyzed,
            executive_summary: result.executive_summary,
            recommended_focus_areas: result.recommended_focus_areas,
          } : undefined,
        },
      });
      
      if (response.error) {
        setChatMessages((prev) => [...prev, { role: "assistant", content: `Error: ${response.error}` }]);
      } else {
        setChatMessages((prev) => [...prev, { role: "assistant", content: response.response }]);
      }
    } catch (err) {
      setChatMessages((prev) => [...prev, { role: "assistant", content: `Failed to get response: ${(err as Error).message}` }]);
    } finally {
      setIsChatLoading(false);
    }
  }, [chatInput, chatMessages, isChatLoading, file, purposeAnalysis, result, generatedPocs]);
  
  // Notes functions
  const addNote = useCallback(async () => {
    if (!newNoteContent.trim() || !file) return;
    
    try {
      const note = await reverseEngineeringClient.createNote(
        sessionId,
        file.name,
        newNoteContent,
        newNoteCategory
      );
      setNotes((prev) => [...prev, note]);
      setNewNoteContent("");
    } catch (err) {
      console.error("Failed to create note:", err);
    }
  }, [newNoteContent, newNoteCategory, sessionId, file]);
  
  const saveEditedNote = useCallback(async () => {
    if (!editingNote || !editNoteContent.trim()) return;
    
    try {
      const updated = await reverseEngineeringClient.updateNote(sessionId, editingNote, editNoteContent);
      setNotes((prev) => prev.map((n) => n.id === editingNote ? updated : n));
      setEditingNote(null);
      setEditNoteContent("");
    } catch (err) {
      console.error("Failed to update note:", err);
    }
  }, [editingNote, editNoteContent, sessionId]);
  
  const deleteNote = useCallback(async (noteId: string) => {
    try {
      await reverseEngineeringClient.deleteNote(sessionId, noteId);
      setNotes((prev) => prev.filter((n) => n.id !== noteId));
    } catch (err) {
      console.error("Failed to delete note:", err);
    }
  }, [sessionId]);
  
  const exportNotesToFile = useCallback(async (format: "markdown" | "json" | "txt") => {
    if (notes.length === 0) return;
    
    try {
      const result = await reverseEngineeringClient.exportNotes(sessionId, format);
      const blob = new Blob([typeof result.content === "string" ? result.content : JSON.stringify(result.content, null, 2)], { 
        type: format === "json" ? "application/json" : "text/plain" 
      });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = result.filename;
      a.click();
      URL.revokeObjectURL(url);
    } catch (err) {
      console.error("Failed to export notes:", err);
    }
  }, [sessionId, notes]);
  
  // AI Code Enhancement functions
  const enhanceCode = useCallback(async () => {
    if (!codeToEnhance.trim()) return;
    
    setIsEnhancing(true);
    setEnhanceError(null);
    setEnhanceResult(null);
    
    try {
      // Get binary context from analysis if available
      // Use dangerous_function_counts from attack_surface_summary
      const dangerousFuncs = result?.attack_surface_summary?.dangerous_function_counts 
        ? Object.keys(result.attack_surface_summary.dangerous_function_counts)
        : [];
      const binaryContext = result ? {
        imports: dangerousFuncs,
        strings: result.attack_surface_summary?.categories_detected || [],
        architecture: undefined,
      } : undefined;
      
      const response = await reverseEngineeringClient.enhanceCode(
        codeToEnhance,
        enhanceFunctionName || "unknown",
        binaryContext,
        enhanceLevel,
        true // include security analysis
      );
      setEnhanceResult(response);
    } catch (err) {
      setEnhanceError((err as Error).message || "Enhancement failed");
    } finally {
      setIsEnhancing(false);
    }
  }, [codeToEnhance, enhanceFunctionName, enhanceLevel, result]);
  
  // Natural Language Search functions
  const performNlSearch = useCallback(async () => {
    if (!nlSearchQuery.trim()) return;
    
    setIsSearching(true);
    setSearchError(null);
    setSearchResult(null);
    setSelectedSearchMatch(null);
    
    try {
      // Get functions from the analysis result
      const functions = result?.vulnerabilities?.map((v: VulnerabilityFinding) => ({
        name: v.function_name || v.title,
        code: v.proof_of_concept || v.technical_details || "",
        address: v.entry_address || "unknown",
      })) || [];
      
      // Also add dangerous functions from attack surface summary
      const dangerousFuncs = result?.attack_surface_summary?.dangerous_function_counts 
        ? Object.entries(result.attack_surface_summary.dangerous_function_counts).map(([name, count]) => ({
          name: name,
          code: `// Called ${count} times`,
          address: "unknown",
        }))
        : [];
      
      const allFunctions = [...functions, ...dangerousFuncs];
      
      if (allFunctions.length === 0) {
        setSearchError("No functions available to search. Run vulnerability analysis first.");
        setIsSearching(false);
        return;
      }
      
      const response = await reverseEngineeringClient.naturalLanguageSearch(
        nlSearchQuery,
        allFunctions,
        10,
        true,
        nlSearchScope
      );
      setSearchResult(response);
    } catch (err) {
      setSearchError((err as Error).message || "Search failed");
    } finally {
      setIsSearching(false);
    }
  }, [nlSearchQuery, nlSearchScope, result]);
  
  // Attack Simulation handler
  const runAttackSimulation = useCallback(async () => {
    if (!selectedVulnForSim) return;
    
    setIsSimulating(true);
    setSimError(null);
    setSimResult(null);
    setCurrentSimStep(0);
    setSimAutoPlay(false);
    
    try {
      // Build vulnerability object for the API
      const vulnData: Record<string, unknown> = {
        title: selectedVulnForSim.title,
        vulnerability_type: selectedVulnForSim.category, // Use category as vulnerability_type
        severity: selectedVulnForSim.severity,
        technical_details: selectedVulnForSim.technical_details,
        description: selectedVulnForSim.description,
        proof_of_concept: selectedVulnForSim.proof_of_concept,
        function_name: selectedVulnForSim.function_name,
        entry_address: selectedVulnForSim.entry_address,
        cwe_id: selectedVulnForSim.cwe_id,
      };
      
      // Get binary context from attack surface summary
      const binaryContext = result?.attack_surface_summary ? {
        imports: result.attack_surface_summary.dangerous_function_counts 
          ? Object.keys(result.attack_surface_summary.dangerous_function_counts)
          : [],
        architecture: undefined,
      } : undefined;
      
      const response = await reverseEngineeringClient.simulateAttack(
        vulnData,
        selectedVulnForSim.proof_of_concept || selectedVulnForSim.technical_details,
        binaryContext,
        simDepth
      );
      setSimResult(response);
    } catch (err) {
      setSimError((err as Error).message || "Simulation failed");
    } finally {
      setIsSimulating(false);
    }
  }, [selectedVulnForSim, simDepth, result]);
  
  // Auto-play simulation steps
  useEffect(() => {
    if (simAutoPlay && simResult && currentSimStep < simResult.steps.length - 1) {
      simAutoPlayRef.current = setTimeout(() => {
        setCurrentSimStep(prev => prev + 1);
      }, 2500);
    }
    return () => {
      if (simAutoPlayRef.current) {
        clearTimeout(simAutoPlayRef.current);
      }
    };
  }, [simAutoPlay, simResult, currentSimStep]);
  
  // Open attack simulation for a vulnerability
  const openAttackSimulation = useCallback((vuln: VulnerabilityFinding) => {
    setSelectedVulnForSim(vuln);
    setSimResult(null);
    setSimError(null);
    setCurrentSimStep(0);
    setSimAutoPlay(false);
    setAttackSimDialogOpen(true);
  }, []);
  
  // Symbolic Execution handlers
  const runSymbolicTrace = useCallback(async () => {
    if (!selectedCodeForSymbolic) return;
    
    setIsRunningSymbolic(true);
    setSymbolicError(null);
    setSymbolicResult(null);
    setSelectedPath(null);
    setSelectedBlock(null);
    setEnhancedCodeResult(null);
    
    try {
      const binaryContext = result?.attack_surface_summary ? {
        imports: result.attack_surface_summary.dangerous_function_counts 
          ? Object.keys(result.attack_surface_summary.dangerous_function_counts)
          : [],
      } : undefined;
      
      const response = await reverseEngineeringClient.symbolicTrace(
        selectedCodeForSymbolic,
        selectedFunctionForSymbolic,
        undefined,
        {
          binaryContext,
          maxPaths: 20,
          maxDepth: 50,
        }
      );
      setSymbolicResult(response);
    } catch (err) {
      setSymbolicError((err as Error).message || "Symbolic trace failed");
    } finally {
      setIsRunningSymbolic(false);
    }
  }, [selectedCodeForSymbolic, selectedFunctionForSymbolic, result]);
  
  const runEnhancedCode = useCallback(async () => {
    if (!selectedCodeForSymbolic || !symbolicResult) return;
    
    setIsEnhancingCode(true);
    
    try {
      const response = await reverseEngineeringClient.enhanceCodeWithSymbolic(
        selectedCodeForSymbolic,
        selectedFunctionForSymbolic,
        symbolicResult,
        { enhancementLevel: "full" }
      );
      setEnhancedCodeResult(response);
      setSymbolicViewTab(3); // Switch to enhanced tab
    } catch (err) {
      setSymbolicError((err as Error).message || "Code enhancement failed");
    } finally {
      setIsEnhancingCode(false);
    }
  }, [selectedCodeForSymbolic, selectedFunctionForSymbolic, symbolicResult]);
  
  const openSymbolicDialog = useCallback((code: string, functionName: string) => {
    setSelectedCodeForSymbolic(code);
    setSelectedFunctionForSymbolic(functionName);
    setSymbolicResult(null);
    setSymbolicError(null);
    setSelectedPath(null);
    setSelectedBlock(null);
    setEnhancedCodeResult(null);
    setSymbolicViewTab(0);
    setSymbolicDialogOpen(true);
  }, []);
  
  // Helper to copy text to clipboard
  const copyToClipboard = useCallback((text: string) => {
    navigator.clipboard.writeText(text);
  }, []);
  
  // Get active step
  const getActiveStep = () => {
    if (!progress) return -1;
    return progress.phases.findIndex((p) => p.status === "in_progress");
  };
  
  return (
    <Box>
      {/* Header */}
      <Box sx={{ mb: 4, textAlign: "center" }}>
        <Box sx={{ display: "flex", alignItems: "center", justifyContent: "center", gap: 2, mb: 2 }}>
          <RadarIcon sx={{ fontSize: 40, color: "primary.main" }} />
          <Typography variant="h4" fontWeight="bold">
            AI Vulnerability Hunter
          </Typography>
        </Box>
        <Typography variant="body1" color="text.secondary" maxWidth={800} mx="auto">
          Autonomous multi-pass vulnerability detection using AI-guided analysis.
          Discovers buffer overflows, format strings, use-after-free, and more.
        </Typography>
      </Box>

      {/* File Selection & Options */}
      {!isHunting && !result && (
        <Grid container spacing={3}>
          <Grid item xs={12} md={5}>
            <FileDropZone onFileSelect={setFile} disabled={isHunting} />
          </Grid>
          
          <Grid item xs={12} md={7}>
            {file ? (
              <Paper sx={{ p: 3 }}>
                <Alert severity="info" sx={{ mb: 3 }}>
                  <strong>{file.name}</strong> ({(file.size / (1024 * 1024)).toFixed(1)} MB)
                </Alert>
                
                {/* Options Toggle */}
                <Button
                  variant="text"
                  size="small"
                  onClick={() => setShowOptions(!showOptions)}
                  sx={{ mb: 2 }}
                >
                  {showOptions ? "Hide Options" : "Show Advanced Options"}
                </Button>
                
                {showOptions && (
                  <Box sx={{ mb: 3 }}>
                    <Typography variant="subtitle2" gutterBottom>
                      Focus Categories (leave empty for all)
                    </Typography>
                    <FormGroup row sx={{ mb: 2 }}>
                      {VULN_CATEGORIES.map((cat) => (
                        <FormControlLabel
                          key={cat.id}
                          control={
                            <Checkbox
                              size="small"
                              checked={selectedCategories.includes(cat.id)}
                              onChange={(e) => {
                                if (e.target.checked) {
                                  setSelectedCategories([...selectedCategories, cat.id]);
                                } else {
                                  setSelectedCategories(selectedCategories.filter((c) => c !== cat.id));
                                }
                              }}
                            />
                          }
                          label={cat.label}
                        />
                      ))}
                    </FormGroup>
                    
                    <Grid container spacing={2}>
                      <Grid item xs={6}>
                        <Typography variant="body2" gutterBottom>
                          Analysis Passes: {maxPasses}
                        </Typography>
                        <Slider
                          value={maxPasses}
                          onChange={(_, v) => setMaxPasses(v as number)}
                          min={1}
                          max={5}
                          marks
                          size="small"
                        />
                      </Grid>
                      <Grid item xs={6}>
                        <Typography variant="body2" gutterBottom>
                          Max Targets/Pass: {maxTargets}
                        </Typography>
                        <Slider
                          value={maxTargets}
                          onChange={(_, v) => setMaxTargets(v as number)}
                          min={5}
                          max={50}
                          step={5}
                          marks
                          size="small"
                        />
                      </Grid>
                    </Grid>
                  </Box>
                )}
                
                <Typography variant="body2" color="text.secondary" sx={{ mb: 2 }}>
                  The hunt will analyze decompiled functions and identify potential vulnerabilities using AI.
                </Typography>
                
                <Alert severity="warning" sx={{ mb: 3 }}>
                  ⏱️ This comprehensive hunt may take <strong>5-15 minutes</strong> depending on binary size.
                </Alert>
                
                {/* Quick Analysis Button */}
                <Button
                  variant="outlined"
                  size="large"
                  fullWidth
                  onClick={startPurposeAnalysis}
                  disabled={isAnalyzingPurpose}
                  startIcon={isAnalyzingPurpose ? <AiIcon /> : <PsychologyIcon />}
                  sx={{ mb: 2 }}
                >
                  {isAnalyzingPurpose ? "Analyzing..." : "What Does This Binary Do?"}
                </Button>
                
                <Button
                  variant="contained"
                  size="large"
                  fullWidth
                  onClick={startHunt}
                  startIcon={<PlayIcon />}
                  sx={{
                    py: 1.5,
                    background: `linear-gradient(135deg, #dc2626 0%, #7c3aed 100%)`,
                  }}
                >
                  Start Vulnerability Hunt
                </Button>
                
                <Button variant="text" size="small" fullWidth onClick={resetHunt} sx={{ mt: 1 }}>
                  Choose Different File
                </Button>
              </Paper>
            ) : (
              <Box
                sx={{
                  height: "100%",
                  display: "flex",
                  flexDirection: "column",
                  alignItems: "center",
                  justifyContent: "center",
                  p: 4,
                  bgcolor: alpha(theme.palette.background.paper, 0.5),
                  borderRadius: 2,
                }}
              >
                <BugIcon sx={{ fontSize: 64, opacity: 0.3, mb: 2 }} />
                <Typography variant="h6" color="text.secondary">
                  Upload a binary to begin vulnerability hunting
                </Typography>
              </Box>
            )}
          </Grid>
        </Grid>
      )}

      {/* Binary Purpose Analysis Progress */}
      {isAnalyzingPurpose && purposeProgress && (
        <Paper sx={{ p: 3, mb: 3 }}>
          <Box sx={{ display: "flex", alignItems: "center", gap: 2, mb: 2 }}>
            <PsychologyIcon color="primary" />
            <Typography variant="h6">Analyzing Binary Purpose...</Typography>
          </Box>
          <LinearProgress
            variant="determinate"
            value={purposeProgress.progress}
            sx={{ height: 8, borderRadius: 4, mb: 2 }}
          />
          <Typography variant="body2" color="text.secondary">
            {purposeProgress.message}
          </Typography>
        </Paper>
      )}

      {/* Binary Purpose Analysis Results */}
      {purposeAnalysis && !result && (
        <Paper sx={{ p: 3, mb: 3 }}>
          <Box sx={{ display: "flex", alignItems: "center", gap: 2, mb: 3 }}>
            <PsychologyIcon sx={{ fontSize: 32, color: "primary.main" }} />
            <Box>
              <Typography variant="h5" fontWeight="bold">
                What Does This Binary Do?
              </Typography>
              <Chip 
                label={purposeAnalysis.category.toUpperCase()} 
                size="small" 
                color="primary" 
                sx={{ mt: 0.5 }}
              />
              <Chip 
                label={`${Math.round(purposeAnalysis.confidence * 100)}% confidence`} 
                size="small" 
                sx={{ ml: 1, mt: 0.5 }}
              />
            </Box>
          </Box>

          {/* Purpose Summary */}
          <Alert severity="info" sx={{ mb: 3 }}>
            <Typography variant="subtitle1" fontWeight="bold">
              {purposeAnalysis.purpose_summary}
            </Typography>
          </Alert>

          {/* Detailed Description */}
          <Typography variant="body1" sx={{ mb: 3, whiteSpace: "pre-wrap" }}>
            {purposeAnalysis.detailed_description}
          </Typography>

          <Divider sx={{ my: 3 }} />

          {/* Functionality & Capabilities Grid */}
          <Grid container spacing={3}>
            {/* Functionality List */}
            <Grid item xs={12} md={6}>
              <Typography variant="subtitle2" color="primary" gutterBottom sx={{ display: "flex", alignItems: "center", gap: 1 }}>
                <CheckIcon fontSize="small" /> Key Functionality
              </Typography>
              <Box component="ul" sx={{ pl: 2, m: 0 }}>
                {purposeAnalysis.functionality.map((func, idx) => (
                  <Typography component="li" variant="body2" key={idx} sx={{ mb: 0.5 }}>
                    {func}
                  </Typography>
                ))}
              </Box>
            </Grid>

            {/* UI Type */}
            <Grid item xs={12} md={6}>
              <Typography variant="subtitle2" color="primary" gutterBottom>
                Application Type
              </Typography>
              <Chip 
                icon={<TerminalIcon />}
                label={purposeAnalysis.ui_type.toUpperCase()}
                color="default"
              />
            </Grid>

            {/* Network Activity */}
            {purposeAnalysis.network_activity?.has_network && (
              <Grid item xs={12} md={6}>
                <Typography variant="subtitle2" color="primary" gutterBottom sx={{ display: "flex", alignItems: "center", gap: 1 }}>
                  <NetworkIcon fontSize="small" /> Network Activity
                </Typography>
                <Stack spacing={1}>
                  {purposeAnalysis.network_activity.protocols?.map((proto, idx) => (
                    <Chip key={idx} label={proto} size="small" variant="outlined" />
                  ))}
                  {purposeAnalysis.network_activity.purposes?.map((purpose, idx) => (
                    <Typography variant="body2" key={idx}>{purpose}</Typography>
                  ))}
                </Stack>
              </Grid>
            )}

            {/* File Operations */}
            {(purposeAnalysis.file_operations?.creates_files || 
              purposeAnalysis.file_operations?.modifies_files || 
              purposeAnalysis.file_operations?.deletes_files) && (
              <Grid item xs={12} md={6}>
                <Typography variant="subtitle2" color="primary" gutterBottom sx={{ display: "flex", alignItems: "center", gap: 1 }}>
                  <FolderIcon fontSize="small" /> File Operations
                </Typography>
                <Stack direction="row" spacing={1} flexWrap="wrap" useFlexGap>
                  {purposeAnalysis.file_operations.creates_files && (
                    <Chip label="Creates Files" size="small" color="success" variant="outlined" />
                  )}
                  {purposeAnalysis.file_operations.modifies_files && (
                    <Chip label="Modifies Files" size="small" color="warning" variant="outlined" />
                  )}
                  {purposeAnalysis.file_operations.deletes_files && (
                    <Chip label="Deletes Files" size="small" color="error" variant="outlined" />
                  )}
                </Stack>
              </Grid>
            )}

            {/* Crypto Usage */}
            {purposeAnalysis.crypto_usage?.uses_crypto && (
              <Grid item xs={12} md={6}>
                <Typography variant="subtitle2" color="primary" gutterBottom sx={{ display: "flex", alignItems: "center", gap: 1 }}>
                  <LockIcon fontSize="small" /> Cryptographic Operations
                </Typography>
                <Stack direction="row" spacing={1} flexWrap="wrap" useFlexGap>
                  {purposeAnalysis.crypto_usage.algorithms?.map((algo, idx) => (
                    <Chip key={idx} label={algo} size="small" variant="outlined" />
                  ))}
                </Stack>
              </Grid>
            )}

            {/* API Usage Summary */}
            <Grid item xs={12}>
              <Typography variant="subtitle2" color="primary" gutterBottom sx={{ display: "flex", alignItems: "center", gap: 1 }}>
                <StorageIcon fontSize="small" /> API Categories Used
              </Typography>
              <Stack direction="row" spacing={1} flexWrap="wrap" useFlexGap>
                {Object.entries(purposeAnalysis.api_usage)
                  .filter(([, apis]) => apis.length > 0)
                  .map(([category, apis]) => (
                    <Tooltip key={category} title={apis.slice(0, 10).join(", ") + (apis.length > 10 ? "..." : "")}>
                      <Chip 
                        label={`${category.replace("_", " ").toUpperCase()} (${apis.length})`} 
                        size="small" 
                        variant="outlined"
                      />
                    </Tooltip>
                  ))}
              </Stack>
            </Grid>
          </Grid>

          {/* Suspicious Behaviors */}
          {purposeAnalysis.suspicious_behaviors.length > 0 && (
            <Box sx={{ mt: 3 }}>
              <Alert severity="warning" sx={{ mb: 2 }}>
                <Typography variant="subtitle2" sx={{ display: "flex", alignItems: "center", gap: 1 }}>
                  <WarningIcon fontSize="small" /> Suspicious Behaviors Detected
                </Typography>
              </Alert>
              {purposeAnalysis.suspicious_behaviors.map((behavior, idx) => (
                <Paper 
                  key={idx} 
                  sx={{ 
                    p: 2, 
                    mb: 1, 
                    borderLeft: `4px solid ${
                      behavior.severity === "critical" ? "#dc2626" :
                      behavior.severity === "high" ? "#ea580c" :
                      behavior.severity === "medium" ? "#ca8a04" : "#16a34a"
                    }` 
                  }}
                >
                  <Typography variant="subtitle2">{behavior.behavior}</Typography>
                  <Typography variant="body2" color="text.secondary">
                    Indicator: {behavior.indicator}
                  </Typography>
                </Paper>
              ))}
            </Box>
          )}

          {/* Analysis Notes */}
          {purposeAnalysis.analysis_notes.length > 0 && (
            <Box sx={{ mt: 3 }}>
              <Typography variant="subtitle2" color="text.secondary" gutterBottom>
                Additional Notes
              </Typography>
              <Box component="ul" sx={{ pl: 2, m: 0 }}>
                {purposeAnalysis.analysis_notes.map((note, idx) => (
                  <Typography component="li" variant="body2" color="text.secondary" key={idx}>
                    {note}
                  </Typography>
                ))}
              </Box>
            </Box>
          )}

          <Divider sx={{ my: 3 }} />

          <Button
            variant="text"
            onClick={() => setPurposeAnalysis(null)}
            sx={{ mr: 2 }}
          >
            Close Analysis
          </Button>
        </Paper>
      )}

      {/* Progress Stepper */}
      {isHunting && progress && (
        <Paper sx={{ p: 3, mb: 3 }}>
          <Box sx={{ display: "flex", justifyContent: "space-between", alignItems: "center", mb: 2 }}>
            <Typography variant="h6">Hunting in Progress...</Typography>
            <Button variant="outlined" color="error" startIcon={<StopIcon />} onClick={cancelHunt}>
              Cancel
            </Button>
          </Box>
          
          <LinearProgress
            variant="determinate"
            value={progress.overall_progress}
            sx={{ height: 8, borderRadius: 4, mb: 3 }}
          />
          
          <Grid container spacing={2} sx={{ mb: 3 }}>
            <Grid item xs={4}>
              <Paper sx={{ p: 2, textAlign: "center", bgcolor: alpha(theme.palette.info.main, 0.1) }}>
                <Typography variant="h4">{progress.targets_identified}</Typography>
                <Typography variant="body2" color="text.secondary">Targets Identified</Typography>
              </Paper>
            </Grid>
            <Grid item xs={4}>
              <Paper sx={{ p: 2, textAlign: "center", bgcolor: alpha(theme.palette.warning.main, 0.1) }}>
                <Typography variant="h4">{progress.vulnerabilities_found}</Typography>
                <Typography variant="body2" color="text.secondary">Vulnerabilities Found</Typography>
              </Paper>
            </Grid>
            <Grid item xs={4}>
              <Paper sx={{ p: 2, textAlign: "center", bgcolor: alpha(theme.palette.success.main, 0.1) }}>
                <Typography variant="h4">{progress.overall_progress}%</Typography>
                <Typography variant="body2" color="text.secondary">Overall Progress</Typography>
              </Paper>
            </Grid>
          </Grid>
          
          <Stepper activeStep={getActiveStep()} orientation="vertical">
            {progress.phases.map((phase, index) => (
              <Step key={phase.id}>
                <StepLabel
                  optional={phase.details && <Typography variant="caption">{phase.details}</Typography>}
                  StepIconComponent={() => (
                    <Box
                      sx={{
                        width: 32,
                        height: 32,
                        borderRadius: "50%",
                        display: "flex",
                        alignItems: "center",
                        justifyContent: "center",
                        bgcolor:
                          phase.status === "completed"
                            ? "success.main"
                            : phase.status === "in_progress"
                            ? "primary.main"
                            : phase.status === "error"
                            ? "error.main"
                            : alpha(theme.palette.text.primary, 0.2),
                        color: "white",
                      }}
                    >
                      {phase.status === "completed" ? (
                        <CheckIcon fontSize="small" />
                      ) : phase.status === "in_progress" ? (
                        <AiIcon fontSize="small" />
                      ) : phase.status === "error" ? (
                        <CriticalIcon fontSize="small" />
                      ) : (
                        <Typography variant="caption">{index + 1}</Typography>
                      )}
                    </Box>
                  )}
                >
                  <Typography variant="subtitle1">{phase.label}</Typography>
                </StepLabel>
                <StepContent>
                  <Typography variant="body2" color="text.secondary">
                    {phase.description}
                  </Typography>
                  {phase.status === "in_progress" && (
                    <LinearProgress
                      variant="indeterminate"
                      sx={{ mt: 1, height: 4, borderRadius: 2 }}
                    />
                  )}
                </StepContent>
              </Step>
            ))}
          </Stepper>
          
          <Typography variant="body2" color="text.secondary" sx={{ mt: 2, textAlign: "center" }}>
            {progress.message}
          </Typography>
        </Paper>
      )}

      {/* Error */}
      {error && (
        <Alert severity="error" sx={{ mb: 3 }} onClose={() => setError(null)}>
          {error}
        </Alert>
      )}
      
      {/* PoC Generation Error */}
      {pocError && (
        <Alert severity="warning" sx={{ mb: 3 }} onClose={() => setPocError(null)}>
          PoC Generation failed: {pocError}
        </Alert>
      )}

      {/* Results */}
      {result && (
        <Box>
          {/* Summary Cards */}
          <Grid container spacing={3} sx={{ mb: 4 }}>
            <Grid item xs={12} md={3}>
              <Card sx={{ bgcolor: alpha(theme.palette.error.main, 0.1), height: "100%" }}>
                <CardContent sx={{ textAlign: "center" }}>
                  <Typography variant="h2" color="error.main" fontWeight="bold">
                    {result.risk_score}
                  </Typography>
                  <Typography variant="body2" color="text.secondary">
                    Risk Score
                  </Typography>
                </CardContent>
              </Card>
            </Grid>
            <Grid item xs={12} md={3}>
              <Card sx={{ height: "100%" }}>
                <CardContent sx={{ textAlign: "center" }}>
                  <Typography variant="h2" color="warning.main" fontWeight="bold">
                    {result.vulnerabilities.length}
                  </Typography>
                  <Typography variant="body2" color="text.secondary">
                    Vulnerabilities Found
                  </Typography>
                </CardContent>
              </Card>
            </Grid>
            <Grid item xs={12} md={3}>
              <Card sx={{ height: "100%" }}>
                <CardContent sx={{ textAlign: "center" }}>
                  <Typography variant="h2" color="info.main" fontWeight="bold">
                    {result.targets_identified}
                  </Typography>
                  <Typography variant="body2" color="text.secondary">
                    Targets Analyzed
                  </Typography>
                </CardContent>
              </Card>
            </Grid>
            <Grid item xs={12} md={3}>
              <Card sx={{ height: "100%" }}>
                <CardContent sx={{ textAlign: "center" }}>
                  <Typography variant="h2" color="success.main" fontWeight="bold">
                    {result.total_functions_analyzed}
                  </Typography>
                  <Typography variant="body2" color="text.secondary">
                    Functions Decompiled
                  </Typography>
                </CardContent>
              </Card>
            </Grid>
          </Grid>

          {/* Executive Summary */}
          <Paper sx={{ p: 3, mb: 4 }}>
            <Typography variant="h6" gutterBottom sx={{ display: "flex", alignItems: "center", gap: 1 }}>
              <SecurityIcon color="primary" /> Executive Summary
            </Typography>
            <Typography variant="body1">{result.executive_summary}</Typography>
          </Paper>

          {/* Vulnerabilities List */}
          {result.vulnerabilities.length > 0 && (
            <Paper sx={{ p: 3, mb: 4 }}>
              <Typography variant="h6" gutterBottom sx={{ display: "flex", alignItems: "center", gap: 1 }}>
                <BugIcon color="error" /> Discovered Vulnerabilities ({result.vulnerabilities.length})
              </Typography>
              
              {/* Severity breakdown */}
              <Stack direction="row" spacing={2} sx={{ mb: 3 }}>
                {["critical", "high", "medium", "low"].map((sev) => {
                  const count = result.vulnerabilities.filter((v) => v.severity === sev).length;
                  return (
                    <Chip
                      key={sev}
                      label={`${sev.toUpperCase()}: ${count}`}
                      sx={{
                        bgcolor: alpha(SEVERITY_COLORS[sev], 0.2),
                        color: SEVERITY_COLORS[sev],
                        fontWeight: "bold",
                      }}
                    />
                  );
                })}
              </Stack>
              
              {result.vulnerabilities
                .sort((a, b) => {
                  const order = { critical: 0, high: 1, medium: 2, low: 3 };
                  return (order[a.severity] ?? 4) - (order[b.severity] ?? 4);
                })
                .map((finding) => (
                  <Box key={finding.id}>
                    <VulnerabilityCard 
                      finding={finding} 
                      onGeneratePoc={generatePoc}
                      isGeneratingPoc={generatingPocForId === finding.id}
                      onSimulateAttack={openAttackSimulation}
                      onSymbolicTrace={openSymbolicDialog}
                    />
                    {/* Show generated PoC if available */}
                    {generatedPocs.has(finding.id) && (
                      <Paper sx={{ p: 3, mb: 2, ml: 4, bgcolor: alpha(theme.palette.error.main, 0.05), borderLeft: "4px solid #dc2626" }}>
                        <Typography variant="h6" gutterBottom sx={{ display: "flex", alignItems: "center", gap: 1 }}>
                          <BoltIcon color="error" /> Generated PoC Exploit
                        </Typography>
                        
                        {(() => {
                          const poc = generatedPocs.get(finding.id)!;
                          return (
                            <Box>
                              <Alert severity="error" sx={{ mb: 2 }}>
                                <Typography variant="body2" fontWeight="bold">
                                  ⚠️ FOR AUTHORIZED SECURITY TESTING ONLY
                                </Typography>
                              </Alert>
                              
                              <Typography variant="subtitle2" gutterBottom>{poc.description}</Typography>
                              
                              <Grid container spacing={2} sx={{ mb: 2 }}>
                                <Grid item xs={6}>
                                  <Typography variant="caption" color="text.secondary">Language</Typography>
                                  <Typography variant="body2">{poc.language}</Typography>
                                </Grid>
                                <Grid item xs={6}>
                                  <Typography variant="caption" color="text.secondary">Reliability</Typography>
                                  <Chip 
                                    label={poc.reliability.toUpperCase()} 
                                    size="small" 
                                    color={poc.reliability === "high" ? "success" : poc.reliability === "medium" ? "warning" : "default"}
                                  />
                                </Grid>
                              </Grid>
                              
                              <Typography variant="subtitle2" gutterBottom>Exploit Code</Typography>
                              <Paper sx={{ p: 2, bgcolor: "#1a1a2e", mb: 2, position: "relative" }}>
                                <IconButton
                                  size="small"
                                  onClick={() => navigator.clipboard.writeText(poc.code)}
                                  sx={{ position: "absolute", top: 8, right: 8, color: "#fff" }}
                                >
                                  <CopyIcon fontSize="small" />
                                </IconButton>
                                <pre style={{ margin: 0, color: "#e0e0e0", fontSize: "0.75rem", overflow: "auto", maxHeight: 400 }}>
                                  {poc.code}
                                </pre>
                              </Paper>
                              
                              <Typography variant="subtitle2" gutterBottom>Usage Instructions</Typography>
                              <Typography variant="body2" sx={{ mb: 2, whiteSpace: "pre-wrap" }}>
                                {poc.usage_instructions}
                              </Typography>
                              
                              <Typography variant="subtitle2" gutterBottom>Prerequisites</Typography>
                              <Box component="ul" sx={{ pl: 2, m: 0, mb: 2 }}>
                                {poc.prerequisites.map((prereq, idx) => (
                                  <Typography component="li" variant="body2" key={idx}>{prereq}</Typography>
                                ))}
                              </Box>
                              
                              <Typography variant="subtitle2" gutterBottom>Expected Outcome</Typography>
                              <Typography variant="body2" sx={{ mb: 2 }}>{poc.expected_outcome}</Typography>
                              
                              {poc.limitations.length > 0 && (
                                <>
                                  <Typography variant="subtitle2" gutterBottom>Limitations</Typography>
                                  <Box component="ul" sx={{ pl: 2, m: 0, mb: 2 }}>
                                    {poc.limitations.map((lim, idx) => (
                                      <Typography component="li" variant="body2" key={idx}>{lim}</Typography>
                                    ))}
                                  </Box>
                                </>
                              )}
                              
                              <Alert severity="warning">
                                <Typography variant="body2">
                                  {poc.safety_notes.join(" ")}
                                </Typography>
                              </Alert>
                            </Box>
                          );
                        })()}
                      </Paper>
                    )}
                  </Box>
                ))}
            </Paper>
          )}

          {/* Attack Surface Summary */}
          <Paper sx={{ p: 3, mb: 4 }}>
            <Typography variant="h6" gutterBottom sx={{ display: "flex", alignItems: "center", gap: 1 }}>
              <RadarIcon color="info" /> Attack Surface Summary
            </Typography>
            <Grid container spacing={3}>
              <Grid item xs={12} md={6}>
                <Typography variant="subtitle2" gutterBottom>
                  Categories Detected
                </Typography>
                <Stack direction="row" spacing={1} flexWrap="wrap" useFlexGap>
                  {result.attack_surface_summary.categories_detected.map((cat) => (
                    <Chip
                      key={cat}
                      label={cat.replace("_", " ").toUpperCase()}
                      size="small"
                      variant="outlined"
                    />
                  ))}
                </Stack>
              </Grid>
              <Grid item xs={12} md={6}>
                <Typography variant="subtitle2" gutterBottom>
                  Dangerous Function Calls
                </Typography>
                <TableContainer>
                  <Table size="small">
                    <TableHead>
                      <TableRow>
                        <TableCell>Function</TableCell>
                        <TableCell align="right">Count</TableCell>
                      </TableRow>
                    </TableHead>
                    <TableBody>
                      {Object.entries(result.attack_surface_summary.dangerous_function_counts)
                        .sort(([, a], [, b]) => b - a)
                        .slice(0, 10)
                        .map(([fn, count]) => (
                          <TableRow key={fn}>
                            <TableCell>
                              <code>{fn}</code>
                            </TableCell>
                            <TableCell align="right">{count}</TableCell>
                          </TableRow>
                        ))}
                    </TableBody>
                  </Table>
                </TableContainer>
              </Grid>
            </Grid>
          </Paper>

          {/* Focus Areas */}
          <Paper sx={{ p: 3, mb: 4 }}>
            <Typography variant="h6" gutterBottom sx={{ display: "flex", alignItems: "center", gap: 1 }}>
              <TimelineIcon color="warning" /> Recommended Focus Areas
            </Typography>
            <Box component="ol" sx={{ pl: 2, m: 0 }}>
              {result.recommended_focus_areas.map((area, idx) => (
                <Typography component="li" variant="body2" key={idx} sx={{ mb: 1 }}>
                  {area}
                </Typography>
              ))}
            </Box>
          </Paper>

          {/* Actions */}
          <Box sx={{ textAlign: "center" }}>
            <Button variant="contained" onClick={resetHunt} startIcon={<SearchIcon />}>
              Hunt Another Binary
            </Button>
          </Box>
        </Box>
      )}

      {/* Floating Speed Dial for Chat & Notes */}
      {file && (
        <SpeedDial
          ariaLabel="Analysis tools"
          sx={{ position: "fixed", bottom: 24, right: 24 }}
          icon={<SpeedDialIcon />}
          open={speedDialOpen}
          onOpen={() => setSpeedDialOpen(true)}
          onClose={() => setSpeedDialOpen(false)}
        >
          <SpeedDialAction
            icon={<SimulateIcon />}
            tooltipTitle="Attack Simulation"
            onClick={() => {
              // Open simulation with first vulnerability if available
              if (result?.vulnerabilities && result.vulnerabilities.length > 0) {
                openAttackSimulation(result.vulnerabilities[0]);
              }
              setSpeedDialOpen(false);
            }}
          />
          <SpeedDialAction
            icon={<CFGIcon />}
            tooltipTitle="Symbolic Execution"
            onClick={() => {
              // Open symbolic analysis with first vulnerability code if available
              if (result?.vulnerabilities && result.vulnerabilities.length > 0) {
                const vuln = result.vulnerabilities[0];
                openSymbolicDialog(vuln.code_snippet || "", vuln.function_name);
              }
              setSpeedDialOpen(false);
            }}
          />
          <SpeedDialAction
            icon={<NLSearchIcon />}
            tooltipTitle="Natural Language Search"
            onClick={() => {
              setNlSearchDialogOpen(true);
              setSpeedDialOpen(false);
            }}
          />
          <SpeedDialAction
            icon={<EnhanceIcon />}
            tooltipTitle="Enhance Code"
            onClick={() => {
              setEnhanceDialogOpen(true);
              setSpeedDialOpen(false);
            }}
          />
          <SpeedDialAction
            icon={
              <Badge badgeContent={notes.length} color="primary" max={99}>
                <NoteIcon />
              </Badge>
            }
            tooltipTitle="Notes"
            onClick={() => {
              setNotesOpen(true);
              setSpeedDialOpen(false);
            }}
          />
          <SpeedDialAction
            icon={
              <Badge badgeContent={chatMessages.length} color="secondary" max={99}>
                <ChatIcon />
              </Badge>
            }
            tooltipTitle="Chat with AI"
            onClick={() => {
              setChatOpen(true);
              setSpeedDialOpen(false);
            }}
          />
        </SpeedDial>
      )}

      {/* AI Chat Dialog */}
      <Dialog
        open={chatOpen}
        onClose={() => setChatOpen(false)}
        maxWidth="md"
        fullWidth
        PaperProps={{
          sx: {
            height: "80vh",
            maxHeight: 700,
          },
        }}
      >
        <DialogTitle sx={{ display: "flex", alignItems: "center", justifyContent: "space-between" }}>
          <Box sx={{ display: "flex", alignItems: "center", gap: 1 }}>
            <AiIcon color="primary" />
            <Typography variant="h6">Chat with AI Assistant</Typography>
          </Box>
          <IconButton onClick={() => setChatOpen(false)}>
            <CloseIcon />
          </IconButton>
        </DialogTitle>
        <DialogContent dividers sx={{ display: "flex", flexDirection: "column", p: 0 }}>
          {/* Chat Messages */}
          <Box sx={{ flex: 1, overflow: "auto", p: 2 }}>
            {chatMessages.length === 0 && (
              <Box sx={{ textAlign: "center", py: 4, color: "text.secondary" }}>
                <ChatIcon sx={{ fontSize: 48, opacity: 0.3, mb: 2 }} />
                <Typography variant="body1">
                  Ask questions about the binary analysis, vulnerabilities, or exploits
                </Typography>
                <Typography variant="body2" color="text.secondary" sx={{ mt: 1 }}>
                  The AI has context about your current analysis
                </Typography>
              </Box>
            )}
            {chatMessages.map((msg, idx) => (
              <Box
                key={idx}
                sx={{
                  display: "flex",
                  justifyContent: msg.role === "user" ? "flex-end" : "flex-start",
                  mb: 2,
                }}
              >
                <Paper
                  sx={{
                    p: 2,
                    maxWidth: "80%",
                    bgcolor: msg.role === "user" 
                      ? alpha(theme.palette.primary.main, 0.1)
                      : alpha(theme.palette.grey[500], 0.1),
                    borderRadius: 2,
                  }}
                >
                  <Typography variant="body2" sx={{ whiteSpace: "pre-wrap" }}>
                    {msg.content}
                  </Typography>
                </Paper>
              </Box>
            ))}
            {isChatLoading && (
              <Box sx={{ display: "flex", justifyContent: "flex-start", mb: 2 }}>
                <Paper sx={{ p: 2, bgcolor: alpha(theme.palette.grey[500], 0.1) }}>
                  <CircularProgress size={20} />
                </Paper>
              </Box>
            )}
            <div ref={chatEndRef} />
          </Box>
          
          {/* Chat Input */}
          <Box sx={{ p: 2, borderTop: 1, borderColor: "divider" }}>
            <Stack direction="row" spacing={1}>
              <TextField
                fullWidth
                variant="outlined"
                placeholder="Ask about vulnerabilities, exploits, or the binary..."
                value={chatInput}
                onChange={(e) => setChatInput(e.target.value)}
                onKeyPress={(e) => {
                  if (e.key === "Enter" && !e.shiftKey) {
                    e.preventDefault();
                    sendChatMessage();
                  }
                }}
                size="small"
                multiline
                maxRows={3}
              />
              <IconButton
                color="primary"
                onClick={sendChatMessage}
                disabled={!chatInput.trim() || isChatLoading}
              >
                <SendIcon />
              </IconButton>
            </Stack>
          </Box>
        </DialogContent>
      </Dialog>

      {/* Notes Drawer */}
      <Drawer
        anchor="right"
        open={notesOpen}
        onClose={() => setNotesOpen(false)}
        PaperProps={{ sx: { width: { xs: "100%", sm: 400 } } }}
      >
        <Box sx={{ p: 2, borderBottom: 1, borderColor: "divider", display: "flex", alignItems: "center", justifyContent: "space-between" }}>
          <Box sx={{ display: "flex", alignItems: "center", gap: 1 }}>
            <NoteIcon color="primary" />
            <Typography variant="h6">Analysis Notes</Typography>
          </Box>
          <IconButton onClick={() => setNotesOpen(false)}>
            <CloseIcon />
          </IconButton>
        </Box>
        
        {/* Add New Note */}
        <Box sx={{ p: 2, borderBottom: 1, borderColor: "divider" }}>
          <TextField
            fullWidth
            variant="outlined"
            placeholder="Add a note..."
            value={newNoteContent}
            onChange={(e) => setNewNoteContent(e.target.value)}
            multiline
            rows={2}
            size="small"
            sx={{ mb: 1 }}
          />
          <Stack direction="row" spacing={1} alignItems="center">
            <FormControl size="small" sx={{ minWidth: 120 }}>
              <Select
                value={newNoteCategory}
                onChange={(e) => setNewNoteCategory(e.target.value as typeof newNoteCategory)}
              >
                <MenuItem value="general">General</MenuItem>
                <MenuItem value="vulnerability">Vulnerability</MenuItem>
                <MenuItem value="poc">PoC</MenuItem>
                <MenuItem value="remediation">Remediation</MenuItem>
              </Select>
            </FormControl>
            <Button
              variant="contained"
              size="small"
              startIcon={<AddIcon />}
              onClick={addNote}
              disabled={!newNoteContent.trim()}
            >
              Add Note
            </Button>
          </Stack>
        </Box>
        
        {/* Notes List */}
        <Box sx={{ flex: 1, overflow: "auto" }}>
          {notes.length === 0 ? (
            <Box sx={{ textAlign: "center", py: 4, color: "text.secondary" }}>
              <NoteIcon sx={{ fontSize: 48, opacity: 0.3, mb: 2 }} />
              <Typography variant="body2">No notes yet</Typography>
            </Box>
          ) : (
            <List>
              {notes.map((note) => (
                <ListItem
                  key={note.id}
                  sx={{ borderBottom: 1, borderColor: "divider", flexDirection: "column", alignItems: "flex-start" }}
                >
                  {editingNote === note.id ? (
                    <Box sx={{ width: "100%" }}>
                      <TextField
                        fullWidth
                        value={editNoteContent}
                        onChange={(e) => setEditNoteContent(e.target.value)}
                        multiline
                        rows={2}
                        size="small"
                        sx={{ mb: 1 }}
                      />
                      <Stack direction="row" spacing={1}>
                        <Button size="small" onClick={saveEditedNote} startIcon={<SaveIcon />}>
                          Save
                        </Button>
                        <Button size="small" onClick={() => setEditingNote(null)}>
                          Cancel
                        </Button>
                      </Stack>
                    </Box>
                  ) : (
                    <>
                      <Box sx={{ display: "flex", justifyContent: "space-between", width: "100%", mb: 1 }}>
                        <Chip
                          label={note.category}
                          size="small"
                          color={
                            note.category === "vulnerability" ? "error" :
                            note.category === "poc" ? "warning" :
                            note.category === "remediation" ? "success" : "default"
                          }
                          variant="outlined"
                        />
                        <Typography variant="caption" color="text.secondary">
                          {new Date(note.created_at).toLocaleString()}
                        </Typography>
                      </Box>
                      <ListItemText primary={note.content} sx={{ whiteSpace: "pre-wrap" }} />
                      <ListItemSecondaryAction>
                        <IconButton
                          size="small"
                          onClick={() => {
                            setEditingNote(note.id);
                            setEditNoteContent(note.content);
                          }}
                        >
                          <EditIcon fontSize="small" />
                        </IconButton>
                        <IconButton size="small" onClick={() => deleteNote(note.id)}>
                          <DeleteIcon fontSize="small" />
                        </IconButton>
                      </ListItemSecondaryAction>
                    </>
                  )}
                </ListItem>
              ))}
            </List>
          )}
        </Box>
        
        {/* Export Notes */}
        {notes.length > 0 && (
          <Box sx={{ p: 2, borderTop: 1, borderColor: "divider" }}>
            <Typography variant="subtitle2" gutterBottom>Export Notes</Typography>
            <Stack direction="row" spacing={1}>
              <Button size="small" variant="outlined" onClick={() => exportNotesToFile("markdown")}>
                Markdown
              </Button>
              <Button size="small" variant="outlined" onClick={() => exportNotesToFile("json")}>
                JSON
              </Button>
              <Button size="small" variant="outlined" onClick={() => exportNotesToFile("txt")}>
                Text
              </Button>
            </Stack>
          </Box>
        )}
      </Drawer>

      {/* AI Code Enhancement Dialog */}
      <Dialog
        open={enhanceDialogOpen}
        onClose={() => setEnhanceDialogOpen(false)}
        maxWidth="lg"
        fullWidth
        PaperProps={{
          sx: { height: "90vh", maxHeight: 900 },
        }}
      >
        <DialogTitle sx={{ display: "flex", alignItems: "center", justifyContent: "space-between" }}>
          <Box sx={{ display: "flex", alignItems: "center", gap: 1 }}>
            <EnhanceIcon color="primary" />
            <Typography variant="h6">AI Code Enhancement</Typography>
          </Box>
          <IconButton onClick={() => setEnhanceDialogOpen(false)}>
            <CloseIcon />
          </IconButton>
        </DialogTitle>
        <DialogContent dividers>
          <Grid container spacing={3}>
            {/* Input Section */}
            <Grid item xs={12} md={enhanceResult ? 6 : 12}>
              <Typography variant="subtitle2" gutterBottom>
                Paste Decompiled Code
              </Typography>
              <TextField
                fullWidth
                multiline
                rows={enhanceResult ? 15 : 20}
                value={codeToEnhance}
                onChange={(e) => setCodeToEnhance(e.target.value)}
                placeholder={`Paste Ghidra/IDA decompiled code here...

Example:
void FUN_00401000(undefined4 param_1, char *param_2) {
  char local_108 [256];
  int local_8;
  
  local_8 = 0;
  strcpy(local_108, param_2);
  ...
}`}
                sx={{ fontFamily: "monospace", fontSize: 12 }}
              />
              
              <Stack direction="row" spacing={2} sx={{ mt: 2 }}>
                <TextField
                  size="small"
                  label="Function Name"
                  value={enhanceFunctionName}
                  onChange={(e) => setEnhanceFunctionName(e.target.value)}
                  placeholder="FUN_00401000"
                  sx={{ flex: 1 }}
                />
                <FormControl size="small" sx={{ minWidth: 150 }}>
                  <InputLabel>Enhancement Level</InputLabel>
                  <Select
                    value={enhanceLevel}
                    label="Enhancement Level"
                    onChange={(e) => setEnhanceLevel(e.target.value as typeof enhanceLevel)}
                  >
                    <MenuItem value="basic">Basic (Variables only)</MenuItem>
                    <MenuItem value="standard">Standard (+Comments)</MenuItem>
                    <MenuItem value="full">Full (+Security)</MenuItem>
                  </Select>
                </FormControl>
                <Button
                  variant="contained"
                  startIcon={isEnhancing ? <CircularProgress size={16} /> : <AiIcon />}
                  onClick={enhanceCode}
                  disabled={!codeToEnhance.trim() || isEnhancing}
                >
                  {isEnhancing ? "Enhancing..." : "Enhance"}
                </Button>
              </Stack>
              
              {enhanceError && (
                <Alert severity="error" sx={{ mt: 2 }}>
                  {enhanceError}
                </Alert>
              )}
            </Grid>
            
            {/* Result Section */}
            {enhanceResult && (
              <Grid item xs={12} md={6}>
                <Box sx={{ display: "flex", alignItems: "center", justifyContent: "space-between", mb: 1 }}>
                  <Typography variant="subtitle2">
                    Enhanced Code
                  </Typography>
                  <Tooltip title="Copy enhanced code">
                    <IconButton size="small" onClick={() => copyToClipboard(enhanceResult.enhanced_code)}>
                      <CopyIcon fontSize="small" />
                    </IconButton>
                  </Tooltip>
                </Box>
                
                {/* Summary Stats */}
                <Stack direction="row" spacing={1} sx={{ mb: 2, flexWrap: "wrap" }}>
                  <Chip 
                    size="small" 
                    icon={<LightbulbIcon />}
                    label={`Suggested: ${enhanceResult.suggested_function_name}`}
                    color="primary"
                    variant="outlined"
                  />
                  <Chip 
                    size="small" 
                    label={`${enhanceResult.readability_improvement}% more readable`}
                    color="success"
                    variant="outlined"
                  />
                  <Chip 
                    size="small" 
                    label={`${enhanceResult.variables.length} variables renamed`}
                    variant="outlined"
                  />
                  <Chip 
                    size="small" 
                    label={`${enhanceResult.inline_comments_added} comments added`}
                    variant="outlined"
                  />
                </Stack>
                
                {/* Function Purpose */}
                <Alert severity="info" sx={{ mb: 2 }}>
                  <Typography variant="body2">
                    <strong>Purpose:</strong> {enhanceResult.function_purpose}
                  </Typography>
                </Alert>
                
                {/* Enhanced Code */}
                <Paper 
                  variant="outlined" 
                  sx={{ 
                    p: 2, 
                    bgcolor: alpha(theme.palette.background.default, 0.5),
                    maxHeight: 300,
                    overflow: "auto",
                  }}
                >
                  <Typography 
                    component="pre" 
                    sx={{ 
                      fontFamily: "monospace", 
                      fontSize: 11, 
                      whiteSpace: "pre-wrap",
                      m: 0,
                    }}
                  >
                    {enhanceResult.enhanced_code}
                  </Typography>
                </Paper>
                
                {/* Variable Mappings */}
                {enhanceResult.variables.length > 0 && (
                  <Accordion sx={{ mt: 2 }}>
                    <AccordionSummary expandIcon={<ExpandMoreIcon />}>
                      <Typography variant="subtitle2">Variable Mappings ({enhanceResult.variables.length})</Typography>
                    </AccordionSummary>
                    <AccordionDetails>
                      <TableContainer>
                        <Table size="small">
                          <TableHead>
                            <TableRow>
                              <TableCell>Original</TableCell>
                              <TableCell>Suggested</TableCell>
                              <TableCell>Type</TableCell>
                              <TableCell>Confidence</TableCell>
                            </TableRow>
                          </TableHead>
                          <TableBody>
                            {enhanceResult.variables.map((v, i) => (
                              <TableRow key={i}>
                                <TableCell sx={{ fontFamily: "monospace" }}>{v.original_name}</TableCell>
                                <TableCell sx={{ fontFamily: "monospace", color: "primary.main" }}>{v.suggested_name}</TableCell>
                                <TableCell sx={{ fontFamily: "monospace" }}>{v.inferred_type}</TableCell>
                                <TableCell>
                                  <Chip 
                                    size="small" 
                                    label={`${Math.round(v.confidence * 100)}%`}
                                    color={v.confidence > 0.7 ? "success" : v.confidence > 0.4 ? "warning" : "default"}
                                  />
                                </TableCell>
                              </TableRow>
                            ))}
                          </TableBody>
                        </Table>
                      </TableContainer>
                    </AccordionDetails>
                  </Accordion>
                )}
                
                {/* Security Annotations */}
                {enhanceResult.security_annotations.length > 0 && (
                  <Accordion sx={{ mt: 1 }}>
                    <AccordionSummary expandIcon={<ExpandMoreIcon />}>
                      <Box sx={{ display: "flex", alignItems: "center", gap: 1 }}>
                        <SecurityIcon color="error" fontSize="small" />
                        <Typography variant="subtitle2">
                          Security Issues ({enhanceResult.security_annotations.length})
                        </Typography>
                      </Box>
                    </AccordionSummary>
                    <AccordionDetails>
                      <Stack spacing={1}>
                        {enhanceResult.security_annotations.map((ann, i) => (
                          <Alert 
                            key={i} 
                            severity={ann.severity === "critical" || ann.severity === "high" ? "error" : ann.severity === "medium" ? "warning" : "info"}
                          >
                            <Typography variant="body2">
                              <strong>Line {ann.line}:</strong> {ann.description}
                              {ann.cwe_id && <Chip size="small" label={ann.cwe_id} sx={{ ml: 1 }} />}
                            </Typography>
                          </Alert>
                        ))}
                      </Stack>
                    </AccordionDetails>
                  </Accordion>
                )}
                
                {/* Data Structures */}
                {enhanceResult.data_structures.length > 0 && (
                  <Accordion sx={{ mt: 1 }}>
                    <AccordionSummary expandIcon={<ExpandMoreIcon />}>
                      <Typography variant="subtitle2">
                        Inferred Data Structures ({enhanceResult.data_structures.length})
                      </Typography>
                    </AccordionSummary>
                    <AccordionDetails>
                      {enhanceResult.data_structures.map((ds, i) => (
                        <Paper key={i} variant="outlined" sx={{ p: 1, mb: 1 }}>
                          <Typography variant="body2" fontWeight="bold">
                            {ds.inferred_type} {ds.name}
                          </Typography>
                          <Typography variant="caption" color="text.secondary">
                            {ds.usage_context}
                          </Typography>
                          <Box sx={{ fontFamily: "monospace", fontSize: 11, mt: 1 }}>
                            {ds.fields.map((f, j) => (
                              <div key={j}>&nbsp;&nbsp;{f.type} {f.name};</div>
                            ))}
                          </Box>
                        </Paper>
                      ))}
                    </AccordionDetails>
                  </Accordion>
                )}
              </Grid>
            )}
          </Grid>
        </DialogContent>
      </Dialog>

      {/* Natural Language Search Dialog */}
      <Dialog
        open={nlSearchDialogOpen}
        onClose={() => setNlSearchDialogOpen(false)}
        maxWidth="lg"
        fullWidth
        PaperProps={{
          sx: { height: "85vh", maxHeight: 850 },
        }}
      >
        <DialogTitle sx={{ display: "flex", alignItems: "center", justifyContent: "space-between" }}>
          <Box sx={{ display: "flex", alignItems: "center", gap: 1 }}>
            <NLSearchIcon color="primary" />
            <Typography variant="h6">Natural Language Search</Typography>
          </Box>
          <IconButton onClick={() => setNlSearchDialogOpen(false)}>
            <CloseIcon />
          </IconButton>
        </DialogTitle>
        <DialogContent dividers>
          {/* Search Input */}
          <Box sx={{ mb: 3 }}>
            <Typography variant="body2" color="text.secondary" sx={{ mb: 2 }}>
              Search across decompiled functions using natural language. Describe what you're looking for:
            </Typography>
            
            <Stack direction="row" spacing={2}>
              <TextField
                fullWidth
                value={nlSearchQuery}
                onChange={(e) => setNlSearchQuery(e.target.value)}
                placeholder="e.g., Find functions that handle network authentication"
                onKeyPress={(e) => e.key === "Enter" && performNlSearch()}
              />
              <FormControl size="medium" sx={{ minWidth: 150 }}>
                <InputLabel>Scope</InputLabel>
                <Select
                  value={nlSearchScope}
                  label="Scope"
                  onChange={(e) => setNlSearchScope(e.target.value as typeof nlSearchScope)}
                >
                  <MenuItem value="all">All Code</MenuItem>
                  <MenuItem value="security">Security</MenuItem>
                  <MenuItem value="network">Network</MenuItem>
                  <MenuItem value="crypto">Crypto</MenuItem>
                  <MenuItem value="file_io">File I/O</MenuItem>
                </Select>
              </FormControl>
              <Button
                variant="contained"
                startIcon={isSearching ? <CircularProgress size={16} /> : <SearchIcon />}
                onClick={performNlSearch}
                disabled={!nlSearchQuery.trim() || isSearching}
              >
                {isSearching ? "Searching..." : "Search"}
              </Button>
            </Stack>
            
            {/* Example Queries */}
            <Box sx={{ mt: 2 }}>
              <Typography variant="caption" color="text.secondary">
                Try these example queries:
              </Typography>
              <Stack direction="row" spacing={1} sx={{ mt: 1, flexWrap: "wrap", gap: 1 }}>
                {NL_SEARCH_EXAMPLES.map((example, i) => (
                  <Chip
                    key={i}
                    label={example}
                    size="small"
                    variant="outlined"
                    onClick={() => setNlSearchQuery(example)}
                    sx={{ cursor: "pointer" }}
                  />
                ))}
              </Stack>
            </Box>
            
            {searchError && (
              <Alert severity="error" sx={{ mt: 2 }}>
                {searchError}
              </Alert>
            )}
          </Box>
          
          {/* Search Results */}
          {searchResult && (
            <Grid container spacing={2}>
              {/* Results List */}
              <Grid item xs={12} md={selectedSearchMatch ? 5 : 12}>
                <Box sx={{ display: "flex", alignItems: "center", justifyContent: "space-between", mb: 2 }}>
                  <Typography variant="subtitle2">
                    Search Results ({searchResult.matches.length} of {searchResult.total_functions_searched} functions)
                  </Typography>
                  {searchResult.interpreted_query !== searchResult.query && (
                    <Tooltip title="How AI interpreted your query">
                      <Chip size="small" label={searchResult.interpreted_query} variant="outlined" />
                    </Tooltip>
                  )}
                </Box>
                
                {/* Category Distribution */}
                {Object.keys(searchResult.categories_found).length > 0 && (
                  <Stack direction="row" spacing={1} sx={{ mb: 2, flexWrap: "wrap" }}>
                    {Object.entries(searchResult.categories_found).map(([cat, count]) => (
                      <Chip key={cat} size="small" label={`${cat}: ${count}`} variant="outlined" />
                    ))}
                  </Stack>
                )}
                
                {searchResult.matches.length === 0 ? (
                  <Alert severity="info">
                    No matching functions found. Try a different query or run vulnerability analysis first.
                  </Alert>
                ) : (
                  <Stack spacing={1} sx={{ maxHeight: 500, overflow: "auto" }}>
                    {searchResult.matches.map((match, i) => (
                      <Paper
                        key={i}
                        variant="outlined"
                        sx={{
                          p: 2,
                          cursor: "pointer",
                          borderColor: selectedSearchMatch === match ? "primary.main" : "divider",
                          bgcolor: selectedSearchMatch === match ? alpha(theme.palette.primary.main, 0.05) : "transparent",
                          "&:hover": {
                            bgcolor: alpha(theme.palette.primary.main, 0.03),
                          },
                        }}
                        onClick={() => setSelectedSearchMatch(match)}
                      >
                        <Box sx={{ display: "flex", alignItems: "center", justifyContent: "space-between", mb: 1 }}>
                          <Typography variant="subtitle2" sx={{ fontFamily: "monospace" }}>
                            {match.function_name}
                          </Typography>
                          <Stack direction="row" spacing={1}>
                            {match.security_relevant && (
                              <Chip size="small" label="Security" color="error" variant="outlined" />
                            )}
                            <Chip 
                              size="small" 
                              label={`${Math.round(match.relevance_score * 100)}% match`}
                              color={match.relevance_score > 0.7 ? "success" : match.relevance_score > 0.4 ? "warning" : "default"}
                            />
                          </Stack>
                        </Box>
                        <Typography variant="body2" color="text.secondary" sx={{ mb: 1 }}>
                          {match.match_reason}
                        </Typography>
                        <Stack direction="row" spacing={0.5} flexWrap="wrap">
                          {match.key_indicators.slice(0, 3).map((ind, j) => (
                            <Chip key={j} size="small" label={ind} variant="outlined" sx={{ fontSize: 10 }} />
                          ))}
                        </Stack>
                      </Paper>
                    ))}
                  </Stack>
                )}
                
                {/* Search Suggestions */}
                {searchResult.search_suggestions.length > 0 && (
                  <Box sx={{ mt: 2 }}>
                    <Typography variant="caption" color="text.secondary">
                      Related searches:
                    </Typography>
                    <Stack direction="row" spacing={1} sx={{ mt: 1, flexWrap: "wrap" }}>
                      {searchResult.search_suggestions.map((sug, i) => (
                        <Chip
                          key={i}
                          label={sug}
                          size="small"
                          onClick={() => setNlSearchQuery(sug)}
                          sx={{ cursor: "pointer" }}
                        />
                      ))}
                    </Stack>
                  </Box>
                )}
              </Grid>
              
              {/* Selected Match Details */}
              {selectedSearchMatch && (
                <Grid item xs={12} md={7}>
                  <Paper variant="outlined" sx={{ p: 2, height: "100%" }}>
                    <Box sx={{ display: "flex", alignItems: "center", justifyContent: "space-between", mb: 2 }}>
                      <Typography variant="h6" sx={{ fontFamily: "monospace" }}>
                        {selectedSearchMatch.function_name}
                      </Typography>
                      <Stack direction="row" spacing={1}>
                        <Chip label={selectedSearchMatch.category} size="small" color="primary" />
                        {selectedSearchMatch.address && (
                          <Chip label={selectedSearchMatch.address} size="small" variant="outlined" />
                        )}
                      </Stack>
                    </Box>
                    
                    <Alert severity={selectedSearchMatch.security_relevant ? "warning" : "info"} sx={{ mb: 2 }}>
                      {selectedSearchMatch.match_reason}
                    </Alert>
                    
                    <Typography variant="subtitle2" gutterBottom>
                      Key Indicators:
                    </Typography>
                    <Stack direction="row" spacing={1} sx={{ mb: 2, flexWrap: "wrap", gap: 1 }}>
                      {selectedSearchMatch.key_indicators.map((ind, i) => (
                        <Chip key={i} label={ind} size="small" variant="outlined" />
                      ))}
                    </Stack>
                    
                    <Typography variant="subtitle2" gutterBottom>
                      Code Snippet:
                    </Typography>
                    <Paper
                      variant="outlined"
                      sx={{
                        p: 2,
                        bgcolor: alpha(theme.palette.background.default, 0.5),
                        maxHeight: 300,
                        overflow: "auto",
                      }}
                    >
                      <Typography
                        component="pre"
                        sx={{
                          fontFamily: "monospace",
                          fontSize: 11,
                          whiteSpace: "pre-wrap",
                          m: 0,
                        }}
                      >
                        {selectedSearchMatch.code_snippet}
                      </Typography>
                    </Paper>
                    
                    <Stack direction="row" spacing={1} sx={{ mt: 2 }}>
                      <Button
                        size="small"
                        startIcon={<EnhanceIcon />}
                        onClick={() => {
                          setCodeToEnhance(selectedSearchMatch.code_snippet);
                          setEnhanceFunctionName(selectedSearchMatch.function_name);
                          setNlSearchDialogOpen(false);
                          setEnhanceDialogOpen(true);
                        }}
                      >
                        Enhance This Code
                      </Button>
                      <Button
                        size="small"
                        startIcon={<CopyIcon />}
                        onClick={() => copyToClipboard(selectedSearchMatch.code_snippet)}
                      >
                        Copy Code
                      </Button>
                    </Stack>
                  </Paper>
                </Grid>
              )}
            </Grid>
          )}
          
          {/* Initial State */}
          {!searchResult && !isSearching && (
            <Box sx={{ textAlign: "center", py: 6, color: "text.secondary" }}>
              <NLSearchIcon sx={{ fontSize: 64, opacity: 0.3, mb: 2 }} />
              <Typography variant="h6" gutterBottom>
                Search with Natural Language
              </Typography>
              <Typography variant="body2" maxWidth={500} mx="auto">
                Describe what you're looking for in plain English. The AI will search through
                all decompiled functions and find the most relevant matches based on behavior,
                API calls, and code patterns.
              </Typography>
            </Box>
          )}
        </DialogContent>
      </Dialog>

      {/* Attack Simulation Dialog */}
      <Dialog
        open={attackSimDialogOpen}
        onClose={() => {
          setAttackSimDialogOpen(false);
          setSimAutoPlay(false);
        }}
        maxWidth="lg"
        fullWidth
        PaperProps={{
          sx: {
            height: "90vh",
            maxHeight: 900,
          },
        }}
      >
        <DialogTitle sx={{ display: "flex", alignItems: "center", justifyContent: "space-between" }}>
          <Box sx={{ display: "flex", alignItems: "center", gap: 1 }}>
            <SimulateIcon color="warning" />
            <Typography variant="h6">Live Attack Simulation</Typography>
            {selectedVulnForSim && (
              <Chip 
                label={selectedVulnForSim.severity.toUpperCase()} 
                size="small"
                sx={{
                  bgcolor: alpha(SEVERITY_COLORS[selectedVulnForSim.severity], 0.2),
                  color: SEVERITY_COLORS[selectedVulnForSim.severity],
                  fontWeight: "bold",
                  ml: 1,
                }}
              />
            )}
          </Box>
          <IconButton onClick={() => {
            setAttackSimDialogOpen(false);
            setSimAutoPlay(false);
          }}>
            <CloseIcon />
          </IconButton>
        </DialogTitle>
        <DialogContent dividers sx={{ p: 0, display: "flex", flexDirection: "column" }}>
          {/* Simulation Controls */}
          {!simResult && !isSimulating && selectedVulnForSim && (
            <Box sx={{ p: 3 }}>
              <Alert severity="warning" sx={{ mb: 3 }}>
                <Typography variant="body2" fontWeight="bold">
                  ⚠️ Educational Simulation Only - For understanding vulnerability impact
                </Typography>
              </Alert>
              
              <Paper variant="outlined" sx={{ p: 2, mb: 3 }}>
                <Typography variant="h6" gutterBottom>{selectedVulnForSim.title}</Typography>
                <Typography variant="body2" color="text.secondary" sx={{ mb: 2 }}>
                  {selectedVulnForSim.description}
                </Typography>
                <Stack direction="row" spacing={1}>
                  <Chip label={selectedVulnForSim.category} size="small" />
                  {selectedVulnForSim.cwe_id && <Chip label={selectedVulnForSim.cwe_id} size="small" variant="outlined" />}
                  <Chip label={`CVSS: ${selectedVulnForSim.cvss_estimate.toFixed(1)}`} size="small" />
                </Stack>
              </Paper>
              
              <Typography variant="subtitle2" gutterBottom>Simulation Depth</Typography>
              <Stack direction="row" spacing={2} sx={{ mb: 3 }}>
                {(["quick", "standard", "comprehensive"] as const).map((depth) => (
                  <Paper
                    key={depth}
                    variant="outlined"
                    sx={{
                      p: 2,
                      flex: 1,
                      cursor: "pointer",
                      borderColor: simDepth === depth ? "warning.main" : "divider",
                      bgcolor: simDepth === depth ? alpha(theme.palette.warning.main, 0.05) : "transparent",
                      "&:hover": {
                        borderColor: "warning.main",
                      },
                    }}
                    onClick={() => setSimDepth(depth)}
                  >
                    <Typography variant="subtitle2" sx={{ textTransform: "capitalize" }}>
                      {depth}
                    </Typography>
                    <Typography variant="caption" color="text.secondary">
                      {depth === "quick" && "4 steps - Basic attack flow"}
                      {depth === "standard" && "6 steps - Detailed simulation"}
                      {depth === "comprehensive" && "10 steps - Full exploitation chain"}
                    </Typography>
                  </Paper>
                ))}
              </Stack>
              
              <Button
                variant="contained"
                color="warning"
                size="large"
                startIcon={<SimulateIcon />}
                onClick={runAttackSimulation}
                fullWidth
                sx={{
                  background: "linear-gradient(135deg, #f59e0b 0%, #dc2626 100%)",
                  py: 1.5,
                }}
              >
                Start Attack Simulation
              </Button>
            </Box>
          )}
          
          {/* Loading State */}
          {isSimulating && (
            <Box sx={{ flex: 1, display: "flex", flexDirection: "column", alignItems: "center", justifyContent: "center", p: 4 }}>
              <CircularProgress size={60} color="warning" sx={{ mb: 3 }} />
              <Typography variant="h6" gutterBottom>Generating Attack Simulation...</Typography>
              <Typography variant="body2" color="text.secondary">
                AI is analyzing the vulnerability and building a realistic exploitation scenario
              </Typography>
            </Box>
          )}
          
          {/* Simulation Error */}
          {simError && (
            <Box sx={{ p: 3 }}>
              <Alert severity="error" sx={{ mb: 2 }}>
                {simError}
              </Alert>
              <Button variant="outlined" onClick={() => setSimError(null)}>
                Try Again
              </Button>
            </Box>
          )}
          
          {/* Simulation Results */}
          {simResult && (
            <Box sx={{ flex: 1, overflow: "hidden", display: "flex", flexDirection: "column" }}>
              {/* Attack Overview Header */}
              <Box sx={{ p: 2, borderBottom: 1, borderColor: "divider", bgcolor: alpha(theme.palette.warning.main, 0.05) }}>
                <Grid container spacing={2} alignItems="center">
                  <Grid item xs={12} md={6}>
                    <Typography variant="h6">{simResult.vulnerability_title}</Typography>
                    <Typography variant="body2" color="text.secondary">
                      {simResult.attack_summary}
                    </Typography>
                  </Grid>
                  <Grid item xs={12} md={6}>
                    <Stack direction="row" spacing={2} justifyContent="flex-end">
                      <Chip
                        label={`Success: ${Math.round(simResult.success_probability * 100)}%`}
                        color={simResult.success_probability > 0.7 ? "error" : simResult.success_probability > 0.4 ? "warning" : "default"}
                      />
                      <Chip
                        label={simResult.difficulty_rating.toUpperCase()}
                        variant="outlined"
                        color={
                          simResult.difficulty_rating === "trivial" || simResult.difficulty_rating === "easy" ? "error" :
                          simResult.difficulty_rating === "moderate" ? "warning" : "default"
                        }
                      />
                    </Stack>
                  </Grid>
                </Grid>
              </Box>
              
              {/* Main Content Area */}
              <Box sx={{ flex: 1, overflow: "auto", display: "flex" }}>
                {/* Steps Timeline (Left) */}
                <Box sx={{ width: 280, borderRight: 1, borderColor: "divider", overflow: "auto", p: 2 }}>
                  <Typography variant="subtitle2" sx={{ mb: 2, display: "flex", alignItems: "center", gap: 1 }}>
                    <TimelineIcon fontSize="small" /> Attack Steps
                  </Typography>
                  <Stepper activeStep={currentSimStep} orientation="vertical">
                    {simResult.steps.map((step, index) => (
                      <Step key={index} completed={index < currentSimStep}>
                        <StepLabel
                          onClick={() => setCurrentSimStep(index)}
                          sx={{ cursor: "pointer" }}
                          StepIconProps={{
                            sx: {
                              color: step.visual_indicator === "danger" ? "error.main" :
                                     step.visual_indicator === "warning" ? "warning.main" :
                                     step.visual_indicator === "success" ? "success.main" : "info.main",
                            },
                          }}
                        >
                          <Typography variant="body2" fontWeight={currentSimStep === index ? "bold" : "normal"}>
                            {step.title}
                          </Typography>
                          <Typography variant="caption" color="text.secondary" sx={{ textTransform: "capitalize" }}>
                            {step.phase}
                          </Typography>
                        </StepLabel>
                      </Step>
                    ))}
                  </Stepper>
                  
                  {/* Playback Controls */}
                  <Box sx={{ mt: 3, pt: 2, borderTop: 1, borderColor: "divider" }}>
                    <Stack direction="row" spacing={1} justifyContent="center">
                      <IconButton 
                        size="small" 
                        onClick={() => setCurrentSimStep(Math.max(0, currentSimStep - 1))}
                        disabled={currentSimStep === 0}
                      >
                        <ArrowBackIcon />
                      </IconButton>
                      <Button
                        size="small"
                        variant={simAutoPlay ? "contained" : "outlined"}
                        color="warning"
                        onClick={() => setSimAutoPlay(!simAutoPlay)}
                        startIcon={simAutoPlay ? <StopIcon /> : <PlayIcon />}
                      >
                        {simAutoPlay ? "Pause" : "Play"}
                      </Button>
                      <IconButton 
                        size="small"
                        onClick={() => setCurrentSimStep(Math.min(simResult.steps.length - 1, currentSimStep + 1))}
                        disabled={currentSimStep === simResult.steps.length - 1}
                      >
                        <ArrowForwardIcon />
                      </IconButton>
                    </Stack>
                  </Box>
                </Box>
                
                {/* Current Step Detail (Center) */}
                <Box sx={{ flex: 1, overflow: "auto", p: 3 }}>
                  {simResult.steps[currentSimStep] && (
                    <Box>
                      {/* Step Header */}
                      <Box sx={{ mb: 3 }}>
                        <Box sx={{ display: "flex", alignItems: "center", gap: 2, mb: 1 }}>
                          <Chip
                            label={`Step ${simResult.steps[currentSimStep].step_number}`}
                            size="small"
                            color={
                              simResult.steps[currentSimStep].visual_indicator === "danger" ? "error" :
                              simResult.steps[currentSimStep].visual_indicator === "warning" ? "warning" :
                              simResult.steps[currentSimStep].visual_indicator === "success" ? "success" : "info"
                            }
                          />
                          <Chip
                            label={simResult.steps[currentSimStep].phase.toUpperCase()}
                            size="small"
                            variant="outlined"
                          />
                        </Box>
                        <Typography variant="h5" gutterBottom>
                          {simResult.steps[currentSimStep].title}
                        </Typography>
                        <Typography variant="body1" color="text.secondary">
                          {simResult.steps[currentSimStep].description}
                        </Typography>
                      </Box>
                      
                      {/* Technical Detail */}
                      <Paper variant="outlined" sx={{ p: 2, mb: 3, bgcolor: alpha(theme.palette.info.main, 0.05) }}>
                        <Typography variant="subtitle2" sx={{ display: "flex", alignItems: "center", gap: 1, mb: 1 }}>
                          <CodeIcon fontSize="small" /> Technical Detail
                        </Typography>
                        <Typography variant="body2" sx={{ fontFamily: "monospace" }}>
                          {simResult.steps[currentSimStep].technical_detail}
                        </Typography>
                        {simResult.steps[currentSimStep].code_location && (
                          <Typography variant="caption" color="text.secondary" sx={{ mt: 1, display: "block" }}>
                            Location: {simResult.steps[currentSimStep].code_location}
                          </Typography>
                        )}
                      </Paper>
                      
                      {/* Attacker Input */}
                      {simResult.steps[currentSimStep].attacker_input && (
                        <Paper variant="outlined" sx={{ p: 2, mb: 3, bgcolor: alpha(theme.palette.error.main, 0.05), borderColor: "error.main" }}>
                          <Typography variant="subtitle2" sx={{ display: "flex", alignItems: "center", gap: 1, mb: 1, color: "error.main" }}>
                            <DangerIcon fontSize="small" /> Attacker Input
                          </Typography>
                          <Typography variant="body2" sx={{ fontFamily: "monospace", whiteSpace: "pre-wrap" }}>
                            {simResult.steps[currentSimStep].attacker_input}
                          </Typography>
                        </Paper>
                      )}
                      
                      {/* Register State */}
                      {simResult.steps[currentSimStep].registers.length > 0 && (
                        <Box sx={{ mb: 3 }}>
                          <Typography variant="subtitle2" sx={{ display: "flex", alignItems: "center", gap: 1, mb: 1 }}>
                            <MemoryIcon fontSize="small" /> Register State
                          </Typography>
                          <TableContainer component={Paper} variant="outlined">
                            <Table size="small">
                              <TableHead>
                                <TableRow>
                                  <TableCell>Register</TableCell>
                                  <TableCell>Value</TableCell>
                                  <TableCell>Description</TableCell>
                                  <TableCell>Control</TableCell>
                                </TableRow>
                              </TableHead>
                              <TableBody>
                                {simResult.steps[currentSimStep].registers.map((reg, i) => (
                                  <TableRow key={i} sx={{ bgcolor: reg.is_controlled ? alpha(theme.palette.error.main, 0.1) : "transparent" }}>
                                    <TableCell sx={{ fontFamily: "monospace", fontWeight: "bold" }}>{reg.name}</TableCell>
                                    <TableCell sx={{ fontFamily: "monospace" }}>{reg.value}</TableCell>
                                    <TableCell>{reg.description || "-"}</TableCell>
                                    <TableCell>
                                      {reg.is_controlled && (
                                        <Chip label="CONTROLLED" size="small" color="error" />
                                      )}
                                    </TableCell>
                                  </TableRow>
                                ))}
                              </TableBody>
                            </Table>
                          </TableContainer>
                        </Box>
                      )}
                      
                      {/* Memory Regions */}
                      {simResult.steps[currentSimStep].memory_regions.length > 0 && (
                        <Box sx={{ mb: 3 }}>
                          <Typography variant="subtitle2" sx={{ display: "flex", alignItems: "center", gap: 1, mb: 1 }}>
                            <StorageIcon fontSize="small" /> Memory Regions
                          </Typography>
                          <Stack spacing={1}>
                            {simResult.steps[currentSimStep].memory_regions.map((mem, i) => (
                              <Paper
                                key={i}
                                variant="outlined"
                                sx={{
                                  p: 2,
                                  borderColor: mem.state === "corrupted" || mem.state === "overwritten" ? "error.main" :
                                               mem.state === "controlled" ? "warning.main" : "divider",
                                  bgcolor: mem.state === "corrupted" || mem.state === "overwritten" ? alpha(theme.palette.error.main, 0.05) :
                                           mem.state === "controlled" ? alpha(theme.palette.warning.main, 0.05) : "transparent",
                                }}
                              >
                                <Box sx={{ display: "flex", alignItems: "center", justifyContent: "space-between", mb: 1 }}>
                                  <Typography variant="body2" fontWeight="bold">
                                    {mem.label}
                                  </Typography>
                                  <Stack direction="row" spacing={1}>
                                    <Chip
                                      label={mem.state.toUpperCase()}
                                      size="small"
                                      color={
                                        mem.state === "corrupted" || mem.state === "overwritten" ? "error" :
                                        mem.state === "controlled" ? "warning" : "default"
                                      }
                                    />
                                    <Chip label={`${mem.size} bytes`} size="small" variant="outlined" />
                                  </Stack>
                                </Box>
                                <Typography variant="caption" sx={{ fontFamily: "monospace", display: "block" }}>
                                  Address: {mem.address}
                                </Typography>
                                {mem.content_preview && (
                                  <Typography variant="caption" sx={{ fontFamily: "monospace", display: "block", mt: 1, opacity: 0.7 }}>
                                    {mem.content_preview}
                                  </Typography>
                                )}
                              </Paper>
                            ))}
                          </Stack>
                        </Box>
                      )}
                    </Box>
                  )}
                </Box>
                
                {/* Side Panel (Right) */}
                <Box sx={{ width: 300, borderLeft: 1, borderColor: "divider", overflow: "auto", p: 2 }}>
                  {/* Exploit Primitives */}
                  <Typography variant="subtitle2" sx={{ mb: 2, display: "flex", alignItems: "center", gap: 1 }}>
                    <BoltIcon fontSize="small" color="error" /> Exploit Primitives
                  </Typography>
                  <Stack spacing={1} sx={{ mb: 3 }}>
                    {simResult.exploit_primitives.map((prim, i) => (
                      <Paper
                        key={i}
                        variant="outlined"
                        sx={{
                          p: 1.5,
                          opacity: prim.achieved_at_step <= currentSimStep + 1 ? 1 : 0.4,
                          borderColor: prim.achieved_at_step <= currentSimStep + 1 ? "error.main" : "divider",
                        }}
                      >
                        <Typography variant="body2" fontWeight="bold">
                          {prim.name}
                        </Typography>
                        <Typography variant="caption" color="text.secondary">
                          {prim.description}
                        </Typography>
                        <Box sx={{ mt: 1 }}>
                          <Chip
                            label={prim.achieved_at_step <= currentSimStep + 1 ? "ACHIEVED" : `Step ${prim.achieved_at_step}`}
                            size="small"
                            color={prim.achieved_at_step <= currentSimStep + 1 ? "error" : "default"}
                          />
                        </Box>
                      </Paper>
                    ))}
                  </Stack>
                  
                  {/* Mitigations */}
                  <Typography variant="subtitle2" sx={{ mb: 2, display: "flex", alignItems: "center", gap: 1 }}>
                    <ShieldIcon fontSize="small" color="success" /> Mitigations
                  </Typography>
                  <Stack spacing={1} sx={{ mb: 3 }}>
                    {simResult.mitigations.map((mit, i) => (
                      <Paper key={i} variant="outlined" sx={{ p: 1.5 }}>
                        <Box sx={{ display: "flex", alignItems: "center", justifyContent: "space-between", mb: 0.5 }}>
                          <Typography variant="body2" fontWeight="bold">
                            {mit.name}
                          </Typography>
                          <Chip
                            label={mit.effectiveness.toUpperCase()}
                            size="small"
                            color={mit.effectiveness === "blocks" ? "success" : mit.effectiveness === "hinders" ? "warning" : "error"}
                          />
                        </Box>
                        <Typography variant="caption" color="text.secondary">
                          {mit.description}
                        </Typography>
                        {mit.bypass_possible && mit.bypass_technique && (
                          <Alert severity="warning" sx={{ mt: 1, py: 0, "& .MuiAlert-message": { py: 0.5 } }}>
                            <Typography variant="caption">
                              Bypass: {mit.bypass_technique}
                            </Typography>
                          </Alert>
                        )}
                      </Paper>
                    ))}
                  </Stack>
                  
                  {/* Detection Opportunities */}
                  <Typography variant="subtitle2" sx={{ mb: 2, display: "flex", alignItems: "center", gap: 1 }}>
                    <VisibilityIcon fontSize="small" color="info" /> Detection
                  </Typography>
                  <Stack spacing={0.5}>
                    {simResult.detection_opportunities.map((det, i) => (
                      <Typography key={i} variant="caption" sx={{ display: "flex", alignItems: "flex-start", gap: 1 }}>
                        <span>•</span> {det}
                      </Typography>
                    ))}
                  </Stack>
                  
                  {/* Real World Examples */}
                  {simResult.real_world_examples.length > 0 && (
                    <Box sx={{ mt: 3 }}>
                      <Typography variant="subtitle2" sx={{ mb: 1 }}>
                        Similar Attacks
                      </Typography>
                      <Stack direction="row" spacing={0.5} flexWrap="wrap" sx={{ gap: 0.5 }}>
                        {simResult.real_world_examples.map((ex, i) => (
                          <Chip key={i} label={ex} size="small" variant="outlined" />
                        ))}
                      </Stack>
                    </Box>
                  )}
                </Box>
              </Box>
              
              {/* Final Impact Footer */}
              <Box sx={{ p: 2, borderTop: 1, borderColor: "divider", bgcolor: alpha(theme.palette.error.main, 0.05) }}>
                <Typography variant="subtitle2" sx={{ display: "flex", alignItems: "center", gap: 1, mb: 1 }}>
                  <DangerIcon color="error" /> Final Impact
                </Typography>
                <Typography variant="body2">{simResult.final_impact}</Typography>
              </Box>
            </Box>
          )}
        </DialogContent>
      </Dialog>
      
      {/* Symbolic Execution Dialog */}
      <Dialog
        open={symbolicDialogOpen}
        onClose={() => setSymbolicDialogOpen(false)}
        maxWidth="xl"
        fullWidth
        PaperProps={{
          sx: {
            height: "95vh",
            maxHeight: 1100,
          },
        }}
      >
        <DialogTitle sx={{ display: "flex", alignItems: "center", justifyContent: "space-between" }}>
          <Box sx={{ display: "flex", alignItems: "center", gap: 1 }}>
            <CFGIcon color="secondary" />
            <Typography variant="h6">Symbolic Execution Trace</Typography>
            {selectedFunctionForSymbolic && (
              <Chip 
                label={selectedFunctionForSymbolic} 
                size="small"
                sx={{ fontFamily: "monospace", ml: 1 }}
              />
            )}
          </Box>
          <IconButton onClick={() => setSymbolicDialogOpen(false)}>
            <CloseIcon />
          </IconButton>
        </DialogTitle>
        <DialogContent dividers sx={{ p: 0, display: "flex", flexDirection: "column" }}>
          {/* Run Analysis Section */}
          {!symbolicResult && !isRunningSymbolic && (
            <Box sx={{ p: 3 }}>
              <Alert severity="info" sx={{ mb: 3 }}>
                <Typography variant="body2" fontWeight="bold">
                  🔬 AI-Powered Symbolic Execution Analysis
                </Typography>
                <Typography variant="caption">
                  Analyzes execution paths, input constraints, tainted data flow, and dangerous sinks
                </Typography>
              </Alert>
              
              <Paper variant="outlined" sx={{ p: 2, mb: 3 }}>
                <Typography variant="subtitle2" gutterBottom>Code to Analyze</Typography>
                <Box sx={{ 
                  maxHeight: 250, 
                  overflow: "auto", 
                  bgcolor: alpha(theme.palette.common.black, 0.7),
                  borderRadius: 1,
                  p: 2,
                }}>
                  <Typography
                    component="pre"
                    sx={{
                      fontFamily: "monospace",
                      fontSize: "0.75rem",
                      color: "common.white",
                      whiteSpace: "pre-wrap",
                      m: 0,
                    }}
                  >
                    {selectedCodeForSymbolic}
                  </Typography>
                </Box>
              </Paper>
              
              <Button
                variant="contained"
                color="secondary"
                size="large"
                startIcon={<CFGIcon />}
                onClick={runSymbolicTrace}
                fullWidth
                sx={{
                  background: "linear-gradient(135deg, #9333ea 0%, #6366f1 100%)",
                  py: 1.5,
                }}
              >
                Run Symbolic Trace Analysis
              </Button>
            </Box>
          )}
          
          {/* Loading State */}
          {isRunningSymbolic && (
            <Box sx={{ flex: 1, display: "flex", flexDirection: "column", alignItems: "center", justifyContent: "center", p: 4 }}>
              <CircularProgress size={60} color="secondary" sx={{ mb: 3 }} />
              <Typography variant="h6" gutterBottom>Performing Symbolic Execution...</Typography>
              <Typography variant="body2" color="text.secondary" textAlign="center">
                AI is tracing execution paths, computing constraints, and identifying taint flows
              </Typography>
            </Box>
          )}
          
          {/* Error State */}
          {symbolicError && (
            <Box sx={{ p: 3 }}>
              <Alert severity="error" sx={{ mb: 2 }}>
                {symbolicError}
              </Alert>
              <Button variant="outlined" onClick={() => setSymbolicError(null)}>
                Try Again
              </Button>
            </Box>
          )}
          
          {/* Symbolic Results */}
          {symbolicResult && (
            <Box sx={{ flex: 1, overflow: "hidden", display: "flex", flexDirection: "column" }}>
              {/* Summary Header */}
              <Box sx={{ p: 2, borderBottom: 1, borderColor: "divider", bgcolor: alpha(theme.palette.secondary.main, 0.05) }}>
                <Grid container spacing={2} alignItems="center">
                  <Grid item xs={12} md={8}>
                    <Typography variant="h6">{symbolicResult.function_name}</Typography>
                    <Typography variant="body2" color="text.secondary">
                      {symbolicResult.analysis_summary}
                    </Typography>
                  </Grid>
                  <Grid item xs={12} md={4}>
                    <Stack direction="row" spacing={1} justifyContent="flex-end" flexWrap="wrap">
                      <Chip
                        icon={<CFGIcon />}
                        label={`${symbolicResult.basic_blocks.length} Blocks`}
                        size="small"
                      />
                      <Chip
                        icon={<TimelineIcon />}
                        label={`${symbolicResult.paths.length} Paths`}
                        size="small"
                      />
                      <Chip
                        icon={<BugReportIcon />}
                        label={`${symbolicResult.dangerous_sinks_reached.length} Sinks`}
                        size="small"
                        color={symbolicResult.dangerous_sinks_reached.length > 0 ? "error" : "default"}
                      />
                    </Stack>
                  </Grid>
                </Grid>
              </Box>
              
              {/* Tabs */}
              <Tabs
                value={symbolicViewTab}
                onChange={(_: React.SyntheticEvent, v: number) => setSymbolicViewTab(v)}
                sx={{ borderBottom: 1, borderColor: "divider", px: 2 }}
              >
                <Tab icon={<CFGIcon />} label="CFG" iconPosition="start" />
                <Tab icon={<TimelineIcon />} label="Execution Paths" iconPosition="start" />
                <Tab icon={<BugReportIcon />} label="Taint Analysis" iconPosition="start" />
                <Tab icon={<CodeIcon />} label="Enhanced Code" iconPosition="start" />
              </Tabs>
              
              {/* Tab Content */}
              <Box sx={{ flex: 1, overflow: "auto", p: 2 }}>
                {/* CFG Tab */}
                {symbolicViewTab === 0 && (
                  <Box>
                    <Typography variant="subtitle2" sx={{ mb: 2, display: "flex", alignItems: "center", gap: 1 }}>
                      <CFGIcon fontSize="small" /> Control Flow Graph - {symbolicResult.basic_blocks.length} Basic Blocks
                    </Typography>
                    <Grid container spacing={2}>
                      {symbolicResult.basic_blocks.map((block: BasicBlock) => (
                        <Grid item xs={12} md={6} lg={4} key={block.id}>
                          <Paper
                            variant="outlined"
                            sx={{
                              p: 2,
                              cursor: "pointer",
                              borderColor: selectedBlock?.id === block.id ? "secondary.main" : 
                                          block.tainted_at_entry.length > 0 ? "warning.main" :
                                          block.is_reachable === false ? "grey.500" : "divider",
                              bgcolor: selectedBlock?.id === block.id ? alpha(theme.palette.secondary.main, 0.1) :
                                      block.tainted_at_entry.length > 0 ? alpha(theme.palette.warning.main, 0.05) :
                                      block.is_reachable === false ? alpha(theme.palette.grey[500], 0.05) : "transparent",
                              opacity: block.is_reachable === false ? 0.6 : 1,
                              "&:hover": {
                                borderColor: "secondary.main",
                              },
                            }}
                            onClick={() => setSelectedBlock(block)}
                          >
                            <Box sx={{ display: "flex", alignItems: "center", justifyContent: "space-between", mb: 1 }}>
                              <Typography variant="subtitle2" sx={{ fontFamily: "monospace" }}>
                                {block.start_address}
                              </Typography>
                              <Stack direction="row" spacing={0.5}>
                                {block.tainted_at_entry.length > 0 && (
                                  <Chip label="TAINTED" size="small" color="warning" />
                                )}
                                {block.is_entry && (
                                  <Chip label="ENTRY" size="small" color="success" />
                                )}
                                {block.is_exit && (
                                  <Chip label="EXIT" size="small" color="info" />
                                )}
                                {block.is_reachable === false && (
                                  <Chip label="DEAD" size="small" />
                                )}
                              </Stack>
                            </Box>
                            <Box sx={{ 
                              bgcolor: alpha(theme.palette.common.black, 0.7),
                              borderRadius: 1,
                              p: 1,
                              mb: 1,
                              maxHeight: 100,
                              overflow: "auto",
                            }}>
                              <Typography
                                component="pre"
                                sx={{
                                  fontFamily: "monospace",
                                  fontSize: "0.65rem",
                                  color: "common.white",
                                  whiteSpace: "pre-wrap",
                                  m: 0,
                                }}
                              >
                                {block.code_preview}
                              </Typography>
                            </Box>
                            <Typography variant="caption" color="text.secondary" sx={{ display: "block" }}>
                              {block.instructions_count} instructions
                            </Typography>
                            {block.successors.length > 0 && (
                              <Typography variant="caption" color="text.secondary">
                                → {block.successors.join(", ")}
                              </Typography>
                            )}
                          </Paper>
                        </Grid>
                      ))}
                    </Grid>
                    
                    {/* Selected Block Details */}
                    {selectedBlock && (
                      <Paper variant="outlined" sx={{ mt: 3, p: 2 }}>
                        <Typography variant="h6" gutterBottom>Block Details: {selectedBlock.start_address}</Typography>
                        <Grid container spacing={2}>
                          <Grid item xs={12} md={6}>
                            <Typography variant="subtitle2" gutterBottom>Code Preview</Typography>
                            <Box sx={{ 
                              bgcolor: alpha(theme.palette.common.black, 0.8),
                              borderRadius: 1,
                              p: 2,
                              maxHeight: 300,
                              overflow: "auto",
                            }}>
                              <Typography
                                component="pre"
                                sx={{
                                  fontFamily: "monospace",
                                  fontSize: "0.75rem",
                                  color: "common.white",
                                  whiteSpace: "pre-wrap",
                                  m: 0,
                                }}
                              >
                                {selectedBlock.code_preview}
                              </Typography>
                            </Box>
                          </Grid>
                          <Grid item xs={12} md={6}>
                            <Typography variant="subtitle2" gutterBottom>Block Info</Typography>
                            <Stack spacing={1}>
                              <Paper variant="outlined" sx={{ p: 1 }}>
                                <Typography variant="caption" color="text.secondary">Address Range</Typography>
                                <Typography variant="body2" sx={{ fontFamily: "monospace" }}>
                                  {selectedBlock.start_address} - {selectedBlock.end_address}
                                </Typography>
                              </Paper>
                              <Paper variant="outlined" sx={{ p: 1 }}>
                                <Typography variant="caption" color="text.secondary">Instructions</Typography>
                                <Typography variant="body2">{selectedBlock.instructions_count} instructions</Typography>
                              </Paper>
                              {selectedBlock.tainted_at_entry.length > 0 && (
                                <Paper variant="outlined" sx={{ p: 1, borderColor: "warning.main" }}>
                                  <Typography variant="caption" color="warning.main">Tainted Variables at Entry</Typography>
                                  {selectedBlock.tainted_at_entry.map((v: string, i: number) => (
                                    <Chip key={i} label={v} size="small" color="warning" sx={{ mr: 0.5, mt: 0.5 }} />
                                  ))}
                                </Paper>
                              )}
                              {selectedBlock.predecessors.length > 0 && (
                                <Paper variant="outlined" sx={{ p: 1 }}>
                                  <Typography variant="caption" color="text.secondary">Predecessors</Typography>
                                  <Typography variant="body2" sx={{ fontFamily: "monospace" }}>
                                    {selectedBlock.predecessors.join(", ")}
                                  </Typography>
                                </Paper>
                              )}
                              {selectedBlock.dominates.length > 0 && (
                                <Paper variant="outlined" sx={{ p: 1 }}>
                                  <Typography variant="caption" color="text.secondary">Dominates</Typography>
                                  <Typography variant="body2" sx={{ fontFamily: "monospace" }}>
                                    {selectedBlock.dominates.join(", ")}
                                  </Typography>
                                </Paper>
                              )}
                            </Stack>
                          </Grid>
                        </Grid>
                      </Paper>
                    )}
                  </Box>
                )}
                
                {/* Execution Paths Tab */}
                {symbolicViewTab === 1 && (
                  <Box>
                    <Typography variant="subtitle2" sx={{ mb: 2 }}>
                      {symbolicResult.paths.length} Execution Paths Found ({symbolicResult.feasible_paths} feasible, {symbolicResult.vulnerable_paths} vulnerable)
                    </Typography>
                    <Grid container spacing={2}>
                      <Grid item xs={12} md={4}>
                        <Typography variant="caption" color="text.secondary" gutterBottom sx={{ display: "block", mb: 1 }}>
                          Select a path to view details
                        </Typography>
                        <Stack spacing={1}>
                          {symbolicResult.paths.map((path: ExecutionPath, idx: number) => (
                            <Paper
                              key={path.path_id}
                              variant="outlined"
                              sx={{
                                p: 1.5,
                                cursor: "pointer",
                                borderColor: selectedPath?.path_id === path.path_id ? "secondary.main" :
                                            path.leads_to_vulnerability ? "error.main" : "divider",
                                bgcolor: selectedPath?.path_id === path.path_id ? alpha(theme.palette.secondary.main, 0.1) :
                                        path.leads_to_vulnerability ? alpha(theme.palette.error.main, 0.05) : "transparent",
                                "&:hover": { borderColor: "secondary.main" },
                              }}
                              onClick={() => setSelectedPath(path)}
                            >
                              <Box sx={{ display: "flex", alignItems: "center", justifyContent: "space-between" }}>
                                <Typography variant="body2" fontWeight="bold">
                                  Path {idx + 1}
                                </Typography>
                                <Stack direction="row" spacing={0.5}>
                                  {path.is_feasible && <Chip label="Feasible" size="small" color="success" />}
                                  {path.leads_to_vulnerability && <Chip label="Vulnerable" size="small" color="error" />}
                                </Stack>
                              </Box>
                              <Typography variant="caption" color="text.secondary">
                                {path.blocks.length} blocks • {path.constraints.length} constraints • {Math.round(path.probability * 100)}% prob
                              </Typography>
                            </Paper>
                          ))}
                        </Stack>
                      </Grid>
                      <Grid item xs={12} md={8}>
                        {selectedPath ? (
                          <Paper variant="outlined" sx={{ p: 2 }}>
                            <Typography variant="h6" gutterBottom>
                              Path: {selectedPath.path_id}
                            </Typography>
                            
                            {/* Path Description */}
                            {selectedPath.path_description && (
                              <Alert severity={selectedPath.leads_to_vulnerability ? "error" : "info"} sx={{ mb: 2 }}>
                                {selectedPath.path_description}
                              </Alert>
                            )}
                            
                            {/* Block Sequence */}
                            <Typography variant="subtitle2" gutterBottom>Block Sequence</Typography>
                            <Box sx={{ 
                              display: "flex", 
                              flexWrap: "wrap", 
                              gap: 1, 
                              mb: 2,
                              p: 1.5,
                              bgcolor: alpha(theme.palette.common.black, 0.05),
                              borderRadius: 1,
                            }}>
                              {selectedPath.blocks.map((blockId: string, i: number) => (
                                <Box key={i} sx={{ display: "flex", alignItems: "center" }}>
                                  <Chip
                                    label={blockId}
                                    size="small"
                                    sx={{ fontFamily: "monospace" }}
                                  />
                                  {i < selectedPath.blocks.length - 1 && (
                                    <Typography sx={{ mx: 0.5 }}>→</Typography>
                                  )}
                                </Box>
                              ))}
                            </Box>
                            
                            {/* Path Constraints */}
                            {selectedPath.constraints.length > 0 && (
                              <>
                                <Typography variant="subtitle2" gutterBottom>Path Constraints</Typography>
                                <Stack spacing={1} sx={{ mb: 2 }}>
                                  {selectedPath.constraints.map((constraint: PathConstraint, i: number) => (
                                    <Paper key={i} variant="outlined" sx={{ p: 1.5 }}>
                                      <Box sx={{ display: "flex", alignItems: "center", justifyContent: "space-between", mb: 0.5 }}>
                                        <Typography variant="caption" color="text.secondary">
                                          {constraint.variable} {constraint.operator}
                                        </Typography>
                                        {constraint.is_satisfiable !== undefined && (
                                          <Chip
                                            label={constraint.is_satisfiable ? "SAT" : "UNSAT"}
                                            size="small"
                                            color={constraint.is_satisfiable ? "success" : "error"}
                                          />
                                        )}
                                      </Box>
                                      <Typography variant="body2" sx={{ fontFamily: "monospace" }}>
                                        {constraint.variable} {constraint.operator} {constraint.value}
                                      </Typography>
                                      <Typography variant="caption" color="text.secondary" sx={{ display: "block", mt: 0.5 }}>
                                        {constraint.description}
                                      </Typography>
                                    </Paper>
                                  ))}
                                </Stack>
                              </>
                            )}
                            
                            {/* Interesting Operations */}
                            {selectedPath.interesting_operations.length > 0 && (
                              <>
                                <Typography variant="subtitle2" gutterBottom>Interesting Operations</Typography>
                                <Stack direction="row" spacing={0.5} flexWrap="wrap" sx={{ mb: 2 }}>
                                  {selectedPath.interesting_operations.map((op: string, i: number) => (
                                    <Chip key={i} label={op} size="small" variant="outlined" sx={{ mb: 0.5 }} />
                                  ))}
                                </Stack>
                              </>
                            )}
                            
                            {/* Tainted at End */}
                            {selectedPath.tainted_at_end.length > 0 && (
                              <Box>
                                <Typography variant="subtitle2" gutterBottom>Tainted Variables at Path End</Typography>
                                <Stack spacing={1}>
                                  {selectedPath.tainted_at_end.map((tv: TaintedVariable, i: number) => (
                                    <Paper key={i} variant="outlined" sx={{ p: 1, borderColor: "warning.main" }}>
                                      <Typography variant="body2" fontWeight="bold">{tv.name}</Typography>
                                      <Typography variant="caption" color="text.secondary">
                                        Source: {tv.source} ({tv.taint_type})
                                      </Typography>
                                    </Paper>
                                  ))}
                                </Stack>
                              </Box>
                            )}
                          </Paper>
                        ) : (
                          <Box sx={{ display: "flex", alignItems: "center", justifyContent: "center", height: "100%", opacity: 0.5 }}>
                            <Typography>Select a path to view details</Typography>
                          </Box>
                        )}
                      </Grid>
                    </Grid>
                  </Box>
                )}
                
                {/* Taint Analysis Tab */}
                {symbolicViewTab === 2 && (
                  <Box>
                    <Grid container spacing={3}>
                      {/* Tainted Variables */}
                      <Grid item xs={12} md={6}>
                        <Typography variant="subtitle2" sx={{ mb: 2, display: "flex", alignItems: "center", gap: 1 }}>
                          <BugReportIcon fontSize="small" color="warning" /> 
                          Tainted Variables ({symbolicResult.tainted_variables.length})
                        </Typography>
                        <Stack spacing={1}>
                          {symbolicResult.tainted_variables.map((tvar: TaintedVariable, idx: number) => (
                            <Paper
                              key={idx}
                              variant="outlined"
                              sx={{
                                p: 2,
                                borderColor: tvar.reaches_sink ? "error.main" : "warning.main",
                                bgcolor: tvar.reaches_sink ? alpha(theme.palette.error.main, 0.05) : alpha(theme.palette.warning.main, 0.05),
                              }}
                            >
                              <Box sx={{ display: "flex", alignItems: "center", justifyContent: "space-between", mb: 1 }}>
                                <Typography variant="body1" fontWeight="bold" sx={{ fontFamily: "monospace" }}>
                                  {tvar.name}
                                </Typography>
                                <Stack direction="row" spacing={0.5}>
                                  <Chip label={tvar.taint_type} size="small" color="warning" />
                                  {tvar.reaches_sink && <Chip label={`→ ${tvar.sink_name || "SINK"}`} size="small" color="error" />}
                                </Stack>
                              </Box>
                              <Typography variant="caption" color="text.secondary" display="block">
                                Source: {tvar.source}
                              </Typography>
                              {tvar.propagation_chain.length > 0 && (
                                <Box sx={{ mt: 1 }}>
                                  <Typography variant="caption" color="text.secondary">Propagation:</Typography>
                                  <Box sx={{ display: "flex", flexWrap: "wrap", gap: 0.5, mt: 0.5 }}>
                                    {tvar.propagation_chain.map((step: string, i: number) => (
                                      <Box key={i} sx={{ display: "flex", alignItems: "center" }}>
                                        <Chip label={step} size="small" variant="outlined" sx={{ fontFamily: "monospace", fontSize: "0.65rem" }} />
                                        {i < tvar.propagation_chain.length - 1 && <Typography sx={{ mx: 0.5, fontSize: "0.7rem" }}>→</Typography>}
                                      </Box>
                                    ))}
                                  </Box>
                                </Box>
                              )}
                            </Paper>
                          ))}
                          {symbolicResult.tainted_variables.length === 0 && (
                            <Alert severity="success">No tainted user-controlled variables detected</Alert>
                          )}
                        </Stack>
                      </Grid>
                      
                      {/* Dangerous Sinks */}
                      <Grid item xs={12} md={6}>
                        <Typography variant="subtitle2" sx={{ mb: 2, display: "flex", alignItems: "center", gap: 1 }}>
                          <DangerIcon fontSize="small" color="error" /> 
                          Dangerous Sinks ({symbolicResult.dangerous_sinks_reached.length})
                        </Typography>
                        <Stack spacing={1}>
                          {symbolicResult.dangerous_sinks_reached.map((sink: DangerousSink, idx: number) => (
                            <Paper
                              key={idx}
                              variant="outlined"
                              sx={{
                                p: 2,
                                borderColor: sink.reachable_from.length > 0 ? "error.main" : "grey.500",
                                bgcolor: sink.reachable_from.length > 0 ? alpha(theme.palette.error.main, 0.1) : "transparent",
                                opacity: sink.reachable_from.length > 0 ? 1 : 0.6,
                              }}
                            >
                              <Box sx={{ display: "flex", alignItems: "center", justifyContent: "space-between", mb: 1 }}>
                                <Typography variant="body1" fontWeight="bold" sx={{ fontFamily: "monospace" }}>
                                  {sink.function_name}
                                </Typography>
                                <Stack direction="row" spacing={0.5}>
                                  <Chip label={sink.sink_type} size="small" color="error" />
                                  <Chip label={sink.severity.toUpperCase()} size="small" color={
                                    sink.severity === "critical" ? "error" : 
                                    sink.severity === "high" ? "warning" : "default"
                                  } />
                                </Stack>
                              </Box>
                              <Typography variant="caption" color="text.secondary" display="block">
                                Address: {sink.address}
                              </Typography>
                              <Typography variant="body2" sx={{ mt: 1 }}>
                                {sink.description}
                              </Typography>
                              {sink.tainted_arguments.length > 0 && (
                                <Alert severity="error" sx={{ mt: 1, py: 0.5 }}>
                                  <Typography variant="caption">
                                    Tainted arguments: {sink.tainted_arguments.join(", ")}
                                  </Typography>
                                </Alert>
                              )}
                              {sink.cwe_id && (
                                <Chip label={sink.cwe_id} size="small" variant="outlined" sx={{ mt: 1 }} />
                              )}
                              {sink.reachable_from.length > 0 && (
                                <Box sx={{ mt: 1 }}>
                                  <Typography variant="caption" color="text.secondary">Reachable from:</Typography>
                                  <Typography variant="caption" sx={{ display: "block", fontFamily: "monospace", ml: 1 }}>
                                    {sink.reachable_from.join(", ")}
                                  </Typography>
                                </Box>
                              )}
                            </Paper>
                          ))}
                          {symbolicResult.dangerous_sinks_reached.length === 0 && (
                            <Alert severity="success">No dangerous sinks detected in this function</Alert>
                          )}
                        </Stack>
                      </Grid>
                    </Grid>
                  </Box>
                )}
                
                {/* Enhanced Code Tab */}
                {symbolicViewTab === 3 && (
                  <Box>
                    {!enhancedCodeResult && !isEnhancingCode && (
                      <Box sx={{ textAlign: "center", py: 4 }}>
                        <Typography variant="h6" gutterBottom>
                          Enhance Code with Symbolic Data
                        </Typography>
                        <Typography variant="body2" color="text.secondary" sx={{ mb: 3 }}>
                          Combine AI decompilation enhancement with symbolic execution results to annotate code with:
                        </Typography>
                        <Stack direction="row" spacing={2} justifyContent="center" sx={{ mb: 3 }}>
                          <Chip icon={<TimelineIcon />} label="Path Reachability" />
                          <Chip icon={<BugReportIcon />} label="Taint Annotations" />
                          <Chip icon={<InfoIcon />} label="Constraint Comments" />
                        </Stack>
                        <Button
                          variant="contained"
                          color="secondary"
                          size="large"
                          startIcon={<CodeIcon />}
                          onClick={runEnhancedCode}
                          sx={{
                            background: "linear-gradient(135deg, #9333ea 0%, #6366f1 100%)",
                          }}
                        >
                          Generate Enhanced Code
                        </Button>
                      </Box>
                    )}
                    
                    {isEnhancingCode && (
                      <Box sx={{ display: "flex", flexDirection: "column", alignItems: "center", justifyContent: "center", py: 6 }}>
                        <CircularProgress size={50} color="secondary" sx={{ mb: 2 }} />
                        <Typography>Enhancing code with symbolic execution data...</Typography>
                      </Box>
                    )}
                    
                    {enhancedCodeResult && (
                      <Box>
                        {/* Summary Alert */}
                        <Alert 
                          severity={enhancedCodeResult.vulnerability_paths_highlighted > 0 ? "error" : "info"}
                          sx={{ mb: 2 }}
                        >
                          <Typography variant="body2" fontWeight="bold">Enhancement Summary</Typography>
                          <Typography variant="body2">
                            {enhancedCodeResult.function_purpose}
                            {enhancedCodeResult.vulnerability_paths_highlighted > 0 && 
                              ` (${enhancedCodeResult.vulnerability_paths_highlighted} vulnerable paths, ${enhancedCodeResult.tainted_sinks_marked} tainted sinks)`}
                          </Typography>
                        </Alert>
                        
                        {/* Stats */}
                        <Stack direction="row" spacing={2} sx={{ mb: 2 }}>
                          <Chip
                            label={`${enhancedCodeResult.taint_annotations?.length || 0} Taint Annotations`}
                            color="warning"
                          />
                          <Chip
                            label={`${enhancedCodeResult.path_annotations?.length || 0} Path Annotations`}
                            color="info"
                          />
                          <Chip
                            label={`${enhancedCodeResult.constraint_annotations?.length || 0} Constraint Annotations`}
                            color="secondary"
                          />
                          <Chip
                            label={`Quality: ${enhancedCodeResult.integration_quality.toUpperCase()}`}
                            color={
                              enhancedCodeResult.integration_quality === "excellent" ? "success" :
                              enhancedCodeResult.integration_quality === "good" ? "info" :
                              enhancedCodeResult.integration_quality === "fair" ? "warning" : "default"
                            }
                          />
                        </Stack>
                        
                        {/* Enhanced Code */}
                        <Paper 
                          variant="outlined" 
                          sx={{ 
                            p: 0, 
                            bgcolor: alpha(theme.palette.common.black, 0.85),
                            position: "relative",
                          }}
                        >
                          <Box sx={{ position: "absolute", top: 8, right: 8, zIndex: 1 }}>
                            <IconButton
                              size="small"
                              onClick={() => copyToClipboard(enhancedCodeResult.enhanced_code)}
                              sx={{ color: "common.white" }}
                            >
                              <CopyIcon fontSize="small" />
                            </IconButton>
                          </Box>
                          <Box sx={{ maxHeight: 500, overflow: "auto", p: 2 }}>
                            <Typography
                              component="pre"
                              sx={{
                                fontFamily: "monospace",
                                fontSize: "0.8rem",
                                color: "common.white",
                                whiteSpace: "pre-wrap",
                                m: 0,
                              }}
                            >
                              {enhancedCodeResult.enhanced_code}
                            </Typography>
                          </Box>
                        </Paper>
                        
                        {/* Annotations Legend */}
                        {(enhancedCodeResult.taint_annotations?.length > 0 || 
                          enhancedCodeResult.path_annotations?.length > 0) && (
                          <Accordion sx={{ mt: 2 }}>
                            <AccordionSummary expandIcon={<ExpandMoreIcon />}>
                              <Typography>View Annotation Details</Typography>
                            </AccordionSummary>
                            <AccordionDetails>
                              <Grid container spacing={2}>
                                {enhancedCodeResult.taint_annotations?.length > 0 && (
                                  <Grid item xs={12} md={6}>
                                    <Typography variant="subtitle2" color="warning.main" gutterBottom>
                                      Taint Annotations
                                    </Typography>
                                    <Stack spacing={0.5}>
                                      {enhancedCodeResult.taint_annotations.map((ann, i) => (
                                        <Typography key={i} variant="caption" sx={{ fontFamily: "monospace" }}>
                                          Line {ann.line}: {ann.variable} ({ann.taint_source}) - {ann.annotation}
                                        </Typography>
                                      ))}
                                    </Stack>
                                  </Grid>
                                )}
                                {enhancedCodeResult.path_annotations?.length > 0 && (
                                  <Grid item xs={12} md={6}>
                                    <Typography variant="subtitle2" color="info.main" gutterBottom>
                                      Path Annotations
                                    </Typography>
                                    <Stack spacing={0.5}>
                                      {enhancedCodeResult.path_annotations.map((ann, i) => (
                                        <Typography key={i} variant="caption" sx={{ fontFamily: "monospace" }}>
                                          Line {ann.line}: {ann.paths.join(", ")} - {ann.annotation}
                                        </Typography>
                                      ))}
                                    </Stack>
                                  </Grid>
                                )}
                              </Grid>
                            </AccordionDetails>
                          </Accordion>
                        )}
                      </Box>
                    )}
                  </Box>
                )}
              </Box>
            </Box>
          )}
        </DialogContent>
      </Dialog>
    </Box>
  );
}

export default VulnerabilityHunter;
