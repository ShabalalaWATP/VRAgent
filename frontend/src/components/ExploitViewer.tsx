/**
 * Exploit Viewer Component
 *
 * Displays synthesized exploits with:
 * - ROP/JOP gadgets found
 * - Exploit skeleton code with syntax highlighting
 * - Bypass strategies
 * - Download functionality
 * - Verification status
 */

import React, { useState, useMemo } from 'react';
import {
  Box,
  Card,
  CardContent,
  Typography,
  Button,
  Grid,
  Chip,
  Alert,
  Paper,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  Accordion,
  AccordionSummary,
  AccordionDetails,
  Tabs,
  Tab,
  IconButton,
  Tooltip,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  TextField,
  InputAdornment,
  Divider,
  LinearProgress,
  alpha,
  useTheme,
  List,
  ListItem,
  ListItemIcon,
  ListItemText,
} from '@mui/material';
import {
  Download,
  Code,
  Security,
  BugReport,
  ExpandMore,
  ContentCopy,
  CheckCircle,
  Warning,
  Error as ErrorIcon,
  Info,
  PlayArrow,
  Search,
  Memory,
  Build,
  Shield,
  Lightbulb,
  Close,
  OpenInNew,
  Terminal,
  FilterList,
} from '@mui/icons-material';
import { Light as SyntaxHighlighter } from 'react-syntax-highlighter';
import python from 'react-syntax-highlighter/dist/esm/languages/hljs/python';
import { atomOneDark } from 'react-syntax-highlighter/dist/esm/styles/hljs';

// Register Python language
SyntaxHighlighter.registerLanguage('python', python);

// Types
interface RopGadget {
  address: number;
  instructions: string;
  bytes: string;
  gadget_type: string;
  category: string;
  controllable_regs: string[];
  quality_score: number;
}

interface BypassStrategy {
  mitigation: string;
  technique: string;
  description: string;
  requirements: string[];
  success_probability: number;
  example_code?: string;
}

interface ExploitConstraint {
  name: string;
  description: string;
  satisfied: boolean;
  how_to_satisfy?: string;
}

interface ExploitSkeleton {
  language: string;
  code: string;
  description: string;
  placeholders: Record<string, string>;
  dependencies: string[];
  usage_instructions: string;
}

interface ExploitSynthesisResult {
  crash_id: string;
  exploitability: string;
  primitives_available: string[];
  gadgets_found: RopGadget[];
  exploit_skeleton?: ExploitSkeleton;
  bypass_suggestions: BypassStrategy[];
  ai_reasoning: string;
  confidence: number;
  synthesis_time_ms: number;
}

interface VerificationResult {
  status: string;
  goal_achieved: boolean;
  crash_info?: {
    signal: number;
    signal_name: string;
    crash_address?: number;
  };
  improvement_suggestions: string[];
}

interface ExploitViewerProps {
  synthesisResult: ExploitSynthesisResult;
  verificationResult?: VerificationResult;
  targetBinary?: string;
  onVerify?: () => void;
  onDownload?: () => void;
  isVerifying?: boolean;
}

// Tab Panel component
interface TabPanelProps {
  children?: React.ReactNode;
  index: number;
  value: number;
}

function TabPanel(props: TabPanelProps) {
  const { children, value, index, ...other } = props;
  return (
    <div role="tabpanel" hidden={value !== index} {...other}>
      {value === index && <Box sx={{ p: 2 }}>{children}</Box>}
    </div>
  );
}

export default function ExploitViewer({
  synthesisResult,
  verificationResult,
  targetBinary,
  onVerify,
  onDownload,
  isVerifying = false,
}: ExploitViewerProps) {
  const theme = useTheme();
  const [activeTab, setActiveTab] = useState(0);
  const [gadgetFilter, setGadgetFilter] = useState('');
  const [gadgetCategory, setGadgetCategory] = useState('all');
  const [codeDialogOpen, setCodeDialogOpen] = useState(false);
  const [copied, setCopied] = useState(false);

  // Filter gadgets
  const filteredGadgets = useMemo(() => {
    return synthesisResult.gadgets_found.filter((gadget) => {
      const matchesSearch =
        !gadgetFilter ||
        gadget.instructions.toLowerCase().includes(gadgetFilter.toLowerCase()) ||
        `0x${gadget.address.toString(16)}`.includes(gadgetFilter.toLowerCase());

      const matchesCategory =
        gadgetCategory === 'all' || gadget.category === gadgetCategory;

      return matchesSearch && matchesCategory;
    });
  }, [synthesisResult.gadgets_found, gadgetFilter, gadgetCategory]);

  // Get unique categories
  const categories = useMemo(() => {
    const cats = new Set(synthesisResult.gadgets_found.map((g) => g.category));
    return ['all', ...Array.from(cats)];
  }, [synthesisResult.gadgets_found]);

  // Copy to clipboard
  const handleCopy = (text: string) => {
    navigator.clipboard.writeText(text);
    setCopied(true);
    setTimeout(() => setCopied(false), 2000);
  };

  // Download exploit
  const handleDownload = () => {
    if (!synthesisResult.exploit_skeleton) return;

    const blob = new Blob([synthesisResult.exploit_skeleton.code], {
      type: 'text/x-python',
    });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `exploit_${synthesisResult.crash_id}.py`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    onDownload?.();
  };

  // Get exploitability color
  const getExploitabilityColor = (score: string) => {
    switch (score.toLowerCase()) {
      case 'exploitable':
        return theme.palette.error.main;
      case 'probably_exploitable':
        return theme.palette.warning.main;
      case 'probably_not_exploitable':
        return theme.palette.info.main;
      case 'not_exploitable':
        return theme.palette.success.main;
      default:
        return theme.palette.grey[500];
    }
  };

  // Get verification status icon
  const getVerificationIcon = () => {
    if (!verificationResult) return null;

    switch (verificationResult.status) {
      case 'success':
        return <CheckCircle color="success" />;
      case 'partial':
        return <Warning color="warning" />;
      case 'failed':
        return <ErrorIcon color="error" />;
      default:
        return <Info color="info" />;
    }
  };

  return (
    <Card
      sx={{
        background: `linear-gradient(135deg, ${alpha(theme.palette.error.dark, 0.1)} 0%, ${alpha(theme.palette.background.paper, 0.95)} 100%)`,
        border: `1px solid ${alpha(theme.palette.error.main, 0.3)}`,
      }}
    >
      <CardContent>
        {/* Header */}
        <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', mb: 2 }}>
          <Box sx={{ display: 'flex', alignItems: 'center', gap: 2 }}>
            <Security sx={{ fontSize: 32, color: theme.palette.error.main }} />
            <Box>
              <Typography variant="h6" sx={{ fontWeight: 600 }}>
                Exploit Synthesis Result
              </Typography>
              <Typography variant="caption" color="text.secondary">
                Crash ID: {synthesisResult.crash_id} | Synthesized in{' '}
                {synthesisResult.synthesis_time_ms}ms
              </Typography>
            </Box>
          </Box>

          <Box sx={{ display: 'flex', gap: 1 }}>
            {onVerify && (
              <Button
                variant="outlined"
                color="warning"
                startIcon={isVerifying ? null : <PlayArrow />}
                onClick={onVerify}
                disabled={isVerifying}
              >
                {isVerifying ? 'Verifying...' : 'Verify Exploit'}
              </Button>
            )}
            <Button
              variant="contained"
              color="error"
              startIcon={<Download />}
              onClick={handleDownload}
              disabled={!synthesisResult.exploit_skeleton}
            >
              Download Exploit
            </Button>
          </Box>
        </Box>

        {isVerifying && <LinearProgress sx={{ mb: 2 }} color="warning" />}

        {/* Status Overview */}
        <Grid container spacing={2} sx={{ mb: 3 }}>
          <Grid item xs={12} md={3}>
            <Paper
              sx={{
                p: 2,
                textAlign: 'center',
                background: alpha(getExploitabilityColor(synthesisResult.exploitability), 0.1),
                border: `1px solid ${alpha(getExploitabilityColor(synthesisResult.exploitability), 0.3)}`,
              }}
            >
              <Typography variant="overline" color="text.secondary">
                Exploitability
              </Typography>
              <Typography
                variant="h6"
                sx={{
                  color: getExploitabilityColor(synthesisResult.exploitability),
                  fontWeight: 600,
                  textTransform: 'uppercase',
                }}
              >
                {synthesisResult.exploitability.replace(/_/g, ' ')}
              </Typography>
            </Paper>
          </Grid>

          <Grid item xs={12} md={3}>
            <Paper sx={{ p: 2, textAlign: 'center' }}>
              <Typography variant="overline" color="text.secondary">
                Gadgets Found
              </Typography>
              <Typography variant="h6" sx={{ fontWeight: 600 }}>
                {synthesisResult.gadgets_found.length}
              </Typography>
            </Paper>
          </Grid>

          <Grid item xs={12} md={3}>
            <Paper sx={{ p: 2, textAlign: 'center' }}>
              <Typography variant="overline" color="text.secondary">
                Confidence
              </Typography>
              <Typography variant="h6" sx={{ fontWeight: 600 }}>
                {(synthesisResult.confidence * 100).toFixed(0)}%
              </Typography>
            </Paper>
          </Grid>

          <Grid item xs={12} md={3}>
            <Paper sx={{ p: 2, textAlign: 'center' }}>
              <Typography variant="overline" color="text.secondary">
                Verification
              </Typography>
              <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 1 }}>
                {getVerificationIcon()}
                <Typography variant="h6" sx={{ fontWeight: 600 }}>
                  {verificationResult?.status || 'Pending'}
                </Typography>
              </Box>
            </Paper>
          </Grid>
        </Grid>

        {/* Verification Result Alert */}
        {verificationResult && (
          <Alert
            severity={
              verificationResult.status === 'success'
                ? 'success'
                : verificationResult.status === 'partial'
                  ? 'warning'
                  : 'error'
            }
            sx={{ mb: 2 }}
          >
            <Typography variant="subtitle2">
              {verificationResult.goal_achieved
                ? 'Exploit verified successfully!'
                : 'Exploit verification incomplete'}
            </Typography>
            {verificationResult.crash_info && (
              <Typography variant="body2">
                Crash signal: {verificationResult.crash_info.signal_name}
                {verificationResult.crash_info.crash_address && (
                  <> at 0x{verificationResult.crash_info.crash_address.toString(16)}</>
                )}
              </Typography>
            )}
            {verificationResult.improvement_suggestions.length > 0 && (
              <Box sx={{ mt: 1 }}>
                <Typography variant="body2" sx={{ fontWeight: 500 }}>
                  Suggestions:
                </Typography>
                <ul style={{ margin: 0, paddingLeft: 20 }}>
                  {verificationResult.improvement_suggestions.map((s, i) => (
                    <li key={i}>
                      <Typography variant="body2">{s}</Typography>
                    </li>
                  ))}
                </ul>
              </Box>
            )}
          </Alert>
        )}

        {/* Available Primitives */}
        {synthesisResult.primitives_available.length > 0 && (
          <Box sx={{ mb: 2 }}>
            <Typography variant="subtitle2" sx={{ mb: 1 }}>
              Available Primitives:
            </Typography>
            <Box sx={{ display: 'flex', flexWrap: 'wrap', gap: 1 }}>
              {synthesisResult.primitives_available.map((p, i) => (
                <Chip
                  key={i}
                  label={p.replace(/_/g, ' ')}
                  size="small"
                  color="primary"
                  variant="outlined"
                  icon={<Build fontSize="small" />}
                />
              ))}
            </Box>
          </Box>
        )}

        {/* Tabs */}
        <Tabs
          value={activeTab}
          onChange={(_, v) => setActiveTab(v)}
          sx={{ borderBottom: 1, borderColor: 'divider', mb: 2 }}
        >
          <Tab icon={<Code />} label="Exploit Code" iconPosition="start" />
          <Tab
            icon={<Memory />}
            label={`Gadgets (${synthesisResult.gadgets_found.length})`}
            iconPosition="start"
          />
          <Tab icon={<Shield />} label="Bypass Strategies" iconPosition="start" />
          <Tab icon={<Lightbulb />} label="AI Reasoning" iconPosition="start" />
        </Tabs>

        {/* Tab: Exploit Code */}
        <TabPanel value={activeTab} index={0}>
          {synthesisResult.exploit_skeleton ? (
            <Box>
              <Box sx={{ display: 'flex', justifyContent: 'space-between', mb: 1 }}>
                <Typography variant="subtitle2">
                  {synthesisResult.exploit_skeleton.description}
                </Typography>
                <Box>
                  <Tooltip title={copied ? 'Copied!' : 'Copy Code'}>
                    <IconButton
                      size="small"
                      onClick={() => handleCopy(synthesisResult.exploit_skeleton!.code)}
                    >
                      {copied ? <CheckCircle color="success" /> : <ContentCopy />}
                    </IconButton>
                  </Tooltip>
                  <Tooltip title="Open Fullscreen">
                    <IconButton size="small" onClick={() => setCodeDialogOpen(true)}>
                      <OpenInNew />
                    </IconButton>
                  </Tooltip>
                </Box>
              </Box>

              <Paper sx={{ maxHeight: 400, overflow: 'auto' }}>
                <SyntaxHighlighter
                  language="python"
                  style={atomOneDark}
                  customStyle={{
                    margin: 0,
                    borderRadius: 4,
                    fontSize: '0.85rem',
                  }}
                  showLineNumbers
                >
                  {synthesisResult.exploit_skeleton.code}
                </SyntaxHighlighter>
              </Paper>

              {/* Placeholders */}
              {Object.keys(synthesisResult.exploit_skeleton.placeholders).length > 0 && (
                <Box sx={{ mt: 2 }}>
                  <Typography variant="subtitle2" sx={{ mb: 1 }}>
                    Placeholders to Fill:
                  </Typography>
                  <Grid container spacing={1}>
                    {Object.entries(synthesisResult.exploit_skeleton.placeholders).map(
                      ([key, desc]) => (
                        <Grid item xs={12} sm={6} key={key}>
                          <Paper sx={{ p: 1.5 }}>
                            <Typography
                              variant="body2"
                              sx={{ fontFamily: 'monospace', fontWeight: 600 }}
                            >
                              {key}
                            </Typography>
                            <Typography variant="caption" color="text.secondary">
                              {desc}
                            </Typography>
                          </Paper>
                        </Grid>
                      ),
                    )}
                  </Grid>
                </Box>
              )}

              {/* Usage Instructions */}
              <Accordion sx={{ mt: 2 }}>
                <AccordionSummary expandIcon={<ExpandMore />}>
                  <Typography variant="subtitle2">Usage Instructions</Typography>
                </AccordionSummary>
                <AccordionDetails>
                  <Typography
                    variant="body2"
                    sx={{ whiteSpace: 'pre-wrap', fontFamily: 'monospace' }}
                  >
                    {synthesisResult.exploit_skeleton.usage_instructions}
                  </Typography>
                </AccordionDetails>
              </Accordion>
            </Box>
          ) : (
            <Alert severity="info">
              No exploit skeleton was generated for this crash.
            </Alert>
          )}
        </TabPanel>

        {/* Tab: Gadgets */}
        <TabPanel value={activeTab} index={1}>
          {/* Gadget Filters */}
          <Box sx={{ display: 'flex', gap: 2, mb: 2 }}>
            <TextField
              size="small"
              placeholder="Search gadgets..."
              value={gadgetFilter}
              onChange={(e) => setGadgetFilter(e.target.value)}
              InputProps={{
                startAdornment: (
                  <InputAdornment position="start">
                    <Search />
                  </InputAdornment>
                ),
              }}
              sx={{ flexGrow: 1 }}
            />
            <TextField
              size="small"
              select
              label="Category"
              value={gadgetCategory}
              onChange={(e) => setGadgetCategory(e.target.value)}
              sx={{ minWidth: 150 }}
              InputProps={{
                startAdornment: (
                  <InputAdornment position="start">
                    <FilterList />
                  </InputAdornment>
                ),
              }}
            >
              {categories.map((cat) => (
                <option key={cat} value={cat}>
                  {cat === 'all' ? 'All Categories' : cat}
                </option>
              ))}
            </TextField>
          </Box>

          <Typography variant="body2" color="text.secondary" sx={{ mb: 1 }}>
            Showing {filteredGadgets.length} of {synthesisResult.gadgets_found.length} gadgets
          </Typography>

          <TableContainer component={Paper} sx={{ maxHeight: 400 }}>
            <Table stickyHeader size="small">
              <TableHead>
                <TableRow>
                  <TableCell>Address</TableCell>
                  <TableCell>Instructions</TableCell>
                  <TableCell>Category</TableCell>
                  <TableCell>Controllable Regs</TableCell>
                  <TableCell align="right">Quality</TableCell>
                </TableRow>
              </TableHead>
              <TableBody>
                {filteredGadgets.slice(0, 100).map((gadget, idx) => (
                  <TableRow key={idx} hover>
                    <TableCell sx={{ fontFamily: 'monospace' }}>
                      0x{gadget.address.toString(16)}
                    </TableCell>
                    <TableCell sx={{ fontFamily: 'monospace', maxWidth: 300 }}>
                      <Tooltip title={gadget.instructions}>
                        <span>
                          {gadget.instructions.length > 50
                            ? `${gadget.instructions.substring(0, 50)}...`
                            : gadget.instructions}
                        </span>
                      </Tooltip>
                    </TableCell>
                    <TableCell>
                      <Chip
                        label={gadget.category}
                        size="small"
                        color={
                          gadget.category.includes('syscall')
                            ? 'error'
                            : gadget.category.includes('pivot')
                              ? 'warning'
                              : 'default'
                        }
                      />
                    </TableCell>
                    <TableCell>
                      {gadget.controllable_regs.slice(0, 3).map((reg, i) => (
                        <Chip
                          key={i}
                          label={reg}
                          size="small"
                          variant="outlined"
                          sx={{ mr: 0.5, fontFamily: 'monospace' }}
                        />
                      ))}
                      {gadget.controllable_regs.length > 3 && (
                        <Chip
                          label={`+${gadget.controllable_regs.length - 3}`}
                          size="small"
                        />
                      )}
                    </TableCell>
                    <TableCell align="right">
                      <LinearProgress
                        variant="determinate"
                        value={gadget.quality_score * 100}
                        sx={{ width: 60 }}
                        color={
                          gadget.quality_score > 0.7
                            ? 'success'
                            : gadget.quality_score > 0.4
                              ? 'warning'
                              : 'error'
                        }
                      />
                    </TableCell>
                  </TableRow>
                ))}
              </TableBody>
            </Table>
          </TableContainer>

          {filteredGadgets.length > 100 && (
            <Alert severity="info" sx={{ mt: 1 }}>
              Showing first 100 gadgets. Use filters to narrow results.
            </Alert>
          )}
        </TabPanel>

        {/* Tab: Bypass Strategies */}
        <TabPanel value={activeTab} index={2}>
          {synthesisResult.bypass_suggestions.length > 0 ? (
            <Grid container spacing={2}>
              {synthesisResult.bypass_suggestions.map((bypass, idx) => (
                <Grid item xs={12} md={6} key={idx}>
                  <Paper sx={{ p: 2, height: '100%' }}>
                    <Box sx={{ display: 'flex', justifyContent: 'space-between', mb: 1 }}>
                      <Chip
                        label={bypass.mitigation}
                        size="small"
                        color="error"
                        variant="outlined"
                      />
                      <Chip
                        label={`${(bypass.success_probability * 100).toFixed(0)}% success`}
                        size="small"
                        color={
                          bypass.success_probability > 0.7
                            ? 'success'
                            : bypass.success_probability > 0.4
                              ? 'warning'
                              : 'default'
                        }
                      />
                    </Box>

                    <Typography variant="subtitle2" sx={{ fontWeight: 600 }}>
                      {bypass.technique}
                    </Typography>
                    <Typography variant="body2" color="text.secondary" sx={{ mb: 1 }}>
                      {bypass.description}
                    </Typography>

                    {bypass.requirements.length > 0 && (
                      <Box sx={{ mb: 1 }}>
                        <Typography variant="caption" color="text.secondary">
                          Requirements:
                        </Typography>
                        <List dense disablePadding>
                          {bypass.requirements.map((req, i) => (
                            <ListItem key={i} sx={{ py: 0 }}>
                              <ListItemIcon sx={{ minWidth: 24 }}>
                                <BugReport fontSize="small" />
                              </ListItemIcon>
                              <ListItemText
                                primary={req}
                                primaryTypographyProps={{ variant: 'caption' }}
                              />
                            </ListItem>
                          ))}
                        </List>
                      </Box>
                    )}

                    {bypass.example_code && (
                      <Accordion elevation={0}>
                        <AccordionSummary expandIcon={<ExpandMore />}>
                          <Typography variant="caption">Example Code</Typography>
                        </AccordionSummary>
                        <AccordionDetails sx={{ p: 0 }}>
                          <SyntaxHighlighter
                            language="python"
                            style={atomOneDark}
                            customStyle={{
                              margin: 0,
                              borderRadius: 4,
                              fontSize: '0.75rem',
                            }}
                          >
                            {bypass.example_code}
                          </SyntaxHighlighter>
                        </AccordionDetails>
                      </Accordion>
                    )}
                  </Paper>
                </Grid>
              ))}
            </Grid>
          ) : (
            <Alert severity="info">No bypass strategies suggested.</Alert>
          )}
        </TabPanel>

        {/* Tab: AI Reasoning */}
        <TabPanel value={activeTab} index={3}>
          <Paper sx={{ p: 2 }}>
            <Typography variant="subtitle2" sx={{ mb: 1, display: 'flex', alignItems: 'center', gap: 1 }}>
              <Lightbulb color="warning" /> AI Analysis
            </Typography>
            <Typography
              variant="body2"
              sx={{ whiteSpace: 'pre-wrap', fontFamily: 'monospace' }}
            >
              {synthesisResult.ai_reasoning || 'No AI reasoning available.'}
            </Typography>
          </Paper>
        </TabPanel>
      </CardContent>

      {/* Fullscreen Code Dialog */}
      <Dialog
        open={codeDialogOpen}
        onClose={() => setCodeDialogOpen(false)}
        maxWidth="lg"
        fullWidth
      >
        <DialogTitle>
          <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
            Exploit Code
            <IconButton onClick={() => setCodeDialogOpen(false)}>
              <Close />
            </IconButton>
          </Box>
        </DialogTitle>
        <DialogContent>
          {synthesisResult.exploit_skeleton && (
            <SyntaxHighlighter
              language="python"
              style={atomOneDark}
              customStyle={{
                margin: 0,
                borderRadius: 4,
                fontSize: '0.9rem',
                maxHeight: '70vh',
              }}
              showLineNumbers
            >
              {synthesisResult.exploit_skeleton.code}
            </SyntaxHighlighter>
          )}
        </DialogContent>
        <DialogActions>
          <Button onClick={() => handleCopy(synthesisResult.exploit_skeleton?.code || '')}>
            Copy Code
          </Button>
          <Button variant="contained" onClick={handleDownload}>
            Download
          </Button>
        </DialogActions>
      </Dialog>
    </Card>
  );
}
