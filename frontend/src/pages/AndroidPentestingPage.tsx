import React, { useState } from "react";
import LearnPageLayout from "../components/LearnPageLayout";
import {
  Box,
  Container,
  Typography,
  Paper,
  Chip,
  Button,
  Grid,
  List,
  ListItem,
  ListItemIcon,
  ListItemText,
  Tabs,
  Tab,
  Accordion,
  AccordionSummary,
  AccordionDetails,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  Card,
  CardContent,
  Alert,
  Divider,
  IconButton,
  Tooltip,
  alpha,
} from "@mui/material";
import ArrowBackIcon from "@mui/icons-material/ArrowBack";
import AndroidIcon from "@mui/icons-material/Android";
import SecurityIcon from "@mui/icons-material/Security";
import BugReportIcon from "@mui/icons-material/BugReport";
import StorageIcon from "@mui/icons-material/Storage";
import WifiIcon from "@mui/icons-material/Wifi";
import CodeIcon from "@mui/icons-material/Code";
import LockOpenIcon from "@mui/icons-material/LockOpen";
import BuildIcon from "@mui/icons-material/Build";
import SearchIcon from "@mui/icons-material/Search";
import CheckCircleIcon from "@mui/icons-material/CheckCircle";
import WarningIcon from "@mui/icons-material/Warning";
import ExpandMoreIcon from "@mui/icons-material/ExpandMore";
import TerminalIcon from "@mui/icons-material/Terminal";
import ContentCopyIcon from "@mui/icons-material/ContentCopy";
import { useNavigate } from "react-router-dom";

interface TabPanelProps {
  children?: React.ReactNode;
  index: number;
  value: number;
}

function TabPanel(props: TabPanelProps) {
  const { children, value, index, ...other } = props;
  return (
    <div role="tabpanel" hidden={value !== index} {...other}>
      {value === index && <Box sx={{ py: 3 }}>{children}</Box>}
    </div>
  );
}

const CodeBlock: React.FC<{ code: string; language?: string; title?: string }> = ({
  code,
  language = "bash",
  title,
}) => {
  const [copied, setCopied] = useState(false);

  const handleCopy = () => {
    navigator.clipboard.writeText(code);
    setCopied(true);
    setTimeout(() => setCopied(false), 2000);
  };

  return (
    <Paper
      sx={{
        bgcolor: "#0d1117",
        borderRadius: 2,
        position: "relative",
        my: 2,
        border: "1px solid rgba(34, 197, 94, 0.2)",
        overflow: "hidden",
      }}
    >
      {title && (
        <Box sx={{ px: 2, py: 1, bgcolor: "rgba(34, 197, 94, 0.1)", borderBottom: "1px solid rgba(34, 197, 94, 0.2)" }}>
          <Typography variant="subtitle2" sx={{ color: "#22c55e", fontWeight: 600 }}>{title}</Typography>
        </Box>
      )}
      <Box sx={{ position: "absolute", top: title ? 40 : 8, right: 8, display: "flex", gap: 1 }}>
        <Chip label={language} size="small" sx={{ bgcolor: alpha("#22c55e", 0.2), color: "#22c55e", fontSize: "0.7rem" }} />
        <Tooltip title={copied ? "Copied!" : "Copy"}>
          <IconButton size="small" onClick={handleCopy} sx={{ color: copied ? "#22c55e" : "#888" }}>
            <ContentCopyIcon fontSize="small" />
          </IconButton>
        </Tooltip>
      </Box>
      <Box
        component="pre"
        sx={{
          m: 0,
          p: 2,
          pt: 3,
          overflow: "auto",
          fontFamily: "'Fira Code', 'Consolas', monospace",
          fontSize: "0.8rem",
          color: "#e6edf3",
          lineHeight: 1.6,
        }}
      >
        {code}
      </Box>
    </Paper>
  );
};

const introHighlights = [
  "Map the Android attack surface using the manifest, permissions, and exported components.",
  "Perform static analysis on the APK to locate insecure configs and hardcoded secrets.",
  "Run the app and intercept traffic to understand API calls and data flow.",
  "Validate data storage and crypto usage with repeatable, beginner friendly steps.",
  "Document issues with clear evidence and remediation guidance.",
];

const prerequisites = [
  "Basic command line comfort (adb, unzip, grep)",
  "Android emulator or test device",
  "Proxy tool (Burp Suite or mitmproxy)",
  "APK sample to test and permission to do so",
];

const scopeChecklist = [
  "Confirm app version, build type, and environment",
  "List user roles and permissions you can test",
  "Identify sensitive data and high value flows",
  "Define what is out of scope (rate limits, production systems)",
];

const pentestVsReverse = [
  {
    title: "Android Pentesting",
    focus: "Find security weaknesses in the running app and its backend.",
    outputs: "Validated findings with impact, evidence, and fixes.",
    tools: "Proxy, adb, jadx, MobSF, Frida (optional)",
  },
  {
    title: "Android Reverse Engineering",
    focus: "Understand how the app works internally, including logic and native code.",
    outputs: "Code comprehension, workflows, and undocumented behaviors.",
    tools: "jadx, apktool, Ghidra, Frida, debugging",
  },
];

const quickStats = [
  { label: "3 analysis modes", icon: <SearchIcon /> },
  { label: "6 core phases", icon: <SecurityIcon /> },
  { label: "8 attack surfaces", icon: <LockOpenIcon /> },
  { label: "7 common issues", icon: <BugReportIcon /> },
];
const methodologySteps = [
  {
    title: "Scope and threat model",
    color: "#22c55e",
    icon: <SearchIcon />,
    description:
      "Define what you can test, which app version is in scope, and what data matters most. This keeps your testing safe, legal, and focused.",
    focus: [
      "App version, build flavor, and environments",
      "User roles and privilege boundaries",
      "High value data: tokens, PII, payments",
      "Out of scope systems and rate limits",
    ],
    output: "A written scope and a short threat model.",
  },
  {
    title: "Static review (no execution)",
    color: "#3b82f6",
    icon: <CodeIcon />,
    description:
      "Open the APK and inspect the manifest, resources, and code without running the app. This is the fastest way to spot obvious issues.",
    focus: [
      "AndroidManifest.xml permissions and components",
      "network_security_config and cleartext rules",
      "Hardcoded secrets in strings or assets",
      "Third party SDK inventory and versions",
    ],
    output: "A list of suspected issues and test targets.",
  },
  {
    title: "Dynamic analysis and traffic",
    color: "#10b981",
    icon: <WifiIcon />,
    description:
      "Run the app on an emulator or device, intercept traffic, and validate what the app really does during login, payments, and other flows.",
    focus: [
      "Proxy API calls and map endpoints",
      "Test TLS handling and pinning",
      "Observe runtime behavior with logcat",
      "Confirm storage issues in practice",
    ],
    output: "Recorded requests, logs, and repro steps.",
  },
  {
    title: "Data storage and crypto",
    color: "#f59e0b",
    icon: <StorageIcon />,
    description:
      "Check how sensitive data is stored on the device and whether encryption and keys are handled correctly.",
    focus: [
      "SharedPreferences, SQLite, files, cache",
      "External storage usage and backup flags",
      "Keystore usage and key lifecycle",
      "Custom crypto or hardcoded keys",
    ],
    output: "Evidence of data at rest risk and fix options.",
  },
  {
    title: "Abuse cases and components",
    color: "#ef4444",
    icon: <LockOpenIcon />,
    description:
      "Try to misuse the app as a malicious app or a crafted link would. This reveals exported component and deep link issues.",
    focus: [
      "Deep links and intent injection",
      "Exported services and receivers",
      "WebView JavaScript bridge exposure",
      "Authorization and session reuse checks",
    ],
    output: "Exploit paths or blocked tests with notes.",
  },
  {
    title: "Report and remediation",
    color: "#8b5cf6",
    icon: <CheckCircleIcon />,
    description:
      "Turn findings into clear, prioritized fixes that developers can act on quickly.",
    focus: [
      "Impact and likelihood",
      "Minimal reproducible steps",
      "Screenshots, logs, or proxy evidence",
      "Remediation guidance and references",
    ],
    output: "Actionable report ready for triage.",
  },
];
const setupSections = [
  {
    title: "Device or emulator",
    icon: <AndroidIcon />,
    description:
      "Start with an emulator for most beginner checks. A rooted test device helps with deeper runtime and certificate work.",
    steps: [
      "Use a clean emulator image with Google APIs or AOSP",
      "Enable Developer Options and USB debugging",
      "Keep a snapshot so you can reset quickly",
      "Use a rooted test device only when authorized",
    ],
  },
  {
    title: "Proxy and certificates",
    icon: <WifiIcon />,
    description:
      "To inspect traffic, route the device through a proxy and trust the proxy CA certificate.",
    steps: [
      "Run Burp Suite or mitmproxy on your host",
      "Set device Wi-Fi proxy to host IP and port",
      "Install the proxy CA certificate on the device",
      "For Android 7+, use network_security_config or a test build",
    ],
  },
  {
    title: "Tooling basics",
    icon: <BuildIcon />,
    description:
      "A small set of tools covers most Android pentesting tasks without overwhelming beginners.",
    steps: [
      "jadx or jadx-gui for decompiling code",
      "apktool for decoding resources and manifest",
      "adb for device control and file access",
      "Frida and Objection for runtime hooks",
      "MobSF for automated analysis when available",
    ],
  },
];
const attackSurface = [
  {
    title: "Manifest and permissions",
    icon: <SecurityIcon />,
    description: "Permissions, exported components, and app flags define what the app allows.",
    checks: [
      "Dangerous permissions and unnecessary access",
      "android:exported and intent filters",
      "android:debuggable and allowBackup flags",
    ],
  },
  {
    title: "App components",
    icon: <LockOpenIcon />,
    description: "Activities, services, receivers, and providers can be entry points for attacks.",
    checks: [
      "Launch exported activities with adb",
      "Trigger receivers with crafted intents",
      "Query content providers for data exposure",
    ],
  },
  {
    title: "Network layer",
    icon: <WifiIcon />,
    description: "APIs are often the most sensitive part of a mobile app.",
    checks: [
      "Cleartext traffic or weak TLS",
      "Certificate pinning and error handling",
      "Auth tokens in headers and responses",
    ],
  },
  {
    title: "Local storage",
    icon: <StorageIcon />,
    description: "Data at rest must be protected against local attackers.",
    checks: [
      "SharedPreferences and SQLite for secrets",
      "Files, caches, and logs",
      "External storage usage",
    ],
  },
  {
    title: "WebView and hybrid content",
    icon: <CodeIcon />,
    description: "Hybrid apps can introduce web style risks inside native apps.",
    checks: [
      "JavaScript enabled with unsafe bridges",
      "File access and mixed content",
      "Deep link handling in WebView flows",
    ],
  },
  {
    title: "Crypto and keys",
    icon: <SecurityIcon />,
    description: "Custom crypto is often wrong. Validate algorithms and key handling.",
    checks: [
      "Hardcoded keys or IV reuse",
      "Use of weak algorithms or modes",
      "Keystore usage for sensitive keys",
    ],
  },
  {
    title: "Native libraries (JNI)",
    icon: <BuildIcon />,
    description: "Native code can contain memory safety issues and hidden logic.",
    checks: [
      "Inspect .so libraries for secrets and APIs",
      "Review JNI bridges for validation bugs",
      "Check for debug symbols or logging",
    ],
  },
  {
    title: "Third party SDKs",
    icon: <BugReportIcon />,
    description: "Analytics, ads, and payment SDKs can leak data or expand risk.",
    checks: [
      "Identify SDK versions and CVEs",
      "Track data sent to third party hosts",
      "Review privacy and consent handling",
    ],
  },
];

const attackSurfaceCommands = [
  { cmd: "aapt dump xmltree app.apk AndroidManifest.xml", desc: "List components and exported flags" },
  { cmd: "adb shell pm list packages | grep <name>", desc: "Find the package name quickly" },
  { cmd: "adb shell dumpsys package com.example.app | grep -i exported", desc: "Identify exported components" },
  { cmd: "adb shell am start -n com.example.app/.MainActivity", desc: "Launch an activity directly" },
  { cmd: "adb shell am broadcast -a com.example.ACTION", desc: "Trigger a broadcast receiver" },
  { cmd: "adb shell content query --uri content://com.example.provider/items", desc: "Query a content provider" },
];
const vulnerabilities = [
  {
    title: "Insecure data storage",
    severity: "High",
    description: "Sensitive data stored in plaintext in SharedPreferences, SQLite, files, or logs.",
    howToTest: "Search app storage for tokens, passwords, or PII. Check logs and cache files.",
    fix: "Encrypt sensitive data, minimize storage, and use the Android Keystore.",
  },
  {
    title: "Insecure communication",
    severity: "High",
    description: "Cleartext traffic, weak TLS, or broken certificate validation.",
    howToTest: "Proxy traffic and look for HTTP or trust-all certificate logic.",
    fix: "Enforce TLS, validate certificates, and avoid trust-all implementations.",
  },
  {
    title: "Broken authentication or session handling",
    severity: "Critical",
    description: "Tokens are reused, stored insecurely, or not validated server-side.",
    howToTest: "Replay tokens, test session expiry, and validate access control on APIs.",
    fix: "Use short lived tokens, rotate secrets, and enforce server-side checks.",
  },
  {
    title: "Exported components and intent injection",
    severity: "Medium",
    description: "Exported activities, services, or receivers can be abused by other apps.",
    howToTest: "Launch exported components with crafted intents and extras.",
    fix: "Restrict exported components, validate input, and require permissions.",
  },
  {
    title: "WebView and JavaScript bridge issues",
    severity: "High",
    description: "Unsafe JavaScript bridges or file access allow code injection or data theft.",
    howToTest: "Inspect WebView config and test HTML or JS payloads in web content.",
    fix: "Limit JavaScript interfaces, disable file access, and validate URLs.",
  },
  {
    title: "Weak crypto and key management",
    severity: "Critical",
    description: "Hardcoded keys, weak algorithms, or incorrect modes like ECB.",
    howToTest: "Search for crypto usage in code and trace runtime key material.",
    fix: "Use modern algorithms and store keys in the Keystore.",
  },
  {
    title: "Debug builds and excessive logging",
    severity: "Medium",
    description: "Debuggable apps and verbose logs expose sensitive data or bypasses.",
    howToTest: "Check android:debuggable and review logcat output.",
    fix: "Disable debug flags and remove sensitive logs in release builds.",
  },
];
const tools = [
  {
    name: "jadx-gui",
    focus: "Static analysis",
    description: "Decompile APKs to readable Java or Kotlin for quick code review.",
  },
  {
    name: "apktool",
    focus: "Resources and manifest",
    description: "Decode AndroidManifest.xml and resources for configuration analysis.",
  },
  {
    name: "adb",
    focus: "Device control",
    description: "Install, launch, and inspect apps on a device or emulator.",
  },
  {
    name: "Frida",
    focus: "Runtime analysis",
    description: "Hook functions, bypass checks, and observe sensitive operations.",
  },
  {
    name: "Objection",
    focus: "Runtime helper",
    description: "Frida powered commands for quick bypass and exploration.",
  },
  {
    name: "MobSF",
    focus: "Automation",
    description: "Static and dynamic automation for quick baselines.",
  },
  {
    name: "Burp Suite or mitmproxy",
    focus: "Network interception",
    description: "Intercept and modify API traffic with full request history.",
  },
  {
    name: "Ghidra",
    focus: "Native code",
    description: "Analyze native libraries and JNI behavior.",
  },
];
const commandSections = [
  {
    category: "APK inspection",
    commands: [
      { cmd: "apktool d app.apk -o decoded", desc: "Decode resources and manifest" },
      { cmd: "jadx -d src app.apk", desc: "Decompile APK to source" },
      { cmd: "aapt dump badging app.apk", desc: "Show package info and SDK levels" },
      { cmd: "aapt dump xmltree app.apk AndroidManifest.xml", desc: "View manifest details" },
      { cmd: "apksigner verify --print-certs app.apk", desc: "Inspect signing certificate" },
    ],
  },
  {
    category: "Device and logs",
    commands: [
      { cmd: "adb devices", desc: "List connected devices" },
      { cmd: "adb install app.apk", desc: "Install APK on device" },
      { cmd: "adb shell pm list packages | grep app", desc: "Find package name" },
      { cmd: "adb logcat | grep -i app", desc: "Watch logs for the app" },
      { cmd: "adb shell run-as com.example.app ls", desc: "List app data directory" },
    ],
  },
  {
    category: "Runtime and network",
    commands: [
      { cmd: "frida-ps -Ua", desc: "List running apps and package IDs" },
      { cmd: "frida -U -f com.example.app -l hook.js --no-pause", desc: "Start app with Frida script" },
      { cmd: "adb shell settings put global http_proxy <host>:<port>", desc: "Set device proxy" },
      { cmd: "adb shell settings put global http_proxy :0", desc: "Clear device proxy" },
      { cmd: "adb shell am start -W -a android.intent.action.VIEW -d \"app://test\"", desc: "Test a deep link" },
    ],
  },
];
const practiceLabs = [
  {
    name: "Manifest and permissions audit",
    difficulty: "Beginner",
    duration: "30 min",
    tools: "apktool, aapt, jadx",
    objectives: [
      "Identify exported components",
      "Review dangerous permissions",
      "Locate cleartext traffic settings",
    ],
    steps: [
      "Decode the APK and open AndroidManifest.xml",
      "List exported activities, receivers, and services",
      "Find usesCleartextTraffic and network_security_config",
      "Document findings with screenshots",
    ],
  },
  {
    name: "Traffic interception and API mapping",
    difficulty: "Beginner",
    duration: "45 min",
    tools: "Burp Suite or mitmproxy, adb",
    objectives: [
      "Capture login and profile requests",
      "Map base URLs and endpoints",
      "Check for weak TLS handling",
    ],
    steps: [
      "Set device proxy and install CA certificate",
      "Run the app and capture auth flow",
      "Identify tokens and headers in requests",
      "Test for HTTP or invalid cert acceptance",
    ],
  },
  {
    name: "Storage and crypto review",
    difficulty: "Intermediate",
    duration: "60 min",
    tools: "adb, jadx, Frida",
    objectives: [
      "Find sensitive data on device storage",
      "Trace encryption routines at runtime",
      "Validate Keystore usage",
    ],
    steps: [
      "Inspect SharedPreferences and databases",
      "Search for secrets in decompiled code",
      "Hook crypto APIs and observe keys",
      "Document storage locations and risks",
    ],
  },
];

const practiceApps = [
  {
    name: "DIVA",
    desc: "Damn Insecure and Vulnerable App with common Android bugs.",
  },
  {
    name: "InsecureBankv2",
    desc: "Vulnerable banking app with backend flows and auth issues.",
  },
  {
    name: "OWASP UnCrackable Apps",
    desc: "Progressive challenges for mobile security practice.",
  },
  {
    name: "MSTG Crackmes",
    desc: "Official OWASP test cases mapped to MASTG.",
  },
];
const reportStructure = [
  "Executive summary with overall risk",
  "Scope and test environment details",
  "Findings by severity with clear titles",
  "Reproduction steps and expected vs actual",
  "Evidence: screenshots, logs, request history",
  "Remediation guidance and references",
];

const findingTemplate = `Title: Insecure data storage in SharedPreferences
Severity: High
Impact: Token theft leads to account takeover
Steps:
1) Login as a test user
2) Pull /data/data/<package>/shared_prefs
3) Observe auth_token stored in plaintext
Evidence: screenshot + file path + sample redacted token
Recommendation: Use EncryptedSharedPreferences or Keystore backed encryption`;

const evidenceChecklist = [
  "App version, build number, and hashes",
  "Device model, Android version, and root status",
  "Proxy logs or request exports",
  "Storage artifacts with file paths",
  "Screenshots and timestamps for each issue",
];

const pageContext = `Android pentesting guide with a beginner friendly introduction, lab setup, methodology, attack surface mapping, common vulnerabilities, tools and commands, practice labs, and reporting guidance.`;

const AndroidPentestingPage: React.FC = () => {
  const navigate = useNavigate();
  const [tabValue, setTabValue] = useState(0);

  const handleTabChange = (_: React.SyntheticEvent, newValue: number) => {
    setTabValue(newValue);
  };

  return (
    <LearnPageLayout pageTitle="Android Pentesting" pageContext={pageContext}>
      <Box sx={{ minHeight: "100vh", bgcolor: "#0a0a0f", py: 4 }}>
        <Container maxWidth="lg">
          {/* Header */}
          <Box sx={{ mb: 4 }}>
            <Button
              startIcon={<ArrowBackIcon />}
              onClick={() => navigate("/learn")}
              sx={{ mb: 2, color: "#22c55e", "&:hover": { color: "#16a34a" } }}
            >
              Back to Learning Hub
            </Button>

            <Box sx={{ display: "flex", alignItems: "center", gap: 2, mb: 2 }}>
              <Box sx={{ p: 2, borderRadius: 2, bgcolor: alpha("#22c55e", 0.1) }}>
                <AndroidIcon sx={{ fontSize: 48, color: "#22c55e" }} />
              </Box>
              <Box>
                <Typography variant="h3" sx={{ fontWeight: 800, color: "white" }}>
                  Android Pentesting
                </Typography>
                <Typography variant="h6" sx={{ color: "grey.400" }}>
                  Beginner friendly guide to assessing Android app security
                </Typography>
              </Box>
            </Box>

            <Box sx={{ display: "flex", gap: 1, flexWrap: "wrap" }}>
              <Chip icon={<AndroidIcon />} label="Android" size="small" variant="outlined" />
              <Chip icon={<SecurityIcon />} label="MASTG aligned" size="small" variant="outlined" />
              <Chip icon={<WifiIcon />} label="Network testing" size="small" variant="outlined" />
              <Chip icon={<StorageIcon />} label="Data storage" size="small" variant="outlined" />
            </Box>
          </Box>

          {/* Intro */}
          <Paper sx={{ p: 4, bgcolor: "#111118", borderRadius: 3, mb: 4 }}>
            <Typography variant="h5" sx={{ color: "#22c55e", fontWeight: 700, mb: 2 }}>
              Introduction: What is Android pentesting?
            </Typography>
            <Typography variant="body1" sx={{ color: "grey.300", mb: 2, lineHeight: 1.8 }}>
              Android pentesting is a structured, authorized way to evaluate the security of an Android application.
              Instead of trying to break the phone, you focus on how the app stores data, talks to its backend, and
              protects sensitive actions. A good test answers simple questions: Can another app access this data?
              Can an attacker on the network read or modify requests? Can the app be tricked into doing something
              it should not do?
            </Typography>
            <Typography variant="body1" sx={{ color: "grey.300", mb: 2, lineHeight: 1.8 }}>
              An Android app is packaged as an APK. Inside it are the manifest (which declares permissions and
              components), compiled code, resources, and sometimes native libraries. Android isolates each app in
              its own sandbox, but the manifest can expose components like activities, services, broadcast receivers,
              and content providers. Those entry points are the attack surface you test.
            </Typography>
            <Typography variant="body1" sx={{ color: "grey.300", mb: 2, lineHeight: 1.8 }}>
              A beginner friendly workflow combines static analysis (reading the APK), dynamic analysis (running the
              app on a device or emulator), and network testing (intercepting API calls). You do not need a rooted phone
              for everything, but a rooted test device can unlock deeper checks. The goal is to find weaknesses and
              explain clear fixes, not to show off exploits.
            </Typography>
            <Divider sx={{ my: 2, borderColor: "rgba(255,255,255,0.08)" }} />
            <Typography variant="subtitle1" sx={{ color: "white", mb: 2, fontWeight: 600 }}>
              Android pentesting vs Android reverse engineering
            </Typography>
            <Grid container spacing={2} sx={{ mb: 2 }}>
              {pentestVsReverse.map((item) => (
                <Grid item xs={12} md={6} key={item.title}>
                  <Paper sx={{ p: 2.5, bgcolor: "#0d1117", borderRadius: 2, border: "1px solid rgba(255,255,255,0.05)" }}>
                    <Typography variant="h6" sx={{ color: "#22c55e", fontWeight: 700, mb: 1 }}>
                      {item.title}
                    </Typography>
                    <Typography variant="body2" sx={{ color: "grey.300", mb: 1 }}>
                      <strong>Focus:</strong> {item.focus}
                    </Typography>
                    <Typography variant="body2" sx={{ color: "grey.300", mb: 1 }}>
                      <strong>Outputs:</strong> {item.outputs}
                    </Typography>
                    <Typography variant="body2" sx={{ color: "grey.400" }}>
                      <strong>Tools:</strong> {item.tools}
                    </Typography>
                  </Paper>
                </Grid>
              ))}
            </Grid>
            <Divider sx={{ my: 2, borderColor: "rgba(255,255,255,0.08)" }} />
            <Grid container spacing={2} sx={{ mb: 2 }}>
              <Grid item xs={12} md={6}>
                <Paper sx={{ p: 2.5, bgcolor: "#0d1117", borderRadius: 2, border: "1px solid rgba(255,255,255,0.05)" }}>
                  <Typography variant="subtitle1" sx={{ color: "#22c55e", fontWeight: 700, mb: 1 }}>
                    Prerequisites
                  </Typography>
                  <List dense>
                    {prerequisites.map((item) => (
                      <ListItem key={item} sx={{ py: 0.2 }}>
                        <ListItemIcon sx={{ minWidth: 24 }}>
                          <CheckCircleIcon sx={{ fontSize: 16, color: "#22c55e" }} />
                        </ListItemIcon>
                        <ListItemText
                          primary={item}
                          primaryTypographyProps={{ variant: "body2", sx: { color: "grey.300" } }}
                        />
                      </ListItem>
                    ))}
                  </List>
                </Paper>
              </Grid>
              <Grid item xs={12} md={6}>
                <Paper sx={{ p: 2.5, bgcolor: "#0d1117", borderRadius: 2, border: "1px solid rgba(255,255,255,0.05)" }}>
                  <Typography variant="subtitle1" sx={{ color: "#22c55e", fontWeight: 700, mb: 1 }}>
                    Scope checklist
                  </Typography>
                  <List dense>
                    {scopeChecklist.map((item) => (
                      <ListItem key={item} sx={{ py: 0.2 }}>
                        <ListItemIcon sx={{ minWidth: 24 }}>
                          <CheckCircleIcon sx={{ fontSize: 16, color: "#22c55e" }} />
                        </ListItemIcon>
                        <ListItemText
                          primary={item}
                          primaryTypographyProps={{ variant: "body2", sx: { color: "grey.300" } }}
                        />
                      </ListItem>
                    ))}
                  </List>
                </Paper>
              </Grid>
            </Grid>
            <Typography variant="subtitle1" sx={{ color: "white", mb: 1, fontWeight: 600 }}>
              What you will learn
            </Typography>
            <List dense>
              {introHighlights.map((item) => (
                <ListItem key={item} sx={{ py: 0.4 }}>
                  <ListItemIcon sx={{ minWidth: 28 }}>
                    <CheckCircleIcon sx={{ color: "#22c55e" }} fontSize="small" />
                  </ListItemIcon>
                  <ListItemText primary={item} sx={{ "& .MuiListItemText-primary": { color: "grey.300" } }} />
                </ListItem>
              ))}
            </List>
          </Paper>

          {/* Quick Stats */}
          <Grid container spacing={2} sx={{ mb: 4 }}>
            {quickStats.map((stat) => (
              <Grid item xs={6} md={3} key={stat.label}>
                <Paper
                  sx={{
                    p: 2,
                    textAlign: "center",
                    bgcolor: alpha("#22c55e", 0.05),
                    border: `1px solid ${alpha("#22c55e", 0.2)}`,
                    borderRadius: 2,
                  }}
                >
                  <Box sx={{ color: "#22c55e", mb: 0.5 }}>{stat.icon}</Box>
                  <Typography variant="body2" sx={{ color: "grey.300", fontWeight: 600 }}>
                    {stat.label}
                  </Typography>
                </Paper>
              </Grid>
            ))}
          </Grid>

          {/* Tabs */}
          <Paper sx={{ bgcolor: "#111118", borderRadius: 3, overflow: "hidden", border: "1px solid rgba(255,255,255,0.05)" }}>
            <Tabs
              value={tabValue}
              onChange={handleTabChange}
              variant="scrollable"
              scrollButtons="auto"
              sx={{
                borderBottom: "1px solid rgba(255,255,255,0.05)",
                "& .MuiTab-root": { color: "grey.400", fontWeight: 600 },
                "& .Mui-selected": { color: "#22c55e" },
                "& .MuiTabs-indicator": { bgcolor: "#22c55e" },
              }}
            >
              <Tab icon={<SearchIcon />} label="Methodology" iconPosition="start" />
              <Tab icon={<BuildIcon />} label="Lab Setup" iconPosition="start" />
              <Tab icon={<LockOpenIcon />} label="Attack Surface" iconPosition="start" />
              <Tab icon={<BugReportIcon />} label="Common Issues" iconPosition="start" />
              <Tab icon={<TerminalIcon />} label="Tools and Commands" iconPosition="start" />
              <Tab icon={<SecurityIcon />} label="Practice Labs" iconPosition="start" />
              <Tab icon={<CheckCircleIcon />} label="Reporting" iconPosition="start" />
            </Tabs>

            {/* Tab 0: Methodology */}
            <TabPanel value={tabValue} index={0}>
              <Grid container spacing={3}>
                {methodologySteps.map((step) => (
                  <Grid item xs={12} md={6} key={step.title}>
                    <Paper
                      sx={{
                        p: 3,
                        bgcolor: "#0d1117",
                        borderRadius: 2,
                        border: `1px solid ${alpha(step.color, 0.2)}`,
                        borderLeft: `4px solid ${step.color}`,
                        height: "100%",
                      }}
                    >
                      <Box sx={{ display: "flex", alignItems: "center", gap: 1.5, mb: 1 }}>
                        <Box sx={{ color: step.color }}>{step.icon}</Box>
                        <Typography variant="h6" sx={{ color: "white", fontWeight: 700 }}>
                          {step.title}
                        </Typography>
                      </Box>
                      <Typography variant="body2" sx={{ color: "grey.400", mb: 2 }}>
                        {step.description}
                      </Typography>
                      <Typography variant="subtitle2" sx={{ color: step.color, mb: 1, fontWeight: 700 }}>
                        Focus areas
                      </Typography>
                      <List dense>
                        {step.focus.map((item) => (
                          <ListItem key={item} sx={{ py: 0.2 }}>
                            <ListItemIcon sx={{ minWidth: 24 }}>
                              <CheckCircleIcon sx={{ fontSize: 16, color: step.color }} />
                            </ListItemIcon>
                            <ListItemText
                              primary={item}
                              primaryTypographyProps={{ variant: "body2", sx: { color: "grey.300" } }}
                            />
                          </ListItem>
                        ))}
                      </List>
                      <Typography variant="caption" sx={{ color: "grey.500" }}>
                        Output: {step.output}
                      </Typography>
                    </Paper>
                  </Grid>
                ))}
              </Grid>
            </TabPanel>

            {/* Tab 1: Lab Setup */}
            <TabPanel value={tabValue} index={1}>
              <Grid container spacing={3}>
                {setupSections.map((section) => (
                  <Grid item xs={12} md={4} key={section.title}>
                    <Card sx={{ bgcolor: "#0d1117", borderRadius: 2, height: "100%", border: "1px solid rgba(255,255,255,0.05)" }}>
                      <CardContent>
                        <Box sx={{ display: "flex", alignItems: "center", gap: 1.5, mb: 1 }}>
                          <Box sx={{ color: "#22c55e" }}>{section.icon}</Box>
                          <Typography variant="h6" sx={{ color: "white", fontWeight: 700 }}>
                            {section.title}
                          </Typography>
                        </Box>
                        <Typography variant="body2" sx={{ color: "grey.400", mb: 2 }}>
                          {section.description}
                        </Typography>
                        <List dense>
                          {section.steps.map((item) => (
                            <ListItem key={item} sx={{ py: 0.2 }}>
                              <ListItemIcon sx={{ minWidth: 24 }}>
                                <CheckCircleIcon sx={{ fontSize: 16, color: "#22c55e" }} />
                              </ListItemIcon>
                              <ListItemText
                                primary={item}
                                primaryTypographyProps={{ variant: "body2", sx: { color: "grey.300" } }}
                              />
                            </ListItem>
                          ))}
                        </List>
                      </CardContent>
                    </Card>
                  </Grid>
                ))}
              </Grid>

              <Divider sx={{ my: 3, borderColor: "rgba(255,255,255,0.05)" }} />

              <Typography variant="h6" sx={{ color: "#22c55e", fontWeight: 700 }}>
                Quick setup commands
              </Typography>
              <CodeBlock
                title="Device prep and app control"
                language="bash"
                code={`# List devices and install APK
adb devices
adb install app.apk

# Launch the app
adb shell monkey -p com.example.app -c android.intent.category.LAUNCHER 1

# View logs for the app
adb logcat | grep -i "com.example.app"`}
              />
            </TabPanel>

            {/* Tab 2: Attack Surface */}
            <TabPanel value={tabValue} index={2}>
              <Grid container spacing={3}>
                {attackSurface.map((surface) => (
                  <Grid item xs={12} md={6} key={surface.title}>
                    <Paper sx={{ p: 3, bgcolor: "#0d1117", borderRadius: 2, height: "100%", border: "1px solid rgba(255,255,255,0.05)" }}>
                      <Box sx={{ display: "flex", alignItems: "center", gap: 1.5, mb: 1 }}>
                        <Box sx={{ color: "#22c55e" }}>{surface.icon}</Box>
                        <Typography variant="h6" sx={{ color: "white", fontWeight: 700 }}>
                          {surface.title}
                        </Typography>
                      </Box>
                      <Typography variant="body2" sx={{ color: "grey.400", mb: 2 }}>
                        {surface.description}
                      </Typography>
                      <List dense>
                        {surface.checks.map((item) => (
                          <ListItem key={item} sx={{ py: 0.2 }}>
                            <ListItemIcon sx={{ minWidth: 24 }}>
                              <CheckCircleIcon sx={{ fontSize: 16, color: "#22c55e" }} />
                            </ListItemIcon>
                            <ListItemText
                              primary={item}
                              primaryTypographyProps={{ variant: "body2", sx: { color: "grey.300" } }}
                            />
                          </ListItem>
                        ))}
                      </List>
                    </Paper>
                  </Grid>
                ))}
              </Grid>

              <Divider sx={{ my: 3, borderColor: "rgba(255,255,255,0.05)" }} />
              <Typography variant="h6" sx={{ color: "#22c55e", fontWeight: 700, mb: 2 }}>
                Attack surface quick commands
              </Typography>
              <TableContainer component={Paper} sx={{ bgcolor: "#0d1117", borderRadius: 2, border: "1px solid rgba(255,255,255,0.05)" }}>
                <Table size="small">
                  <TableHead>
                    <TableRow>
                      <TableCell sx={{ color: "white", fontWeight: 700, width: "55%" }}>Command</TableCell>
                      <TableCell sx={{ color: "white", fontWeight: 700 }}>Purpose</TableCell>
                    </TableRow>
                  </TableHead>
                  <TableBody>
                    {attackSurfaceCommands.map((row) => (
                      <TableRow key={row.cmd}>
                        <TableCell sx={{ color: "#22c55e", fontFamily: "monospace", fontSize: "0.8rem" }}>
                          {row.cmd}
                        </TableCell>
                        <TableCell sx={{ color: "grey.300" }}>{row.desc}</TableCell>
                      </TableRow>
                    ))}
                  </TableBody>
                </Table>
              </TableContainer>
            </TabPanel>

            {/* Tab 3: Common Issues */}
            <TabPanel value={tabValue} index={3}>
              <Box sx={{ p: 1 }}>
                {vulnerabilities.map((vuln) => (
                  <Accordion key={vuln.title} sx={{ mb: 1, bgcolor: "#0d1117", "&:before": { display: "none" } }}>
                    <AccordionSummary expandIcon={<ExpandMoreIcon sx={{ color: "grey.500" }} />}>
                      <Box sx={{ display: "flex", alignItems: "center", gap: 2, width: "100%" }}>
                        <Chip
                          label={vuln.severity}
                          size="small"
                          sx={{
                            bgcolor: vuln.severity === "Critical" ? alpha("#ef4444", 0.2) :
                                     vuln.severity === "High" ? alpha("#f59e0b", 0.2) :
                                     alpha("#3b82f6", 0.2),
                            color: vuln.severity === "Critical" ? "#ef4444" :
                                   vuln.severity === "High" ? "#f59e0b" : "#3b82f6",
                            fontWeight: 700,
                          }}
                        />
                        <Typography variant="subtitle1" sx={{ color: "white", fontWeight: 700 }}>
                          {vuln.title}
                        </Typography>
                      </Box>
                    </AccordionSummary>
                    <AccordionDetails>
                      <Typography variant="body2" sx={{ color: "grey.400", mb: 2 }}>
                        {vuln.description}
                      </Typography>
                      <Paper sx={{ p: 2, bgcolor: alpha("#3b82f6", 0.08), borderRadius: 2, mb: 2 }}>
                        <Typography variant="subtitle2" sx={{ color: "#3b82f6", fontWeight: 700, mb: 1 }}>
                          How to test
                        </Typography>
                        <Typography variant="body2" sx={{ color: "grey.300" }}>
                          {vuln.howToTest}
                        </Typography>
                      </Paper>
                      <Paper sx={{ p: 2, bgcolor: alpha("#22c55e", 0.08), borderRadius: 2 }}>
                        <Typography variant="subtitle2" sx={{ color: "#22c55e", fontWeight: 700, mb: 1 }}>
                          Recommended fix
                        </Typography>
                        <Typography variant="body2" sx={{ color: "grey.300" }}>
                          {vuln.fix}
                        </Typography>
                      </Paper>
                    </AccordionDetails>
                  </Accordion>
                ))}
              </Box>
            </TabPanel>

            {/* Tab 4: Tools and Commands */}
            <TabPanel value={tabValue} index={4}>
              <Grid container spacing={3}>
                {tools.map((tool) => (
                  <Grid item xs={12} md={6} key={tool.name}>
                    <Paper sx={{ p: 3, bgcolor: "#0d1117", borderRadius: 2, height: "100%", border: "1px solid rgba(255,255,255,0.05)" }}>
                      <Box sx={{ display: "flex", alignItems: "center", justifyContent: "space-between", mb: 1 }}>
                        <Typography variant="h6" sx={{ color: "white", fontWeight: 700 }}>
                          {tool.name}
                        </Typography>
                        <Chip label={tool.focus} size="small" sx={{ bgcolor: alpha("#22c55e", 0.2), color: "#22c55e" }} />
                      </Box>
                      <Typography variant="body2" sx={{ color: "grey.400" }}>
                        {tool.description}
                      </Typography>
                    </Paper>
                  </Grid>
                ))}
              </Grid>

              <Divider sx={{ my: 3, borderColor: "rgba(255,255,255,0.05)" }} />

              {commandSections.map((section) => (
                <Paper key={section.category} sx={{ p: 3, mb: 3, bgcolor: "#0d1117", borderRadius: 2, border: "1px solid rgba(255,255,255,0.05)" }}>
                  <Typography variant="h6" sx={{ color: "#22c55e", fontWeight: 700, mb: 2 }}>
                    {section.category}
                  </Typography>
                  <TableContainer>
                    <Table size="small">
                      <TableHead>
                        <TableRow>
                          <TableCell sx={{ color: "white", fontWeight: 700, width: "55%" }}>Command</TableCell>
                          <TableCell sx={{ color: "white", fontWeight: 700 }}>Description</TableCell>
                        </TableRow>
                      </TableHead>
                      <TableBody>
                        {section.commands.map((cmd) => (
                          <TableRow key={cmd.cmd}>
                            <TableCell sx={{ color: "#22c55e", fontFamily: "monospace", fontSize: "0.8rem" }}>
                              {cmd.cmd}
                            </TableCell>
                            <TableCell sx={{ color: "grey.300" }}>{cmd.desc}</TableCell>
                          </TableRow>
                        ))}
                      </TableBody>
                    </Table>
                  </TableContainer>
                </Paper>
              ))}
            </TabPanel>

            {/* Tab 5: Practice Labs */}
            <TabPanel value={tabValue} index={5}>
              <Grid container spacing={3}>
                {practiceLabs.map((lab) => (
                  <Grid item xs={12} key={lab.name}>
                    <Card sx={{ bgcolor: "#0d1117", borderRadius: 2, border: "1px solid rgba(255,255,255,0.05)" }}>
                      <CardContent>
                        <Box sx={{ display: "flex", alignItems: "center", justifyContent: "space-between", mb: 1 }}>
                          <Typography variant="h6" sx={{ color: "white", fontWeight: 700 }}>
                            {lab.name}
                          </Typography>
                          <Box sx={{ display: "flex", gap: 1 }}>
                            <Chip label={lab.difficulty} size="small" sx={{ bgcolor: alpha("#22c55e", 0.2), color: "#22c55e" }} />
                            <Chip label={lab.duration} size="small" variant="outlined" />
                          </Box>
                        </Box>
                        <Typography variant="body2" sx={{ color: "grey.400", mb: 1 }}>
                          Tools: {lab.tools}
                        </Typography>
                        <Divider sx={{ my: 2, borderColor: "rgba(255,255,255,0.05)" }} />
                        <Grid container spacing={2}>
                          <Grid item xs={12} md={6}>
                            <Typography variant="subtitle2" sx={{ color: "#22c55e", fontWeight: 700, mb: 1 }}>
                              Objectives
                            </Typography>
                            <List dense>
                              {lab.objectives.map((obj) => (
                                <ListItem key={obj} sx={{ py: 0.2 }}>
                                  <ListItemIcon sx={{ minWidth: 24 }}>
                                    <CheckCircleIcon sx={{ fontSize: 16, color: "#22c55e" }} />
                                  </ListItemIcon>
                                  <ListItemText
                                    primary={obj}
                                    primaryTypographyProps={{ variant: "body2", sx: { color: "grey.300" } }}
                                  />
                                </ListItem>
                              ))}
                            </List>
                          </Grid>
                          <Grid item xs={12} md={6}>
                            <Typography variant="subtitle2" sx={{ color: "#22c55e", fontWeight: 700, mb: 1 }}>
                              Steps
                            </Typography>
                            <List dense>
                              {lab.steps.map((step, index) => (
                                <ListItem key={step} sx={{ py: 0.2 }}>
                                  <ListItemIcon sx={{ minWidth: 24 }}>
                                    <Typography variant="caption" sx={{ color: "#22c55e", fontWeight: 700 }}>
                                      {index + 1}.
                                    </Typography>
                                  </ListItemIcon>
                                  <ListItemText
                                    primary={step}
                                    primaryTypographyProps={{ variant: "body2", sx: { color: "grey.300" } }}
                                  />
                                </ListItem>
                              ))}
                            </List>
                          </Grid>
                        </Grid>
                      </CardContent>
                    </Card>
                  </Grid>
                ))}
              </Grid>

              <Paper sx={{ p: 3, mt: 3, bgcolor: alpha("#22c55e", 0.08), borderRadius: 2, border: "1px solid rgba(34,197,94,0.2)" }}>
                <Typography variant="h6" sx={{ color: "#22c55e", fontWeight: 700, mb: 2 }}>
                  Practice apps
                </Typography>
                <Grid container spacing={2}>
                  {practiceApps.map((app) => (
                    <Grid item xs={12} md={6} key={app.name}>
                      <Paper sx={{ p: 2, bgcolor: "#0d1117", borderRadius: 2, border: "1px solid rgba(255,255,255,0.05)" }}>
                        <Typography variant="subtitle1" sx={{ color: "white", fontWeight: 600 }}>
                          {app.name}
                        </Typography>
                        <Typography variant="body2" sx={{ color: "grey.400" }}>
                          {app.desc}
                        </Typography>
                      </Paper>
                    </Grid>
                  ))}
                </Grid>
              </Paper>
            </TabPanel>

            {/* Tab 6: Reporting */}
            <TabPanel value={tabValue} index={6}>
              <Grid container spacing={3}>
                <Grid item xs={12} md={6}>
                  <Paper sx={{ p: 3, bgcolor: "#0d1117", borderRadius: 2, border: "1px solid rgba(255,255,255,0.05)" }}>
                    <Typography variant="h6" sx={{ color: "#22c55e", fontWeight: 700, mb: 2 }}>
                      Report structure
                    </Typography>
                    <List dense>
                      {reportStructure.map((item) => (
                        <ListItem key={item} sx={{ py: 0.2 }}>
                          <ListItemIcon sx={{ minWidth: 24 }}>
                            <CheckCircleIcon sx={{ fontSize: 16, color: "#22c55e" }} />
                          </ListItemIcon>
                          <ListItemText
                            primary={item}
                            primaryTypographyProps={{ variant: "body2", sx: { color: "grey.300" } }}
                          />
                        </ListItem>
                      ))}
                    </List>
                  </Paper>
                </Grid>
                <Grid item xs={12} md={6}>
                  <Paper sx={{ p: 3, bgcolor: "#0d1117", borderRadius: 2, border: "1px solid rgba(255,255,255,0.05)" }}>
                    <Typography variant="h6" sx={{ color: "#22c55e", fontWeight: 700, mb: 2 }}>
                      Evidence checklist
                    </Typography>
                    <List dense>
                      {evidenceChecklist.map((item) => (
                        <ListItem key={item} sx={{ py: 0.2 }}>
                          <ListItemIcon sx={{ minWidth: 24 }}>
                            <CheckCircleIcon sx={{ fontSize: 16, color: "#22c55e" }} />
                          </ListItemIcon>
                          <ListItemText
                            primary={item}
                            primaryTypographyProps={{ variant: "body2", sx: { color: "grey.300" } }}
                          />
                        </ListItem>
                      ))}
                    </List>
                  </Paper>
                </Grid>
                <Grid item xs={12}>
                  <Paper sx={{ p: 3, bgcolor: alpha("#3b82f6", 0.08), borderRadius: 2, border: "1px solid rgba(59,130,246,0.2)" }}>
                    <Typography variant="h6" sx={{ color: "#3b82f6", fontWeight: 700, mb: 1 }}>
                      Tips for beginners
                    </Typography>
                    <Typography variant="body2" sx={{ color: "grey.300" }}>
                      Keep your findings simple and specific. Show how to reproduce the issue and why it matters,
                      then recommend a fix that the development team can apply quickly. If you are unsure about impact,
                      describe the risk and ask for clarification instead of guessing.
                    </Typography>
                  </Paper>
                </Grid>
              </Grid>

              <Divider sx={{ my: 3, borderColor: "rgba(255,255,255,0.05)" }} />
              <Typography variant="h6" sx={{ color: "#22c55e", fontWeight: 700 }}>
                Sample finding template
              </Typography>
              <CodeBlock language="text" code={findingTemplate} />
            </TabPanel>
          </Paper>

          {/* Legal Notice */}
          <Alert
            severity="warning"
            icon={<WarningIcon />}
            sx={{ mt: 4, bgcolor: alpha("#f59e0b", 0.1), color: "grey.200" }}
          >
            Only test applications you own or have explicit written permission to assess.
          </Alert>

          {/* Related Learning */}
          <Paper sx={{ p: 3, mt: 3, borderRadius: 3, bgcolor: alpha("#22c55e", 0.08) }}>
            <Typography variant="h6" sx={{ color: "#22c55e", fontWeight: 700, mb: 2 }}>
              Related learning
            </Typography>
            <Box sx={{ display: "flex", gap: 1, flexWrap: "wrap" }}>
              <Chip label="APK Analysis" clickable onClick={() => navigate("/learn/apk-analysis")} />
              <Chip label="Android Reverse Engineering" clickable onClick={() => navigate("/learn/android-reverse-engineering")} />
              <Chip label="Mobile App Pentesting" clickable onClick={() => navigate("/learn/mobile-pentest")} />
              <Chip label="OWASP Mobile Top 10" clickable onClick={() => navigate("/learn/owasp-mobile")} />
            </Box>
          </Paper>

          {/* Back to Learning Hub */}
          <Box sx={{ mt: 4, textAlign: "center" }}>
            <Button
              variant="outlined"
              startIcon={<ArrowBackIcon />}
              onClick={() => navigate("/learn")}
              sx={{
                borderColor: alpha("#22c55e", 0.5),
                color: "#22c55e",
                px: 4,
                py: 1,
                "&:hover": { borderColor: "#22c55e", bgcolor: alpha("#22c55e", 0.1) },
              }}
            >
              Back to Learning Hub
            </Button>
          </Box>
        </Container>
      </Box>
    </LearnPageLayout>
  );
};

export default AndroidPentestingPage;
