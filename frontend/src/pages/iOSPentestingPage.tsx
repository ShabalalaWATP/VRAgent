import React, { useState } from "react";
import LearnPageLayout from "../components/LearnPageLayout";
import {
  Box,
  Container,
  Typography,
  Paper,
  Chip,
  Button,
  Grid,
  List,
  ListItem,
  ListItemIcon,
  ListItemText,
  alpha,
  useTheme,
  Tabs,
  Tab,
  Accordion,
  AccordionSummary,
  AccordionDetails,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  Card,
  CardContent,
  Alert,
  Divider,
  LinearProgress,
} from "@mui/material";
import ArrowBackIcon from "@mui/icons-material/ArrowBack";
import AppleIcon from "@mui/icons-material/Apple";
import SecurityIcon from "@mui/icons-material/Security";
import BugReportIcon from "@mui/icons-material/BugReport";
import StorageIcon from "@mui/icons-material/Storage";
import HttpIcon from "@mui/icons-material/Http";
import LockOpenIcon from "@mui/icons-material/LockOpen";
import BuildIcon from "@mui/icons-material/Build";
import CheckCircleIcon from "@mui/icons-material/CheckCircle";
import WarningIcon from "@mui/icons-material/Warning";
import ExpandMoreIcon from "@mui/icons-material/ExpandMore";
import CodeIcon from "@mui/icons-material/Code";
import SchoolIcon from "@mui/icons-material/School";
import VerifiedUserIcon from "@mui/icons-material/VerifiedUser";
import TerminalIcon from "@mui/icons-material/Terminal";
import FingerprintIcon from "@mui/icons-material/Fingerprint";
import NetworkCheckIcon from "@mui/icons-material/NetworkCheck";
import ScienceIcon from "@mui/icons-material/Science";
import MenuBookIcon from "@mui/icons-material/MenuBook";
import QuizIcon from "@mui/icons-material/Quiz";
import EmojiEventsIcon from "@mui/icons-material/EmojiEvents";
import RefreshIcon from "@mui/icons-material/Refresh";
import { useNavigate } from "react-router-dom";

// Quiz Question Interface
interface QuizQuestion {
  id: number;
  question: string;
  options: string[];
  correctAnswer: number;
  explanation: string;
  topic: string;
}

// iOS Pentesting Quiz Question Bank (75 questions)
const questionBank: QuizQuestion[] = [
  // Section 1: iOS Architecture (10 questions)
  { id: 1, question: "What is the iOS app sandbox?", options: ["A game environment", "Security mechanism restricting app access to its own container", "Cloud storage", "Testing environment"], correctAnswer: 1, explanation: "iOS sandbox isolates each app to its own container with limited system access.", topic: "Architecture" },
  { id: 2, question: "What is the iOS Secure Enclave?", options: ["App container", "Hardware security processor for cryptographic operations", "iCloud feature", "App Store section"], correctAnswer: 1, explanation: "Secure Enclave is a dedicated hardware processor for key storage and biometric operations.", topic: "Architecture" },
  { id: 3, question: "What is the App Store code signing requirement?", options: ["Optional", "All apps must be signed with Apple-issued certificates", "Only paid apps", "Only enterprise apps"], correctAnswer: 1, explanation: "Apple requires all iOS apps to be code-signed with valid certificates.", topic: "Architecture" },
  { id: 4, question: "What is ASLR in iOS?", options: ["Apple Security Layer Runtime", "Address Space Layout Randomization", "App Store License Requirement", "Application Security Lock Registry"], correctAnswer: 1, explanation: "ASLR randomizes memory addresses to prevent exploitation of memory corruption.", topic: "Architecture" },
  { id: 5, question: "What is the Data Protection API?", options: ["Backup feature", "File encryption based on device lock state", "Network protection", "Data validation"], correctAnswer: 1, explanation: "Data Protection API encrypts files with keys protected by device passcode.", topic: "Architecture" },
  { id: 6, question: "What are iOS entitlements?", options: ["User permissions", "Capabilities granted to apps through code signing", "Network access", "Storage quotas"], correctAnswer: 1, explanation: "Entitlements are key-value pairs specifying app capabilities and permissions.", topic: "Architecture" },
  { id: 7, question: "What is a .ipa file?", options: ["iOS Protocol Archive", "iOS App Store Package - archive format for apps", "iOS Password Archive", "iOS Preferences Archive"], correctAnswer: 1, explanation: "IPA (iOS App Store Package) is the archive format for iOS applications.", topic: "Architecture" },
  { id: 8, question: "What is the purpose of provisioning profiles?", options: ["App performance", "Link code signing identity with devices and entitlements", "User profiles", "Network settings"], correctAnswer: 1, explanation: "Provisioning profiles authorize apps to run on specific devices with specific capabilities.", topic: "Architecture" },
  { id: 9, question: "What is iOS App Transport Security (ATS)?", options: ["Physical security", "Policy requiring HTTPS for network connections", "App backup", "Transport protocol"], correctAnswer: 1, explanation: "ATS enforces secure network connections by requiring HTTPS.", topic: "Architecture" },
  { id: 10, question: "What is the iOS Keychain?", options: ["Physical keychain", "Encrypted storage for sensitive credentials", "iCloud sync", "Password manager app"], correctAnswer: 1, explanation: "Keychain provides encrypted storage for passwords, certificates, and secrets.", topic: "Architecture" },

  // Section 2: Jailbreaking & Device Setup (10 questions)
  { id: 11, question: "What is jailbreaking?", options: ["Breaking the phone", "Removing iOS security restrictions to gain root access", "iOS update", "Factory reset"], correctAnswer: 1, explanation: "Jailbreaking bypasses iOS security controls to allow root access and testing.", topic: "Jailbreaking" },
  { id: 12, question: "Why is a jailbroken device useful for pentesting?", options: ["Faster performance", "Full filesystem access and ability to install tools", "Better graphics", "Longer battery"], correctAnswer: 1, explanation: "Jailbreaking enables installing testing tools and accessing protected directories.", topic: "Jailbreaking" },
  { id: 13, question: "What is Cydia?", options: ["Virus", "Package manager for jailbroken iOS devices", "Apple app", "Game"], correctAnswer: 1, explanation: "Cydia is a package manager for installing apps and tools on jailbroken devices.", topic: "Jailbreaking" },
  { id: 14, question: "What is Sileo?", options: ["Music app", "Modern package manager replacing Cydia", "Camera app", "Browser"], correctAnswer: 1, explanation: "Sileo is a modern package manager alternative to Cydia for jailbroken devices.", topic: "Jailbreaking" },
  { id: 15, question: "What is checkra1n?", options: ["Check rain", "Hardware-based semi-tethered jailbreak tool", "Weather app", "Security check"], correctAnswer: 1, explanation: "checkra1n exploits a hardware vulnerability (checkm8) for jailbreaking.", topic: "Jailbreaking" },
  { id: 16, question: "What is a semi-tethered jailbreak?", options: ["Half broken", "Requires computer to jailbreak after reboot but boots without", "Permanent jailbreak", "Cloud-based"], correctAnswer: 1, explanation: "Semi-tethered boots without computer but jailbreak state requires re-jailbreaking.", topic: "Jailbreaking" },
  { id: 17, question: "What is SSH used for on jailbroken devices?", options: ["Streaming", "Remote shell access and file transfer", "Social media", "Email"], correctAnswer: 1, explanation: "SSH provides secure remote terminal access to the jailbroken device.", topic: "Jailbreaking" },
  { id: 18, question: "What is the default SSH password on jailbroken iOS?", options: ["password", "alpine", "root", "1234"], correctAnswer: 1, explanation: "The default SSH password on jailbroken iOS is 'alpine' - should be changed!", topic: "Jailbreaking" },
  { id: 19, question: "What is unc0ver?", options: ["Discovery tool", "Popular jailbreak tool using software exploits", "Backup app", "Privacy tool"], correctAnswer: 1, explanation: "unc0ver is a popular semi-untethered jailbreak tool for various iOS versions.", topic: "Jailbreaking" },
  { id: 20, question: "What filesystem access does root provide?", options: ["User files only", "Complete access to all iOS directories and files", "Photos only", "App data only"], correctAnswer: 1, explanation: "Root access allows reading/writing all files including system and app data.", topic: "Jailbreaking" },

  // Section 3: Static Analysis (12 questions)
  { id: 21, question: "What tool decrypts App Store apps on jailbroken devices?", options: ["Xcode", "Clutch or frida-ios-dump", "iTunes", "Safari"], correctAnswer: 1, explanation: "Tools like Clutch or frida-ios-dump decrypt FairPlay-encrypted apps.", topic: "Static Analysis" },
  { id: 22, question: "What is class-dump used for?", options: ["Cleanup", "Extracting Objective-C class information from binaries", "Creating classes", "Database dump"], correctAnswer: 1, explanation: "class-dump extracts Objective-C runtime information from Mach-O binaries.", topic: "Static Analysis" },
  { id: 23, question: "What is Hopper Disassembler?", options: ["Transport", "Disassembler and decompiler for Mach-O binaries", "Network tool", "File manager"], correctAnswer: 1, explanation: "Hopper analyzes and decompiles iOS binaries for reverse engineering.", topic: "Static Analysis" },
  { id: 24, question: "What is the Info.plist file?", options: ["User info", "App configuration file with metadata and permissions", "Contact list", "Log file"], correctAnswer: 1, explanation: "Info.plist contains app configuration, URL schemes, permissions, and settings.", topic: "Static Analysis" },
  { id: 25, question: "What are URL schemes in iOS?", options: ["Website URLs", "Custom protocols for launching apps and passing data", "HTTP methods", "API endpoints"], correctAnswer: 1, explanation: "URL schemes allow deep linking and inter-app communication.", topic: "Static Analysis" },
  { id: 26, question: "What should you check in entitlements?", options: ["App name", "Keychain access groups, app groups, and capabilities", "Developer name", "Version"], correctAnswer: 1, explanation: "Review entitlements for excessive capabilities and keychain sharing.", topic: "Static Analysis" },
  { id: 27, question: "What is MobSF for iOS?", options: ["Mobile SF game", "Automated security analysis framework", "Map app", "Music app"], correctAnswer: 1, explanation: "MobSF performs automated static and dynamic analysis of iOS apps.", topic: "Static Analysis" },
  { id: 28, question: "What is PIE in iOS binaries?", options: ["Food", "Position Independent Executable - ASLR support", "Program Interface", "Password Interface"], correctAnswer: 1, explanation: "PIE enables ASLR, making exploitation more difficult.", topic: "Static Analysis" },
  { id: 29, question: "What does checking for ARC reveal?", options: ["Curve geometry", "Whether app uses Automatic Reference Counting for memory", "Network arcs", "UI curves"], correctAnswer: 1, explanation: "ARC helps prevent memory management vulnerabilities.", topic: "Static Analysis" },
  { id: 30, question: "What are hardcoded secrets?", options: ["Encrypted secrets", "API keys, passwords embedded in code", "User secrets", "Secure storage"], correctAnswer: 1, explanation: "Hardcoded credentials in binaries can be extracted through analysis.", topic: "Static Analysis" },
  { id: 31, question: "What is string analysis in iOS apps?", options: ["Cord analysis", "Searching binary for embedded strings like URLs, keys", "UI text", "String length"], correctAnswer: 1, explanation: "String analysis reveals hardcoded URLs, keys, and sensitive data.", topic: "Static Analysis" },
  { id: 32, question: "What is FairPlay encryption?", options: ["Game DRM", "Apple's DRM protecting App Store apps", "Music protection", "Video codec"], correctAnswer: 1, explanation: "FairPlay encrypts App Store apps; decryption needed for analysis.", topic: "Static Analysis" },

  // Section 4: Dynamic Analysis (12 questions)
  { id: 33, question: "What is Frida?", options: ["Painter", "Dynamic instrumentation toolkit", "Camera app", "Browser"], correctAnswer: 1, explanation: "Frida injects JavaScript to hook and modify iOS app behavior at runtime.", topic: "Dynamic Analysis" },
  { id: 34, question: "What is objection?", options: ["Protest", "Runtime mobile exploration toolkit built on Frida", "IDE", "Compiler"], correctAnswer: 1, explanation: "objection provides pre-built Frida scripts for common iOS testing tasks.", topic: "Dynamic Analysis" },
  { id: 35, question: "What is Cycript?", options: ["Script type", "Runtime manipulation using JavaScript and Objective-C", "Build script", "Test script"], correctAnswer: 1, explanation: "Cycript allows runtime inspection and modification using JS/ObjC syntax.", topic: "Dynamic Analysis" },
  { id: 36, question: "How do you intercept iOS network traffic?", options: ["Screenshot", "Configure proxy and install CA certificate", "Record screen", "Take photo"], correctAnswer: 1, explanation: "Install proxy CA in device settings and configure WiFi proxy.", topic: "Dynamic Analysis" },
  { id: 37, question: "What is SSL Kill Switch?", options: ["Power switch", "Tweak to disable SSL certificate validation", "Network switch", "App switch"], correctAnswer: 1, explanation: "SSL Kill Switch disables certificate pinning for traffic interception.", topic: "Dynamic Analysis" },
  { id: 38, question: "What is LLDB used for?", options: ["Database", "Debugging iOS applications at runtime", "File browser", "Network tool"], correctAnswer: 1, explanation: "LLDB is the debugger for iOS apps, allowing runtime inspection.", topic: "Dynamic Analysis" },
  { id: 39, question: "What is method swizzling?", options: ["Dance move", "Runtime replacement of method implementations", "UI animation", "Code formatting"], correctAnswer: 1, explanation: "Swizzling exchanges method implementations at runtime for hooking.", topic: "Dynamic Analysis" },
  { id: 40, question: "What is the iOS simulator useful for?", options: ["Games", "Testing without device but limited for security testing", "Video editing", "Music"], correctAnswer: 1, explanation: "Simulator runs iOS apps but lacks some hardware security features.", topic: "Dynamic Analysis" },
  { id: 41, question: "What is runtime analysis goal?", options: ["Performance", "Understand app behavior and bypass security controls", "UI testing", "Battery testing"], correctAnswer: 1, explanation: "Runtime analysis reveals actual app behavior and enables bypassing protections.", topic: "Dynamic Analysis" },
  { id: 42, question: "What can you do with Frida on iOS?", options: ["Only logging", "Hook methods, bypass protections, dump data, trace calls", "Only screenshots", "Only network"], correctAnswer: 1, explanation: "Frida enables comprehensive runtime manipulation and analysis.", topic: "Dynamic Analysis" },
  { id: 43, question: "What is needle?", options: ["Sewing tool", "iOS security testing framework (deprecated)", "Injection tool", "Analysis tool"], correctAnswer: 1, explanation: "needle was an iOS security testing framework, now largely replaced by objection.", topic: "Dynamic Analysis" },
  { id: 44, question: "How can biometric authentication be bypassed?", options: ["Cannot bypass", "Hook authentication callbacks to return success", "Only by fingerprint", "Only with passcode"], correctAnswer: 1, explanation: "Frida can hook biometric callbacks to bypass Touch ID/Face ID.", topic: "Dynamic Analysis" },

  // Section 5: Data Storage (10 questions)
  { id: 45, question: "Where is the iOS app container located?", options: ["/Applications/", "/var/mobile/Containers/Data/Application/", "/System/", "/tmp/"], correctAnswer: 1, explanation: "App data is stored in /var/mobile/Containers/Data/Application/<UUID>/.", topic: "Data Storage" },
  { id: 46, question: "What is NSUserDefaults?", options: ["Default user", "Simple key-value storage for preferences", "User management", "Default settings"], correctAnswer: 1, explanation: "NSUserDefaults stores user preferences, but shouldn't hold secrets.", topic: "Data Storage" },
  { id: 47, question: "What is Core Data?", options: ["CPU core", "Framework for object graph and persistence", "Data center", "Core files"], correctAnswer: 1, explanation: "Core Data manages object models with SQLite storage backend.", topic: "Data Storage" },
  { id: 48, question: "What Keychain access protection classes exist?", options: ["Public/Private", "WhenUnlocked, AfterFirstUnlock, Always, etc.", "Read/Write", "User/Admin"], correctAnswer: 1, explanation: "Keychain protection classes determine when data is accessible.", topic: "Data Storage" },
  { id: 49, question: "What is kSecAttrAccessibleWhenUnlocked?", options: ["Never accessible", "Data accessible only when device is unlocked", "Always accessible", "Accessible after reboot"], correctAnswer: 1, explanation: "WhenUnlocked restricts access to when the device is unlocked.", topic: "Data Storage" },
  { id: 50, question: "What should you check in SQLite databases?", options: ["Performance", "Unencrypted sensitive data and credentials", "Table count", "Query speed"], correctAnswer: 1, explanation: "Examine SQLite DBs for sensitive data stored without encryption.", topic: "Data Storage" },
  { id: 51, question: "What is the Documents directory used for?", options: ["System docs", "User-created content backed up to iCloud", "App docs", "Help files"], correctAnswer: 1, explanation: "Documents stores user content and is backed up by iTunes/iCloud.", topic: "Data Storage" },
  { id: 52, question: "What is the Caches directory?", options: ["Money storage", "Temporary data that may persist and be backed up", "System cache", "Network cache"], correctAnswer: 1, explanation: "Caches holds temporary data that may contain sensitive information.", topic: "Data Storage" },
  { id: 53, question: "What is Realm database?", options: ["Game world", "Mobile database alternative to Core Data/SQLite", "Cloud database", "Server database"], correctAnswer: 1, explanation: "Realm is a mobile database that should be encrypted for sensitive data.", topic: "Data Storage" },
  { id: 54, question: "What is the risk of NSCoding archives?", options: ["No risk", "Serialized objects may contain sensitive data", "Performance only", "Size only"], correctAnswer: 1, explanation: "NSCoding/NSKeyedArchiver serializations may persist sensitive objects.", topic: "Data Storage" },

  // Section 6: Network Security (10 questions)
  { id: 55, question: "What is certificate pinning?", options: ["Physical pinning", "Hardcoding expected server certificates in app", "Network speed", "DNS pinning"], correctAnswer: 1, explanation: "Certificate pinning validates server certs against embedded values.", topic: "Network Security" },
  { id: 56, question: "How to bypass SSL pinning with Frida?", options: ["Cannot bypass", "Hook SSL validation methods to always succeed", "Disable WiFi", "Restart device"], correctAnswer: 1, explanation: "Frida scripts can hook SSL validation to bypass pinning.", topic: "Network Security" },
  { id: 57, question: "What is NSURLSession?", options: ["URL shortener", "Modern networking API for HTTP/HTTPS requests", "Session manager", "Cookie storage"], correctAnswer: 1, explanation: "NSURLSession is the primary networking API in iOS.", topic: "Network Security" },
  { id: 58, question: "What does ATS exception info.plist reveal?", options: ["Nothing", "Domains allowed to use insecure connections", "App version", "Developer info"], correctAnswer: 1, explanation: "ATS exceptions show domains exempted from security requirements.", topic: "Network Security" },
  { id: 59, question: "What is Universal Links?", options: ["Chain links", "Secure alternative to custom URL schemes", "Deep links", "Web links"], correctAnswer: 1, explanation: "Universal Links provide secure deep linking verified by apple-app-site-association.", topic: "Network Security" },
  { id: 60, question: "What is mitmproxy used for?", options: ["Mining", "Interactive HTTPS interception and analysis", "Media player", "Map tool"], correctAnswer: 1, explanation: "mitmproxy intercepts and analyzes HTTP/HTTPS traffic.", topic: "Network Security" },
  { id: 61, question: "What is Charles Proxy?", options: ["Royal figure", "HTTP debugging proxy for traffic analysis", "Chat app", "Game character"], correctAnswer: 1, explanation: "Charles Proxy captures and analyzes web traffic from iOS devices.", topic: "Network Security" },
  { id: 62, question: "What are WebSockets in iOS security?", options: ["Web spiders", "Persistent connections that should be inspected", "Socket wrenches", "Web pages"], correctAnswer: 1, explanation: "WebSocket connections may bypass regular HTTP inspection.", topic: "Network Security" },
  { id: 63, question: "What is NSAllowsArbitraryLoads?", options: ["Memory setting", "Disables ATS allowing all HTTP connections", "CPU setting", "Storage setting"], correctAnswer: 1, explanation: "NSAllowsArbitraryLoads=YES disables ATS protections.", topic: "Network Security" },
  { id: 64, question: "What should you check in API responses?", options: ["Speed only", "Sensitive data exposure, verbose errors, headers", "Size only", "Format only"], correctAnswer: 1, explanation: "Check for data leakage, sensitive info in errors, and security headers.", topic: "Network Security" },

  // Section 7: Binary Protections (11 questions)
  { id: 65, question: "What is jailbreak detection?", options: ["Finding jailbreaks", "Checking if device security is compromised", "Jailbreak tool", "Device check"], correctAnswer: 1, explanation: "Apps detect jailbroken devices to protect against manipulation.", topic: "Binary Protection" },
  { id: 66, question: "How to bypass jailbreak detection?", options: ["Cannot bypass", "Hook detection methods with Frida or use HideJB tweaks", "Unjailbreak", "Reinstall app"], correctAnswer: 1, explanation: "Jailbreak detection can be bypassed by hooking checks or using tweaks.", topic: "Binary Protection" },
  { id: 67, question: "What is debugger detection?", options: ["Finding bugs", "Detecting if debugger is attached to prevent analysis", "Debug mode", "Error detection"], correctAnswer: 1, explanation: "Apps detect debuggers to prevent runtime analysis.", topic: "Binary Protection" },
  { id: 68, question: "What is code obfuscation?", options: ["Code clarity", "Making code difficult to understand", "Code comments", "Code formatting"], correctAnswer: 1, explanation: "Obfuscation makes reverse engineering harder.", topic: "Binary Protection" },
  { id: 69, question: "What is anti-tampering?", options: ["Weatherproofing", "Detecting modifications to app binary", "UI protection", "Data protection"], correctAnswer: 1, explanation: "Anti-tampering detects if the app has been modified.", topic: "Binary Protection" },
  { id: 70, question: "What is Device Check API?", options: ["Hardware test", "Apple API for device validity checking", "Screen check", "Battery check"], correctAnswer: 1, explanation: "DeviceCheck allows servers to verify device authenticity with Apple.", topic: "Binary Protection" },
  { id: 71, question: "What is App Attest?", options: ["App testimony", "Hardware-based app integrity verification", "App review", "App test"], correctAnswer: 1, explanation: "App Attest uses Secure Enclave to verify app integrity to servers.", topic: "Binary Protection" },
  { id: 72, question: "What is Stack Smashing Protection?", options: ["Stack overflow", "Canary values to detect buffer overflows", "Memory allocation", "Stack cleanup"], correctAnswer: 1, explanation: "Stack canaries detect buffer overflow attacks.", topic: "Binary Protection" },
  { id: 73, question: "What is otool used for?", options: ["Tools organization", "Displaying Mach-O binary information", "Tool download", "Build tool"], correctAnswer: 1, explanation: "otool displays information about Mach-O object files.", topic: "Binary Protection" },
  { id: 74, question: "What is nm command?", options: ["Name manager", "Lists symbols from object files", "Network manager", "Node manager"], correctAnswer: 1, explanation: "nm displays the symbol table of binaries.", topic: "Binary Protection" },
  { id: 75, question: "What does checking for stripped binaries reveal?", options: ["File size", "Whether debug symbols are removed", "Performance", "Compatibility"], correctAnswer: 1, explanation: "Stripped binaries have debug symbols removed, making analysis harder.", topic: "Binary Protection" },
];

// Quiz Section Component
function QuizSection() {
  const theme = useTheme();
  const [quizStarted, setQuizStarted] = React.useState(false);
  const [currentQuestions, setCurrentQuestions] = React.useState<QuizQuestion[]>([]);
  const [userAnswers, setUserAnswers] = React.useState<{ [key: number]: number }>({});
  const [showResults, setShowResults] = React.useState(false);
  const [currentQuestionIndex, setCurrentQuestionIndex] = React.useState(0);

  const shuffleAndSelectQuestions = () => {
    const shuffled = [...questionBank].sort(() => Math.random() - 0.5);
    return shuffled.slice(0, 10);
  };

  const startQuiz = () => {
    setCurrentQuestions(shuffleAndSelectQuestions());
    setUserAnswers({});
    setShowResults(false);
    setCurrentQuestionIndex(0);
    setQuizStarted(true);
  };

  const handleAnswerSelect = (questionId: number, answerIndex: number) => {
    setUserAnswers((prev) => ({ ...prev, [questionId]: answerIndex }));
  };

  const calculateScore = () => {
    let correct = 0;
    currentQuestions.forEach((q) => {
      if (userAnswers[q.id] === q.correctAnswer) correct++;
    });
    return correct;
  };

  const getScoreColor = (score: number) => {
    if (score >= 8) return "#007AFF";
    if (score >= 6) return "#f59e0b";
    return "#ef4444";
  };

  const getScoreMessage = (score: number) => {
    if (score === 10) return "Perfect! You're an iOS security expert! ðŸ†";
    if (score >= 8) return "Excellent! Strong iOS pentesting knowledge! ðŸŽ";
    if (score >= 6) return "Good job! Keep studying iOS security! ðŸ“š";
    if (score >= 4) return "Not bad, but review the material again. ðŸ’ª";
    return "Keep learning! Review the sections above. ðŸ“–";
  };

  if (!quizStarted) {
    return (
      <Paper id="quiz-section" sx={{ p: 4, mb: 4, borderRadius: 3, bgcolor: alpha("#007AFF", 0.03), border: `2px solid ${alpha("#007AFF", 0.2)}` }}>
        <Typography variant="h5" sx={{ fontWeight: 800, mb: 2, display: "flex", alignItems: "center", gap: 2 }}>
          <Box sx={{ width: 48, height: 48, borderRadius: 2, background: "linear-gradient(135deg, #007AFF, #5856D6)", display: "flex", alignItems: "center", justifyContent: "center" }}>
            <QuizIcon sx={{ color: "white", fontSize: 28 }} />
          </Box>
          Test Your iOS Pentesting Knowledge
        </Typography>
        <Typography variant="body1" sx={{ mb: 3, color: "text.secondary" }}>
          Ready to test what you've learned? Take this <strong>10-question quiz</strong> covering iOS security testing. Questions are randomly selected from a pool of <strong>75 questions</strong>!
        </Typography>
        <Grid container spacing={2} sx={{ mb: 3 }}>
          {[{ label: "Questions", value: "10", color: "#007AFF" }, { label: "Question Pool", value: "75", color: "#5856D6" }, { label: "Topics", value: "7", color: "#8b5cf6" }, { label: "Retakes", value: "âˆž", color: "#f59e0b" }].map((stat) => (
            <Grid item xs={6} sm={3} key={stat.label}>
              <Paper sx={{ p: 2, textAlign: "center", bgcolor: alpha(stat.color, 0.1), borderRadius: 2 }}>
                <Typography variant="h4" sx={{ fontWeight: 800, color: stat.color }}>{stat.value}</Typography>
                <Typography variant="caption" color="text.secondary">{stat.label}</Typography>
              </Paper>
            </Grid>
          ))}
        </Grid>
        <Button variant="contained" size="large" onClick={startQuiz} startIcon={<QuizIcon />} sx={{ background: "linear-gradient(135deg, #007AFF, #5856D6)", fontWeight: 700, px: 4, py: 1.5, "&:hover": { background: "linear-gradient(135deg, #5856D6, #007AFF)" } }}>
          Start Quiz
        </Button>
      </Paper>
    );
  }

  if (showResults) {
    const score = calculateScore();
    return (
      <Paper id="quiz-section" sx={{ p: 4, mb: 4, borderRadius: 3, border: `2px solid ${alpha(getScoreColor(score), 0.3)}` }}>
        <Typography variant="h5" sx={{ fontWeight: 800, mb: 3, display: "flex", alignItems: "center", gap: 2 }}>
          <EmojiEventsIcon sx={{ color: getScoreColor(score), fontSize: 36 }} /> Quiz Results
        </Typography>
        <Box sx={{ textAlign: "center", mb: 4 }}>
          <Typography variant="h1" sx={{ fontWeight: 900, color: getScoreColor(score) }}>{score}/10</Typography>
          <Typography variant="h6" color="text.secondary" sx={{ mb: 2 }}>{getScoreMessage(score)}</Typography>
          <Chip label={`${score * 10}%`} sx={{ bgcolor: alpha(getScoreColor(score), 0.15), color: getScoreColor(score), fontWeight: 700, fontSize: "1rem" }} />
        </Box>
        <Divider sx={{ my: 3 }} />
        <Typography variant="h6" sx={{ fontWeight: 700, mb: 2 }}>Review Your Answers:</Typography>
        {currentQuestions.map((q, index) => {
          const isCorrect = userAnswers[q.id] === q.correctAnswer;
          return (
            <Paper key={q.id} sx={{ p: 2, mb: 2, borderRadius: 2, bgcolor: alpha(isCorrect ? "#007AFF" : "#ef4444", 0.05), border: `1px solid ${alpha(isCorrect ? "#007AFF" : "#ef4444", 0.2)}` }}>
              <Box sx={{ display: "flex", alignItems: "flex-start", gap: 1, mb: 1 }}>
                <Chip label={`Q${index + 1}`} size="small" sx={{ bgcolor: isCorrect ? "#007AFF" : "#ef4444", color: "white", fontWeight: 700 }} />
                <Typography variant="body2" sx={{ fontWeight: 600 }}>{q.question}</Typography>
              </Box>
              <Typography variant="body2" color="text.secondary" sx={{ ml: 5 }}>
                <strong>Your answer:</strong> {q.options[userAnswers[q.id]] || "Not answered"}
                {!isCorrect && (<><br /><strong style={{ color: "#007AFF" }}>Correct:</strong> {q.options[q.correctAnswer]}</>)}
              </Typography>
              {!isCorrect && <Alert severity="info" sx={{ mt: 1, ml: 5 }}><Typography variant="caption">{q.explanation}</Typography></Alert>}
            </Paper>
          );
        })}
        <Box sx={{ display: "flex", gap: 2, mt: 3 }}>
          <Button variant="contained" onClick={startQuiz} startIcon={<RefreshIcon />} sx={{ background: "linear-gradient(135deg, #007AFF, #5856D6)", fontWeight: 700 }}>Try Again</Button>
          <Button variant="outlined" onClick={() => setQuizStarted(false)}>Back to Overview</Button>
        </Box>
      </Paper>
    );
  }

  const currentQuestion = currentQuestions[currentQuestionIndex];
  const answeredCount = Object.keys(userAnswers).length;

  return (
    <Paper id="quiz-section" sx={{ p: 4, mb: 4, borderRadius: 3, border: `2px solid ${alpha("#007AFF", 0.2)}` }}>
      <Box sx={{ mb: 3 }}>
        <Box sx={{ display: "flex", justifyContent: "space-between", alignItems: "center", mb: 1 }}>
          <Typography variant="subtitle2" sx={{ fontWeight: 700 }}>Question {currentQuestionIndex + 1} of 10</Typography>
          <Chip label={currentQuestion.topic} size="small" sx={{ bgcolor: alpha("#5856D6", 0.15), color: "#5856D6", fontWeight: 600 }} />
        </Box>
        <LinearProgress variant="determinate" value={((currentQuestionIndex + 1) / 10) * 100} sx={{ height: 8, borderRadius: 1, bgcolor: alpha("#007AFF", 0.1), "& .MuiLinearProgress-bar": { bgcolor: "#007AFF" } }} />
      </Box>
      <Typography variant="h6" sx={{ fontWeight: 700, mb: 3, lineHeight: 1.5 }}>{currentQuestion.question}</Typography>
      <Grid container spacing={2} sx={{ mb: 4 }}>
        {currentQuestion.options.map((option, index) => {
          const isSelected = userAnswers[currentQuestion.id] === index;
          return (
            <Grid item xs={12} key={index}>
              <Paper onClick={() => handleAnswerSelect(currentQuestion.id, index)} sx={{ p: 2, borderRadius: 2, cursor: "pointer", bgcolor: isSelected ? alpha("#007AFF", 0.1) : "background.paper", border: `2px solid ${isSelected ? "#007AFF" : alpha(theme.palette.divider, 0.2)}`, transition: "all 0.2s", "&:hover": { borderColor: "#007AFF", bgcolor: alpha("#007AFF", 0.05) } }}>
                <Box sx={{ display: "flex", alignItems: "center", gap: 2 }}>
                  <Box sx={{ width: 32, height: 32, borderRadius: "50%", bgcolor: isSelected ? "#007AFF" : alpha(theme.palette.divider, 0.3), color: isSelected ? "white" : "text.secondary", display: "flex", alignItems: "center", justifyContent: "center", fontWeight: 700 }}>{String.fromCharCode(65 + index)}</Box>
                  <Typography variant="body1" sx={{ fontWeight: isSelected ? 600 : 400 }}>{option}</Typography>
                </Box>
              </Paper>
            </Grid>
          );
        })}
      </Grid>
      <Box sx={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
        <Button variant="outlined" disabled={currentQuestionIndex === 0} onClick={() => setCurrentQuestionIndex((p) => p - 1)}>Previous</Button>
        <Typography variant="body2" color="text.secondary">{answeredCount}/10 answered</Typography>
        {currentQuestionIndex < 9 ? (
          <Button variant="contained" onClick={() => setCurrentQuestionIndex((p) => p + 1)} sx={{ background: "linear-gradient(135deg, #007AFF, #5856D6)" }}>Next</Button>
        ) : (
          <Button variant="contained" onClick={() => setShowResults(true)} disabled={answeredCount < 10} sx={{ background: answeredCount >= 10 ? "linear-gradient(135deg, #3b82f6, #2563eb)" : undefined, fontWeight: 700 }}>Submit Quiz</Button>
        )}
      </Box>
    </Paper>
  );
}

// CodeBlock component for displaying code snippets
const CodeBlock: React.FC<{ code: string; language?: string }> = ({
  code,
  language = "javascript",
}) => {
  return (
    <Box
      component="pre"
      sx={{
        p: 2,
        borderRadius: 1,
        bgcolor: "#0d1117",
        color: "#c9d1d9",
        overflow: "auto",
        fontSize: "0.85rem",
        fontFamily: "'Fira Code', 'Consolas', monospace",
        border: "1px solid #30363d",
        maxHeight: 400,
        "&::-webkit-scrollbar": {
          height: 8,
          width: 8,
        },
        "&::-webkit-scrollbar-thumb": {
          bgcolor: "#30363d",
          borderRadius: 4,
        },
      }}
    >
      <code>{code}</code>
    </Box>
  );
};

interface TabPanelProps {
  children?: React.ReactNode;
  index: number;
  value: number;
}

function TabPanel(props: TabPanelProps) {
  const { children, value, index, ...other } = props;
  return (
    <div role="tabpanel" hidden={value !== index} {...other}>
      {value === index && <Box>{children}</Box>}
    </div>
  );
}

interface Section {
  title: string;
  icon: React.ReactNode;
  color: string;
  items: string[];
}

// OWASP MASVS Categories
const masvsCategories = [
  {
    id: "MASVS-STORAGE",
    name: "Storage",
    description: "Secure storage of sensitive data",
    controls: [
      { id: "MASVS-STORAGE-1", name: "Secure credential storage", severity: "High" },
      { id: "MASVS-STORAGE-2", name: "No sensitive data in logs", severity: "Medium" },
    ],
  },
  {
    id: "MASVS-CRYPTO",
    name: "Cryptography",
    description: "Use of proven cryptographic primitives",
    controls: [
      { id: "MASVS-CRYPTO-1", name: "Strong algorithms only", severity: "High" },
      { id: "MASVS-CRYPTO-2", name: "Proper key management", severity: "Critical" },
    ],
  },
  {
    id: "MASVS-AUTH",
    name: "Authentication",
    description: "Authentication and session management",
    controls: [
      { id: "MASVS-AUTH-1", name: "Proper authentication mechanisms", severity: "Critical" },
      { id: "MASVS-AUTH-2", name: "Session management", severity: "High" },
    ],
  },
  {
    id: "MASVS-NETWORK",
    name: "Network",
    description: "Secure network communication",
    controls: [
      { id: "MASVS-NETWORK-1", name: "TLS for all connections", severity: "High" },
      { id: "MASVS-NETWORK-2", name: "Certificate validation", severity: "High" },
    ],
  },
  {
    id: "MASVS-PLATFORM",
    name: "Platform",
    description: "Secure platform interaction",
    controls: [
      { id: "MASVS-PLATFORM-1", name: "Secure IPC mechanisms", severity: "Medium" },
      { id: "MASVS-PLATFORM-2", name: "WebView security", severity: "High" },
    ],
  },
  {
    id: "MASVS-CODE",
    name: "Code Quality",
    description: "Security best practices in code",
    controls: [
      { id: "MASVS-CODE-1", name: "Signature verification", severity: "High" },
      { id: "MASVS-CODE-2", name: "No debug code in release", severity: "Medium" },
    ],
  },
  {
    id: "MASVS-RESILIENCE",
    name: "Resilience",
    description: "Defense in depth measures",
    controls: [
      { id: "MASVS-RESILIENCE-1", name: "Jailbreak detection", severity: "Medium" },
      { id: "MASVS-RESILIENCE-2", name: "Anti-tampering", severity: "Medium" },
    ],
  },
];

// Common iOS vulnerabilities
const vulnerabilities = [
  {
    name: "Insecure Data Storage",
    severity: "High",
    description: "Sensitive data stored in plaintext in Keychain, NSUserDefaults, or filesystem",
    impact: "Data theft, credential exposure",
    detection: "Inspect app sandbox, dump Keychain, analyze SQLite databases",
    mitigation: "Use Keychain with proper access control, encrypt sensitive data",
  },
  {
    name: "Weak Transport Layer Security",
    severity: "High",
    description: "App allows insecure connections or doesn't validate certificates properly",
    impact: "Man-in-the-middle attacks, data interception",
    detection: "Traffic interception with Burp/mitmproxy, check ATS exceptions",
    mitigation: "Enforce TLS 1.2+, implement certificate pinning, no ATS exceptions",
  },
  {
    name: "Insufficient Cryptography",
    severity: "Critical",
    description: "Use of weak algorithms, hardcoded keys, or improper key storage",
    impact: "Data decryption, authentication bypass",
    detection: "Static analysis for crypto APIs, entropy analysis, key extraction",
    mitigation: "Use iOS Keychain for keys, Apple CryptoKit, avoid custom crypto",
  },
  {
    name: "Client-Side Injection",
    severity: "High",
    description: "SQL injection in local databases, JavaScript injection in WebViews",
    impact: "Data manipulation, code execution",
    detection: "Fuzz input fields, analyze WebView configuration",
    mitigation: "Parameterized queries, disable JavaScript in WebViews when not needed",
  },
  {
    name: "Broken Authentication",
    severity: "Critical",
    description: "Weak local authentication, bypassable biometrics, insecure session management",
    impact: "Unauthorized access, account takeover",
    detection: "Frida hooks on authentication methods, token analysis",
    mitigation: "Server-side validation, secure token storage, proper biometric implementation",
  },
  {
    name: "Insecure IPC",
    severity: "Medium",
    description: "Vulnerable URL schemes, exposed pasteboard data, insecure app extensions",
    impact: "Data leakage, unauthorized actions",
    detection: "Analyze URL scheme handlers, test deep links with malformed input",
    mitigation: "Validate all IPC input, use universal links, clear pasteboard on background",
  },
  {
    name: "Binary Protections Missing",
    severity: "Medium",
    description: "Lack of PIE, ARC, stack canaries, or code obfuscation",
    impact: "Easier exploitation of memory corruption bugs",
    detection: "otool -hv, check for __RESTRICT segment",
    mitigation: "Enable all compiler security flags, consider obfuscation",
  },
  {
    name: "Sensitive Data in Backups",
    severity: "Medium",
    description: "Sensitive files included in iTunes/iCloud backups without protection",
    impact: "Data exposure via backup extraction",
    detection: "Create backup, analyze with iBackup tools",
    mitigation: "Mark sensitive files with NSURLIsExcludedFromBackupKey",
  },
];

// Frida scripts
const fridaScripts = {
  sslPinningBypass: `// SSL Pinning Bypass for iOS
// Works with most common pinning implementations

// Bypass SecTrustEvaluate
var SecTrustEvaluate = Module.findExportByName("Security", "SecTrustEvaluate");
if (SecTrustEvaluate) {
  Interceptor.replace(SecTrustEvaluate, new NativeCallback(function(trust, result) {
    Memory.writeU32(result, 0); // kSecTrustResultProceed
    return 0; // errSecSuccess
  }, 'int', ['pointer', 'pointer']));
  console.log("[+] SecTrustEvaluate hooked");
}

// Bypass NSURLSession delegate
var resolver = new ApiResolver('objc');
resolver.enumerateMatches('-[* URLSession:didReceiveChallenge:completionHandler:]', {
  onMatch: function(match) {
    Interceptor.attach(match.address, {
      onEnter: function(args) {
        var completionHandler = new ObjC.Block(args[4]);
        completionHandler.implementation = function(disposition, credential) {
          completionHandler(0, null); // NSURLSessionAuthChallengeUseCredential
        };
      }
    });
    console.log("[+] Hooked: " + match.name);
  },
  onComplete: function() {}
});`,

  jailbreakBypass: `// Jailbreak Detection Bypass
// Hooks common detection methods

var paths = [
  "/Applications/Cydia.app",
  "/Library/MobileSubstrate/MobileSubstrate.dylib",
  "/bin/bash",
  "/usr/sbin/sshd",
  "/etc/apt",
  "/private/var/lib/apt/",
  "/usr/bin/ssh"
];

// Hook NSFileManager fileExistsAtPath
var NSFileManager = ObjC.classes.NSFileManager;
var fileExists = NSFileManager['- fileExistsAtPath:'];
Interceptor.attach(fileExists.implementation, {
  onEnter: function(args) {
    this.path = ObjC.Object(args[2]).toString();
  },
  onLeave: function(retval) {
    for (var i = 0; i < paths.length; i++) {
      if (this.path.indexOf(paths[i]) !== -1) {
        retval.replace(0);
        console.log("[+] Blocked: " + this.path);
        break;
      }
    }
  }
});

// Hook canOpenURL for Cydia
var UIApplication = ObjC.classes.UIApplication;
var canOpenURL = UIApplication['- canOpenURL:'];
Interceptor.attach(canOpenURL.implementation, {
  onEnter: function(args) {
    this.url = ObjC.Object(args[2]).toString();
  },
  onLeave: function(retval) {
    if (this.url.indexOf("cydia") !== -1) {
      retval.replace(0);
      console.log("[+] Blocked cydia URL check");
    }
  }
});

// Hook fork() - some apps check if fork succeeds
var fork = Module.findExportByName(null, "fork");
if (fork) {
  Interceptor.replace(fork, new NativeCallback(function() {
    console.log("[+] fork() blocked");
    return -1;
  }, 'int', []));
}`,

  keychainDump: `// Keychain Data Extraction
// Dumps all accessible Keychain items

var SecItemCopyMatching = Module.findExportByName("Security", "SecItemCopyMatching");

function dumpKeychain() {
  var kSecClass = ObjC.classes.__NSCFString.stringWithString_("class");
  var kSecAttrAccount = ObjC.classes.__NSCFString.stringWithString_("acct");
  var kSecAttrService = ObjC.classes.__NSCFString.stringWithString_("svce");
  var kSecValueData = ObjC.classes.__NSCFString.stringWithString_("v_Data");
  var kSecReturnAttributes = ObjC.classes.__NSCFString.stringWithString_("r_Attributes");
  var kSecReturnData = ObjC.classes.__NSCFString.stringWithString_("r_Data");
  var kSecMatchLimit = ObjC.classes.__NSCFString.stringWithString_("m_Limit");
  var kSecMatchLimitAll = ObjC.classes.__NSCFString.stringWithString_("m_LimitAll");
  
  var classes = ["genp", "inet", "cert", "keys"];
  
  classes.forEach(function(secClass) {
    var query = ObjC.classes.NSMutableDictionary.alloc().init();
    query.setObject_forKey_(secClass, kSecClass);
    query.setObject_forKey_(ObjC.classes.NSNumber.numberWithBool_(true), kSecReturnAttributes);
    query.setObject_forKey_(ObjC.classes.NSNumber.numberWithBool_(true), kSecReturnData);
    query.setObject_forKey_(kSecMatchLimitAll, kSecMatchLimit);
    
    var result = Memory.alloc(Process.pointerSize);
    var status = SecItemCopyMatching(query, result);
    
    if (status === 0) {
      var items = ObjC.Object(Memory.readPointer(result));
      console.log("\\n[*] " + secClass + " items: " + items.count());
      for (var i = 0; i < items.count(); i++) {
        var item = items.objectAtIndex_(i);
        console.log(item.toString());
      }
    }
  });
}

// Run after app initialization
setTimeout(dumpKeychain, 2000);`,

  methodTracer: `// Objective-C Method Tracer
// Trace all method calls for a specific class

function traceClass(className) {
  var targetClass = ObjC.classes[className];
  if (!targetClass) {
    console.log("[-] Class not found: " + className);
    return;
  }
  
  // Trace instance methods
  var methods = targetClass.$ownMethods;
  methods.forEach(function(method) {
    var impl = targetClass[method];
    Interceptor.attach(impl.implementation, {
      onEnter: function(args) {
        console.log("[CALL] " + className + " " + method);
        
        // Print first 3 arguments if they're objects
        for (var i = 2; i < Math.min(args.length, 5); i++) {
          try {
            var arg = ObjC.Object(args[i]);
            console.log("  arg" + (i-2) + ": " + arg.toString().substring(0, 100));
          } catch(e) {}
        }
      },
      onLeave: function(retval) {
        try {
          var ret = ObjC.Object(retval);
          console.log("  => " + ret.toString().substring(0, 100));
        } catch(e) {}
      }
    });
  });
  
  console.log("[+] Tracing " + methods.length + " methods on " + className);
}

// Usage: traceClass("LoginViewController");
// traceClass("KeychainManager");`,

  biometricBypass: `// Biometric Authentication Bypass
// Bypasses Touch ID / Face ID local authentication

var LAContext = ObjC.classes.LAContext;

// Hook evaluatePolicy:localizedReason:reply:
var evaluatePolicy = LAContext['- evaluatePolicy:localizedReason:reply:'];
Interceptor.attach(evaluatePolicy.implementation, {
  onEnter: function(args) {
    var block = new ObjC.Block(args[4]);
    var origImpl = block.implementation;
    
    block.implementation = function(success, error) {
      console.log("[+] Biometric auth bypassed!");
      origImpl(true, null); // Force success
    };
  }
});

// Also hook canEvaluatePolicy to always return true
var canEvaluate = LAContext['- canEvaluatePolicy:error:'];
Interceptor.attach(canEvaluate.implementation, {
  onLeave: function(retval) {
    retval.replace(1); // true
    console.log("[+] canEvaluatePolicy forced to true");
  }
});

console.log("[*] Biometric bypass loaded");`,
};

// Tools with detailed info
const detailedTools = [
  {
    name: "Frida",
    category: "Dynamic Analysis",
    description: "Dynamic instrumentation toolkit for hooking and modifying app behavior at runtime",
    installation: "pip install frida-tools",
    usage: "frida -U -f com.app.bundle -l script.js --no-pause",
    features: ["Method hooking", "Memory manipulation", "Function tracing", "SSL bypass"],
  },
  {
    name: "Objection",
    category: "Dynamic Analysis",
    description: "Runtime mobile exploration toolkit powered by Frida",
    installation: "pip install objection",
    usage: "objection -g com.app.bundle explore",
    features: ["Built-in bypass scripts", "Keychain dump", "File browser", "SQLite browser"],
  },
  {
    name: "MobSF",
    category: "Static/Dynamic",
    description: "Mobile Security Framework for automated security analysis",
    installation: "docker run -p 8000:8000 opensecurity/mobile-security-framework-mobsf",
    usage: "Upload IPA through web interface",
    features: ["Binary analysis", "Manifest review", "Code analysis", "API security"],
  },
  {
    name: "Ghidra",
    category: "Binary Analysis",
    description: "NSA's reverse engineering framework for binary analysis",
    installation: "Download from ghidra-sre.org",
    usage: "Extract app binary, load in Ghidra",
    features: ["Disassembly", "Decompilation", "Cross-references", "Scripting"],
  },
  {
    name: "Hopper",
    category: "Binary Analysis",
    description: "macOS disassembler with Objective-C support",
    installation: "Commercial - hopperapp.com",
    usage: "Open Mach-O binary directly",
    features: ["ARM64 support", "Pseudo-code", "Objective-C analysis", "Swift support"],
  },
  {
    name: "class-dump",
    category: "Static Analysis",
    description: "Extracts Objective-C class information from Mach-O files",
    installation: "brew install class-dump",
    usage: "class-dump -H AppBinary -o headers/",
    features: ["Header extraction", "Protocol dump", "Category info", "Method signatures"],
  },
  {
    name: "SSL Kill Switch 2",
    category: "Network",
    description: "Cydia tweak to disable SSL certificate validation system-wide",
    installation: "Cydia: com.nablac0d3.sslkillswitch2",
    usage: "Enable in Settings app",
    features: ["System-wide bypass", "No app modification", "Easy toggle", "iOS 13+ support"],
  },
  {
    name: "Clutch",
    category: "IPA Extraction",
    description: "Decrypt and dump iOS applications from jailbroken devices",
    installation: "Install from Cydia or build from source",
    usage: "clutch -d com.app.bundle",
    features: ["App decryption", "IPA creation", "Batch processing", "ARM64 support"],
  },
];

// Lab exercises
const labExercises = [
  {
    name: "IPA Static Analysis Lab",
    difficulty: "Beginner",
    duration: "30 min",
    objectives: [
      "Extract and decrypt an IPA file",
      "Analyze Info.plist for security misconfigurations",
      "Identify hardcoded secrets using grep/strings",
      "Check binary protections with otool",
    ],
    tools: "class-dump, otool, strings, plutil",
    steps: [
      "Extract IPA: unzip app.ipa -d extracted/",
      "Find app binary: find extracted/ -name '*.app' -exec ls {} \\;",
      "Dump headers: class-dump -H Binary -o headers/",
      "Check protections: otool -hv Binary | grep -E 'PIE|RESTRICT'",
      "Search secrets: strings Binary | grep -iE 'api|key|secret|password'",
      "Analyze plist: plutil -convert xml1 Info.plist -o -",
    ],
  },
  {
    name: "Runtime Manipulation with Frida",
    difficulty: "Intermediate",
    duration: "45 min",
    objectives: [
      "Set up Frida on jailbroken device",
      "Hook authentication methods",
      "Bypass jailbreak detection",
      "Extract runtime secrets",
    ],
    tools: "Frida, Objection, SSH",
    steps: [
      "SSH to device: ssh root@<device-ip>",
      "List running apps: frida-ps -Ua",
      "Attach to app: frida -U -n 'AppName'",
      "List classes: ObjC.classes",
      "Hook method: Interceptor.attach(method.implementation, {...})",
      "Run custom script: frida -U -f bundle.id -l bypass.js",
    ],
  },
  {
    name: "Network Traffic Interception",
    difficulty: "Intermediate",
    duration: "30 min",
    objectives: [
      "Configure proxy on iOS device",
      "Install Burp CA certificate",
      "Bypass SSL pinning",
      "Analyze API endpoints",
    ],
    tools: "Burp Suite, SSL Kill Switch, Frida",
    steps: [
      "Set HTTP proxy in iOS Settings â†’ WiFi â†’ Configure Proxy",
      "Install Burp CA: navigate to http://burp in Safari",
      "Trust CA in Settings â†’ General â†’ About â†’ Certificate Trust Settings",
      "If pinning exists, enable SSL Kill Switch or use Frida script",
      "Capture and analyze API requests in Burp",
      "Test for IDOR, injection, auth bypass in API calls",
    ],
  },
  {
    name: "Keychain Security Analysis",
    difficulty: "Advanced",
    duration: "60 min",
    objectives: [
      "Understand iOS Keychain architecture",
      "Dump Keychain items with Objection",
      "Analyze data protection classes",
      "Identify improperly protected credentials",
    ],
    tools: "Objection, Keychain-Dumper, Frida",
    steps: [
      "Connect with Objection: objection -g bundle.id explore",
      "Dump Keychain: ios keychain dump",
      "Check protection classes for each item",
      "Items with kSecAttrAccessibleAlways are vulnerable",
      "Extract and decode credential data",
      "Test if app still works after deleting Keychain items",
    ],
  },
  {
    name: "Binary Reverse Engineering",
    difficulty: "Advanced",
    duration: "90 min",
    objectives: [
      "Load iOS binary in Ghidra/Hopper",
      "Identify security-critical functions",
      "Understand authentication flow",
      "Find hardcoded encryption keys",
    ],
    tools: "Ghidra, Hopper, class-dump",
    steps: [
      "Extract decrypted binary from IPA",
      "Generate headers with class-dump for reference",
      "Load binary in Ghidra, analyze ARM64",
      "Search for crypto functions: CCCrypt, SecKey*, etc.",
      "Find authentication: LoginViewController, validatePassword",
      "Cross-reference string constants for hardcoded values",
    ],
  },
];

// File locations for forensics
const fileLocations = [
  { path: "/var/mobile/Containers/Data/Application/[UUID]/", desc: "App sandbox (Documents, Library, tmp)", sensitive: true },
  { path: "/var/mobile/Containers/Bundle/Application/[UUID]/", desc: "App bundle (binary, resources)", sensitive: false },
  { path: "/var/mobile/Library/Preferences/", desc: "System and app preferences (plists)", sensitive: true },
  { path: "/var/Keychains/", desc: "Keychain database files", sensitive: true },
  { path: "/var/mobile/Library/Cookies/", desc: "Safari and app cookies", sensitive: true },
  { path: "/var/mobile/Library/Caches/", desc: "Various app caches", sensitive: true },
  { path: "/var/log/", desc: "System and app logs", sensitive: true },
  { path: "/private/var/mobile/Library/SMS/", desc: "SMS database", sensitive: true },
  { path: "/var/mobile/Media/DCIM/", desc: "Photos and videos", sensitive: true },
];

// Command cheatsheet
const commandCheatsheet = [
  { category: "Device Access", commands: [
    { cmd: "ssh root@<ip>", desc: "SSH to jailbroken device (default: alpine)" },
    { cmd: "scp file root@<ip>:/path", desc: "Copy file to device" },
    { cmd: "iproxy 2222 22", desc: "USB SSH tunnel via usbmuxd" },
  ]},
  { category: "App Discovery", commands: [
    { cmd: "frida-ps -Uai", desc: "List installed apps with bundle IDs" },
    { cmd: "find /var/mobile/Containers -name 'AppName'", desc: "Find app container" },
    { cmd: "ls -la /var/mobile/Containers/Data/Application/", desc: "List app data directories" },
  ]},
  { category: "Binary Analysis", commands: [
    { cmd: "otool -L Binary", desc: "List linked libraries" },
    { cmd: "otool -hv Binary", desc: "Check binary flags (PIE, etc.)" },
    { cmd: "nm Binary | grep -i auth", desc: "Search symbols" },
    { cmd: "strings Binary | grep -i password", desc: "Extract strings" },
  ]},
  { category: "Frida Commands", commands: [
    { cmd: "frida -U -f bundle.id -l script.js", desc: "Spawn and inject" },
    { cmd: "frida -U -n 'AppName'", desc: "Attach to running app" },
    { cmd: "frida-trace -U -i '*auth*' bundle.id", desc: "Trace functions" },
  ]},
  { category: "Objection Commands", commands: [
    { cmd: "ios keychain dump", desc: "Dump all Keychain items" },
    { cmd: "ios plist cat file.plist", desc: "Read plist file" },
    { cmd: "ios sslpinning disable", desc: "Disable SSL pinning" },
    { cmd: "ios jailbreak disable", desc: "Bypass jailbreak detection" },
  ]},
];

const sections: Section[] = [
  {
    title: "Environment Setup",
    icon: <BuildIcon sx={{ fontSize: 32 }} />,
    color: "#6366f1",
    items: [
      "Jailbroken device (checkra1n, unc0ver, palera1n, Dopamine)",
      "macOS with Xcode & command line tools",
      "Burp Suite / mitmproxy for traffic interception",
      "Frida & Objection for runtime manipulation",
      "Install Cydia packages: OpenSSH, Filza, SSL Kill Switch 2",
      "Corellium virtual device (alternative to physical jailbreak)",
    ],
  },
  {
    title: "Static Analysis",
    icon: <StorageIcon sx={{ fontSize: 32 }} />,
    color: "#8b5cf6",
    items: [
      "Extract IPA (clutch, frida-ios-dump, bagbak)",
      "Analyze Info.plist for ATS exceptions, URL schemes",
      "Check for hardcoded secrets, API keys, certificates",
      "Review URL schemes & universal links",
      "Inspect embedded frameworks & third-party libraries",
      "Check binary protections (PIE, ARC, stack canaries)",
      "Analyze entitlements and capabilities",
    ],
  },
  {
    title: "Dynamic Analysis",
    icon: <BugReportIcon sx={{ fontSize: 32 }} />,
    color: "#ef4444",
    items: [
      "Hook Objective-C/Swift methods with Frida",
      "Bypass jailbreak detection mechanisms",
      "Bypass SSL/certificate pinning",
      "Monitor filesystem and Keychain access",
      "Trace method calls and parameters",
      "Modify return values and bypass checks",
      "Dump decrypted classes at runtime",
    ],
  },
  {
    title: "Data Storage",
    icon: <SecurityIcon sx={{ fontSize: 32 }} />,
    color: "#f59e0b",
    items: [
      "Keychain data extraction and analysis",
      "NSUserDefaults / UserDefaults inspection",
      "SQLite database content review",
      "Plist files, caches, and cookies",
      "Check data protection classes (AFU, CFU, etc.)",
      "Analyze backup inclusion settings",
      "Review clipboard/pasteboard data",
    ],
  },
  {
    title: "Network Security",
    icon: <HttpIcon sx={{ fontSize: 32 }} />,
    color: "#3b82f6",
    items: [
      "Intercept HTTPS traffic via proxy",
      "Certificate pinning bypass techniques",
      "API endpoint enumeration and testing",
      "WebSocket and GraphQL analysis",
      "Check for sensitive data in transit",
      "Analyze App Transport Security configuration",
      "Test for server-side vulnerabilities",
    ],
  },
  {
    title: "Authentication & Sessions",
    icon: <LockOpenIcon sx={{ fontSize: 32 }} />,
    color: "#10b981",
    items: [
      "Token storage and lifecycle analysis",
      "Biometric authentication bypass (Touch ID/Face ID)",
      "Session management and expiration testing",
      "OAuth 2.0 / OpenID Connect implementation",
      "Local authentication (passcode) bypass",
      "Keychain access control validation",
      "Multi-factor authentication testing",
    ],
  },
];

const tools = [
  { name: "Frida", desc: "Dynamic instrumentation toolkit" },
  { name: "Objection", desc: "Runtime mobile exploration" },
  { name: "Hopper / IDA", desc: "Binary disassembly" },
  { name: "MobSF", desc: "Automated static/dynamic analysis" },
  { name: "Burp Suite", desc: "Traffic interception" },
  { name: "Ghidra", desc: "NSA reverse engineering tool" },
];

export default function iOSPentestingPage() {
  const navigate = useNavigate();
  const theme = useTheme();
  const [tabValue, setTabValue] = useState(0);

  const pageContext = `iOS Pentesting Guide - Comprehensive security testing for iOS applications. Covers OWASP MASVS/MASTG compliance testing, environment setup (jailbroken device with checkra1n/unc0ver/palera1n, Frida, Objection), static analysis (IPA extraction with clutch/frida-ios-dump, Info.plist, binary protections, hardcoded secrets), dynamic analysis (method hooking, jailbreak bypass, SSL pinning bypass, runtime manipulation), data storage security (Keychain analysis, NSUserDefaults, SQLite, data protection classes), network security (HTTPS interception, certificate pinning, ATS configuration), and authentication testing (biometric bypass, session management, OAuth). Includes detailed Frida scripts for SSL pinning bypass, jailbreak detection bypass, Keychain dumping, and biometric bypass. Essential tools: Frida, Objection, MobSF, Ghidra, Hopper, class-dump, Clutch, SSL Kill Switch 2. Lab exercises from beginner to advanced covering static analysis, runtime manipulation, traffic interception, and binary reverse engineering.`;

  return (
    <LearnPageLayout pageTitle="iOS Pentesting" pageContext={pageContext}>
      <Container maxWidth="lg" sx={{ py: 4 }}>
        {/* Header */}
        <Box sx={{ mb: 4 }}>
          <Button
            startIcon={<ArrowBackIcon />}
            onClick={() => navigate("/learn")}
            sx={{ mb: 2 }}
          >
            Back to Learning Hub
          </Button>
          <Box sx={{ display: "flex", alignItems: "center", gap: 2, mb: 2 }}>
            <Box
              sx={{
                width: 64,
                height: 64,
                borderRadius: 2,
                bgcolor: alpha("#6366f1", 0.1),
                display: "flex",
                alignItems: "center",
                justifyContent: "center",
              }}
            >
              <AppleIcon sx={{ fontSize: 36, color: "#6366f1" }} />
            </Box>
            <Box>
              <Typography variant="h4" sx={{ fontWeight: 800 }}>
                iOS Pentesting
              </Typography>
              <Typography variant="body1" color="text.secondary">
                Comprehensive security testing for iOS applications
              </Typography>
            </Box>
          </Box>
          <Box sx={{ display: "flex", gap: 1, flexWrap: "wrap" }}>
            <Chip label="Mobile" color="primary" size="small" />
            <Chip label="iOS" size="small" sx={{ bgcolor: alpha("#6366f1", 0.1), color: "#6366f1" }} />
            <Chip label="Frida" size="small" sx={{ bgcolor: alpha("#ef4444", 0.1), color: "#ef4444" }} />
            <Chip label="OWASP MASVS" size="small" sx={{ bgcolor: alpha("#22c55e", 0.1), color: "#22c55e" }} />
            <Chip label="Reverse Engineering" size="small" sx={{ bgcolor: alpha("#8b5cf6", 0.1), color: "#8b5cf6" }} />
          </Box>
        </Box>

        {/* Stats */}
        <Grid container spacing={2} sx={{ mb: 4 }}>
          {[
            { label: "MASVS Categories", value: "7", color: "#22c55e" },
            { label: "Vulnerabilities", value: "8+", color: "#ef4444" },
            { label: "Frida Scripts", value: "5", color: "#f59e0b" },
            { label: "Lab Exercises", value: "5", color: "#3b82f6" },
          ].map((stat) => (
            <Grid item xs={6} sm={3} key={stat.label}>
              <Paper sx={{ p: 2, textAlign: "center", borderTop: `3px solid ${stat.color}` }}>
                <Typography variant="h4" sx={{ fontWeight: 800, color: stat.color }}>{stat.value}</Typography>
                <Typography variant="body2" color="text.secondary">{stat.label}</Typography>
              </Paper>
            </Grid>
          ))}
        </Grid>

        {/* Tabs */}
        <Paper sx={{ borderRadius: 3, overflow: "hidden", mb: 4 }}>
          <Tabs
            value={tabValue}
            onChange={(_, v) => setTabValue(v)}
            variant="scrollable"
            scrollButtons="auto"
            sx={{ borderBottom: 1, borderColor: "divider", bgcolor: alpha(theme.palette.background.paper, 0.5) }}
          >
            <Tab icon={<AppleIcon />} label="Overview" iconPosition="start" />
            <Tab icon={<VerifiedUserIcon />} label="MASVS" iconPosition="start" />
            <Tab icon={<BugReportIcon />} label="Vulnerabilities" iconPosition="start" />
            <Tab icon={<CodeIcon />} label="Frida Scripts" iconPosition="start" />
            <Tab icon={<BuildIcon />} label="Tools" iconPosition="start" />
            <Tab icon={<TerminalIcon />} label="Commands" iconPosition="start" />
            <Tab icon={<ScienceIcon />} label="Labs" iconPosition="start" />
          </Tabs>

          {/* Tab 0: Overview */}
          <TabPanel value={tabValue} index={0}>
            <Box sx={{ p: 3 }}>
              {/* Intro */}
              <Paper sx={{ p: 3, mb: 4, borderRadius: 3, border: `1px solid ${alpha(theme.palette.divider, 0.1)}` }}>
                <Typography variant="h6" sx={{ fontWeight: 700, mb: 2, display: "flex", alignItems: "center", gap: 1 }}>
                  <AppleIcon color="primary" /> Overview
                </Typography>
                <Typography variant="body1" color="text.secondary" sx={{ lineHeight: 1.8, mb: 2 }}>
                  iOS app pentesting involves analyzing applications for security vulnerabilities through static analysis 
                  (examining the IPA file and binary), dynamic analysis (runtime manipulation with Frida/Objection), 
                  and network traffic inspection. A jailbroken device provides the deepest access for comprehensive testing.
                </Typography>
                <Alert severity="info" sx={{ mb: 2 }}>
                  iOS security testing aligns with the <strong>OWASP Mobile Application Security Verification Standard (MASVS)</strong> and 
                  the <strong>Mobile Application Security Testing Guide (MASTG)</strong>.
                </Alert>
              </Paper>

              {/* Testing Areas Grid */}
              <Typography variant="h5" sx={{ fontWeight: 700, mb: 3 }}>
                ðŸŽ¯ Testing Areas
              </Typography>
              <Grid container spacing={3} sx={{ mb: 4 }}>
                {sections.map((section) => (
                  <Grid item xs={12} md={6} key={section.title}>
                    <Paper
                      sx={{
                        p: 3,
                        height: "100%",
                        borderRadius: 3,
                        border: `1px solid ${alpha(section.color, 0.2)}`,
                        transition: "all 0.3s ease",
                        "&:hover": {
                          borderColor: section.color,
                          boxShadow: `0 8px 30px ${alpha(section.color, 0.15)}`,
                        },
                      }}
                    >
                      <Box sx={{ display: "flex", alignItems: "center", gap: 2, mb: 2 }}>
                        <Box
                          sx={{
                            width: 48,
                            height: 48,
                            borderRadius: 2,
                            bgcolor: alpha(section.color, 0.1),
                            display: "flex",
                            alignItems: "center",
                            justifyContent: "center",
                            color: section.color,
                          }}
                        >
                          {section.icon}
                        </Box>
                        <Typography variant="h6" sx={{ fontWeight: 700 }}>
                          {section.title}
                        </Typography>
                      </Box>
                      <List dense>
                        {section.items.map((item, i) => (
                          <ListItem key={i} sx={{ py: 0.25, px: 0 }}>
                            <ListItemIcon sx={{ minWidth: 28 }}>
                              <CheckCircleIcon sx={{ fontSize: 16, color: section.color }} />
                            </ListItemIcon>
                            <ListItemText
                              primary={item}
                              primaryTypographyProps={{ variant: "body2" }}
                            />
                          </ListItem>
                        ))}
                      </List>
                    </Paper>
                  </Grid>
                ))}
              </Grid>

              {/* File Locations */}
              <Paper sx={{ p: 3, mb: 4, borderRadius: 3 }}>
                <Typography variant="h6" sx={{ fontWeight: 700, mb: 2, display: "flex", alignItems: "center", gap: 1 }}>
                  <StorageIcon sx={{ color: "#f59e0b" }} /> Important File Locations
                </Typography>
                <TableContainer>
                  <Table size="small">
                    <TableHead>
                      <TableRow>
                        <TableCell sx={{ fontWeight: 700 }}>Path</TableCell>
                        <TableCell sx={{ fontWeight: 700 }}>Description</TableCell>
                        <TableCell sx={{ fontWeight: 700 }}>Sensitive</TableCell>
                      </TableRow>
                    </TableHead>
                    <TableBody>
                      {fileLocations.map((loc) => (
                        <TableRow key={loc.path}>
                          <TableCell sx={{ fontFamily: "monospace", fontSize: "0.8rem" }}>{loc.path}</TableCell>
                          <TableCell>{loc.desc}</TableCell>
                          <TableCell>
                            {loc.sensitive ? (
                              <Chip label="Yes" size="small" color="error" />
                            ) : (
                              <Chip label="No" size="small" />
                            )}
                          </TableCell>
                        </TableRow>
                      ))}
                    </TableBody>
                  </Table>
                </TableContainer>
              </Paper>

              {/* Quick Tools */}
              <Paper
                sx={{
                  p: 3,
                  borderRadius: 3,
                  background: `linear-gradient(135deg, ${alpha("#3b82f6", 0.05)}, ${alpha("#6366f1", 0.05)})`,
                  border: `1px solid ${alpha("#3b82f6", 0.2)}`,
                }}
              >
                <Typography variant="h6" sx={{ fontWeight: 700, mb: 2, display: "flex", alignItems: "center", gap: 1 }}>
                  <BuildIcon sx={{ color: "#3b82f6" }} /> Essential Tools
                </Typography>
                <Grid container spacing={2}>
                  {tools.map((tool) => (
                    <Grid item xs={6} sm={4} key={tool.name}>
                      <Paper
                        sx={{
                          p: 1.5,
                          borderRadius: 2,
                          bgcolor: alpha("#3b82f6", 0.05),
                          border: `1px solid ${alpha("#3b82f6", 0.1)}`,
                        }}
                      >
                        <Typography variant="subtitle2" sx={{ fontWeight: 700 }}>
                          {tool.name}
                        </Typography>
                        <Typography variant="caption" color="text.secondary">
                          {tool.desc}
                        </Typography>
                      </Paper>
                    </Grid>
                  ))}
                </Grid>
              </Paper>
            </Box>
          </TabPanel>

          {/* Tab 1: MASVS */}
          <TabPanel value={tabValue} index={1}>
            <Box sx={{ p: 3 }}>
              <Alert severity="info" sx={{ mb: 3 }}>
                The <strong>OWASP Mobile Application Security Verification Standard (MASVS)</strong> defines 
                security requirements for mobile apps. Use this as a checklist for comprehensive iOS testing.
              </Alert>

              <Grid container spacing={3}>
                {masvsCategories.map((category) => (
                  <Grid item xs={12} md={6} key={category.id}>
                    <Card sx={{ height: "100%", borderTop: `3px solid #22c55e` }}>
                      <CardContent>
                        <Box sx={{ display: "flex", alignItems: "center", gap: 1, mb: 1 }}>
                          <Chip label={category.id} size="small" sx={{ bgcolor: alpha("#22c55e", 0.1), color: "#22c55e", fontWeight: 700 }} />
                          <Typography variant="h6" sx={{ fontWeight: 700 }}>{category.name}</Typography>
                        </Box>
                        <Typography variant="body2" color="text.secondary" sx={{ mb: 2 }}>
                          {category.description}
                        </Typography>
                        <Divider sx={{ my: 1.5 }} />
                        <List dense>
                          {category.controls.map((control) => (
                            <ListItem key={control.id} sx={{ px: 0 }}>
                              <ListItemIcon sx={{ minWidth: 32 }}>
                                <CheckCircleIcon sx={{ fontSize: 16, color: "#22c55e" }} />
                              </ListItemIcon>
                              <ListItemText
                                primary={control.name}
                                secondary={control.id}
                                primaryTypographyProps={{ variant: "body2", fontWeight: 600 }}
                                secondaryTypographyProps={{ variant: "caption" }}
                              />
                              <Chip
                                label={control.severity}
                                size="small"
                                sx={{
                                  bgcolor: control.severity === "Critical" ? alpha("#ef4444", 0.1) :
                                           control.severity === "High" ? alpha("#f59e0b", 0.1) :
                                           alpha("#3b82f6", 0.1),
                                  color: control.severity === "Critical" ? "#ef4444" :
                                         control.severity === "High" ? "#f59e0b" : "#3b82f6",
                                  fontSize: "0.7rem",
                                }}
                              />
                            </ListItem>
                          ))}
                        </List>
                      </CardContent>
                    </Card>
                  </Grid>
                ))}
              </Grid>

              <Paper sx={{ p: 3, mt: 3, borderRadius: 3 }}>
                <Typography variant="h6" sx={{ fontWeight: 700, mb: 2, display: "flex", alignItems: "center", gap: 1 }}>
                  <MenuBookIcon sx={{ color: "#6366f1" }} /> MASTG Resources
                </Typography>
                <List dense>
                  {[
                    "OWASP MASTG: Comprehensive testing guide with iOS-specific techniques",
                    "MASVS: Security requirements standard (L1, L2, R levels)",
                    "Mobile Security Checklist: Actionable verification checklist",
                    "Test cases mapped to MASVS requirements",
                  ].map((item) => (
                    <ListItem key={item} sx={{ px: 0 }}>
                      <ListItemIcon sx={{ minWidth: 28 }}>
                        <CheckCircleIcon sx={{ fontSize: 16, color: "#6366f1" }} />
                      </ListItemIcon>
                      <ListItemText primary={item} primaryTypographyProps={{ variant: "body2" }} />
                    </ListItem>
                  ))}
                </List>
              </Paper>
            </Box>
          </TabPanel>

          {/* Tab 2: Vulnerabilities */}
          <TabPanel value={tabValue} index={2}>
            <Box sx={{ p: 3 }}>
              <Typography variant="h6" sx={{ fontWeight: 700, mb: 3 }}>
                Common iOS Vulnerabilities
              </Typography>

              {vulnerabilities.map((vuln, idx) => (
                <Accordion key={idx} sx={{ mb: 1, "&:before": { display: "none" } }}>
                  <AccordionSummary expandIcon={<ExpandMoreIcon />}>
                    <Box sx={{ display: "flex", alignItems: "center", gap: 2, width: "100%" }}>
                      <Chip
                        label={vuln.severity}
                        size="small"
                        sx={{
                          bgcolor: vuln.severity === "Critical" ? alpha("#ef4444", 0.1) :
                                   vuln.severity === "High" ? alpha("#f59e0b", 0.1) :
                                   alpha("#3b82f6", 0.1),
                          color: vuln.severity === "Critical" ? "#ef4444" :
                                 vuln.severity === "High" ? "#f59e0b" : "#3b82f6",
                          fontWeight: 700,
                        }}
                      />
                      <Typography variant="subtitle1" sx={{ fontWeight: 700 }}>{vuln.name}</Typography>
                    </Box>
                  </AccordionSummary>
                  <AccordionDetails>
                    <Grid container spacing={2}>
                      <Grid item xs={12}>
                        <Typography variant="body2" color="text.secondary" sx={{ mb: 2 }}>
                          {vuln.description}
                        </Typography>
                      </Grid>
                      <Grid item xs={12} md={6}>
                        <Paper sx={{ p: 2, bgcolor: alpha("#ef4444", 0.05), borderRadius: 2 }}>
                          <Typography variant="subtitle2" sx={{ fontWeight: 700, color: "#ef4444", mb: 1 }}>
                            Impact
                          </Typography>
                          <Typography variant="body2">{vuln.impact}</Typography>
                        </Paper>
                      </Grid>
                      <Grid item xs={12} md={6}>
                        <Paper sx={{ p: 2, bgcolor: alpha("#3b82f6", 0.05), borderRadius: 2 }}>
                          <Typography variant="subtitle2" sx={{ fontWeight: 700, color: "#3b82f6", mb: 1 }}>
                            Detection
                          </Typography>
                          <Typography variant="body2">{vuln.detection}</Typography>
                        </Paper>
                      </Grid>
                      <Grid item xs={12}>
                        <Paper sx={{ p: 2, bgcolor: alpha("#22c55e", 0.05), borderRadius: 2 }}>
                          <Typography variant="subtitle2" sx={{ fontWeight: 700, color: "#22c55e", mb: 1 }}>
                            Mitigation
                          </Typography>
                          <Typography variant="body2">{vuln.mitigation}</Typography>
                        </Paper>
                      </Grid>
                    </Grid>
                  </AccordionDetails>
                </Accordion>
              ))}
            </Box>
          </TabPanel>

          {/* Tab 3: Frida Scripts */}
          <TabPanel value={tabValue} index={3}>
            <Box sx={{ p: 3 }}>
              <Alert severity="warning" sx={{ mb: 3 }}>
                These scripts are for authorized security testing only. Always obtain proper authorization before testing.
              </Alert>

              <Accordion defaultExpanded sx={{ mb: 2 }}>
                <AccordionSummary expandIcon={<ExpandMoreIcon />}>
                  <Box sx={{ display: "flex", alignItems: "center", gap: 2 }}>
                    <NetworkCheckIcon sx={{ color: "#3b82f6" }} />
                    <Typography variant="subtitle1" sx={{ fontWeight: 700 }}>SSL Pinning Bypass</Typography>
                  </Box>
                </AccordionSummary>
                <AccordionDetails>
                  <Typography variant="body2" color="text.secondary" sx={{ mb: 2 }}>
                    Bypasses common SSL/TLS certificate pinning implementations including SecTrustEvaluate and NSURLSession delegates.
                  </Typography>
                  <CodeBlock code={fridaScripts.sslPinningBypass} language="javascript" />
                </AccordionDetails>
              </Accordion>

              <Accordion sx={{ mb: 2 }}>
                <AccordionSummary expandIcon={<ExpandMoreIcon />}>
                  <Box sx={{ display: "flex", alignItems: "center", gap: 2 }}>
                    <SecurityIcon sx={{ color: "#ef4444" }} />
                    <Typography variant="subtitle1" sx={{ fontWeight: 700 }}>Jailbreak Detection Bypass</Typography>
                  </Box>
                </AccordionSummary>
                <AccordionDetails>
                  <Typography variant="body2" color="text.secondary" sx={{ mb: 2 }}>
                    Hooks common jailbreak detection methods including file existence checks, URL scheme checks, and fork() calls.
                  </Typography>
                  <CodeBlock code={fridaScripts.jailbreakBypass} language="javascript" />
                </AccordionDetails>
              </Accordion>

              <Accordion sx={{ mb: 2 }}>
                <AccordionSummary expandIcon={<ExpandMoreIcon />}>
                  <Box sx={{ display: "flex", alignItems: "center", gap: 2 }}>
                    <StorageIcon sx={{ color: "#f59e0b" }} />
                    <Typography variant="subtitle1" sx={{ fontWeight: 700 }}>Keychain Dumper</Typography>
                  </Box>
                </AccordionSummary>
                <AccordionDetails>
                  <Typography variant="body2" color="text.secondary" sx={{ mb: 2 }}>
                    Extracts all accessible Keychain items including generic passwords, internet passwords, certificates, and keys.
                  </Typography>
                  <CodeBlock code={fridaScripts.keychainDump} language="javascript" />
                </AccordionDetails>
              </Accordion>

              <Accordion sx={{ mb: 2 }}>
                <AccordionSummary expandIcon={<ExpandMoreIcon />}>
                  <Box sx={{ display: "flex", alignItems: "center", gap: 2 }}>
                    <CodeIcon sx={{ color: "#8b5cf6" }} />
                    <Typography variant="subtitle1" sx={{ fontWeight: 700 }}>Method Tracer</Typography>
                  </Box>
                </AccordionSummary>
                <AccordionDetails>
                  <Typography variant="body2" color="text.secondary" sx={{ mb: 2 }}>
                    Traces all method calls for a specific Objective-C class, useful for understanding authentication flows.
                  </Typography>
                  <CodeBlock code={fridaScripts.methodTracer} language="javascript" />
                </AccordionDetails>
              </Accordion>

              <Accordion sx={{ mb: 2 }}>
                <AccordionSummary expandIcon={<ExpandMoreIcon />}>
                  <Box sx={{ display: "flex", alignItems: "center", gap: 2 }}>
                    <FingerprintIcon sx={{ color: "#10b981" }} />
                    <Typography variant="subtitle1" sx={{ fontWeight: 700 }}>Biometric Bypass</Typography>
                  </Box>
                </AccordionSummary>
                <AccordionDetails>
                  <Typography variant="body2" color="text.secondary" sx={{ mb: 2 }}>
                    Bypasses Touch ID and Face ID local authentication by hooking LAContext methods.
                  </Typography>
                  <CodeBlock code={fridaScripts.biometricBypass} language="javascript" />
                </AccordionDetails>
              </Accordion>
            </Box>
          </TabPanel>

          {/* Tab 4: Tools */}
          <TabPanel value={tabValue} index={4}>
            <Box sx={{ p: 3 }}>
              <Grid container spacing={3}>
                {detailedTools.map((tool) => (
                  <Grid item xs={12} md={6} key={tool.name}>
                    <Card sx={{ height: "100%" }}>
                      <CardContent>
                        <Box sx={{ display: "flex", justifyContent: "space-between", alignItems: "center", mb: 2 }}>
                          <Typography variant="h6" sx={{ fontWeight: 700 }}>{tool.name}</Typography>
                          <Chip label={tool.category} size="small" color="primary" />
                        </Box>
                        <Typography variant="body2" color="text.secondary" sx={{ mb: 2 }}>
                          {tool.description}
                        </Typography>
                        <Divider sx={{ my: 1.5 }} />
                        <Typography variant="caption" sx={{ fontWeight: 700, display: "block", mb: 0.5 }}>Installation:</Typography>
                        <Paper sx={{ p: 1, bgcolor: "grey.900", borderRadius: 1, mb: 1.5 }}>
                          <Typography variant="caption" sx={{ fontFamily: "monospace" }}>{tool.installation}</Typography>
                        </Paper>
                        <Typography variant="caption" sx={{ fontWeight: 700, display: "block", mb: 0.5 }}>Usage:</Typography>
                        <Paper sx={{ p: 1, bgcolor: "grey.900", borderRadius: 1, mb: 1.5 }}>
                          <Typography variant="caption" sx={{ fontFamily: "monospace" }}>{tool.usage}</Typography>
                        </Paper>
                        <Box sx={{ display: "flex", gap: 0.5, flexWrap: "wrap" }}>
                          {tool.features.map((f) => (
                            <Chip key={f} label={f} size="small" variant="outlined" sx={{ fontSize: "0.7rem" }} />
                          ))}
                        </Box>
                      </CardContent>
                    </Card>
                  </Grid>
                ))}
              </Grid>
            </Box>
          </TabPanel>

          {/* Tab 5: Commands */}
          <TabPanel value={tabValue} index={5}>
            <Box sx={{ p: 3 }}>
              {commandCheatsheet.map((section) => (
                <Paper key={section.category} sx={{ p: 3, mb: 3, borderRadius: 3 }}>
                  <Typography variant="h6" sx={{ fontWeight: 700, mb: 2, color: "#6366f1" }}>
                    {section.category}
                  </Typography>
                  <TableContainer>
                    <Table size="small">
                      <TableHead>
                        <TableRow>
                          <TableCell sx={{ fontWeight: 700, width: "50%" }}>Command</TableCell>
                          <TableCell sx={{ fontWeight: 700 }}>Description</TableCell>
                        </TableRow>
                      </TableHead>
                      <TableBody>
                        {section.commands.map((cmd) => (
                          <TableRow key={cmd.cmd}>
                            <TableCell sx={{ fontFamily: "monospace", fontSize: "0.85rem", color: "#22c55e" }}>
                              {cmd.cmd}
                            </TableCell>
                            <TableCell>{cmd.desc}</TableCell>
                          </TableRow>
                        ))}
                      </TableBody>
                    </Table>
                  </TableContainer>
                </Paper>
              ))}
            </Box>
          </TabPanel>

          {/* Tab 6: Labs */}
          <TabPanel value={tabValue} index={6}>
            <Box sx={{ p: 3 }}>
              <Alert severity="warning" sx={{ mb: 3 }}>
                Always perform security testing in isolated environments with proper authorization.
                Use test applications like DVIA-v2 or iGoat for practice.
              </Alert>

              <Grid container spacing={3}>
                {labExercises.map((lab) => (
                  <Grid item xs={12} key={lab.name}>
                    <Card sx={{ 
                      borderLeft: `4px solid ${
                        lab.difficulty === "Beginner" ? "#22c55e" :
                        lab.difficulty === "Intermediate" ? "#f59e0b" : "#ef4444"
                      }` 
                    }}>
                      <CardContent>
                        <Box sx={{ display: "flex", justifyContent: "space-between", alignItems: "center", mb: 2 }}>
                          <Typography variant="h6" sx={{ fontWeight: 700 }}>{lab.name}</Typography>
                          <Box sx={{ display: "flex", gap: 1 }}>
                            <Chip
                              label={lab.difficulty}
                              size="small"
                              sx={{
                                bgcolor: lab.difficulty === "Beginner" ? alpha("#22c55e", 0.1) :
                                         lab.difficulty === "Intermediate" ? alpha("#f59e0b", 0.1) :
                                         alpha("#ef4444", 0.1),
                                color: lab.difficulty === "Beginner" ? "#22c55e" :
                                       lab.difficulty === "Intermediate" ? "#f59e0b" : "#ef4444",
                                fontWeight: 700,
                              }}
                            />
                            <Chip label={lab.duration} size="small" variant="outlined" />
                          </Box>
                        </Box>
                        <Typography variant="body2" color="text.secondary" sx={{ mb: 1 }}>
                          <strong>Tools:</strong> {lab.tools}
                        </Typography>
                        <Divider sx={{ my: 2 }} />
                        <Grid container spacing={2}>
                          <Grid item xs={12} md={6}>
                            <Typography variant="subtitle2" sx={{ fontWeight: 700, mb: 1 }}>Objectives:</Typography>
                            <List dense>
                              {lab.objectives.map((obj, i) => (
                                <ListItem key={i} sx={{ py: 0.25, px: 0 }}>
                                  <ListItemIcon sx={{ minWidth: 24 }}>
                                    <CheckCircleIcon sx={{ fontSize: 14, color: "#22c55e" }} />
                                  </ListItemIcon>
                                  <ListItemText primary={obj} primaryTypographyProps={{ variant: "body2" }} />
                                </ListItem>
                              ))}
                            </List>
                          </Grid>
                          <Grid item xs={12} md={6}>
                            <Typography variant="subtitle2" sx={{ fontWeight: 700, mb: 1 }}>Steps:</Typography>
                            <List dense>
                              {lab.steps.map((step, i) => (
                                <ListItem key={i} sx={{ py: 0.25, px: 0 }}>
                                  <ListItemIcon sx={{ minWidth: 24 }}>
                                    <Typography variant="caption" sx={{ fontWeight: 700, color: "#6366f1" }}>{i + 1}.</Typography>
                                  </ListItemIcon>
                                  <ListItemText 
                                    primary={step} 
                                    primaryTypographyProps={{ variant: "body2", sx: { fontFamily: "monospace", fontSize: "0.8rem" } }} 
                                  />
                                </ListItem>
                              ))}
                            </List>
                          </Grid>
                        </Grid>
                      </CardContent>
                    </Card>
                  </Grid>
                ))}
              </Grid>

              <Paper sx={{ p: 3, mt: 3, borderRadius: 3, bgcolor: alpha("#6366f1", 0.05) }}>
                <Typography variant="h6" sx={{ fontWeight: 700, mb: 2 }}>
                  ðŸ“± Practice Applications
                </Typography>
                <Grid container spacing={2}>
                  {[
                    { name: "DVIA-v2", desc: "Damn Vulnerable iOS App - comprehensive vulnerability examples" },
                    { name: "iGoat", desc: "OWASP learning application for iOS security" },
                    { name: "InsecureBankv2", desc: "Vulnerable banking app for testing" },
                    { name: "DIVA iOS", desc: "Damn Insecure and Vulnerable App" },
                  ].map((app) => (
                    <Grid item xs={12} sm={6} key={app.name}>
                      <Paper sx={{ p: 2, borderRadius: 2 }}>
                        <Typography variant="subtitle2" sx={{ fontWeight: 700 }}>{app.name}</Typography>
                        <Typography variant="caption" color="text.secondary">{app.desc}</Typography>
                      </Paper>
                    </Grid>
                  ))}
                </Grid>
              </Paper>
            </Box>
          </TabPanel>
        </Paper>

        {/* Warning */}
        <Paper
          sx={{
            p: 2,
            mb: 4,
            borderRadius: 2,
            bgcolor: alpha("#f59e0b", 0.05),
            border: `1px solid ${alpha("#f59e0b", 0.2)}`,
            display: "flex",
            alignItems: "center",
            gap: 2,
          }}
        >
          <WarningIcon sx={{ color: "#f59e0b" }} />
          <Typography variant="body2">
            <strong>Legal Notice:</strong> Only test applications you own or have explicit authorization to test. 
            Unauthorized testing is illegal and unethical.
          </Typography>
        </Paper>

        {/* Related */}
        <Paper sx={{ p: 3, borderRadius: 3, bgcolor: alpha(theme.palette.primary.main, 0.03) }}>
          <Typography variant="h6" sx={{ fontWeight: 700, mb: 2 }}>
            ðŸ“š Related Learning
          </Typography>
          <Box sx={{ display: "flex", gap: 1, flexWrap: "wrap" }}>
            <Chip
              label="APK Analysis â†’"
              clickable
              onClick={() => navigate("/learn/apk-analysis")}
              sx={{ fontWeight: 600 }}
            />
            <Chip
              label="Android RE â†’"
              clickable
              onClick={() => navigate("/learn/android-reverse-engineering")}
              sx={{ fontWeight: 600 }}
            />
            <Chip
              label="MITM Proxy â†’"
              clickable
              onClick={() => navigate("/learn/mitm")}
              sx={{ fontWeight: 600 }}
            />
            <Chip
              label="Mobile Forensics â†’"
              clickable
              onClick={() => navigate("/learn/mobile-forensics")}
              sx={{ fontWeight: 600 }}
            />
          </Box>
        </Paper>

        {/* Quiz Section */}
        <Box sx={{ mt: 4 }}>
          <QuizSection />
        </Box>
      </Container>
    </LearnPageLayout>
  );
}
