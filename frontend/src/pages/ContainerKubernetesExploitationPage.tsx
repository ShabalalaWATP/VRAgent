import React, { useState } from "react";
import LearnPageLayout from "../components/LearnPageLayout";
import {
  Box,
  Container,
  Typography,
  Paper,
  Tabs,
  Tab,
  Chip,
  Button,
  Accordion,
  AccordionSummary,
  AccordionDetails,
  Grid,
  List,
  ListItem,
  ListItemIcon,
  ListItemText,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  IconButton,
  Tooltip,
} from "@mui/material";
import ArrowBackIcon from "@mui/icons-material/ArrowBack";
import ExpandMoreIcon from "@mui/icons-material/ExpandMore";
import ContentCopyIcon from "@mui/icons-material/ContentCopy";
import SecurityIcon from "@mui/icons-material/Security";
import LayersIcon from "@mui/icons-material/Layers";
import HubIcon from "@mui/icons-material/Hub";
import BuildIcon from "@mui/icons-material/Build";
import ChecklistIcon from "@mui/icons-material/Checklist";
import WarningIcon from "@mui/icons-material/Warning";
import CheckCircleIcon from "@mui/icons-material/CheckCircle";
import CloudIcon from "@mui/icons-material/Cloud";
import { useNavigate } from "react-router-dom";

interface TabPanelProps {
  children?: React.ReactNode;
  index: number;
  value: number;
}

function TabPanel(props: TabPanelProps) {
  const { children, value, index, ...other } = props;
  return (
    <div role="tabpanel" hidden={value !== index} {...other}>
      {value === index && <Box sx={{ py: 3 }}>{children}</Box>}
    </div>
  );
}

const CodeBlock: React.FC<{ code: string; language?: string }> = ({
  code,
  language = "bash",
}) => {
  const [copied, setCopied] = useState(false);

  const handleCopy = () => {
    navigator.clipboard.writeText(code);
    setCopied(true);
    setTimeout(() => setCopied(false), 2000);
  };

  return (
    <Paper
      sx={{
        p: 2,
        bgcolor: "#121424",
        borderRadius: 2,
        position: "relative",
        my: 2,
        border: "1px solid rgba(56, 189, 248, 0.3)",
      }}
    >
      <Box sx={{ position: "absolute", top: 8, right: 8, display: "flex", gap: 1 }}>
        <Chip label={language} size="small" sx={{ bgcolor: "#38bdf8", color: "#0b1020" }} />
        <Tooltip title={copied ? "Copied!" : "Copy"}>
          <IconButton size="small" onClick={handleCopy} sx={{ color: "#e2e8f0" }}>
            <ContentCopyIcon fontSize="small" />
          </IconButton>
        </Tooltip>
      </Box>
      <Box
        component="pre"
        sx={{
          m: 0,
          overflow: "auto",
          fontFamily: "monospace",
          fontSize: "0.85rem",
          color: "#e2e8f0",
          pt: 2,
        }}
      >
        {code}
      </Box>
    </Paper>
  );
};

const ContainerKubernetesExploitationPage: React.FC = () => {
  const navigate = useNavigate();
  const [tabValue, setTabValue] = useState(0);

  const pageContext = `This page covers container and Kubernetes security exploitation techniques for offensive assessments. Topics include container runtime security (Docker, containerd), Kubernetes cluster enumeration, control plane components, RBAC and authentication weaknesses, secrets and service account abuse, node and pod escalation paths, container escape techniques, persistence ideas, detection signals, and supply chain risks. The page covers tools like Trivy, Grype, kube-hunter, kube-bench, and Docker Bench. Lab environments include Kubernetes Goat, KubeGoat, Kind/Minikube, and OWASP Juice Shop on K8s. Key concepts include pods, nodes, namespaces, service accounts, DaemonSets, Ingress, and privileged containers.`;

  const guardrails = [
    "Only test systems you own or have explicit written authorization to assess.",
    "Confirm scope, time window, and escalation contacts before testing.",
    "Avoid destructive actions unless explicitly approved by stakeholders.",
    "Collect evidence and log outputs for reproducibility.",
    "Coordinate with platform owners before draining nodes or restarting workloads.",
  ];

  const attackSurface = [
    {
      area: "Container Images",
      risk: "Outdated bases, embedded secrets, and unsigned artifacts.",
      focus: "Scan SBOMs, search for secrets, validate signatures.",
    },
    {
      area: "Runtime Config",
      risk: "Privileged containers and weak isolation.",
      focus: "Check caps, seccomp, AppArmor, and host mounts.",
    },
    {
      area: "Registries",
      risk: "Public exposure or weak auth controls.",
      focus: "Review pull permissions, tag immutability, and audit logs.",
    },
    {
      area: "Kubernetes API",
      risk: "Overly broad RBAC or exposed API endpoints.",
      focus: "Map RBAC bindings and auth can-i results.",
    },
    {
      area: "Nodes and Kubelet",
      risk: "Direct node access or insecure kubelet endpoints.",
      focus: "Validate node exposure and kubelet auth mode.",
    },
    {
      area: "Secrets and Config",
      risk: "Plaintext secrets and weak service account controls.",
      focus: "Review secret scope, rotation, and token use.",
    },
  ];
  const beginnerPath = [
    "1) Build a local lab (kind or minikube) and deploy a safe demo app.",
    "2) Learn the core terms: pod, node, namespace, service account, RBAC.",
    "3) Enumerate what you can see with kubectl and simple container checks.",
    "4) Map risks: privileged pods, hostPath mounts, and broad RBAC grants.",
    "5) Document evidence, impact, and fixes you would recommend.",
  ];
  const beginnerGlossary = [
    { term: "Container", desc: "Isolated process with its own filesystem and network." },
    { term: "Image", desc: "Read-only template used to start a container." },
    { term: "Registry", desc: "Server that stores and delivers container images." },
    { term: "Pod", desc: "Smallest deployable unit in Kubernetes, one or more containers." },
    { term: "Node", desc: "Machine that runs pods (VM or physical host)." },
    { term: "Namespace", desc: "Logical isolation boundary inside a cluster." },
    { term: "Service Account", desc: "Identity used by pods to talk to the Kubernetes API." },
    { term: "RBAC", desc: "Role-based access control for Kubernetes resources." },
    { term: "RoleBinding", desc: "Binds a role to users or service accounts." },
    { term: "Kubelet", desc: "Node agent that runs containers and reports status." },
    { term: "DaemonSet", desc: "Ensures a pod runs on each node in the cluster." },
    { term: "Ingress", desc: "Routes HTTP traffic to services inside the cluster." },
  ];
  const containerCommandHints = [
    { cmd: "id", purpose: "Who am I inside the container." },
    { cmd: "cat /proc/1/cgroup", purpose: "Confirm container runtime context." },
    { cmd: "mount", purpose: "Find host mounts and sensitive paths." },
    { cmd: "ls -l /var/run/docker.sock", purpose: "Check for Docker socket exposure." },
    { cmd: "capsh --print", purpose: "Review Linux capabilities." },
  ];
  const kubectlBasics = [
    { cmd: "kubectl get ns", purpose: "List namespaces." },
    { cmd: "kubectl get pods -A", purpose: "List all pods in all namespaces." },
    { cmd: "kubectl auth can-i --list", purpose: "See what the current identity can do." },
    { cmd: "kubectl get roles,rolebindings -A", purpose: "Map RBAC permissions." },
    { cmd: "kubectl describe pod <name> -n <ns>", purpose: "View pod details and mounts." },
  ];
  const k8sNetworkRecon = `# Service and network mapping
kubectl get svc -A
kubectl get endpoints -A
kubectl get ingress -A
kubectl get networkpolicy -A
kubectl get pods -A -o wide`;
  const controlPlaneComponents = [
    {
      component: "API Server",
      risk: "Primary control plane entrypoint. Exposure or weak auth grants cluster control.",
      focus: "Restrict access, enable authn/authz, audit logs.",
    },
    {
      component: "etcd",
      risk: "Stores secrets and cluster state. Exposure yields full compromise.",
      focus: "No public access, mTLS, encrypted backups.",
    },
    {
      component: "Controller Manager",
      risk: "Can create or scale workloads for persistence.",
      focus: "Protect via API auth and RBAC.",
    },
    {
      component: "Scheduler",
      risk: "Can schedule privileged pods to nodes.",
      focus: "Limit API access and enforce policies.",
    },
    {
      component: "Kubelet",
      risk: "Insecure endpoints allow exec or log access.",
      focus: "Disable read-only port, require auth.",
    },
  ];
  const runtimeEscalationPatterns = [
    "Docker or containerd socket access enables container to host control.",
    "HostPath mounts allow overwriting host binaries or kubelet configs.",
    "Privileged pods with host PID or host network can reach host namespaces.",
    "CAP_SYS_ADMIN plus sensitive mounts unlocks escape primitives.",
    "Writable /proc or /sys mounts can alter host settings.",
  ];
  const containerDetectionSignals = [
    "Access to /var/run/docker.sock or /run/containerd.sock inside pods",
    "Unexpected processes spawning with elevated capabilities",
    "Write activity to hostPath mounts or /proc/1/root",
    "Outbound calls to metadata endpoints from workloads",
    "New containers or DaemonSets created without change tickets",
  ];
  const kubernetesEscalationPaths = [
    {
      vector: "Service account token theft",
      impact: "API access as the pod identity",
      signal: "Token used from unexpected pod or namespace",
    },
    {
      vector: "RBAC wildcard permissions",
      impact: "Create pods, read secrets, or bind cluster-admin",
      signal: "can-i shows '*' verbs/resources",
    },
    {
      vector: "Privileged DaemonSet",
      impact: "Node access and host persistence",
      signal: "DaemonSet with hostPID or hostPath mounts",
    },
    {
      vector: "Kubelet exposure",
      impact: "Exec into pods or read logs",
      signal: "Unsecured kubelet ports 10250 or 10255",
    },
    {
      vector: "Admission policy gaps",
      impact: "Unsafe pod specs allowed",
      signal: "Pods created without expected policy checks",
    },
  ];
  const persistenceIdeas = [
    "Add a CronJob or DaemonSet with elevated permissions.",
    "Patch an existing deployment image or environment values.",
    "Create a ClusterRoleBinding for a controlled service account.",
    "Store payloads in ConfigMaps or Secrets and mount them in pods.",
  ];
  const reportingChecklist = [
    "Capture kubectl auth can-i outputs and RBAC bindings.",
    "Record pod specs showing hostPath, privileged, or capabilities.",
    "List exposed endpoints (kubelet, API server, registries).",
    "Document impact, evidence, and recommended fixes per finding.",
  ];

  return (
    <LearnPageLayout pageTitle="Container and Kubernetes Exploitation" pageContext={pageContext}>
    <Box sx={{ minHeight: "100vh", bgcolor: "#0a0d18", py: 4 }}>
      <Container maxWidth="lg">
        <Button startIcon={<ArrowBackIcon />} onClick={() => navigate("/learn")} sx={{ mb: 2, color: "grey.400" }}>
          Back to Learn Hub
        </Button>

        <Box sx={{ display: "flex", alignItems: "center", gap: 2, mb: 2 }}>
          <CloudIcon sx={{ fontSize: 42, color: "#38bdf8" }} />
          <Typography
            variant="h3"
            sx={{
              fontWeight: 700,
              background: "linear-gradient(135deg, #38bdf8 0%, #6366f1 100%)",
              backgroundClip: "text",
              WebkitBackgroundClip: "text",
              color: "transparent",
            }}
          >
            Container and Kubernetes Exploitation
          </Typography>
        </Box>
        <Typography variant="h6" sx={{ color: "grey.400", mb: 2 }}>
          Offensive learning paths for container runtime testing and Kubernetes security assessments.
        </Typography>
        <Box sx={{ display: "flex", gap: 1, flexWrap: "wrap", mb: 3 }}>
          <Chip icon={<LayersIcon />} label="Containers" size="small" />
          <Chip icon={<HubIcon />} label="Kubernetes" size="small" />
          <Chip icon={<SecurityIcon />} label="RBAC and Access" size="small" />
          <Chip icon={<WarningIcon />} label="Misconfigurations" size="small" />
        </Box>

        <Paper sx={{ bgcolor: "#111424", borderRadius: 2 }}>
          <Tabs
            value={tabValue}
            onChange={(_, v) => setTabValue(v)}
            variant="scrollable"
            scrollButtons="auto"
            sx={{
              borderBottom: "1px solid rgba(255,255,255,0.08)",
              "& .MuiTab-root": { color: "grey.400" },
              "& .Mui-selected": { color: "#38bdf8" },
            }}
          >
            <Tab icon={<SecurityIcon />} label="Overview" />
            <Tab icon={<LayersIcon />} label="Container Runtime" />
            <Tab icon={<HubIcon />} label="Kubernetes" />
            <Tab icon={<BuildIcon />} label="Tools and Labs" />
            <Tab icon={<ChecklistIcon />} label="Checklists" />
          </Tabs>

          <TabPanel value={tabValue} index={0}>
            <Box sx={{ p: 3 }}>
              <Paper
                sx={{
                  p: 2.5,
                  mb: 3,
                  bgcolor: "#0e1222",
                  border: "1px solid rgba(239,68,68,0.3)",
                  borderRadius: 2,
                }}
              >
                <Typography variant="h6" sx={{ color: "#f87171", mb: 1 }}>
                  Engagement Guardrails
                </Typography>
                <List dense>
                  {guardrails.map((item) => (
                    <ListItem key={item}>
                      <ListItemIcon>
                        <CheckCircleIcon color="success" fontSize="small" />
                      </ListItemIcon>
                      <ListItemText primary={item} sx={{ "& .MuiListItemText-primary": { color: "grey.300" } }} />
                    </ListItem>
                  ))}
                </List>
              </Paper>

              <Paper sx={{ mb: 3, p: 2.5, bgcolor: "#0c0f1c", borderRadius: 2 }}>
                <Typography variant="h6" sx={{ color: "#38bdf8", mb: 1 }}>
                  Beginner Path (60 to 120 minutes)
                </Typography>
                <List dense>
                  {beginnerPath.map((step) => (
                    <ListItem key={step}>
                      <ListItemIcon>
                        <CheckCircleIcon color="info" fontSize="small" />
                      </ListItemIcon>
                      <ListItemText primary={step} sx={{ "& .MuiListItemText-primary": { color: "grey.300" } }} />
                    </ListItem>
                  ))}
                </List>
              </Paper>

              <Paper sx={{ mb: 3, p: 2.5, bgcolor: "#0c0f1c", borderRadius: 2 }}>
                <Typography variant="h6" sx={{ color: "#a5b4fc", mb: 2 }}>
                  Quick Glossary
                </Typography>
                <TableContainer>
                  <Table size="small">
                    <TableHead>
                      <TableRow>
                        <TableCell sx={{ color: "#a5b4fc" }}>Term</TableCell>
                        <TableCell sx={{ color: "#a5b4fc" }}>Meaning</TableCell>
                      </TableRow>
                    </TableHead>
                    <TableBody>
                      {beginnerGlossary.map((item) => (
                        <TableRow key={item.term}>
                          <TableCell sx={{ color: "grey.200", fontWeight: 600 }}>{item.term}</TableCell>
                          <TableCell sx={{ color: "grey.400" }}>{item.desc}</TableCell>
                        </TableRow>
                      ))}
                    </TableBody>
                  </Table>
                </TableContainer>
              </Paper>

              <Typography variant="h6" sx={{ color: "#38bdf8", mb: 2 }}>
                Primary Attack Surfaces
              </Typography>
              <Grid container spacing={2}>
                {attackSurface.map((item) => (
                  <Grid item xs={12} md={6} key={item.area}>
                    <Paper
                      sx={{
                        p: 2,
                        bgcolor: "#0c0f1c",
                        borderRadius: 2,
                        border: "1px solid rgba(56,189,248,0.2)",
                        height: "100%",
                      }}
                    >
                      <Typography variant="subtitle1" sx={{ color: "#e2e8f0", fontWeight: 600 }}>
                        {item.area}
                      </Typography>
                      <Typography variant="body2" sx={{ color: "grey.400", mb: 1 }}>
                        Risk: {item.risk}
                      </Typography>
                      <Typography variant="caption" sx={{ color: "grey.500" }}>
                        Focus: {item.focus}
                      </Typography>
                    </Paper>
                  </Grid>
                ))}
              </Grid>

              <Paper sx={{ mt: 3, p: 2.5, bgcolor: "#0c0f1c", borderRadius: 2 }}>
                <Typography variant="h6" sx={{ color: "#a5b4fc", mb: 2 }}>
                  Control Plane Components and Risk
                </Typography>
                <TableContainer>
                  <Table size="small">
                    <TableHead>
                      <TableRow>
                        <TableCell sx={{ color: "#a5b4fc" }}>Component</TableCell>
                        <TableCell sx={{ color: "#a5b4fc" }}>Risk</TableCell>
                        <TableCell sx={{ color: "#a5b4fc" }}>Focus</TableCell>
                      </TableRow>
                    </TableHead>
                    <TableBody>
                      {controlPlaneComponents.map((item) => (
                        <TableRow key={item.component}>
                          <TableCell sx={{ color: "grey.200", fontWeight: 600 }}>{item.component}</TableCell>
                          <TableCell sx={{ color: "grey.400" }}>{item.risk}</TableCell>
                          <TableCell sx={{ color: "grey.400" }}>{item.focus}</TableCell>
                        </TableRow>
                      ))}
                    </TableBody>
                  </Table>
                </TableContainer>
              </Paper>

              <Paper sx={{ mt: 3, p: 2.5, bgcolor: "#0c0f1c", borderRadius: 2 }}>
                <Typography variant="subtitle1" sx={{ color: "#a5b4fc", mb: 1 }}>
                  Typical Offensive Flow
                </Typography>
                <List dense>
                  {[
                    "Enumerate runtime, cluster, and registry context.",
                    "Identify weak isolation or exposed control-plane services.",
                    "Abuse RBAC or service account permissions to expand access.",
                    "Pivot to nodes, registries, or adjacent namespaces.",
                    "Document evidence, impact, and recommended fixes.",
                  ].map((step) => (
                    <ListItem key={step}>
                      <ListItemIcon>
                        <CheckCircleIcon color="info" fontSize="small" />
                      </ListItemIcon>
                      <ListItemText primary={step} sx={{ "& .MuiListItemText-primary": { color: "grey.300" } }} />
                    </ListItem>
                  ))}
                </List>
              </Paper>
            </Box>
          </TabPanel>

          <TabPanel value={tabValue} index={1}>
            <Box sx={{ p: 3 }}>
              <Accordion defaultExpanded>
                <AccordionSummary expandIcon={<ExpandMoreIcon />}>
                  <Typography variant="h6">Beginner Quick Triage</Typography>
                </AccordionSummary>
                <AccordionDetails>
                  <List dense>
                    {[
                      "Confirm you are inside a container and note your user identity.",
                      "Check for host mounts and exposed Docker sockets.",
                      "Identify any privileged settings or dangerous capabilities.",
                      "Look for secrets in environment variables and mounted files.",
                      "Record what you find before making changes.",
                    ].map((item) => (
                      <ListItem key={item}>
                        <ListItemIcon>
                          <CheckCircleIcon color="info" fontSize="small" />
                        </ListItemIcon>
                        <ListItemText primary={item} sx={{ "& .MuiListItemText-primary": { color: "grey.300" } }} />
                      </ListItem>
                    ))}
                  </List>
                </AccordionDetails>
              </Accordion>

              <Accordion defaultExpanded>
                <AccordionSummary expandIcon={<ExpandMoreIcon />}>
                  <Typography variant="h6">Enumeration Basics</Typography>
                </AccordionSummary>
                <AccordionDetails>
                  <CodeBlock
                    code={`# Container and host context
id
cat /proc/1/cgroup
cat /etc/os-release

# Docker visibility (if socket exposed)
docker version
docker ps --format "table {{.ID}}\\t{{.Image}}\\t{{.Status}}"
docker inspect <container_id>

# Capability review
capsh --print
getcap -r / 2>/dev/null`}
                  />
                </AccordionDetails>
              </Accordion>

              <Accordion>
                <AccordionSummary expandIcon={<ExpandMoreIcon />}>
                  <Typography variant="h6">Command Cheat Sheet</Typography>
                </AccordionSummary>
                <AccordionDetails>
                  <TableContainer>
                    <Table size="small">
                      <TableHead>
                        <TableRow>
                          <TableCell sx={{ color: "#38bdf8" }}>Command</TableCell>
                          <TableCell sx={{ color: "#38bdf8" }}>Why it matters</TableCell>
                        </TableRow>
                      </TableHead>
                      <TableBody>
                        {containerCommandHints.map((item) => (
                          <TableRow key={item.cmd}>
                            <TableCell sx={{ color: "grey.200", fontFamily: "monospace" }}>{item.cmd}</TableCell>
                            <TableCell sx={{ color: "grey.400" }}>{item.purpose}</TableCell>
                          </TableRow>
                        ))}
                      </TableBody>
                    </Table>
                  </TableContainer>
                </AccordionDetails>
              </Accordion>

              <Accordion>
                <AccordionSummary expandIcon={<ExpandMoreIcon />}>
                  <Typography variant="h6">High-Risk Runtime Config</Typography>
                </AccordionSummary>
                <AccordionDetails>
                  <List dense>
                    {[
                      "Privileged containers or CAP_SYS_ADMIN enabled.",
                      "Host mounts like /var/run/docker.sock or / mounted read-write.",
                      "allowPrivilegeEscalation=true or seccomp=unconfined.",
                      "AppArmor disabled or custom profiles missing.",
                      "Host networking or host PID namespace enabled.",
                    ].map((item) => (
                      <ListItem key={item}>
                        <ListItemIcon>
                          <WarningIcon sx={{ color: "#f59e0b" }} fontSize="small" />
                        </ListItemIcon>
                        <ListItemText primary={item} sx={{ "& .MuiListItemText-primary": { color: "grey.300" } }} />
                      </ListItem>
                    ))}
                  </List>
                </AccordionDetails>
              </Accordion>

              <Accordion>
                <AccordionSummary expandIcon={<ExpandMoreIcon />}>
                  <Typography variant="h6">Image and Supply Chain Risks</Typography>
                </AccordionSummary>
                <AccordionDetails>
                  <List dense>
                    {[
                      "Outdated base images or vulnerable packages.",
                      "Secrets baked into images or layered history.",
                      "Unsigned images or untrusted registries.",
                      "Overly broad build contexts and copied credentials.",
                      "Build pipelines with weak dependency pinning.",
                    ].map((item) => (
                      <ListItem key={item}>
                        <ListItemIcon>
                          <CheckCircleIcon color="warning" fontSize="small" />
                        </ListItemIcon>
                        <ListItemText primary={item} sx={{ "& .MuiListItemText-primary": { color: "grey.300" } }} />
                      </ListItem>
                    ))}
                  </List>
                </AccordionDetails>
              </Accordion>

              <Accordion>
                <AccordionSummary expandIcon={<ExpandMoreIcon />}>
                  <Typography variant="h6">Container Escape Themes</Typography>
                </AccordionSummary>
                <AccordionDetails>
                  <Typography variant="body2" sx={{ color: "grey.400", mb: 2 }}>
                    Focus on isolation breaks caused by misconfiguration, not kernel zero-days.
                  </Typography>
                  <List dense>
                    {[
                      "Abuse mounted Docker socket to control the host.",
                      "HostPath volumes that expose host filesystem or secrets.",
                      "Privileged pods with host PID or host network access.",
                      "Sensitive device mounts like /dev or /proc.",
                      "Weak seccomp or AppArmor profiles that allow dangerous syscalls.",
                    ].map((item) => (
                      <ListItem key={item}>
                        <ListItemIcon>
                          <CheckCircleIcon color="success" fontSize="small" />
                        </ListItemIcon>
                        <ListItemText primary={item} sx={{ "& .MuiListItemText-primary": { color: "grey.300" } }} />
                      </ListItem>
                    ))}
                  </List>
                </AccordionDetails>
              </Accordion>

              <Accordion>
                <AccordionSummary expandIcon={<ExpandMoreIcon />}>
                  <Typography variant="h6">Privilege Escalation Patterns</Typography>
                </AccordionSummary>
                <AccordionDetails>
                  <List dense>
                    {runtimeEscalationPatterns.map((item) => (
                      <ListItem key={item}>
                        <ListItemIcon>
                          <CheckCircleIcon color="info" fontSize="small" />
                        </ListItemIcon>
                        <ListItemText primary={item} sx={{ "& .MuiListItemText-primary": { color: "grey.300" } }} />
                      </ListItem>
                    ))}
                  </List>
                </AccordionDetails>
              </Accordion>

              <Accordion>
                <AccordionSummary expandIcon={<ExpandMoreIcon />}>
                  <Typography variant="h6">Detection Signals</Typography>
                </AccordionSummary>
                <AccordionDetails>
                  <List dense>
                    {containerDetectionSignals.map((item) => (
                      <ListItem key={item}>
                        <ListItemIcon>
                          <WarningIcon sx={{ color: "#f59e0b" }} fontSize="small" />
                        </ListItemIcon>
                        <ListItemText primary={item} sx={{ "& .MuiListItemText-primary": { color: "grey.300" } }} />
                      </ListItem>
                    ))}
                  </List>
                </AccordionDetails>
              </Accordion>
            </Box>
          </TabPanel>

          <TabPanel value={tabValue} index={2}>
            <Box sx={{ p: 3 }}>
              <Accordion defaultExpanded>
                <AccordionSummary expandIcon={<ExpandMoreIcon />}>
                  <Typography variant="h6">Beginner kubectl Basics</Typography>
                </AccordionSummary>
                <AccordionDetails>
                  <TableContainer>
                    <Table size="small">
                      <TableHead>
                        <TableRow>
                          <TableCell sx={{ color: "#38bdf8" }}>Command</TableCell>
                          <TableCell sx={{ color: "#38bdf8" }}>Purpose</TableCell>
                        </TableRow>
                      </TableHead>
                      <TableBody>
                        {kubectlBasics.map((item) => (
                          <TableRow key={item.cmd}>
                            <TableCell sx={{ color: "grey.200", fontFamily: "monospace" }}>{item.cmd}</TableCell>
                            <TableCell sx={{ color: "grey.400" }}>{item.purpose}</TableCell>
                          </TableRow>
                        ))}
                      </TableBody>
                    </Table>
                  </TableContainer>
                </AccordionDetails>
              </Accordion>

              <Accordion defaultExpanded>
                <AccordionSummary expandIcon={<ExpandMoreIcon />}>
                  <Typography variant="h6">Cluster Recon</Typography>
                </AccordionSummary>
                <AccordionDetails>
                  <CodeBlock
                    code={`# Basic cluster visibility
kubectl version --short
kubectl config view --minify
kubectl get ns
kubectl get nodes -o wide
kubectl get pods -A

# RBAC and access checks
kubectl auth can-i --list
kubectl get roles,rolebindings -A
kubectl get clusterroles,clusterrolebindings`}
                  />
                </AccordionDetails>
              </Accordion>

              <Accordion>
                <AccordionSummary expandIcon={<ExpandMoreIcon />}>
                  <Typography variant="h6">Service Discovery and Network Mapping</Typography>
                </AccordionSummary>
                <AccordionDetails>
                  <CodeBlock code={k8sNetworkRecon} />
                </AccordionDetails>
              </Accordion>

              <Accordion>
                <AccordionSummary expandIcon={<ExpandMoreIcon />}>
                  <Typography variant="h6">RBAC and Auth Weaknesses</Typography>
                </AccordionSummary>
                <AccordionDetails>
                  <List dense>
                    {[
                      "ClusterRoleBinding grants cluster-admin to service accounts.",
                      "Namespace RoleBindings allow wildcard verbs or resources.",
                      "Anonymous or unauthenticated access enabled.",
                      "Default service accounts with broad permissions.",
                      "Lack of authn/authz on kubelet endpoints.",
                    ].map((item) => (
                      <ListItem key={item}>
                        <ListItemIcon>
                          <WarningIcon sx={{ color: "#f59e0b" }} fontSize="small" />
                        </ListItemIcon>
                        <ListItemText primary={item} sx={{ "& .MuiListItemText-primary": { color: "grey.300" } }} />
                      </ListItem>
                    ))}
                  </List>
                </AccordionDetails>
              </Accordion>

              <Accordion>
                <AccordionSummary expandIcon={<ExpandMoreIcon />}>
                  <Typography variant="h6">Escalation Paths</Typography>
                </AccordionSummary>
                <AccordionDetails>
                  <TableContainer>
                    <Table size="small">
                      <TableHead>
                        <TableRow>
                          <TableCell sx={{ color: "#38bdf8" }}>Vector</TableCell>
                          <TableCell sx={{ color: "#38bdf8" }}>Impact</TableCell>
                          <TableCell sx={{ color: "#38bdf8" }}>Signal</TableCell>
                        </TableRow>
                      </TableHead>
                      <TableBody>
                        {kubernetesEscalationPaths.map((item) => (
                          <TableRow key={item.vector}>
                            <TableCell sx={{ color: "grey.200", fontWeight: 600 }}>{item.vector}</TableCell>
                            <TableCell sx={{ color: "grey.400" }}>{item.impact}</TableCell>
                            <TableCell sx={{ color: "grey.400" }}>{item.signal}</TableCell>
                          </TableRow>
                        ))}
                      </TableBody>
                    </Table>
                  </TableContainer>
                </AccordionDetails>
              </Accordion>

              <Accordion>
                <AccordionSummary expandIcon={<ExpandMoreIcon />}>
                  <Typography variant="h6">Secrets and Service Accounts</Typography>
                </AccordionSummary>
                <AccordionDetails>
                  <List dense>
                    {[
                      "Service account tokens mounted in every pod by default.",
                      "Secrets stored in plaintext or with weak rotation.",
                      "ConfigMaps with credentials or API keys.",
                      "CI/CD tokens stored in namespaces shared by many teams.",
                    ].map((item) => (
                      <ListItem key={item}>
                        <ListItemIcon>
                          <CheckCircleIcon color="warning" fontSize="small" />
                        </ListItemIcon>
                        <ListItemText primary={item} sx={{ "& .MuiListItemText-primary": { color: "grey.300" } }} />
                      </ListItem>
                    ))}
                  </List>
                </AccordionDetails>
              </Accordion>

              <Accordion>
                <AccordionSummary expandIcon={<ExpandMoreIcon />}>
                  <Typography variant="h6">Node and Pod Escalation Paths</Typography>
                </AccordionSummary>
                <AccordionDetails>
                  <List dense>
                    {[
                      "Privileged pods with host PID or host network access.",
                      "HostPath volumes mounted read-write.",
                      "DaemonSets deployed with broad permissions.",
                      "Exposed kubelet read-only or unsecured metrics.",
                      "Access to container runtime sockets on the node.",
                    ].map((item) => (
                      <ListItem key={item}>
                        <ListItemIcon>
                          <CheckCircleIcon color="success" fontSize="small" />
                        </ListItemIcon>
                        <ListItemText primary={item} sx={{ "& .MuiListItemText-primary": { color: "grey.300" } }} />
                      </ListItem>
                    ))}
                  </List>
                </AccordionDetails>
              </Accordion>

              <Accordion>
                <AccordionSummary expandIcon={<ExpandMoreIcon />}>
                  <Typography variant="h6">Persistence Ideas</Typography>
                </AccordionSummary>
                <AccordionDetails>
                  <List dense>
                    {persistenceIdeas.map((item) => (
                      <ListItem key={item}>
                        <ListItemIcon>
                          <CheckCircleIcon color="info" fontSize="small" />
                        </ListItemIcon>
                        <ListItemText primary={item} sx={{ "& .MuiListItemText-primary": { color: "grey.300" } }} />
                      </ListItem>
                    ))}
                  </List>
                </AccordionDetails>
              </Accordion>
            </Box>
          </TabPanel>

          <TabPanel value={tabValue} index={3}>
            <Box sx={{ p: 3 }}>
              <Typography variant="h6" sx={{ color: "#38bdf8", mb: 2 }}>
                Tools for Offensive Assessment
              </Typography>
              <TableContainer sx={{ mb: 3 }}>
                <Table size="small">
                  <TableHead>
                    <TableRow>
                      <TableCell sx={{ color: "#38bdf8" }}>Tool</TableCell>
                      <TableCell sx={{ color: "#38bdf8" }}>Focus</TableCell>
                      <TableCell sx={{ color: "#38bdf8" }}>Use Case</TableCell>
                    </TableRow>
                  </TableHead>
                  <TableBody>
                    {[
                      ["Trivy", "Image and config scanning", "Find vulnerable packages and misconfigurations"],
                      ["Grype + Syft", "SBOM and vuln scanning", "Inventory and CVE mapping"],
                      ["kube-hunter", "Kubernetes recon", "Cluster attack surface discovery"],
                      ["kube-bench", "CIS checks", "Baseline hardening verification"],
                      ["kubectl + krew", "Native access", "Query RBAC and resources"],
                      ["Docker Bench", "Docker CIS checks", "Host and daemon validation"],
                    ].map(([tool, focus, use]) => (
                      <TableRow key={tool}>
                        <TableCell sx={{ color: "grey.200", fontWeight: 600 }}>{tool}</TableCell>
                        <TableCell sx={{ color: "grey.400" }}>{focus}</TableCell>
                        <TableCell sx={{ color: "grey.400" }}>{use}</TableCell>
                      </TableRow>
                    ))}
                  </TableBody>
                </Table>
              </TableContainer>

              <Typography variant="h6" sx={{ color: "#a5b4fc", mb: 2 }}>
                Recommended Lab Environments
              </Typography>
              <Grid container spacing={2}>
                {[
                  {
                    title: "Kubernetes Goat",
                    desc: "Intentionally vulnerable cluster scenarios for common attack paths.",
                  },
                  {
                    title: "KubeGoat",
                    desc: "Hands-on exercises for misconfigurations and RBAC abuse.",
                  },
                  {
                    title: "Kind or Minikube",
                    desc: "Local clusters for repeatable testing without touching production.",
                  },
                  {
                    title: "OWASP Juice Shop on K8s",
                    desc: "Pair web exploitation with container runtime learning.",
                  },
                ].map((lab) => (
                  <Grid item xs={12} md={6} key={lab.title}>
                    <Paper
                      sx={{
                        p: 2,
                        bgcolor: "#0c0f1c",
                        borderRadius: 2,
                        border: "1px solid rgba(99,102,241,0.3)",
                      }}
                    >
                      <Typography variant="subtitle1" sx={{ color: "#e2e8f0", fontWeight: 600 }}>
                        {lab.title}
                      </Typography>
                      <Typography variant="body2" sx={{ color: "grey.400" }}>
                        {lab.desc}
                      </Typography>
                    </Paper>
                  </Grid>
                ))}
              </Grid>

              <Paper sx={{ mt: 3, p: 2.5, bgcolor: "#0c0f1c", borderRadius: 2 }}>
                <Typography variant="h6" sx={{ color: "#38bdf8", mb: 2 }}>
                  Beginner Lab Quickstart (Local Cluster)
                </Typography>
                <Typography variant="body2" sx={{ color: "grey.400", mb: 1 }}>
                  Create a local cluster, deploy a simple app, and run basic recon. Use a disposable lab only.
                </Typography>
                <CodeBlock
                  code={`# Create a local cluster (kind)
kind create cluster --name k8s-lab
kubectl cluster-info

# Deploy a sample app
kubectl create ns demo
kubectl run demo-nginx --image=nginx --namespace demo
kubectl get pods -n demo -o wide

# Inspect the pod and its mounts
kubectl describe pod demo-nginx -n demo

# Cleanup
kind delete cluster --name k8s-lab`}
                />
                <Typography variant="body2" sx={{ color: "grey.400", mt: 2 }}>
                  If you use minikube instead of kind, replace the create and delete steps:
                </Typography>
                <CodeBlock
                  code={`# minikube alternative
minikube start
kubectl get nodes
minikube delete`}
                />
              </Paper>
            </Box>
          </TabPanel>

          <TabPanel value={tabValue} index={4}>
            <Box sx={{ p: 3 }}>
              <Paper sx={{ p: 2, bgcolor: "#0c0f1c", borderRadius: 2, mb: 2 }}>
                <Typography variant="subtitle1" sx={{ color: "#a5b4fc", mb: 1 }}>
                  Beginner Preflight
                </Typography>
                <List dense>
                  {[
                    "Confirm scope and permission to test before touching any cluster.",
                    "Work in a local or lab environment first.",
                    "Keep a simple notes file with commands and outputs.",
                    "Take screenshots of risky configurations for evidence.",
                  ].map((item) => (
                    <ListItem key={item}>
                      <ListItemIcon>
                        <CheckCircleIcon color="info" fontSize="small" />
                      </ListItemIcon>
                      <ListItemText primary={item} sx={{ "& .MuiListItemText-primary": { color: "grey.300" } }} />
                    </ListItem>
                  ))}
                </List>
              </Paper>

              <Typography variant="h6" sx={{ color: "#38bdf8", mb: 2 }}>
                Container Checklist
              </Typography>
              <List dense>
                {[
                  "Identify privileged or high-capability containers.",
                  "Check for mounted Docker or container runtime sockets.",
                  "Review base image age and vulnerability posture.",
                  "Look for secrets in image layers or environment variables.",
                  "Validate seccomp, AppArmor, and user namespaces.",
                ].map((item) => (
                  <ListItem key={item}>
                    <ListItemIcon>
                      <CheckCircleIcon color="success" fontSize="small" />
                    </ListItemIcon>
                    <ListItemText primary={item} sx={{ "& .MuiListItemText-primary": { color: "grey.300" } }} />
                  </ListItem>
                ))}
              </List>

              <Typography variant="h6" sx={{ color: "#a5b4fc", mt: 3, mb: 2 }}>
                Kubernetes Checklist
              </Typography>
              <List dense>
                {[
                  "Enumerate RBAC for cluster-admin or wildcard permissions.",
                  "Inspect service account token usage and secret access.",
                  "Check for hostPath volumes or privileged pods.",
                  "Review kubelet, API server, and etcd exposure.",
                  "Assess network policies and namespace isolation.",
                ].map((item) => (
                  <ListItem key={item}>
                    <ListItemIcon>
                      <CheckCircleIcon color="info" fontSize="small" />
                    </ListItemIcon>
                    <ListItemText primary={item} sx={{ "& .MuiListItemText-primary": { color: "grey.300" } }} />
                  </ListItem>
                ))}
              </List>

              <Typography variant="h6" sx={{ color: "#38bdf8", mt: 3, mb: 2 }}>
                Reporting Checklist
              </Typography>
              <List dense>
                {reportingChecklist.map((item) => (
                  <ListItem key={item}>
                    <ListItemIcon>
                      <CheckCircleIcon color="success" fontSize="small" />
                    </ListItemIcon>
                    <ListItemText primary={item} sx={{ "& .MuiListItemText-primary": { color: "grey.300" } }} />
                  </ListItem>
                ))}
              </List>
            </Box>
          </TabPanel>
        </Paper>

        <Box sx={{ mt: 4, textAlign: "center" }}>
          <Button
            variant="outlined"
            startIcon={<ArrowBackIcon />}
            onClick={() => navigate("/learn")}
            sx={{ borderColor: "#38bdf8", color: "#38bdf8" }}
          >
            Back to Learn Hub
          </Button>
        </Box>
      </Container>
    </Box>
    </LearnPageLayout>
  );
};

export default ContainerKubernetesExploitationPage;
