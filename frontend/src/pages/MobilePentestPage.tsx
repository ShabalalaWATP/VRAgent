import React, { useState } from "react";
import {
  Box,
  Container,
  Typography,
  Paper,
  Tabs,
  Tab,
  Chip,
  Button,
  Accordion,
  AccordionSummary,
  AccordionDetails,
  Alert,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  IconButton,
  Tooltip,
  List,
  ListItem,
  ListItemIcon,
  ListItemText,
  Grid,
  Card,
  CardContent,
  alpha,
  Divider,
  LinearProgress,
} from "@mui/material";
import ArrowBackIcon from "@mui/icons-material/ArrowBack";
import ExpandMoreIcon from "@mui/icons-material/ExpandMore";
import ContentCopyIcon from "@mui/icons-material/ContentCopy";
import PhoneAndroidIcon from "@mui/icons-material/PhoneAndroid";
import AppleIcon from "@mui/icons-material/Apple";
import SecurityIcon from "@mui/icons-material/Security";
import StorageIcon from "@mui/icons-material/Storage";
import WifiIcon from "@mui/icons-material/Wifi";
import BuildIcon from "@mui/icons-material/Build";
import CheckCircleIcon from "@mui/icons-material/CheckCircle";
import WarningIcon from "@mui/icons-material/Warning";
import BugReportIcon from "@mui/icons-material/BugReport";
import CodeIcon from "@mui/icons-material/Code";
import LockOpenIcon from "@mui/icons-material/LockOpen";
import FingerprintIcon from "@mui/icons-material/Fingerprint";
import DownloadIcon from "@mui/icons-material/Download";
import VisibilityIcon from "@mui/icons-material/Visibility";
import { useNavigate } from "react-router-dom";

interface TabPanelProps {
  children?: React.ReactNode;
  index: number;
  value: number;
}

function TabPanel(props: TabPanelProps) {
  const { children, value, index, ...other } = props;
  return (
    <div role="tabpanel" hidden={value !== index} {...other}>
      {value === index && <Box sx={{ py: 3 }}>{children}</Box>}
    </div>
  );
}

const CodeBlock: React.FC<{ code: string; language?: string; title?: string }> = ({
  code,
  language = "bash",
  title,
}) => {
  const [copied, setCopied] = useState(false);

  const handleCopy = () => {
    navigator.clipboard.writeText(code);
    setCopied(true);
    setTimeout(() => setCopied(false), 2000);
  };

  return (
    <Paper
      sx={{
        bgcolor: "#0d1117",
        borderRadius: 2,
        position: "relative",
        my: 2,
        border: "1px solid rgba(16, 185, 129, 0.2)",
        overflow: "hidden",
      }}
    >
      {title && (
        <Box sx={{ px: 2, py: 1, bgcolor: "rgba(16, 185, 129, 0.1)", borderBottom: "1px solid rgba(16, 185, 129, 0.2)" }}>
          <Typography variant="subtitle2" sx={{ color: "#10b981", fontWeight: 600 }}>{title}</Typography>
        </Box>
      )}
      <Box sx={{ position: "absolute", top: title ? 40 : 8, right: 8, display: "flex", gap: 1 }}>
        <Chip label={language} size="small" sx={{ bgcolor: alpha("#10b981", 0.2), color: "#10b981", fontSize: "0.7rem" }} />
        <Tooltip title={copied ? "Copied!" : "Copy"}>
          <IconButton size="small" onClick={handleCopy} sx={{ color: copied ? "#10b981" : "#888" }}>
            <ContentCopyIcon fontSize="small" />
          </IconButton>
        </Tooltip>
      </Box>
      <Box
        component="pre"
        sx={{
          m: 0,
          p: 2,
          pt: 3,
          overflow: "auto",
          fontFamily: "'Fira Code', 'Consolas', monospace",
          fontSize: "0.8rem",
          color: "#e6edf3",
          lineHeight: 1.6,
        }}
      >
        {code}
      </Box>
    </Paper>
  );
};

const MobilePentestPage: React.FC = () => {
  const navigate = useNavigate();
  const [tabValue, setTabValue] = useState(0);

  const handleTabChange = (_: React.SyntheticEvent, newValue: number) => {
    setTabValue(newValue);
  };

  const tools = [
    { name: "Frida", purpose: "Dynamic instrumentation & hooking", platform: "Both", icon: "üîß" },
    { name: "Objection", purpose: "Runtime exploration (Frida-based)", platform: "Both", icon: "üéØ" },
    { name: "MobSF", purpose: "Automated static/dynamic analysis", platform: "Both", icon: "üîç" },
    { name: "jadx", purpose: "Android APK decompiler to Java", platform: "Android", icon: "üì¶" },
    { name: "apktool", purpose: "APK unpacking/repacking/smali", platform: "Android", icon: "üõ†Ô∏è" },
    { name: "Hopper/IDA", purpose: "iOS binary disassembly", platform: "iOS", icon: "üíª" },
    { name: "Burp Suite", purpose: "HTTP/S traffic interception", platform: "Both", icon: "üåê" },
    { name: "adb", purpose: "Android Debug Bridge CLI", platform: "Android", icon: "üì±" },
    { name: "class-dump", purpose: "Extract ObjC headers from iOS apps", platform: "iOS", icon: "üìã" },
    { name: "Cycript", purpose: "iOS runtime manipulation", platform: "iOS", icon: "‚ö°" },
  ];

  return (
    <Box sx={{ minHeight: "100vh", bgcolor: "#0a0a0f", py: 4 }}>
      <Container maxWidth="lg">
        {/* Header */}
        <Box sx={{ mb: 4 }}>
          <Button
            startIcon={<ArrowBackIcon />}
            onClick={() => navigate("/learn")}
            sx={{ mb: 2, color: "grey.400", "&:hover": { color: "#10b981" } }}
          >
            Back to Learn Hub
          </Button>
          
          <Box sx={{ display: "flex", alignItems: "center", gap: 2, mb: 2 }}>
            <Box
              sx={{
                p: 1.5,
                borderRadius: 2,
                background: "linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(52, 211, 153, 0.1) 100%)",
                border: "1px solid rgba(16, 185, 129, 0.3)",
              }}
            >
              <PhoneAndroidIcon sx={{ fontSize: 36, color: "#10b981" }} />
            </Box>
            <Box>
              <Typography
                variant="h3"
                sx={{
                  fontWeight: 700,
                  background: "linear-gradient(135deg, #10b981 0%, #34d399 50%, #6ee7b7 100%)",
                  backgroundClip: "text",
                  WebkitBackgroundClip: "text",
                  color: "transparent",
                }}
              >
                Mobile App Pentesting
              </Typography>
              <Typography variant="body1" sx={{ color: "grey.500" }}>
                Security testing methodology for Android and iOS applications
              </Typography>
            </Box>
          </Box>
          
          <Box sx={{ display: "flex", gap: 1, flexWrap: "wrap", mt: 2 }}>
            <Chip 
              icon={<PhoneAndroidIcon />} 
              label="Android" 
              size="small" 
              sx={{ bgcolor: alpha("#10b981", 0.15), color: "#10b981", borderColor: "#10b981" }}
              variant="outlined"
            />
            <Chip 
              icon={<AppleIcon />} 
              label="iOS" 
              size="small"
              sx={{ bgcolor: alpha("#8b5cf6", 0.15), color: "#8b5cf6", borderColor: "#8b5cf6" }}
              variant="outlined"
            />
            <Chip icon={<SecurityIcon />} label="OWASP MASTG" size="small" variant="outlined" />
            <Chip icon={<BugReportIcon />} label="Runtime Analysis" size="small" variant="outlined" />
          </Box>
        </Box>

        {/* Quick Stats */}
        <Grid container spacing={2} sx={{ mb: 4 }}>
          {[
            { icon: <BuildIcon />, label: "10 Tools", color: "#10b981" },
            { icon: <BugReportIcon />, label: "OWASP Top 10", color: "#f59e0b" },
            { icon: <CodeIcon />, label: "Frida Scripts", color: "#8b5cf6" },
            { icon: <SecurityIcon />, label: "SSL Bypass", color: "#ef4444" },
          ].map((stat) => (
            <Grid item xs={6} sm={3} key={stat.label}>
              <Paper
                sx={{
                  p: 2,
                  textAlign: "center",
                  bgcolor: alpha(stat.color, 0.05),
                  border: `1px solid ${alpha(stat.color, 0.2)}`,
                  borderRadius: 2,
                }}
              >
                <Box sx={{ color: stat.color, mb: 0.5 }}>{stat.icon}</Box>
                <Typography variant="body2" sx={{ color: "grey.300", fontWeight: 500 }}>
                  {stat.label}
                </Typography>
              </Paper>
            </Grid>
          ))}
        </Grid>

        {/* Platform Cards */}
        <Grid container spacing={3} sx={{ mb: 4 }}>
          <Grid item xs={12} md={6}>
            <Card 
              sx={{ 
                bgcolor: "#12121a",
                border: "1px solid",
                borderColor: alpha("#10b981", 0.3),
                borderRadius: 3,
                overflow: "hidden",
              }}
            >
              <Box sx={{ height: 4, background: "linear-gradient(90deg, #10b981, #34d399)" }} />
              <CardContent sx={{ p: 3 }}>
                <Box sx={{ display: "flex", alignItems: "center", gap: 2, mb: 2 }}>
                  <Box sx={{ p: 1.5, borderRadius: 2, bgcolor: alpha("#10b981", 0.15) }}>
                    <PhoneAndroidIcon sx={{ color: "#10b981", fontSize: 28 }} />
                  </Box>
                  <Box>
                    <Typography variant="h6" sx={{ color: "#10b981", fontWeight: 600 }}>Android</Typography>
                    <Typography variant="caption" sx={{ color: "grey.500" }}>APK / Java / Kotlin</Typography>
                  </Box>
                  <Chip label="Easier" size="small" sx={{ ml: "auto", bgcolor: alpha("#10b981", 0.2), color: "#10b981" }} />
                </Box>
                <Divider sx={{ borderColor: "rgba(255,255,255,0.05)", my: 2 }} />
                <Grid container spacing={1}>
                  {[
                    { icon: <DownloadIcon />, text: "APK files easily extracted" },
                    { icon: <CodeIcon />, text: "Java bytecode decompiles well" },
                    { icon: <VisibilityIcon />, text: "Emulator testing supported" },
                    { icon: <LockOpenIcon />, text: "Root detection common" },
                  ].map((item, idx) => (
                    <Grid item xs={12} key={idx}>
                      <Box sx={{ display: "flex", alignItems: "center", gap: 1.5 }}>
                        <Box sx={{ color: "#10b981", opacity: 0.7 }}>{item.icon}</Box>
                        <Typography variant="body2" sx={{ color: "grey.300" }}>{item.text}</Typography>
                      </Box>
                    </Grid>
                  ))}
                </Grid>
              </CardContent>
            </Card>
          </Grid>
          <Grid item xs={12} md={6}>
            <Card 
              sx={{ 
                bgcolor: "#12121a",
                border: "1px solid",
                borderColor: alpha("#8b5cf6", 0.3),
                borderRadius: 3,
                overflow: "hidden",
              }}
            >
              <Box sx={{ height: 4, background: "linear-gradient(90deg, #8b5cf6, #a855f7)" }} />
              <CardContent sx={{ p: 3 }}>
                <Box sx={{ display: "flex", alignItems: "center", gap: 2, mb: 2 }}>
                  <Box sx={{ p: 1.5, borderRadius: 2, bgcolor: alpha("#8b5cf6", 0.15) }}>
                    <AppleIcon sx={{ color: "#8b5cf6", fontSize: 28 }} />
                  </Box>
                  <Box>
                    <Typography variant="h6" sx={{ color: "#8b5cf6", fontWeight: 600 }}>iOS</Typography>
                    <Typography variant="caption" sx={{ color: "grey.500" }}>IPA / Swift / Obj-C</Typography>
                  </Box>
                  <Chip label="Harder" size="small" sx={{ ml: "auto", bgcolor: alpha("#f59e0b", 0.2), color: "#f59e0b" }} />
                </Box>
                <Divider sx={{ borderColor: "rgba(255,255,255,0.05)", my: 2 }} />
                <Grid container spacing={1}>
                  {[
                    { icon: <DownloadIcon />, text: "IPA extraction needs jailbreak" },
                    { icon: <CodeIcon />, text: "Compiled ARM, harder to RE" },
                    { icon: <VisibilityIcon />, text: "Requires macOS or device" },
                    { icon: <FingerprintIcon />, text: "Jailbreak detection common" },
                  ].map((item, idx) => (
                    <Grid item xs={12} key={idx}>
                      <Box sx={{ display: "flex", alignItems: "center", gap: 1.5 }}>
                        <Box sx={{ color: "#8b5cf6", opacity: 0.7 }}>{item.icon}</Box>
                        <Typography variant="body2" sx={{ color: "grey.300" }}>{item.text}</Typography>
                      </Box>
                    </Grid>
                  ))}
                </Grid>
              </CardContent>
            </Card>
          </Grid>
        </Grid>

        {/* Tabs */}
        <Paper sx={{ bgcolor: "#12121a", borderRadius: 3, overflow: "hidden", border: "1px solid rgba(255,255,255,0.05)" }}>
          <Tabs
            value={tabValue}
            onChange={handleTabChange}
            variant="scrollable"
            scrollButtons="auto"
            sx={{
              bgcolor: "rgba(0,0,0,0.2)",
              borderBottom: "1px solid rgba(255,255,255,0.05)",
              "& .MuiTab-root": { 
                color: "grey.500",
                minHeight: 64,
                textTransform: "none",
                fontSize: "0.9rem",
                fontWeight: 500,
                "&:hover": { color: "grey.300" },
              },
              "& .Mui-selected": { color: "#10b981 !important" },
              "& .MuiTabs-indicator": { bgcolor: "#10b981", height: 3 },
            }}
          >
            <Tab icon={<BuildIcon />} label="Tools" iconPosition="start" />
            <Tab icon={<StorageIcon />} label="Data Storage" iconPosition="start" />
            <Tab icon={<WifiIcon />} label="Network" iconPosition="start" />
            <Tab icon={<SecurityIcon />} label="Frida" iconPosition="start" />
            <Tab icon={<CheckCircleIcon />} label="Checklist" iconPosition="start" />
          </Tabs>

          {/* Tab 0: Tools */}
          <TabPanel value={tabValue} index={0}>
            <Box sx={{ p: 3 }}>
              <Typography variant="h5" sx={{ color: "#10b981", mb: 1, fontWeight: 600 }}>
                Essential Tools
              </Typography>
              <Typography variant="body2" sx={{ color: "grey.500", mb: 3 }}>
                Core toolkit for mobile application security testing
              </Typography>

              <Grid container spacing={2} sx={{ mb: 3 }}>
                {tools.map((tool) => (
                  <Grid item xs={12} sm={6} md={4} key={tool.name}>
                    <Paper
                      sx={{
                        p: 2,
                        bgcolor: "#0d1117",
                        border: "1px solid",
                        borderColor: tool.platform === "Android" ? alpha("#10b981", 0.2) : tool.platform === "iOS" ? alpha("#8b5cf6", 0.2) : alpha("#3b82f6", 0.2),
                        borderRadius: 2,
                        height: "100%",
                        transition: "all 0.2s",
                        "&:hover": {
                          borderColor: tool.platform === "Android" ? "#10b981" : tool.platform === "iOS" ? "#8b5cf6" : "#3b82f6",
                          transform: "translateY(-2px)",
                        },
                      }}
                    >
                      <Box sx={{ display: "flex", alignItems: "center", gap: 1, mb: 1 }}>
                        <Typography sx={{ fontSize: "1.2rem" }}>{tool.icon}</Typography>
                        <Typography sx={{ color: tool.platform === "Android" ? "#10b981" : tool.platform === "iOS" ? "#8b5cf6" : "#3b82f6", fontWeight: 600 }}>
                          {tool.name}
                        </Typography>
                      </Box>
                      <Typography variant="body2" sx={{ color: "grey.400", mb: 1.5, fontSize: "0.8rem" }}>
                        {tool.purpose}
                      </Typography>
                      <Chip 
                        label={tool.platform} 
                        size="small" 
                        sx={{ 
                          fontSize: "0.7rem",
                          bgcolor: tool.platform === "Both" ? alpha("#3b82f6", 0.15) : tool.platform === "Android" ? alpha("#10b981", 0.15) : alpha("#8b5cf6", 0.15),
                          color: tool.platform === "Both" ? "#3b82f6" : tool.platform === "Android" ? "#10b981" : "#8b5cf6",
                        }} 
                      />
                    </Paper>
                  </Grid>
                ))}
              </Grid>

              <Divider sx={{ borderColor: "rgba(255,255,255,0.05)", my: 3 }} />

              <Typography variant="h6" sx={{ color: "grey.200", mb: 2 }}>
                üöÄ Quick Setup
              </Typography>

              <CodeBlock
                title="Android Analysis Setup"
                language="bash"
                code={`# Extract & decompile APK
apktool d app.apk -o app_extracted
jadx -d output/ app.apk

# Install & debug app
adb install app.apk
adb shell pm list packages | grep appname
adb logcat | grep -i "com.app.name"`}
              />

              <CodeBlock
                title="iOS Analysis Setup"
                language="bash"
                code={`# Extract IPA (jailbroken device)
scp root@device:/var/containers/Bundle/Application/*/App.app .

# Decrypt binary (if encrypted)
./flexdecrypt /path/to/App

# Start MobSF (Docker)
docker run -p 8000:8000 opensecurity/mobile-security-framework-mobsf`}
              />
            </Box>
          </TabPanel>

          {/* Tab 1: Data Storage */}
          <TabPanel value={tabValue} index={1}>
            <Box sx={{ p: 3 }}>
              <Typography variant="h5" sx={{ color: "#10b981", mb: 1, fontWeight: 600 }}>
                Insecure Data Storage
              </Typography>
              <Typography variant="body2" sx={{ color: "grey.500", mb: 3 }}>
                Mobile apps frequently store sensitive data insecurely on device
              </Typography>

              <Alert 
                severity="warning" 
                sx={{ 
                  mb: 3, 
                  bgcolor: alpha("#f59e0b", 0.1),
                  "& .MuiAlert-icon": { color: "#f59e0b" },
                }}
              >
                <strong>OWASP M9:</strong> Insecure Data Storage is a top mobile vulnerability.
                Always check local storage for tokens, credentials, and PII!
              </Alert>

              <Grid container spacing={3}>
                <Grid item xs={12} md={6}>
                  <Paper sx={{ bgcolor: "#0d1117", borderRadius: 2, overflow: "hidden", height: "100%" }}>
                    <Box sx={{ p: 2, bgcolor: alpha("#10b981", 0.1), borderBottom: "1px solid", borderColor: alpha("#10b981", 0.2) }}>
                      <Box sx={{ display: "flex", alignItems: "center", gap: 1 }}>
                        <PhoneAndroidIcon sx={{ color: "#10b981" }} />
                        <Typography variant="h6" sx={{ color: "#10b981" }}>Android Storage</Typography>
                      </Box>
                    </Box>
                    <Box sx={{ p: 2 }}>
                      <CodeBlock
                        language="bash"
                        code={`# App's private directory
adb shell run-as com.app.name \\
  ls /data/data/com.app.name/

# SharedPreferences (often has tokens!)
adb shell cat /data/data/com.app.name/\\
  shared_prefs/*.xml

# SQLite databases
adb pull /data/data/com.app.name/databases/
sqlite3 database.db ".dump"

# External storage (world-readable!)
adb shell ls /sdcard/Android/data/com.app.name/

# Search secrets in decompiled APK
grep -rE "api[_-]?key|password|secret|token" \\
  ./app_extracted/`}
                      />
                    </Box>
                  </Paper>
                </Grid>
                <Grid item xs={12} md={6}>
                  <Paper sx={{ bgcolor: "#0d1117", borderRadius: 2, overflow: "hidden", height: "100%" }}>
                    <Box sx={{ p: 2, bgcolor: alpha("#8b5cf6", 0.1), borderBottom: "1px solid", borderColor: alpha("#8b5cf6", 0.2) }}>
                      <Box sx={{ display: "flex", alignItems: "center", gap: 1 }}>
                        <AppleIcon sx={{ color: "#8b5cf6" }} />
                        <Typography variant="h6" sx={{ color: "#8b5cf6" }}>iOS Storage</Typography>
                      </Box>
                    </Box>
                    <Box sx={{ p: 2 }}>
                      <CodeBlock
                        language="bash"
                        code={`# App sandbox (jailbroken)
cd /var/mobile/Containers/Data/\\
  Application/<UUID>/

# Check plist files
find . -name "*.plist" -exec plutil -p {} \\;

# Keychain items
./keychain-dumper

# NSUserDefaults
cat Library/Preferences/\\
  com.app.name.plist

# SQLite databases
find . -name "*.sqlite" -o -name "*.db" | \\
  xargs -I {} sqlite3 {} ".tables"`}
                      />
                    </Box>
                  </Paper>
                </Grid>
              </Grid>

              <Box sx={{ mt: 4 }}>
                <Typography variant="h6" sx={{ color: "grey.200", mb: 2 }}>
                  üö® Common Vulnerabilities
                </Typography>
                <Grid container spacing={2}>
                  {[
                    { issue: "Plaintext credentials in SharedPrefs", severity: "Critical", color: "#ef4444" },
                    { issue: "API keys hardcoded in source", severity: "Critical", color: "#ef4444" },
                    { issue: "JWT tokens stored unencrypted", severity: "High", color: "#f59e0b" },
                    { issue: "PII logged to console/files", severity: "High", color: "#f59e0b" },
                    { issue: "Backup flag enabled (allowBackup)", severity: "Medium", color: "#3b82f6" },
                    { issue: "Data in external storage", severity: "Medium", color: "#3b82f6" },
                  ].map((item) => (
                    <Grid item xs={12} sm={6} key={item.issue}>
                      <Paper
                        sx={{
                          p: 2,
                          bgcolor: alpha(item.color, 0.05),
                          border: `1px solid ${alpha(item.color, 0.2)}`,
                          borderRadius: 2,
                          display: "flex",
                          alignItems: "center",
                          gap: 2,
                        }}
                      >
                        <WarningIcon sx={{ color: item.color }} />
                        <Box sx={{ flex: 1 }}>
                          <Typography variant="body2" sx={{ color: "grey.200" }}>{item.issue}</Typography>
                        </Box>
                        <Chip 
                          label={item.severity} 
                          size="small" 
                          sx={{ bgcolor: alpha(item.color, 0.2), color: item.color, fontWeight: 600 }}
                        />
                      </Paper>
                    </Grid>
                  ))}
                </Grid>
              </Box>
            </Box>
          </TabPanel>

          {/* Tab 2: Network */}
          <TabPanel value={tabValue} index={2}>
            <Box sx={{ p: 3 }}>
              <Typography variant="h5" sx={{ color: "#10b981", mb: 1, fontWeight: 600 }}>
                Network Security Testing
              </Typography>
              <Typography variant="body2" sx={{ color: "grey.500", mb: 3 }}>
                Intercept and analyze mobile app network traffic
              </Typography>

              <Grid container spacing={3} sx={{ mb: 3 }}>
                <Grid item xs={12} md={6}>
                  <Paper sx={{ p: 3, bgcolor: "#0d1117", borderRadius: 2, border: "1px solid rgba(255,255,255,0.05)" }}>
                    <Typography variant="h6" sx={{ color: "#10b981", mb: 2, display: "flex", alignItems: "center", gap: 1 }}>
                      <PhoneAndroidIcon /> Android Proxy Setup
                    </Typography>
                    <List dense>
                      {[
                        "Export Burp CA certificate (.der)",
                        "Push to device: adb push burp.der /sdcard/",
                        "Settings ‚Üí Security ‚Üí Install from storage",
                        "Set WiFi proxy to <your-ip>:8080",
                      ].map((step, idx) => (
                        <ListItem key={idx} sx={{ py: 0.5 }}>
                          <ListItemIcon sx={{ minWidth: 28 }}>
                            <Chip label={idx + 1} size="small" sx={{ width: 20, height: 20, fontSize: "0.7rem", bgcolor: "#10b981" }} />
                          </ListItemIcon>
                          <ListItemText primary={step} sx={{ "& .MuiListItemText-primary": { color: "grey.300", fontSize: "0.85rem" } }} />
                        </ListItem>
                      ))}
                    </List>
                    <Alert severity="warning" sx={{ mt: 2, py: 0 }}>
                      <Typography variant="caption">Android 7+: CA certs must be in system store or app must trust user certs</Typography>
                    </Alert>
                  </Paper>
                </Grid>
                <Grid item xs={12} md={6}>
                  <Paper sx={{ p: 3, bgcolor: "#0d1117", borderRadius: 2, border: "1px solid rgba(255,255,255,0.05)" }}>
                    <Typography variant="h6" sx={{ color: "#8b5cf6", mb: 2, display: "flex", alignItems: "center", gap: 1 }}>
                      <AppleIcon /> iOS Proxy Setup
                    </Typography>
                    <List dense>
                      {[
                        "Navigate to http://burp in Safari",
                        "Download & install CA Certificate",
                        "Settings ‚Üí General ‚Üí About ‚Üí Certificate Trust",
                        "Enable full trust for Burp cert",
                        "Set WiFi proxy to <your-ip>:8080",
                      ].map((step, idx) => (
                        <ListItem key={idx} sx={{ py: 0.5 }}>
                          <ListItemIcon sx={{ minWidth: 28 }}>
                            <Chip label={idx + 1} size="small" sx={{ width: 20, height: 20, fontSize: "0.7rem", bgcolor: "#8b5cf6" }} />
                          </ListItemIcon>
                          <ListItemText primary={step} sx={{ "& .MuiListItemText-primary": { color: "grey.300", fontSize: "0.85rem" } }} />
                        </ListItem>
                      ))}
                    </List>
                  </Paper>
                </Grid>
              </Grid>

              <Typography variant="h6" sx={{ color: "grey.200", mb: 2 }}>
                üîç What to Look For
              </Typography>
              <Grid container spacing={2}>
                {[
                  { icon: <WarningIcon />, issue: "HTTP instead of HTTPS", desc: "Sensitive data transmitted in plaintext", color: "#ef4444" },
                  { icon: <LockOpenIcon />, issue: "No certificate pinning", desc: "Easy to intercept with proxy", color: "#f59e0b" },
                  { icon: <VisibilityIcon />, issue: "Tokens in URLs/logs", desc: "Exposed in server logs & history", color: "#f59e0b" },
                  { icon: <SecurityIcon />, issue: "Weak authentication", desc: "Predictable tokens, no expiry", color: "#3b82f6" },
                  { icon: <BugReportIcon />, issue: "IDOR vulnerabilities", desc: "Change IDs to access other users", color: "#ef4444" },
                  { icon: <CodeIcon />, issue: "API key in requests", desc: "Hardcoded keys in traffic", color: "#f59e0b" },
                ].map((item) => (
                  <Grid item xs={12} sm={6} key={item.issue}>
                    <Paper
                      sx={{
                        p: 2,
                        bgcolor: alpha(item.color, 0.05),
                        border: `1px solid ${alpha(item.color, 0.15)}`,
                        borderRadius: 2,
                      }}
                    >
                      <Box sx={{ display: "flex", alignItems: "flex-start", gap: 1.5 }}>
                        <Box sx={{ color: item.color, mt: 0.3 }}>{item.icon}</Box>
                        <Box>
                          <Typography variant="body2" sx={{ color: "grey.200", fontWeight: 500 }}>{item.issue}</Typography>
                          <Typography variant="caption" sx={{ color: "grey.500" }}>{item.desc}</Typography>
                        </Box>
                      </Box>
                    </Paper>
                  </Grid>
                ))}
              </Grid>
            </Box>
          </TabPanel>

          {/* Tab 3: Frida */}
          <TabPanel value={tabValue} index={3}>
            <Box sx={{ p: 3 }}>
              <Typography variant="h5" sx={{ color: "#10b981", mb: 1, fontWeight: 600 }}>
                Frida Dynamic Instrumentation
              </Typography>
              <Typography variant="body2" sx={{ color: "grey.500", mb: 3 }}>
                Inject JavaScript into running apps to bypass security controls
              </Typography>

              <Alert 
                severity="info" 
                sx={{ 
                  mb: 3,
                  bgcolor: alpha("#3b82f6", 0.1),
                  "& .MuiAlert-icon": { color: "#3b82f6" },
                }}
              >
                <strong>Frida</strong> lets you hook functions, modify return values, and trace execution 
                at runtime. Perfect for bypassing SSL pinning, root detection, and debugging obfuscated apps.
              </Alert>

              <Grid container spacing={3}>
                <Grid item xs={12} md={6}>
                  <CodeBlock
                    title="üöÄ Frida Setup"
                    language="bash"
                    code={`# Install Frida tools
pip install frida-tools

# Download frida-server for your device arch
# https://github.com/frida/frida/releases

# Push & run on Android (rooted)
adb push frida-server /data/local/tmp/
adb shell chmod +x /data/local/tmp/frida-server
adb shell /data/local/tmp/frida-server &

# List running apps
frida-ps -U

# Attach to running app
frida -U -n "App Name" -l script.js

# Spawn app with script
frida -U -f com.app.name -l script.js`}
                  />
                </Grid>
                <Grid item xs={12} md={6}>
                  <CodeBlock
                    title="‚ö° Objection (Frida Made Easy)"
                    language="bash"
                    code={`# Install objection
pip install objection

# Explore running app
objection -g "com.app.name" explore

# Common bypasses (inside objection)
android sslpinning disable
android root disable
ios sslpinning disable
ios jailbreak disable

# Dump keychain/keystore
ios keychain dump
android keystore list

# Search classes
android hooking search classes password
ios hooking search classes Token`}
                  />
                </Grid>
              </Grid>

              <Divider sx={{ borderColor: "rgba(255,255,255,0.05)", my: 3 }} />

              <Typography variant="h6" sx={{ color: "grey.200", mb: 2 }}>
                üìú Common Bypass Scripts
              </Typography>

              <Accordion defaultExpanded sx={{ bgcolor: "#0d1117", "&:before": { display: "none" } }}>
                <AccordionSummary expandIcon={<ExpandMoreIcon sx={{ color: "grey.500" }} />}>
                  <Box sx={{ display: "flex", alignItems: "center", gap: 1 }}>
                    <LockOpenIcon sx={{ color: "#10b981" }} />
                    <Typography sx={{ color: "#10b981" }}>SSL Pinning Bypass (Android)</Typography>
                  </Box>
                </AccordionSummary>
                <AccordionDetails>
                  <CodeBlock
                    language="javascript"
                    code={`Java.perform(function() {
    // Bypass TrustManager
    var TrustManager = Java.use('javax.net.ssl.X509TrustManager');
    var SSLContext = Java.use('javax.net.ssl.SSLContext');
    
    var TrustAllCerts = Java.registerClass({
        name: 'com.bypass.TrustAllCerts',
        implements: [TrustManager],
        methods: {
            checkClientTrusted: function(chain, authType) {},
            checkServerTrusted: function(chain, authType) {},
            getAcceptedIssuers: function() { return []; }
        }
    });
    
    var ctx = SSLContext.getInstance("TLS");
    ctx.init(null, [TrustAllCerts.$new()], null);
    console.log("[+] SSL Pinning Bypassed!");
});`}
                  />
                </AccordionDetails>
              </Accordion>

              <Accordion sx={{ bgcolor: "#0d1117", "&:before": { display: "none" } }}>
                <AccordionSummary expandIcon={<ExpandMoreIcon sx={{ color: "grey.500" }} />}>
                  <Box sx={{ display: "flex", alignItems: "center", gap: 1 }}>
                    <FingerprintIcon sx={{ color: "#f59e0b" }} />
                    <Typography sx={{ color: "#f59e0b" }}>Root Detection Bypass</Typography>
                  </Box>
                </AccordionSummary>
                <AccordionDetails>
                  <CodeBlock
                    language="javascript"
                    code={`Java.perform(function() {
    // Hook common root check methods
    var RootBeer = Java.use("com.scottyab.rootbeer.RootBeer");
    RootBeer.isRooted.implementation = function() {
        console.log("[+] RootBeer.isRooted() bypassed");
        return false;
    };
    
    // Hook Runtime.exec for "su" checks
    var Runtime = Java.use("java.lang.Runtime");
    Runtime.exec.overload('java.lang.String').implementation = function(cmd) {
        if (cmd.indexOf("su") !== -1) {
            console.log("[+] Blocked: " + cmd);
            throw new Error("Command not found");
        }
        return this.exec(cmd);
    };
    
    // Hook File.exists for path checks
    var File = Java.use("java.io.File");
    File.exists.implementation = function() {
        var path = this.getAbsolutePath();
        if (path.indexOf("su") !== -1 || path.indexOf("Superuser") !== -1) {
            console.log("[+] Hidden: " + path);
            return false;
        }
        return this.exists();
    };
});`}
                  />
                </AccordionDetails>
              </Accordion>

              <Alert severity="success" sx={{ mt: 3, bgcolor: alpha("#10b981", 0.1), "& .MuiAlert-icon": { color: "#10b981" } }}>
                <strong>üí° Pro Tip:</strong> Use <code>frida-trace</code> to quickly trace method calls:
                <br />
                <code>frida-trace -U -i "SSL*" -n "App Name"</code>
              </Alert>
            </Box>
          </TabPanel>

          {/* Tab 4: Checklist */}
          <TabPanel value={tabValue} index={4}>
            <Box sx={{ p: 3 }}>
              <Typography variant="h5" sx={{ color: "#10b981", mb: 1, fontWeight: 600 }}>
                Mobile Pentest Checklist
              </Typography>
              <Typography variant="body2" sx={{ color: "grey.500", mb: 3 }}>
                Comprehensive testing checklist based on OWASP MASTG
              </Typography>

              <Grid container spacing={3}>
                {[
                  { 
                    category: "Static Analysis", 
                    icon: <CodeIcon />,
                    color: "#3b82f6",
                    items: [
                      "Decompile APK/IPA and review source",
                      "Search for hardcoded secrets & API keys",
                      "Check AndroidManifest.xml permissions",
                      "Review network_security_config.xml",
                      "Analyze third-party libraries for CVEs",
                      "Check for debug flags and logging",
                    ]
                  },
                  { 
                    category: "Data Storage", 
                    icon: <StorageIcon />,
                    color: "#f59e0b",
                    items: [
                      "Check SharedPreferences/NSUserDefaults",
                      "Examine SQLite databases for PII",
                      "Review Keychain/Keystore usage",
                      "Check logs for sensitive data",
                      "Verify backup flag (allowBackup)",
                      "Test clipboard data exposure",
                    ]
                  },
                  { 
                    category: "Network Security", 
                    icon: <WifiIcon />,
                    color: "#10b981",
                    items: [
                      "Test for SSL/TLS pinning",
                      "Intercept API traffic with proxy",
                      "Check for HTTP endpoints",
                      "Analyze authentication tokens",
                      "Test for IDOR vulnerabilities",
                      "Review API error messages",
                    ]
                  },
                  { 
                    category: "Runtime Analysis", 
                    icon: <BugReportIcon />,
                    color: "#ef4444",
                    items: [
                      "Bypass root/jailbreak detection",
                      "Hook and modify sensitive functions",
                      "Test biometric authentication bypass",
                      "Check runtime integrity checks",
                      "Test anti-tampering mechanisms",
                      "Analyze memory for secrets",
                    ]
                  },
                ].map((section) => (
                  <Grid item xs={12} md={6} key={section.category}>
                    <Paper 
                      sx={{ 
                        bgcolor: "#0d1117", 
                        borderRadius: 2, 
                        overflow: "hidden",
                        border: `1px solid ${alpha(section.color, 0.2)}`,
                        height: "100%",
                      }}
                    >
                      <Box 
                        sx={{ 
                          p: 2, 
                          bgcolor: alpha(section.color, 0.1),
                          borderBottom: `1px solid ${alpha(section.color, 0.2)}`,
                          display: "flex",
                          alignItems: "center",
                          gap: 1.5,
                        }}
                      >
                        <Box sx={{ color: section.color }}>{section.icon}</Box>
                        <Typography variant="h6" sx={{ color: section.color, fontWeight: 600 }}>
                          {section.category}
                        </Typography>
                      </Box>
                      <Box sx={{ p: 2 }}>
                        {section.items.map((item, idx) => (
                          <Box 
                            key={idx} 
                            sx={{ 
                              display: "flex", 
                              alignItems: "center", 
                              gap: 1.5, 
                              py: 0.75,
                              borderBottom: idx < section.items.length - 1 ? "1px solid rgba(255,255,255,0.03)" : "none",
                            }}
                          >
                            <CheckCircleIcon sx={{ fontSize: 16, color: "grey.600" }} />
                            <Typography variant="body2" sx={{ color: "grey.300" }}>{item}</Typography>
                          </Box>
                        ))}
                      </Box>
                    </Paper>
                  </Grid>
                ))}
              </Grid>

              <Box sx={{ mt: 4, p: 3, bgcolor: alpha("#8b5cf6", 0.1), borderRadius: 2, border: `1px solid ${alpha("#8b5cf6", 0.2)}` }}>
                <Typography variant="h6" sx={{ color: "#8b5cf6", mb: 2 }}>
                  üìö Essential Resources
                </Typography>
                <Grid container spacing={2}>
                  {[
                    { name: "OWASP MASTG", desc: "Mobile Application Security Testing Guide" },
                    { name: "OWASP MASVS", desc: "Mobile Application Security Verification Standard" },
                    { name: "Frida Codeshare", desc: "Community Frida scripts" },
                    { name: "MobSF Docs", desc: "Mobile Security Framework documentation" },
                  ].map((resource) => (
                    <Grid item xs={12} sm={6} key={resource.name}>
                      <Box sx={{ display: "flex", alignItems: "center", gap: 1 }}>
                        <CheckCircleIcon sx={{ color: "#8b5cf6", fontSize: 18 }} />
                        <Box>
                          <Typography variant="body2" sx={{ color: "grey.200", fontWeight: 500 }}>{resource.name}</Typography>
                          <Typography variant="caption" sx={{ color: "grey.500" }}>{resource.desc}</Typography>
                        </Box>
                      </Box>
                    </Grid>
                  ))}
                </Grid>
              </Box>
            </Box>
          </TabPanel>
        </Paper>

        {/* Footer */}
        <Box sx={{ mt: 4, textAlign: "center" }}>
          <Button
            variant="outlined"
            startIcon={<ArrowBackIcon />}
            onClick={() => navigate("/learn")}
            sx={{ 
              borderColor: alpha("#10b981", 0.5), 
              color: "#10b981",
              px: 4,
              py: 1,
              "&:hover": {
                borderColor: "#10b981",
                bgcolor: alpha("#10b981", 0.1),
              },
            }}
          >
            Back to Learn Hub
          </Button>
        </Box>
      </Container>
    </Box>
  );
};

export default MobilePentestPage;
