import React from "react";
import LearnPageLayout from "../components/LearnPageLayout";
import {
  Box,
  Container,
  Typography,
  Paper,
  Chip,
  Button,
  Grid,
  List,
  ListItem,
  ListItemIcon,
  ListItemText,
  alpha,
  useTheme,
} from "@mui/material";
import ArrowBackIcon from "@mui/icons-material/ArrowBack";
import MemoryIcon from "@mui/icons-material/Memory";
import BugReportIcon from "@mui/icons-material/BugReport";
import BuildIcon from "@mui/icons-material/Build";
import WarningIcon from "@mui/icons-material/Warning";
import CheckCircleIcon from "@mui/icons-material/CheckCircle";
import { useNavigate } from "react-router-dom";

interface Technique {
  name: string;
  description: string;
  color: string;
}

const heapTechniques: Technique[] = [
  { name: "Use-After-Free (UAF)", description: "Accessing memory after it's been freed, allowing control of dangling pointers", color: "#ef4444" },
  { name: "Double Free", description: "Freeing the same chunk twice to corrupt heap metadata", color: "#f59e0b" },
  { name: "Heap Overflow", description: "Writing beyond allocated chunk boundaries to corrupt adjacent data", color: "#8b5cf6" },
  { name: "Heap Spray", description: "Filling heap with controlled data to make exploitation predictable", color: "#3b82f6" },
  { name: "Fastbin Attack", description: "Manipulating fastbin freelist to get arbitrary allocation", color: "#10b981" },
  { name: "Tcache Poisoning", description: "Corrupting tcache freelist for arbitrary write (glibc 2.26+)", color: "#ec4899" },
];

const houseOf = [
  { name: "House of Force", desc: "Overflow top chunk size for arbitrary allocation" },
  { name: "House of Spirit", desc: "Free fake chunk to get allocation at target" },
  { name: "House of Lore", desc: "Corrupt smallbin for arbitrary allocation" },
  { name: "House of Orange", desc: "Trigger malloc error for code execution" },
  { name: "House of Einherjar", desc: "Null byte overflow for chunk consolidation" },
];

const allocatorConcepts = [
  { title: "Chunks and metadata", detail: "Size fields, inuse bits, and forward/back pointers" },
  { title: "Bins and freelists", detail: "Fastbins, small/large bins, and tcache buckets" },
  { title: "Consolidation", detail: "Adjacent free chunks coalesce to form larger chunks" },
  { title: "Alignment and size classes", detail: "Rounding influences layout and reuse" },
  { title: "Top chunk (wilderness)", detail: "Allocator source for large new allocations" },
  { title: "Safe-linking", detail: "XOR-masked pointers harden tcache freelists" },
];

const exploitationGoals = [
  { title: "Info leak", detail: "Reveal heap/libc pointers to defeat ASLR", color: "#3b82f6" },
  { title: "Write-what-where", detail: "Corrupt freelists to control allocation targets", color: "#ef4444" },
  { title: "Control flow hijack", detail: "Overwrite function pointers, hooks, or vtables", color: "#8b5cf6" },
  { title: "Code reuse", detail: "ROP or ret2libc after pointer control", color: "#10b981" },
];

const exploitationWorkflow = [
  { step: "Find primitive", detail: "UAF, overflow, or double free with controllable data" },
  { step: "Heap grooming", detail: "Shape allocation order and chunk adjacency" },
  { step: "Leak addresses", detail: "Use metadata or bins to obtain heap/libc leaks" },
  { step: "Gain write", detail: "Poison tcache or fastbins for targeted writes" },
  { step: "Trigger hijack", detail: "Pivot execution via hooks or corrupted pointers" },
];

const mitigations = [
  "Safe-linking and tcache hardening (newer glibc)",
  "ASLR, PIE, RELRO, NX, and stack canaries",
  "Hardened allocators (Scudo, PartitionAlloc, Hardened Malloc)",
  "Guard pages and heap isolation zones",
  "Compiler sanitizers (ASan/UBSan) in testing",
  "Seccomp and sandboxing to reduce impact",
];

const tools = [
  "GDB + pwndbg/GEF",
  "pwntools",
  "how2heap",
  "heap-analysis plugins",
  "ltrace/strace",
];

export default function HeapExploitationPage() {
  const navigate = useNavigate();
  const theme = useTheme();

  const pageContext = `Heap Exploitation Techniques Guide - Covers heap memory corruption techniques including Use-After-Free, Double Free, Heap Overflow, Heap Spray, Fastbin Attack, and Tcache Poisoning. Introduces heap allocator concepts, exploitation goals, workflow, House of techniques (Force, Spirit, Lore, Orange, Einherjar), mitigations, and essential tools for heap exploitation.`;

  return (
    <LearnPageLayout pageTitle="Heap Exploitation Techniques" pageContext={pageContext}>
      <Container maxWidth="lg" sx={{ py: 4 }}>
        {/* Header */}
        <Box sx={{ mb: 4 }}>
          <Button startIcon={<ArrowBackIcon />} onClick={() => navigate("/learn")} sx={{ mb: 2 }}>
            Back to Learning Hub
          </Button>
          <Box sx={{ display: "flex", alignItems: "center", gap: 2, mb: 2 }}>
            <Box
              sx={{
                width: 64,
                height: 64,
                borderRadius: 2,
                bgcolor: alpha("#ef4444", 0.1),
                display: "flex",
                alignItems: "center",
                justifyContent: "center",
              }}
            >
              <MemoryIcon sx={{ fontSize: 36, color: "#ef4444" }} />
            </Box>
            <Box>
              <Typography variant="h4" sx={{ fontWeight: 800 }}>
                Heap Exploitation Techniques
              </Typography>
              <Typography variant="body1" color="text.secondary">
                Dynamic memory corruption and exploitation
              </Typography>
            </Box>
          </Box>
          <Box sx={{ display: "flex", gap: 1, flexWrap: "wrap" }}>
            <Chip label="Memory Corruption" color="error" size="small" />
            <Chip label="Exploitation" size="small" sx={{ bgcolor: alpha("#8b5cf6", 0.1), color: "#8b5cf6" }} />
            <Chip label="glibc" size="small" sx={{ bgcolor: alpha("#3b82f6", 0.1), color: "#3b82f6" }} />
          </Box>
        </Box>

        {/* Overview */}
        <Paper sx={{ p: 3, mb: 4, borderRadius: 3, border: `1px solid ${alpha(theme.palette.divider, 0.1)}` }}>
          <Typography variant="h6" sx={{ fontWeight: 700, mb: 2, display: "flex", alignItems: "center", gap: 1 }}>
            <MemoryIcon color="primary" /> Overview
          </Typography>
          <Typography variant="body1" color="text.secondary" sx={{ lineHeight: 1.8 }}>
            Heap exploitation targets dynamically allocated memory managed by allocators like glibc's ptmalloc2. 
            By corrupting heap metadata or exploiting allocator behavior, attackers can achieve arbitrary read/write 
            primitives and ultimately code execution. Understanding heap internals is essential for modern binary exploitation.
          </Typography>
        </Paper>

        {/* Allocator Concepts */}
        <Paper sx={{ p: 3, mb: 4, borderRadius: 3, border: `1px solid ${alpha(theme.palette.divider, 0.1)}` }}>
          <Typography variant="h6" sx={{ fontWeight: 700, mb: 2, display: "flex", alignItems: "center", gap: 1 }}>
            <BuildIcon sx={{ color: "#3b82f6" }} /> Allocator Concepts
          </Typography>
          <Grid container spacing={2}>
            {allocatorConcepts.map((concept) => (
              <Grid item xs={12} sm={6} md={4} key={concept.title}>
                <Box sx={{ p: 2, borderRadius: 2, bgcolor: alpha(theme.palette.primary.main, 0.04), height: "100%" }}>
                  <Typography variant="subtitle2" sx={{ fontWeight: 700, mb: 0.5 }}>
                    {concept.title}
                  </Typography>
                  <Typography variant="body2" color="text.secondary">
                    {concept.detail}
                  </Typography>
                </Box>
              </Grid>
            ))}
          </Grid>
        </Paper>

        {/* Core Techniques */}
        <Typography variant="h5" sx={{ fontWeight: 700, mb: 3 }}>üéØ Core Techniques</Typography>
        <Grid container spacing={2} sx={{ mb: 4 }}>
          {heapTechniques.map((tech) => (
            <Grid item xs={12} sm={6} md={4} key={tech.name}>
              <Paper
                sx={{
                  p: 2,
                  height: "100%",
                  borderRadius: 2,
                  border: `1px solid ${alpha(tech.color, 0.2)}`,
                  "&:hover": { borderColor: tech.color },
                }}
              >
                <Typography variant="subtitle1" sx={{ fontWeight: 700, color: tech.color, mb: 1 }}>
                  {tech.name}
                </Typography>
                <Typography variant="body2" color="text.secondary">
                  {tech.description}
                </Typography>
              </Paper>
            </Grid>
          ))}
        </Grid>

        {/* Exploitation Goals */}
        <Typography variant="h5" sx={{ fontWeight: 700, mb: 3 }}>?? Exploitation Goals</Typography>
        <Grid container spacing={2} sx={{ mb: 4 }}>
          {exploitationGoals.map((goal) => (
            <Grid item xs={12} sm={6} md={3} key={goal.title}>
              <Paper
                sx={{
                  p: 2,
                  height: "100%",
                  borderRadius: 2,
                  border: `1px solid ${alpha(goal.color, 0.2)}`,
                  "&:hover": { borderColor: goal.color },
                }}
              >
                <Typography variant="subtitle2" sx={{ fontWeight: 700, color: goal.color, mb: 1 }}>
                  {goal.title}
                </Typography>
                <Typography variant="body2" color="text.secondary">
                  {goal.detail}
                </Typography>
              </Paper>
            </Grid>
          ))}
        </Grid>

        {/* House of Techniques */}
        <Paper
          sx={{
            p: 3,
            mb: 4,
            borderRadius: 3,
            background: `linear-gradient(135deg, ${alpha("#8b5cf6", 0.05)}, ${alpha("#6366f1", 0.05)})`,
            border: `1px solid ${alpha("#8b5cf6", 0.2)}`,
          }}
        >
          <Typography variant="h6" sx={{ fontWeight: 700, mb: 2 }}>üè† House of Techniques</Typography>
          <Grid container spacing={2}>
            {houseOf.map((h) => (
              <Grid item xs={12} sm={6} key={h.name}>
                <Box sx={{ display: "flex", alignItems: "flex-start", gap: 1 }}>
                  <CheckCircleIcon sx={{ fontSize: 18, color: "#8b5cf6", mt: 0.3 }} />
                  <Box>
                    <Typography variant="subtitle2" sx={{ fontWeight: 700 }}>{h.name}</Typography>
                    <Typography variant="caption" color="text.secondary">{h.desc}</Typography>
                  </Box>
                </Box>
              </Grid>
            ))}
          </Grid>
        </Paper>

        {/* Exploitation Workflow */}
        <Paper sx={{ p: 3, mb: 4, borderRadius: 3, bgcolor: alpha("#ef4444", 0.03) }}>
          <Typography variant="h6" sx={{ fontWeight: 700, mb: 2, display: "flex", alignItems: "center", gap: 1 }}>
            <BugReportIcon sx={{ color: "#ef4444" }} /> Exploitation Workflow
          </Typography>
          <List dense>
            {exploitationWorkflow.map((item, i) => (
              <ListItem key={i} sx={{ py: 0.25, px: 0 }}>
                <ListItemIcon sx={{ minWidth: 28 }}>
                  <CheckCircleIcon sx={{ fontSize: 16, color: "#ef4444" }} />
                </ListItemIcon>
                <ListItemText
                  primary={item.step}
                  secondary={item.detail}
                  primaryTypographyProps={{ variant: "body2", fontWeight: 700 }}
                  secondaryTypographyProps={{ variant: "caption" }}
                />
              </ListItem>
            ))}
          </List>
        </Paper>

        {/* Mitigations */}
        <Paper sx={{ p: 3, mb: 4, borderRadius: 3, bgcolor: alpha("#10b981", 0.03) }}>
          <Typography variant="h6" sx={{ fontWeight: 700, mb: 2, display: "flex", alignItems: "center", gap: 1 }}>
            <CheckCircleIcon sx={{ color: "#10b981" }} /> Mitigations and Hardening
          </Typography>
          <List dense>
            {mitigations.map((item, i) => (
              <ListItem key={i} sx={{ py: 0.25, px: 0 }}>
                <ListItemIcon sx={{ minWidth: 28 }}>
                  <CheckCircleIcon sx={{ fontSize: 16, color: "#10b981" }} />
                </ListItemIcon>
                <ListItemText primary={item} primaryTypographyProps={{ variant: "body2" }} />
              </ListItem>
            ))}
          </List>
        </Paper>

        {/* Tools */}
        <Paper sx={{ p: 3, mb: 4, borderRadius: 3, bgcolor: alpha("#3b82f6", 0.03) }}>
          <Typography variant="h6" sx={{ fontWeight: 700, mb: 2, display: "flex", alignItems: "center", gap: 1 }}>
            <BuildIcon sx={{ color: "#3b82f6" }} /> Essential Tools
          </Typography>
          <Box sx={{ display: "flex", flexWrap: "wrap", gap: 1 }}>
            {tools.map((tool) => (
              <Chip key={tool} label={tool} variant="outlined" size="small" />
            ))}
          </Box>
        </Paper>

        {/* Warning */}
        <Paper
          sx={{
            p: 2,
            mb: 4,
            borderRadius: 2,
            bgcolor: alpha("#f59e0b", 0.05),
            border: `1px solid ${alpha("#f59e0b", 0.2)}`,
            display: "flex",
            alignItems: "center",
            gap: 2,
          }}
        >
          <WarningIcon sx={{ color: "#f59e0b" }} />
          <Typography variant="body2">
            <strong>Note:</strong> Heap exploitation techniques vary by allocator (ptmalloc2, jemalloc, tcmalloc) and glibc version.
          </Typography>
        </Paper>

        {/* Related */}
        <Paper sx={{ p: 3, borderRadius: 3, bgcolor: alpha(theme.palette.primary.main, 0.03) }}>
          <Typography variant="h6" sx={{ fontWeight: 700, mb: 2 }}>üìö Related Learning</Typography>
          <Box sx={{ display: "flex", gap: 1, flexWrap: "wrap" }}>
            <Chip label="Buffer Overflow ‚Üí" clickable onClick={() => navigate("/learn/buffer-overflow")} sx={{ fontWeight: 600 }} />
            <Chip label="ROP ‚Üí" clickable onClick={() => navigate("/learn/rop")} sx={{ fontWeight: 600 }} />
          </Box>
        </Paper>
      </Container>
    </LearnPageLayout>
  );
}
